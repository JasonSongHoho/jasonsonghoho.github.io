<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jason&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://jasonsonghoho.github.io/"/>
  <updated>2019-04-30T15:37:18.334Z</updated>
  <id>https://jasonsonghoho.github.io/</id>
  
  <author>
    <name>jason song</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Java7 ConcurrentHashMap ç®€ä»‹</title>
    <link href="https://jasonsonghoho.github.io/2019/04/30/Java7-concurrentHashMap-%E7%AE%80%E4%BB%8B/"/>
    <id>https://jasonsonghoho.github.io/2019/04/30/Java7-concurrentHashMap-ç®€ä»‹/</id>
    <published>2019-04-30T10:52:14.000Z</published>
    <updated>2019-04-30T15:37:18.334Z</updated>
    
    <content type="html"><![CDATA[<p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š15åˆ†é’Ÿ</em></p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>Java7 ConcurrentHashMap æ˜¯çº¿ç¨‹å®‰å…¨çš„ HashMapã€‚ä¸ HashTable çš„åŒºåˆ«æ˜¯ï¼Œæ”¯æŒå¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œååé‡é«˜ã€‚<br>ç»“æ„å¦‚ä¸‹ï¼š<br><img src="/2019/04/30/Java7-concurrentHashMap-ç®€ä»‹/concurrentHashMap.png"></p><p>å¦‚å›¾ï¼ŒConcurrentHashMap å°±æ˜¯ Segment æ•°ç»„ï¼Œæ¯ä¸ª Segment å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª HashMapã€‚åŒä¸€æ—¶é—´ï¼Œæ¯ä¸ª Segment åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚Segment çš„æ•°é‡åœ¨åˆå§‹åŒ–åä¸å†å…è®¸æ›´æ”¹ï¼Œä½†æ˜¯æ¯ä¸ª Segment çš„é•¿åº¦æ˜¯å¯ä»¥æ”¹å˜çš„ã€‚</p><h3 id="Unsafe-ç±»"><a href="#Unsafe-ç±»" class="headerlink" title="Unsafe ç±»"></a>Unsafe ç±»</h3><p>Unsafe ç±»æ˜¯ jdk æä¾›çš„ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»æä¾›äº†ä¸€äº›ç»•å¼€ JVM çš„æ›´åº•å±‚åŠŸèƒ½ï¼ŒåŸºäºå®ƒçš„å®ç°å¯ä»¥æé«˜æ•ˆç‡ã€‚ä½†å®ƒæ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼šæ­£å¦‚å®ƒçš„åå­—æ‰€è®²ï¼Œå®ƒæ˜¯ Unsafe çš„ï¼Œå®ƒæ‰€åˆ†é…çš„å†…å­˜éœ€è¦æ‰‹åŠ¨ freeï¼ˆä¸è¢« GC å›æ”¶ï¼‰ã€‚<br>ConcurrentHashMap ä¸­åå¤ç”¨åˆ°äº†å…¶ä¸­çš„å‡ ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/***</span><br><span class="line"> * Sets the value of the object field at the specified offset in the</span><br><span class="line"> * supplied object to the given value.  This is an ordered or lazy</span><br><span class="line"> * version of &lt;code&gt;putObjectVolatile(Object,long,Object)&lt;/code&gt;, which</span><br><span class="line"> * doesn&apos;t guarantee the immediate visibility of the change to other</span><br><span class="line"> * threads.  It is only really useful where the object field is</span><br><span class="line"> * &lt;code&gt;volatile&lt;/code&gt;, and is thus expected to change unexpectedly.</span><br><span class="line"> * è®¾ç½®objå¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„objectå‹fieldçš„å€¼ä¸ºæŒ‡å®šå€¼ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰åºæˆ–è€…</span><br><span class="line"> * æœ‰å»¶è¿Ÿçš„&lt;code&gt;putObjectVolatile&lt;/cdoe&gt;æ–¹æ³•ï¼Œå¹¶ä¸”ä¸ä¿è¯å€¼çš„æ”¹å˜è¢«å…¶ä»–çº¿ç¨‹ç«‹</span><br><span class="line"> * å³çœ‹åˆ°ã€‚åªæœ‰åœ¨fieldè¢«&lt;code&gt;volatile&lt;/code&gt;ä¿®é¥°å¹¶ä¸”æœŸæœ›è¢«æ„å¤–ä¿®æ”¹çš„æ—¶å€™</span><br><span class="line"> * ä½¿ç”¨æ‰æœ‰ç”¨ã€‚</span><br><span class="line"> *</span><br><span class="line"> * @param obj the object containing the field to modify.</span><br><span class="line"> *    åŒ…å«éœ€è¦ä¿®æ”¹fieldçš„å¯¹è±¡</span><br><span class="line"> * @param offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</span><br><span class="line"> *       &lt;code&gt;obj&lt;/code&gt;ä¸­longå‹fieldçš„åç§»é‡</span><br><span class="line"> * @param value the new value of the field.</span><br><span class="line"> *      fieldå°†è¢«è®¾ç½®çš„æ–°å€¼</span><br><span class="line"> */</span><br><span class="line">public native void putOrderedObject(Object obj, long offset, Object value);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/***</span><br><span class="line">  * Retrieves the value of the object field at the specified offset in the</span><br><span class="line">  * supplied object with volatile load semantics.</span><br><span class="line">  * è·å–objå¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„objectå‹fieldçš„å€¼,æ”¯æŒvolatile loadè¯­ä¹‰ã€‚</span><br><span class="line">  *</span><br><span class="line">  * @param obj the object containing the field to read.</span><br><span class="line">  *    åŒ…å«éœ€è¦å»è¯»å–çš„fieldçš„å¯¹è±¡</span><br><span class="line">  * @param offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</span><br><span class="line">  *       &lt;code&gt;obj&lt;/code&gt;ä¸­objectå‹fieldçš„åç§»é‡</span><br><span class="line">  */</span><br><span class="line"> public native Object getObjectVolatile(Object obj, long offset);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/***</span><br><span class="line"> * Compares the value of the object field at the specified offset</span><br><span class="line"> * in the supplied object with the given expected value, and updates</span><br><span class="line"> * it if they match.  The operation of this method should be atomic,</span><br><span class="line"> * thus providing an uninterruptible way of updating an object field.</span><br><span class="line"> * åœ¨objçš„offsetä½ç½®æ¯”è¾ƒobject fieldå’ŒæœŸæœ›çš„å€¼ï¼Œå¦‚æœç›¸åŒåˆ™æ›´æ–°ã€‚è¿™ä¸ªæ–¹æ³•</span><br><span class="line"> * çš„æ“ä½œåº”è¯¥æ˜¯åŸå­çš„ï¼Œå› æ­¤æä¾›äº†ä¸€ç§ä¸å¯ä¸­æ–­çš„æ–¹å¼æ›´æ–°object fieldã€‚</span><br><span class="line"> *</span><br><span class="line"> * @param obj the object containing the field to modify.</span><br><span class="line"> *    åŒ…å«è¦ä¿®æ”¹fieldçš„å¯¹è±¡</span><br><span class="line"> * @param offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</span><br><span class="line"> *         &lt;code&gt;obj&lt;/code&gt;ä¸­objectå‹fieldçš„åç§»é‡</span><br><span class="line"> * @param expect the expected value of the field.</span><br><span class="line"> *               å¸Œæœ›fieldä¸­å­˜åœ¨çš„å€¼</span><br><span class="line"> * @param update the new value of the field if it equals &lt;code&gt;expect&lt;/code&gt;.</span><br><span class="line"> *               å¦‚æœæœŸæœ›å€¼expectä¸fieldçš„å½“å‰å€¼ç›¸åŒï¼Œè®¾ç½®filedçš„å€¼ä¸ºè¿™ä¸ªæ–°å€¼</span><br><span class="line"> * @return true if the field was changed.</span><br><span class="line"> *              å¦‚æœfieldçš„å€¼è¢«æ›´æ”¹</span><br><span class="line"> */</span><br><span class="line">public native boolean compareAndSwapObject(Object obj, long offset, Object expect, Object update);</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>è§æ³¨é‡Šï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) &#123;</span><br><span class="line">    if (!(loadFactor &gt; 0) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0)</span><br><span class="line">        throw new IllegalArgumentException();</span><br><span class="line">    if (concurrencyLevel &gt; MAX_SEGMENTS)</span><br><span class="line">        concurrencyLevel = MAX_SEGMENTS;</span><br><span class="line">    int sshift = 0;</span><br><span class="line">    //ssize æ˜¯ä¸å°äºé¢„è®¾å¹¶å‘åº¦ä¸”ä¸º2çš„å¹‚æ•°çš„æœ€å°å€¼</span><br><span class="line">    int ssize = 1;</span><br><span class="line">    while (ssize &lt; concurrencyLevel) &#123;</span><br><span class="line">        ++sshift;</span><br><span class="line">        ssize &lt;&lt;= 1;</span><br><span class="line">    &#125;</span><br><span class="line">    //segmentShift å’Œ segmentMask æ˜¯ç”¨äºè®¡ç®— Segment ä½ç½®çš„,int j =(hash &gt;&gt;&gt; segmentShift) &amp; segmentMask ã€‚</span><br><span class="line">    this.segmentShift = 32 - sshift;</span><br><span class="line">    this.segmentMask = ssize - 1;</span><br><span class="line">    if (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    // c æ˜¯æ¯ä¸ª Segment çš„å®¹é‡</span><br><span class="line">    int c = initialCapacity / ssize;</span><br><span class="line">    if (c * ssize &lt; initialCapacity)</span><br><span class="line">        ++c;</span><br><span class="line">    int cap = MIN_SEGMENT_TABLE_CAPACITY;</span><br><span class="line">    while (cap &lt; c)</span><br><span class="line">        cap &lt;&lt;= 1;</span><br><span class="line">    // åˆ›å»º Segment æ•°ç»„ï¼Œå¹¶åˆå§‹åŒ– Segment[0]ã€‚</span><br><span class="line">    Segment&lt;K,V&gt; s0 =</span><br><span class="line">        new Segment&lt;K,V&gt;(loadFactor, (int)(cap * loadFactor),</span><br><span class="line">                         (HashEntry&lt;K,V&gt;[])new HashEntry[cap]);</span><br><span class="line">    Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])new Segment[ssize];</span><br><span class="line">    UNSAFE.putOrderedObject(ss, SBASE, s0); // ordered write of segments[0]</span><br><span class="line">    this.segments = ss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>å¾ˆç®€å•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public V get(Object key) &#123;</span><br><span class="line">    Segment&lt;K,V&gt; s;</span><br><span class="line">    HashEntry&lt;K,V&gt;[] tab;</span><br><span class="line">    int h = hash(key);</span><br><span class="line">    //u æ˜¯è¯¥ Segment åœ¨æ•°ç»„ä¸­çš„ä½ç½®</span><br><span class="line">    long u = (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;</span><br><span class="line">    //Segment ä¸ä¸ºç©ºä¸” Segment çš„ HashEntry æ•°ç»„ä¸ä¸ºç©ºæ—¶ï¼Œéå†é“¾è¡¨æ‰¾åˆ°å€¼è¿”å›ï¼›å¦åˆ™è¿”å› null ã€‚</span><br><span class="line">    if ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != null &amp;&amp;</span><br><span class="line">        (tab = s.table) != null) &#123;</span><br><span class="line">        for (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile</span><br><span class="line">                 (tab, ((long)(((tab.length - 1) &amp; h)) &lt;&lt; TSHIFT) + TBASE);</span><br><span class="line">             e != null; e = e.next) &#123;</span><br><span class="line">            K k;</span><br><span class="line">            if ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))</span><br><span class="line">                return e.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="put"><a href="#put" class="headerlink" title="put"></a>put</h3><p>put è¾ƒå¤æ‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">    Segment&lt;K,V&gt; s;</span><br><span class="line">    if (value == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    int hash = hash(key);</span><br><span class="line">    int j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</span><br><span class="line">    //å¦‚æœè¦æ’å…¥çš„ Segment ä¸º nullï¼Œæ‰§è¡Œ ensureSegment ,åˆå§‹åŒ–å®ƒã€‚</span><br><span class="line">    if ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject(segments, (j &lt;&lt; SSHIFT) + SBASE)) == null)</span><br><span class="line">        s = ensureSegment(j);</span><br><span class="line">    //è°ƒç”¨ Segment çš„ put æ–¹æ³•</span><br><span class="line">    return s.put(key, hash, value, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ensureSegment å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private Segment&lt;K,V&gt; ensureSegment(int k) &#123;</span><br><span class="line">    final Segment&lt;K,V&gt;[] ss = this.segments;</span><br><span class="line">    long u = (k &lt;&lt; SSHIFT) + SBASE; // raw offset</span><br><span class="line">    Segment&lt;K,V&gt; seg;</span><br><span class="line">    if ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == null) &#123;</span><br><span class="line">        //ä½¿ç”¨ Segment[0] çš„å®¹é‡å’Œè´Ÿè½½å› å­åˆå§‹åŒ–è¯¥ Segment</span><br><span class="line">        Segment&lt;K,V&gt; proto = ss[0];</span><br><span class="line">        int cap = proto.table.length;</span><br><span class="line">        float lf = proto.loadFactor;</span><br><span class="line">        int threshold = (int)(cap * lf);</span><br><span class="line">        HashEntry&lt;K,V&gt;[] tab = (HashEntry&lt;K,V&gt;[])new HashEntry[cap];</span><br><span class="line">        //ä½¿ç”¨ CAS å°†è¯¥ Segment åˆå§‹åŒ–</span><br><span class="line">        if ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == null) &#123; // recheck</span><br><span class="line">            Segment&lt;K,V&gt; s = new Segment&lt;K,V&gt;(lf, threshold, tab);</span><br><span class="line">            while ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == null) &#123;</span><br><span class="line">                if (UNSAFE.compareAndSwapObject(ss, u, null, seg = s))</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return seg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…æ‰§è¡Œæ’å…¥çš„ Segment çš„ put æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">final V put(K key, int hash, V value, boolean onlyIfAbsent) &#123;</span><br><span class="line">    //å°è¯•è·å–ä¸€æ¬¡é”ï¼Œè·å–åˆ°å¾€ä¸‹èµ°ï¼›å¦åˆ™æ‰§è¡Œ scanAndLockForPut æ–¹æ³•æ¥è·å–é”</span><br><span class="line">    HashEntry&lt;K,V&gt; node = tryLock() ? null :</span><br><span class="line">        scanAndLockForPut(key, hash, value);</span><br><span class="line">    V oldValue;</span><br><span class="line">    try &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt;[] tab = table;</span><br><span class="line">        int index = (tab.length - 1) &amp; hash;</span><br><span class="line">        HashEntry&lt;K,V&gt; first = entryAt(tab, index);</span><br><span class="line">        //è·å–åˆ°å¤´èŠ‚ç‚¹ï¼Œå¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œæ’å…¥è¯¥å€¼ç›´æ¥è¿”å› nullï¼›</span><br><span class="line">        //å¦åˆ™è¿›è¡Œéå†ï¼Œæ‰¾åˆ°ç›¸åº” key åˆ™è¿›è¡Œä¿®æ”¹,è¿”å›æ—§å€¼ï¼Œæ²¡æ‰¾åˆ°åˆ™åœ¨æœ€åæ’å…¥è¯¥å€¼ç„¶åè¿”å› nullã€‚</span><br><span class="line">        for (HashEntry&lt;K,V&gt; e = first;;) &#123;</span><br><span class="line">            if (e != null) &#123;</span><br><span class="line">                K k;</span><br><span class="line">                if ((k = e.key) == key ||</span><br><span class="line">                    (e.hash == hash &amp;&amp; key.equals(k))) &#123;</span><br><span class="line">                    oldValue = e.value;</span><br><span class="line">                    if (!onlyIfAbsent) &#123;</span><br><span class="line">                        e.value = value;</span><br><span class="line">                        ++modCount;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                e = e.next;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                if (node != null)</span><br><span class="line">                    node.setNext(first);</span><br><span class="line">                else</span><br><span class="line">                    node = new HashEntry&lt;K,V&gt;(hash, key, value, first);</span><br><span class="line">                int c = count + 1;</span><br><span class="line">                if (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)</span><br><span class="line">                    rehash(node);</span><br><span class="line">                else</span><br><span class="line">                    setEntryAt(tab, index, node);</span><br><span class="line">                ++modCount;</span><br><span class="line">                count = c;</span><br><span class="line">                oldValue = null;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    return oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç”¨äºè·å–é”çš„ scanAndLockForPutï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private HashEntry&lt;K,V&gt; scanAndLockForPut(K key, int hash, V value) &#123;</span><br><span class="line">    HashEntry&lt;K,V&gt; first = entryForHash(this, hash);</span><br><span class="line">    HashEntry&lt;K,V&gt; e = first;</span><br><span class="line">    HashEntry&lt;K,V&gt; node = null;</span><br><span class="line">    int retries = -1; // negative while locating node</span><br><span class="line">    //å¾ªç¯è°ƒç”¨ tryLock() å°è¯•è·å–é”ï¼ˆè‡ªæ—‹ï¼‰ï¼Œå½“å¯¹æŸä¸€å…ƒç´ çš„è‡ªæ—‹æ¬¡æ•°è¶…è¿‡ä¸€å®šæ¬¡æ•°æ—¶å°†è¢«é˜»å¡</span><br><span class="line">    while (!tryLock()) &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt; f; // to recheck first below</span><br><span class="line">        //è‡ªæ—‹å¼€å§‹æ—¶ï¼Œå…ˆéå†æ‰¾åˆ°å¯¹åº”çš„å…ƒç´ </span><br><span class="line">        if (retries &lt; 0) &#123;</span><br><span class="line">            if (e == null) &#123;</span><br><span class="line">                if (node == null) // speculatively create node</span><br><span class="line">                    node = new HashEntry&lt;K,V&gt;(hash, key, value, null);</span><br><span class="line">                retries = 0;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (key.equals(e.key))</span><br><span class="line">                retries = 0;</span><br><span class="line">            else</span><br><span class="line">                e = e.next;</span><br><span class="line">        &#125;</span><br><span class="line">        //MAX_SCAN_RETRIES:æœ€å¤§åŠ é”å°è¯•æ¬¡æ•°ï¼Œå•æ ¸ä¸‹ä¸º1ï¼›å¤šæ ¸ä¸‹ä¸º64ã€‚</span><br><span class="line">        //å¦‚æœå·²ç»è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°åˆ™åœæ­¢è‡ªæ—‹ï¼Œå½“å‰çº¿ç¨‹è¢«é˜»å¡ï¼Œä¼‘çœ ä¸€ç›´åˆ°è¯¥é”å¯ä»¥è·å–ã€‚</span><br><span class="line">        else if (++retries &gt; MAX_SCAN_RETRIES) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        //å¦‚æœ retries ä¸ºå¶æ•°ä¸”è¯¥è¡¨å¤´å…ƒç´ å·²ç»æ›´æ”¹åˆ™é‡æ–°å¼€å§‹è‡ªæ—‹</span><br><span class="line">        else if ((retries &amp; 1) == 0 &amp;&amp; (f = entryForHash(this, hash)) != first) &#123;</span><br><span class="line">            e = first = f; // re-traverse if entry changed</span><br><span class="line">            retries = -1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h3><p>å®é™…æ‰§è¡Œæ‰©å®¹çš„æ˜¯ Segment çš„ rehash æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">private void rehash(HashEntry&lt;K,V&gt; node) &#123;</span><br><span class="line">    HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">    int oldCapacity = oldTable.length;</span><br><span class="line">    //å®¹é‡ç¿»å€</span><br><span class="line">    int newCapacity = oldCapacity &lt;&lt; 1;</span><br><span class="line">    threshold = (int)(newCapacity * loadFactor);</span><br><span class="line">    HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">        (HashEntry&lt;K,V&gt;[]) new HashEntry[newCapacity];</span><br><span class="line">    int sizeMask = newCapacity - 1;</span><br><span class="line">    for (int i = 0; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">        HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">        if (e != null) &#123;</span><br><span class="line">            HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">            int idx = e.hash &amp; sizeMask;</span><br><span class="line">            if (next == null)   //  Single node on list</span><br><span class="line">                newTable[idx] = e;</span><br><span class="line">            else &#123; // Reuse consecutive sequence at same slot</span><br><span class="line">                HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                int lastIdx = idx;</span><br><span class="line">                //ç¬¬ä¸€æ¬¡éå†ï¼Œæ‰¾å‡ºæœ€åé¢æœ‰å“ªäº›è¿ç»­çš„å…ƒç´ æ‰©å®¹åä¼šåœ¨ç›¸åŒçš„èŠ‚ç‚¹ä¸Š</span><br><span class="line">                //æ ¹æ®æ¦‚ç‡æ¥è®²ï¼Œå¹³å‡åé¢ 5/6 çš„æ•°æ®éƒ½ä¼šåœ¨ç›¸åŒçš„èŠ‚ç‚¹ä¸Š</span><br><span class="line">                for (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                     last != null;</span><br><span class="line">                     last = last.next) &#123;</span><br><span class="line">                    int k = last.hash &amp; sizeMask;</span><br><span class="line">                    if (k != lastIdx) &#123;</span><br><span class="line">                        lastIdx = k;</span><br><span class="line">                        lastRun = last;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                newTable[lastIdx] = lastRun;</span><br><span class="line">                // å…‹éš†åˆ†ç•ŒèŠ‚ç‚¹ï¼ˆlastrunï¼‰ä¹‹å‰çš„æ‰€æœ‰å…ƒç´ </span><br><span class="line">                for (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                    V v = p.value;</span><br><span class="line">                    int h = p.hash;</span><br><span class="line">                    int k = h &amp; sizeMask;</span><br><span class="line">                    HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                    newTable[k] = new HashEntry&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    int nodeIndex = node.hash &amp; sizeMask; // add the new node</span><br><span class="line">    node.setNext(newTable[nodeIndex]);</span><br><span class="line">    newTable[nodeIndex] = node;</span><br><span class="line">    table = newTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="isEmpty-ã€size"><a href="#isEmpty-ã€size" class="headerlink" title="isEmpty()ã€size()"></a>isEmpty()ã€size()</h3><p>isEmpty ä¸ size ä¸¤ä¸ªæ–¹æ³•ä¸ HashMap æœ‰äº›åŒºåˆ«ã€‚å› ä¸ºå®ƒè¦éå†çš„å¯¹è±¡æ˜¯æ‰€æœ‰ Segmentã€‚ç›´æ¥å¯¹æ‰€æœ‰ Segment åŠ é”éå†ååˆ†å½±å“æ€§èƒ½ï¼Œå› æ­¤è¿™ä¸¤ä¸ªæ–¹æ³•ç”¨äº†å…±åŒçš„ç‰¹æ®ŠæŠ€å·§æ¥å®ç°ã€‚</p><p>isEmpty æ–¹æ³•ä¼šä¸åŠ é”éå†ä¸¤æ¬¡ï¼Œåªè¦ä¸¤æ¬¡è·å–åˆ°çš„ modCount(ä¿®æ”¹æ¬¡æ•°)ä¸ä¸€è‡´æˆ–æŸä¸ª Segment çš„å…ƒç´ ä¸ä¸º0ï¼Œåˆ™è®¤ä¸ºä¸ä¸ºç©ºã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public boolean isEmpty() &#123;</span><br><span class="line">    long sum = 0L;</span><br><span class="line">    final Segment&lt;K,V&gt;[] segments = this.segments;</span><br><span class="line">    for (int j = 0; j &lt; segments.length; ++j) &#123;</span><br><span class="line">        Segment&lt;K,V&gt; seg = segmentAt(segments, j);</span><br><span class="line">        if (seg != null) &#123;</span><br><span class="line">            if (seg.count != 0)</span><br><span class="line">                return false;</span><br><span class="line">            sum += seg.modCount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (sum != 0L) &#123; // recheck unless no modifications</span><br><span class="line">        for (int j = 0; j &lt; segments.length; ++j) &#123;</span><br><span class="line">            Segment&lt;K,V&gt; seg = segmentAt(segments, j);</span><br><span class="line">            if (seg != null) &#123;</span><br><span class="line">                if (seg.count != 0)</span><br><span class="line">                    return false;</span><br><span class="line">                sum -= seg.modCount;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (sum != 0L)</span><br><span class="line">            return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>size æ–¹æ³•ä¹Ÿä¼šå…ˆæ‰§è¡Œä¸¤æ¬¡ä¸åŠ é”çš„éå†ï¼Œè‹¥ä¸¤æ¬¡è·å–çš„ size çš„å¤§å°ä¸€è‡´åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™åŠ é”é‡æ–°è·å– sizeã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public int size() &#123;</span><br><span class="line">    // Try a few times to get accurate count. On failure due to</span><br><span class="line">    // continuous async changes in table, resort to locking.</span><br><span class="line">    final Segment&lt;K,V&gt;[] segments = this.segments;</span><br><span class="line">    int size;</span><br><span class="line">    boolean overflow; // true if size overflows 32 bits</span><br><span class="line">    long sum;         // sum of modCounts</span><br><span class="line">    long last = 0L;   // previous sum</span><br><span class="line">    int retries = -1; // first iteration isn&apos;t retry</span><br><span class="line">    try &#123;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            //å‰ä¸¤æ¬¡éå†è·å–çš„ size çš„å¤§å°ä¸ä¸€è‡´ï¼Œåˆ™åŠ é”è·å– sizeã€‚</span><br><span class="line">            if (retries++ == RETRIES_BEFORE_LOCK) &#123;</span><br><span class="line">                for (int j = 0; j &lt; segments.length; ++j)</span><br><span class="line">                    ensureSegment(j).lock(); // force creation</span><br><span class="line">            &#125;</span><br><span class="line">            sum = 0L;</span><br><span class="line">            size = 0;</span><br><span class="line">            overflow = false;</span><br><span class="line">            for (int j = 0; j &lt; segments.length; ++j) &#123;</span><br><span class="line">                Segment&lt;K,V&gt; seg = segmentAt(segments, j);</span><br><span class="line">                if (seg != null) &#123;</span><br><span class="line">                    sum += seg.modCount;</span><br><span class="line">                    int c = seg.count;</span><br><span class="line">                    if (c &lt; 0 || (size += c) &lt; 0)</span><br><span class="line">                        overflow = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (sum == last)</span><br><span class="line">                break;</span><br><span class="line">            last = sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //å¦‚æœåŠ é”äº†ï¼Œéœ€è¦è¿›è¡Œè§£é”</span><br><span class="line">        if (retries &gt; RETRIES_BEFORE_LOCK) &#123;</span><br><span class="line">            for (int j = 0; j &lt; segments.length; ++j)</span><br><span class="line">                segmentAt(segments, j).unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //å¦‚æœ size å·²è¶…è¿‡32ä½ï¼Œåˆ™å– Integer.MAX_VALUEï¼Œå¦åˆ™å–å®é™…çš„ sizeã€‚</span><br><span class="line">    return overflow ? Integer.MAX_VALUE : size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸ªäººé™‹è§éš¾å…ç–æ¼ï¼Œä¸è¶³ä¹‹å¤„è¿˜è¯·å¤šå¤šæŒ‡æ•™ã€‚ğŸ˜„</p><p>æ±Ÿæ¹–è·¯è¿œï¼Œæˆ‘ä»¬ä¸‹æœŸå†ä¼šã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š15åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h3&gt;&lt;p&gt;Java7 ConcurrentHashMap æ˜¯çº¿ç¨‹å®‰å…¨çš„ HashMapã€‚ä¸ H
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="ConcurrentHashMap" scheme="https://jasonsonghoho.github.io/public/tags/ConcurrentHashMap/"/>
    
  </entry>
  
  <entry>
    <title>Sentinel ä½¿ç”¨ç®€ä»‹</title>
    <link href="https://jasonsonghoho.github.io/2019/03/18/Sentinel%E7%AE%80%E4%BB%8B/"/>
    <id>https://jasonsonghoho.github.io/2019/03/18/Sentinelç®€ä»‹/</id>
    <published>2019-03-18T08:04:27.000Z</published>
    <updated>2019-03-18T10:43:29.225Z</updated>
    
    <content type="html"><![CDATA[<img src="/2019/03/18/Sentinelç®€ä»‹/sentinel-logo.png"><h3 id="Sentinel-æ˜¯ä»€ä¹ˆ"><a href="#Sentinel-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Sentinel æ˜¯ä»€ä¹ˆ"></a>Sentinel æ˜¯ä»€ä¹ˆ</h3><p>Sentinel æ˜¯é¢å‘åˆ†å¸ƒå¼æœåŠ¡æ¶æ„çš„è½»é‡çº§ <strong>æµé‡æ§åˆ¶æ¡†æ¶</strong>ï¼Œå¯ä»¥ä» <strong>æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤</strong> ç­‰å¤šä¸ªç»´åº¦æ¥ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p><h4 id="æµé‡æ§åˆ¶"><a href="#æµé‡æ§åˆ¶" class="headerlink" title="æµé‡æ§åˆ¶"></a>æµé‡æ§åˆ¶</h4><p>å¯ä»¥ç†è§£ä¸ºé™åˆ¶æŸç§è¯·æ±‚çš„æœ€å¤§ QPS æˆ–å®ƒèƒ½åŒæ—¶å‘èµ·çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚æ§åˆ¶è¡Œä¸ºå¯ä»¥æ˜¯ <strong>ç›´æ¥æ‹’ç»ã€æ’é˜Ÿç­‰å€™ã€ç¼“æ…¢å¯åŠ¨</strong> ç­‰ã€‚</p><h4 id="ç†”æ–­é™çº§"><a href="#ç†”æ–­é™çº§" class="headerlink" title="ç†”æ–­é™çº§"></a>ç†”æ–­é™çº§</h4><p>å½“æŸç§è¯·æ±‚çš„è¿ç»­çš„å‡ æ¬¡è¯·æ±‚éƒ½è¶…æ—¶æˆ–è¡¨ç°å‡ºå…¶ä»–å¼‚å¸¸ï¼Œå½±å“åˆ°æœåŠ¡çš„å¥åº·æ—¶ï¼Œå¯ä»¥åœ¨æ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´å†…æ‹’ç»ç›¸åŒçš„è¯·æ±‚ï¼Œä»¥ä¿æŠ¤æœåŠ¡å¥åº·ã€‚</p><h4 id="ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤"><a href="#ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤" class="headerlink" title="ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤"></a>ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤</h4><p>ä»æ•´ä½“ç»´åº¦å¯¹åº”ç”¨å…¥å£æµé‡è¿›è¡Œæ§åˆ¶ï¼Œç»“åˆåº”ç”¨çš„ Loadã€æ€»ä½“å¹³å‡ RT(RequestTime)ã€å…¥å£ QPS å’Œçº¿ç¨‹æ•°ç­‰å‡ ä¸ªç»´åº¦çš„ç›‘æ§æŒ‡æ ‡ï¼Œ<strong>è®©ç³»ç»Ÿçš„å…¥å£æµé‡å’Œç³»ç»Ÿçš„è´Ÿè½½è¾¾åˆ°ä¸€ä¸ªå¹³è¡¡</strong>ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ã€‚</p><img src="/2019/03/18/Sentinelç®€ä»‹/sentinelåŠŸèƒ½.png"><h3 id="Sentinel-åŸºæœ¬æ¦‚å¿µ"><a href="#Sentinel-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="Sentinel åŸºæœ¬æ¦‚å¿µ"></a>Sentinel åŸºæœ¬æ¦‚å¿µ</h3><h4 id="èµ„æº"><a href="#èµ„æº" class="headerlink" title="èµ„æº"></a>èµ„æº</h4><p>èµ„æºæ˜¯ Sentinel çš„å…³é”®æ¦‚å¿µã€‚ <strong>å®ƒå¯ä»¥æ˜¯ Java åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å†…å®¹</strong>ï¼Œä¾‹å¦‚ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›çš„æœåŠ¡ï¼Œæˆ–ç”±åº”ç”¨ç¨‹åºè°ƒç”¨çš„å…¶å®ƒåº”ç”¨æä¾›çš„æœåŠ¡ï¼Œç”šè‡³å¯ä»¥æ˜¯ä¸€æ®µä»£ç ã€‚</p><h4 id="è§„åˆ™"><a href="#è§„åˆ™" class="headerlink" title="è§„åˆ™"></a>è§„åˆ™</h4><p>å›´ç»•èµ„æºçš„å®æ—¶çŠ¶æ€è®¾å®šçš„è§„åˆ™ï¼Œå¯ä»¥åŒ…æ‹¬æµé‡æ§åˆ¶è§„åˆ™ã€ç†”æ–­é™çº§è§„åˆ™ä»¥åŠç³»ç»Ÿä¿æŠ¤è§„åˆ™ã€‚æ‰€æœ‰è§„åˆ™å¯ä»¥ <strong>åŠ¨æ€å®æ—¶è°ƒæ•´</strong> ã€‚</p><h3 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h3><h4 id="1-æ·»åŠ -POM-ä¾èµ–"><a href="#1-æ·»åŠ -POM-ä¾èµ–" class="headerlink" title="1.æ·»åŠ  POM ä¾èµ–"></a>1.æ·»åŠ  POM ä¾èµ–</h4><p>Sentinel çš„ä½¿ç”¨å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:</p><ul><li>æ ¸å¿ƒåº“ï¼ˆJava å®¢æˆ·ç«¯ï¼‰ï¼šæ ¸å¿ƒåŠŸèƒ½å®ç°åŒ…ã€‚ä¸ä¾èµ–ä»»ä½•æ¡†æ¶/åº“ï¼Œèƒ½å¤Ÿè¿è¡Œäº Java 7 åŠä»¥ä¸Šçš„ç‰ˆæœ¬çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚</li><li>æ§åˆ¶å°ï¼ˆDashboardï¼‰ï¼šDashboardä¸»è¦è´Ÿè´£ç®¡ç†æ¨é€è§„åˆ™ï¼›ç›‘æ§ï¼›ç®¡ç†æœºå™¨ä¿¡æ¯ç­‰ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- æ ¸å¿ƒåº“ --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sentinel-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.5.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- ä¸æ§åˆ¶å°äº¤äº’ç”¨ --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sentinel-transport-simple-http&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.5.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h4 id="2-å®šä¹‰èµ„æº"><a href="#2-å®šä¹‰èµ„æº" class="headerlink" title="2.å®šä¹‰èµ„æº"></a>2.å®šä¹‰èµ„æº</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    initFlowRules();</span><br><span class="line">    while (true) &#123;</span><br><span class="line">        Entry entry = null;</span><br><span class="line">        try &#123;</span><br><span class="line">    entry = SphU.entry(&quot;HelloWorld&quot;);</span><br><span class="line">            /*æ‚¨çš„ä¸šåŠ¡é€»è¾‘ - å¼€å§‹*/</span><br><span class="line">            System.out.println(&quot;hello world&quot;);</span><br><span class="line">            /*æ‚¨çš„ä¸šåŠ¡é€»è¾‘ - ç»“æŸ*/</span><br><span class="line">&#125; catch (BlockException e1) &#123;</span><br><span class="line">            /*æµæ§é€»è¾‘å¤„ç† - å¼€å§‹*/</span><br><span class="line">    System.out.println(&quot;block!&quot;);</span><br><span class="line">            /*æµæ§é€»è¾‘å¤„ç† - ç»“æŸ*/</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">   if (entry != null) &#123;</span><br><span class="line">       entry.exit();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-å®šä¹‰è§„åˆ™"><a href="#3-å®šä¹‰è§„åˆ™" class="headerlink" title="3.å®šä¹‰è§„åˆ™"></a>3.å®šä¹‰è§„åˆ™</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private static void initFlowRules()&#123;</span><br><span class="line">    List&lt;FlowRule&gt; rules = new ArrayList&lt;&gt;();</span><br><span class="line">    FlowRule rule = new FlowRule();</span><br><span class="line">    rule.setResource(&quot;HelloWorld&quot;);</span><br><span class="line">    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">    // Set limit QPS to 20.</span><br><span class="line">    rule.setCount(20);</span><br><span class="line">    rules.add(rule);</span><br><span class="line">    FlowRuleManager.loadRules(rules);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨è¯¥ demo å·¥ç¨‹ï¼Œå‚æ•°æ·»åŠ  <code>-Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=data-gateway</code></p><h4 id="4-å¯åŠ¨æ§åˆ¶å°è§‚å¯Ÿç»“æœ"><a href="#4-å¯åŠ¨æ§åˆ¶å°è§‚å¯Ÿç»“æœ" class="headerlink" title="4.å¯åŠ¨æ§åˆ¶å°è§‚å¯Ÿç»“æœ"></a>4.å¯åŠ¨æ§åˆ¶å°è§‚å¯Ÿç»“æœ</h4><p>ä¸‹è½½ <a href="git@github.com:alibaba/Sentinel.git">alibaba/Sentinel</a> å·¥ç¨‹ï¼Œæœ¬åœ°å¯åŠ¨ sentinel-dashboard æ¨¡å—ï¼Œè¿è¡Œå‚æ•°æ·»åŠ  <code>-Dserver.port=8080</code> ã€‚</p><img src="/2019/03/18/Sentinelç®€ä»‹/sentinelæ§åˆ¶å°.png" title="sentinelæ§åˆ¶å°"><p>æ›´å¤š demo å¯å‚è€ƒ <a href="https://github.com/alibaba/Sentinel/tree/master/sentinel-demo" target="_blank" rel="noopener">Sentinel Examples</a></p><h3 id="è§„åˆ™è¯¦æƒ…"><a href="#è§„åˆ™è¯¦æƒ…" class="headerlink" title="è§„åˆ™è¯¦æƒ…"></a>è§„åˆ™è¯¦æƒ…</h3><h4 id="æµé‡æ§åˆ¶è§„åˆ™-FlowRule"><a href="#æµé‡æ§åˆ¶è§„åˆ™-FlowRule" class="headerlink" title="æµé‡æ§åˆ¶è§„åˆ™ (FlowRule)"></a>æµé‡æ§åˆ¶è§„åˆ™ (FlowRule)</h4><h5 id="é‡è¦å±æ€§ï¼š"><a href="#é‡è¦å±æ€§ï¼š" class="headerlink" title="é‡è¦å±æ€§ï¼š"></a>é‡è¦å±æ€§ï¼š</h5><table><thead><tr><th>Field</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>resource</td><td>èµ„æºåï¼Œèµ„æºåæ˜¯é™æµè§„åˆ™çš„ä½œç”¨å¯¹è±¡</td><td></td></tr><tr><td>count</td><td>é™æµé˜ˆå€¼</td><td>QPS æ¨¡å¼</td></tr><tr><td>grade</td><td>é™æµé˜ˆå€¼ç±»å‹ï¼ŒQPS æˆ–çº¿ç¨‹æ•°æ¨¡å¼</td><td></td></tr><tr><td>limitApp</td><td>æµæ§é’ˆå¯¹çš„è°ƒç”¨æ¥æº</td><td>defaultï¼Œä»£è¡¨ä¸åŒºåˆ†è°ƒç”¨æ¥æº</td></tr><tr><td>strategy</td><td>åˆ¤æ–­çš„æ ¹æ®æ˜¯èµ„æºè‡ªèº«ï¼Œè¿˜æ˜¯æ ¹æ®å…¶å®ƒå…³è”èµ„æº (refResource)ï¼Œè¿˜æ˜¯æ ¹æ®é“¾è·¯å…¥å£</td><td>æ ¹æ®èµ„æºæœ¬èº«</td></tr><tr><td>controlBehavior</td><td>æµæ§æ•ˆæœï¼ˆç›´æ¥æ‹’ç» / æ’é˜Ÿç­‰å¾… / æ…¢å¯åŠ¨æ¨¡å¼ï¼‰</td><td>ç›´æ¥æ‹’ç»</td></tr></tbody></table><h5 id="demo"><a href="#demo" class="headerlink" title="demo:"></a>demo:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void initFlowQpsRule() &#123;</span><br><span class="line">    List&lt;FlowRule&gt; rules = new ArrayList&lt;&gt;();</span><br><span class="line">    FlowRule rule = new FlowRule(resourceName);</span><br><span class="line">    // set limit qps to 20</span><br><span class="line">    rule.setCount(20);</span><br><span class="line">    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">    rule.setLimitApp(&quot;default&quot;);</span><br><span class="line">    rules.add(rule);</span><br><span class="line">    FlowRuleManager.loadRules(rules);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ›´å¤šå†…å®¹å¯å‚è€ƒ<a href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener">æµé‡æ§åˆ¶</a></p><h4 id="ç†”æ–­é™çº§è§„åˆ™-DegradeRule"><a href="#ç†”æ–­é™çº§è§„åˆ™-DegradeRule" class="headerlink" title="ç†”æ–­é™çº§è§„åˆ™ (DegradeRule)"></a>ç†”æ–­é™çº§è§„åˆ™ (DegradeRule)</h4><h5 id="é‡è¦å±æ€§ï¼š-1"><a href="#é‡è¦å±æ€§ï¼š-1" class="headerlink" title="é‡è¦å±æ€§ï¼š"></a>é‡è¦å±æ€§ï¼š</h5><table><thead><tr><th>Field</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>resource</td><td>èµ„æºåï¼Œèµ„æºåæ˜¯é™æµè§„åˆ™çš„ä½œç”¨å¯¹è±¡</td><td></td></tr><tr><td>count</td><td>é˜ˆå€¼,å•ä½ä¸º ms</td><td></td></tr><tr><td>timeWindow</td><td>é™çº§çš„æ—¶é—´ï¼Œå•ä½ä¸º s</td><td></td></tr><tr><td>grade</td><td>é™çº§æ¨¡å¼ï¼Œæ ¹æ® RT é™çº§è¿˜æ˜¯æ ¹æ®å¼‚å¸¸æ¯”ä¾‹é™çº§</td><td>RT</td></tr></tbody></table><h5 id="demo-1"><a href="#demo-1" class="headerlink" title="demo:"></a>demo:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void initDegradeRule() &#123;</span><br><span class="line">    List&lt;DegradeRule&gt; rules = new ArrayList&lt;&gt;();</span><br><span class="line">    DegradeRule rule = new DegradeRule();</span><br><span class="line">    rule.setResource(KEY);</span><br><span class="line">    rule.setGrade(RuleConstant.DEGRADE_GRADE_RT);</span><br><span class="line">    // è‹¥è¿ç»­ 5 ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´å‡è¶…è¿‡ 300 ms ï¼Œå°†ä¼šè¢«ç†”æ–­ 10S</span><br><span class="line">    rule.setCount(300);</span><br><span class="line">    rule.setTimeWindow(10);</span><br><span class="line">    rules.add(rule);</span><br><span class="line">    DegradeRuleManager.loadRules(rules);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ›´å¤šå†…å®¹å¯å‚è€ƒ<a href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7" target="_blank" rel="noopener">ç†”æ–­é™çº§</a></p><h4 id="ç³»ç»Ÿä¿æŠ¤è§„åˆ™-SystemRule"><a href="#ç³»ç»Ÿä¿æŠ¤è§„åˆ™-SystemRule" class="headerlink" title="ç³»ç»Ÿä¿æŠ¤è§„åˆ™ (SystemRule)"></a>ç³»ç»Ÿä¿æŠ¤è§„åˆ™ (SystemRule)</h4><h5 id="é‡è¦å±æ€§ï¼š-2"><a href="#é‡è¦å±æ€§ï¼š-2" class="headerlink" title="é‡è¦å±æ€§ï¼š"></a>é‡è¦å±æ€§ï¼š</h5><table><thead><tr><th>Field</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>highestSystemLoad</td><td>æœ€å¤§çš„ load1ï¼Œå‚è€ƒå€¼</td><td>-1 (ä¸ç”Ÿæ•ˆ)</td></tr><tr><td>avgRt</td><td>æ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡å“åº”æ—¶é—´</td><td>-1 (ä¸ç”Ÿæ•ˆ)</td></tr><tr><td>maxThread</td><td>å…¥å£æµé‡çš„æœ€å¤§å¹¶å‘æ•°</td><td>-1 (ä¸ç”Ÿæ•ˆ)</td></tr><tr><td>qps</td><td>æ‰€æœ‰å…¥å£èµ„æºçš„ QPS</td><td>-1 (ä¸ç”Ÿæ•ˆ)</td></tr></tbody></table><h5 id="demo-2"><a href="#demo-2" class="headerlink" title="demo:"></a>demo:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void initSystemRule() &#123;</span><br><span class="line">    List&lt;SystemRule&gt; rules = new ArrayList&lt;&gt;();</span><br><span class="line">    SystemRule rule = new SystemRule();</span><br><span class="line">    rule.setHighestSystemLoad(10);</span><br><span class="line">    rules.add(rule);</span><br><span class="line">    SystemRuleManager.loadRules(rules);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ›´å¤šå†…å®¹å¯å‚è€ƒ<a href="https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81" target="_blank" rel="noopener">ç³»ç»Ÿè‡ªé€‚åº”é™æµ</a></p><h4 id="æˆæƒè§„åˆ™-AuthorityRule"><a href="#æˆæƒè§„åˆ™-AuthorityRule" class="headerlink" title="æˆæƒè§„åˆ™ (AuthorityRule)"></a>æˆæƒè§„åˆ™ (AuthorityRule)</h4><h5 id="é‡è¦å±æ€§ï¼š-3"><a href="#é‡è¦å±æ€§ï¼š-3" class="headerlink" title="é‡è¦å±æ€§ï¼š"></a>é‡è¦å±æ€§ï¼š</h5><table><thead><tr><th>Field</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>resource</td><td>èµ„æºåï¼Œèµ„æºåæ˜¯é™æµè§„åˆ™çš„ä½œç”¨å¯¹è±¡</td><td></td></tr><tr><td>limitApp</td><td>å¯¹åº”çš„é»‘åå•/ç™½åå•ï¼Œä¸åŒ origin ç”¨ , åˆ†éš”ï¼Œå¦‚ appA,appB</td><td></td></tr><tr><td>strategy</td><td>é™åˆ¶æ¨¡å¼ï¼ŒAUTHORITY_WHITE ä¸ºç™½åå•æ¨¡å¼ï¼ŒAUTHORITY_BLACK ä¸ºé»‘åå•æ¨¡å¼</td><td>ç™½åå•</td></tr></tbody></table><h5 id="demo-3"><a href="#demo-3" class="headerlink" title="demo:"></a>demo:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AuthorityRule rule = new AuthorityRule();</span><br><span class="line">rule.setResource(&quot;test&quot;);</span><br><span class="line">rule.setStrategy(RuleConstant.AUTHORITY_WHITE);</span><br><span class="line">rule.setLimitApp(&quot;appA,appB&quot;);</span><br><span class="line">AuthorityRuleManager.loadRules(Collections.singletonList(rule));</span><br></pre></td></tr></table></figure><p>æ›´å¤šå†…å®¹å¯å‚è€ƒ<a href="https://github.com/alibaba/Sentinel/wiki/%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener">é»‘ç™½åå•æ§åˆ¶</a></p><h4 id="çƒ­ç‚¹è§„åˆ™-ParamFlowRule"><a href="#çƒ­ç‚¹è§„åˆ™-ParamFlowRule" class="headerlink" title="çƒ­ç‚¹è§„åˆ™ (ParamFlowRule)"></a>çƒ­ç‚¹è§„åˆ™ (ParamFlowRule)</h4><h5 id="é‡è¦å±æ€§ï¼š-4"><a href="#é‡è¦å±æ€§ï¼š-4" class="headerlink" title="é‡è¦å±æ€§ï¼š"></a>é‡è¦å±æ€§ï¼š</h5><table><thead><tr><th>Field</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>resource</td><td>èµ„æºåï¼Œå¿…å¡«</td><td></td></tr><tr><td>count</td><td>é™æµé˜ˆå€¼ï¼Œå¿…å¡«</td><td></td></tr><tr><td>paramIdx</td><td>çƒ­ç‚¹å‚æ•°çš„ç´¢å¼•ï¼Œå¿…å¡«ï¼Œå¯¹åº” SphU.entry(xxx, args) ä¸­çš„å‚æ•°ç´¢å¼•ä½ç½®</td><td></td></tr><tr><td>paramFlowItemList</td><td>å‚æ•°ä¾‹å¤–é¡¹ï¼Œå¯ä»¥é’ˆå¯¹æŒ‡å®šçš„å‚æ•°å€¼å•ç‹¬è®¾ç½®é™æµé˜ˆå€¼ï¼Œä¸å—å‰é¢ count é˜ˆå€¼çš„é™åˆ¶ã€‚ä»…æ”¯æŒåŸºæœ¬ç±»å‹</td><td></td></tr><tr><td>grade</td><td>é™æµæ¨¡å¼</td><td>QPS æ¨¡å¼</td></tr></tbody></table><h5 id="demo-4"><a href="#demo-4" class="headerlink" title="demo:"></a>demo:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ParamFlowRule rule = new ParamFlowRule(resourceName)</span><br><span class="line">    .setParamIdx(0)</span><br><span class="line">    .setCount(5);</span><br><span class="line">// é’ˆå¯¹ int ç±»å‹çš„å‚æ•° PARAM_Bï¼Œå•ç‹¬è®¾ç½®é™æµ QPS é˜ˆå€¼ä¸º 10ï¼Œè€Œä¸æ˜¯å…¨å±€çš„é˜ˆå€¼ 5.</span><br><span class="line">ParamFlowItem item = new ParamFlowItem().setObject(String.valueOf(PARAM_B))</span><br><span class="line">    .setClassType(int.class.getName())</span><br><span class="line">    .setCount(10);</span><br><span class="line">rule.setParamFlowItemList(Collections.singletonList(item));</span><br><span class="line"></span><br><span class="line">ParamFlowRuleManager.loadRules(Collections.singletonList(rule));</span><br></pre></td></tr></table></figure><p>æ›´å¤šå†…å®¹å¯å‚è€ƒ<a href="https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81" target="_blank" rel="noopener">çƒ­ç‚¹å‚æ•°é™æµ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/2019/03/18/Sentinelç®€ä»‹/sentinel-logo.png&quot;&gt;
&lt;h3 id=&quot;Sentinel-æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#Sentinel-æ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; title=&quot;Sentinel æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="ä¸­é—´ä»¶" scheme="https://jasonsonghoho.github.io/public/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>volatileã€CASã€synchronizedã€ReentrantLock ç®€ä»‹</title>
    <link href="https://jasonsonghoho.github.io/2018/11/24/volatile%E3%80%81CAS%E3%80%81synchronized%E3%80%81ReentrantLock-%E7%AE%80%E4%BB%8B/"/>
    <id>https://jasonsonghoho.github.io/2018/11/24/volatileã€CASã€synchronizedã€ReentrantLock-ç®€ä»‹/</id>
    <published>2018-11-24T04:23:02.000Z</published>
    <updated>2018-11-24T14:59:54.059Z</updated>
    
    <content type="html"><![CDATA[<p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š10åˆ†é’Ÿ</em></p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>volatileã€CASã€synchronizedã€ReentrantLock éƒ½æ˜¯å¤šçº¿ç¨‹ä¸­éœ€è¦ç†è§£çš„é‡è¦çŸ¥è¯†ï¼Œæœ¬æ–‡æŠŠå®ƒä»¬æ”¾ä¸€èµ·å¯¹æ¯”ä¸‹ï¼Œåšä¸ªç®€å•çš„ä»‹ç»ï¼Œä¸ºåé¢åˆ†æconcurrentåŒ…æºç æ‰“å¥½åŸºç¡€ã€‚<br>å…¶ä¸­ volatile å’Œ CAS æ˜¯ç”¨æ¥ä¿è¯å¯¹å˜é‡çš„æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œsynchronized å’Œ Lock æ˜¯ç”¨æ¥ä¿è¯å¤šä¸ªæ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚</p><h3 id="ä¸€ä¸ªå®éªŒ"><a href="#ä¸€ä¸ªå®éªŒ" class="headerlink" title="ä¸€ä¸ªå®éªŒ"></a>ä¸€ä¸ªå®éªŒ</h3><p>æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªå°å®éªŒæ¥ç®€å•äº†è§£ä¸‹ä»–ä»¬çš„ä½¿ç”¨æ–¹æ³•å’ŒåŒºåˆ«ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">public class AtomicLab &#123;</span><br><span class="line">    private static final int LOOP_TIME = 500;</span><br><span class="line">    private static final Object LOCK = new Object();</span><br><span class="line">    private static Integer availableProcessors = Runtime.getRuntime().availableProcessors();</span><br><span class="line">    private static Lock lock = new ReentrantLock();</span><br><span class="line"></span><br><span class="line">    private static Integer i0 = 0;</span><br><span class="line">    private static volatile Integer i1 = 0;</span><br><span class="line">    private static Integer i2 = 0;</span><br><span class="line">    private static AtomicInteger i3 = new AtomicInteger();</span><br><span class="line">    private static Integer i4 = 0;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(&quot;jasonLab-%d&quot;).build();</span><br><span class="line">        ExecutorService service = new ThreadPoolExecutor(availableProcessors + 1, availableProcessors * 2,</span><br><span class="line">                60L, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;Runnable&gt;(5000), threadFactory);</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            service.execute(new TestThread0());</span><br><span class="line">            service.execute(new TestThread1());</span><br><span class="line">            service.execute(new TestThread2());</span><br><span class="line">            service.execute(new TestThread3());</span><br><span class="line">            service.execute(new TestThread4());</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(1000L);</span><br><span class="line">        System.out.println(&quot;i0 result is &quot; + i0 + &quot; , equal 50000 : &quot; + (i0 == 50000));</span><br><span class="line">        System.out.println(&quot;i1 result is &quot; + i1 + &quot; , equal 50000 : &quot; + (i1 == 50000));</span><br><span class="line">        System.out.println(&quot;i2 result is &quot; + i2 + &quot; , equal 50000 : &quot; + (i2 == 50000));</span><br><span class="line">        System.out.println(&quot;i3 result is &quot; + i3 + &quot; , equal 50000 : &quot; + (i3.get() == 50000));</span><br><span class="line">        System.out.println(&quot;i4 result is &quot; + i4 + &quot; , equal 50000 : &quot; + (i4 == 50000));</span><br><span class="line"></span><br><span class="line">        service.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class TestThread0 implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            for (int i = 0; i &lt; LOOP_TIME; i++) &#123;</span><br><span class="line">                i0 += 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class TestThread1 implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            for (int i = 0; i &lt; LOOP_TIME; i++) &#123;</span><br><span class="line">                i1++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class TestThread2 implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            for (int i = 0; i &lt; LOOP_TIME; i++) &#123;</span><br><span class="line">                synchronized (LOCK) &#123;</span><br><span class="line">                    i2 += 1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class TestThread3 implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            for (int i = 0; i &lt; LOOP_TIME; i++) &#123;</span><br><span class="line">                i3.getAndAdd(1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class TestThread4 implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            try &#123;</span><br><span class="line">                for (int i = 0; i &lt; LOOP_TIME; i++) &#123;</span><br><span class="line">                    i4++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸Šè¿° main æ–¹æ³•ï¼Œä¸€ä¸ªå¯èƒ½çš„ç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">i0 result is 48646 , equal 50000 : false</span><br><span class="line">i1 result is 48509 , equal 50000 : false</span><br><span class="line">i2 result is 50000 , equal 50000 : true</span><br><span class="line">i3 result is 50000 , equal 50000 : true</span><br><span class="line">i4 result is 50000 , equal 50000 : true</span><br></pre></td></tr></table></figure></p><p>ä¸Šè¿°å®éªŒæ˜¯è®¡ç®— 100 ä¸ªçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€ä¸ª i è¿›è¡Œ<code>i++</code>æ“ä½œçš„ç´¯åŠ ç»“æœã€‚<br>æˆ‘ä»¬çŸ¥é“ï¼Œ<code>i++</code>æ“ä½œå…¶å®åˆ†ï¼šè¯»ï¼ˆgetI()ï¼‰ã€æ”¹ï¼ˆi=i+1ï¼‰ã€å†™ï¼ˆsetI(i)ï¼‰ä¸‰æ­¥è¿›è¡Œçš„ã€‚<br>å¯¹äº i0ï¼Œè¿™ä¸‰ä¸ªæ“ä½œéƒ½ä¸å…·å¤‡åŸå­æ€§ä¿è¯ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹ä¸‹éš¾å…ä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚è€Œè‡³äºi1-i4ï¼Œå…¶å®åˆ†åˆ«ç”¨åˆ°äº†æ ‡é¢˜ä¸­çš„å››ä¸ªçŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬ä¾æ¬¡ä»‹ç»ä¸‹å®ƒä»¬ã€‚</p><h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h3><p>i1 è¢« volatile ä¿®é¥°ï¼Œå®ƒæ˜¯ Java ä¸­çš„å…³é”®å­—ï¼Œå®ƒä¿®é¥°çš„å˜é‡å…·æœ‰å¯è§æ€§å’ŒåŸå­æ€§çš„ç‰¹ç‚¹ã€‚</p><h4 id="å¯è§æ€§å’ŒåŸå­æ€§"><a href="#å¯è§æ€§å’ŒåŸå­æ€§" class="headerlink" title="å¯è§æ€§å’ŒåŸå­æ€§"></a>å¯è§æ€§å’ŒåŸå­æ€§</h4><p>å¯è§æ€§ï¼šå¦‚æœä¸€ä¸ªå˜é‡å…·æœ‰å¯è§æ€§ï¼Œå¯ä»¥ç†è§£ä¸ºä»»æ„æ—¶åˆ»å¾—åˆ°çš„éƒ½æ˜¯è¯¥å˜é‡çš„æœ€æ–°å€¼ã€‚<br>åŸå­æ€§ï¼šæŒ‡å¯¹è¯¥å˜é‡çš„æ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ã€‚å³ä½¿æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¸€èµ·æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹å¹²æ‰°ã€‚</p><h4 id="volatile-å®ç°åŸç†"><a href="#volatile-å®ç°åŸç†" class="headerlink" title="volatile å®ç°åŸç†"></a>volatile å®ç°åŸç†</h4><p>volatile ä¿®é¥°çš„å˜é‡åœ¨è¿›è¡Œæ“ä½œæ—¶ï¼Œä¼šåœ¨æ±‡ç¼–ä»£ç ä¸­åŠ ä¸Š <code>Lock</code> å‰ç¼€ï¼Œè¿™å°†å¯¼è‡´ä¸¤ä»¶äº‹æƒ…ï¼š</p><ol><li>æ‰€æœ‰å¤„ç†å™¨ä¸ä¼šåœ¨æœ¬åœ°å†…å­˜ä¸­è®°å½•è¯¥å˜é‡ï¼Œè€Œæ˜¯ç›´æ¥å†™åˆ°å…±äº«å†…å­˜ä¸­ã€‚</li><li>æ‰€æœ‰å¤„ç†å™¨åœ¨è¯»å–è¯¥å˜é‡æ—¶ï¼Œéƒ½ç›´æ¥ä»å…±äº«å†…å­˜ä¸­è¯»å–ã€‚</li></ol><h4 id="ç»“æœåˆ†æ"><a href="#ç»“æœåˆ†æ" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h4><p>æ ¹æ®å®ç°åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼š<strong>å¯¹ volatile å˜é‡çš„è¯»æˆ–å†™éƒ½å¯ä»¥ä¿è¯åŸå­æ€§</strong>ã€‚ä¹Ÿå°±æ˜¯ä¸Šé¢çš„ç¬¬ä¸€æ­¥å’Œç¬¬ä¸‰æ­¥æ˜¯åŸå­æ€§çš„æ“ä½œï¼Œä½†æ˜¯ç¬¬äºŒæ­¥ä¿®æ”¹æ“ä½œæ—¶å´ä¸èƒ½ä¿è¯ã€‚<br>å½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¿®æ”¹æ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»æ‰§è¡Œè¿‡å†™å…¥æ“ä½œäº†ï¼Œæ‰€ä»¥å½“è¯¥çº¿ç¨‹æ‰§è¡Œå†™å…¥æ“ä½œæ—¶ï¼Œå°±è¦†ç›–äº†å‰é¢çš„å†™å…¥æ“ä½œï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p><h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹ i3ï¼Œå¯ä»¥çœ‹åˆ°å®ƒä½¿ç”¨äº†åŸå­æ›´æ–°æ•´å‹ï¼š<code>AtomicInteger</code>ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œç´¯åŠ æ—¶ï¼Œä½¿ç”¨äº†å®ƒçš„<code>getAndAdd()</code>æ–¹æ³•ã€‚<br>è¿™ä¸ªæ–¹æ³•å…¶å®æœ€ç»ˆè°ƒç”¨äº†<code>Unsafe.compareAndSwapInt()</code>æ–¹æ³•ï¼Œè¿™æ˜¯ä¸ª native æ–¹æ³•ï¼Œä¾èµ– CASï¼ˆCompareAndSwapï¼‰åŸç†å®ç°ã€‚</p><h4 id="CAS-å®ç°åŸç†"><a href="#CAS-å®ç°åŸç†" class="headerlink" title="CAS å®ç°åŸç†"></a>CAS å®ç°åŸç†</h4><p>CAS çš„å®ç°ä½¿ç”¨äº†å¤„ç†å™¨æä¾›çš„ <code>CMPXCHG</code>æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤ä¹Ÿå¸¦æœ‰<code>Lock</code>å‰ç¼€ï¼Œåœ¨è¿›è¡Œ CAS æ“ä½œæ—¶ï¼Œä¼šé”ä½ç›¸åº”çš„å†…å­˜åŒºåŸŸï¼Œå…¶ä»–ä¸èƒ½æ“ä½œç›¸åº”å†…å­˜åŒºåŸŸçš„çº¿ç¨‹åœ¨å¤–é¢å¾ªç¯è¿›è¡Œå°è¯•ï¼Œå®ç°å¤šçº¿ç¨‹åŸå­æ€§ã€‚<br>è¿›è¡Œ CAS æ—¶ï¼Œéœ€è¦å¯¹ä¸‰ä¸ªå€¼è¿›è¡Œæ“ä½œï¼šç°åœ¨çš„å€¼ã€é¢„æœŸçš„å€¼ã€è¦æ›¿æ¢çš„å€¼ã€‚åªæœ‰å½“é¢„æœŸçš„å€¼å’Œå½“å‰å€¼ä¸€è‡´æ—¶ï¼Œæ‰ä¼šè¿›è¡Œä¿®æ”¹ã€‚</p><h4 id="ABAé—®é¢˜"><a href="#ABAé—®é¢˜" class="headerlink" title="ABAé—®é¢˜"></a>ABAé—®é¢˜</h4><p>CAS æ“ä½œå¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼šå˜é‡çš„å€¼åŸæ¥æ˜¯Aï¼Œè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ä¸ºäº†Bï¼Œåæ¥åˆè¢«ä¿®æ”¹å›Aï¼Œå½“è¯¥çº¿ç¨‹è¿›è¡ŒCASæ“ä½œæ—¶ï¼Œå‘ç°é¢„æœŸå€¼ä¸å½“å‰å€¼ä¸€è‡´ï¼Œè¿›è¡Œäº†ä¿®æ”¹ã€‚è€Œå…¶å®å˜é‡å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œè¿™æ ·å°±å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–çš„é—®é¢˜ã€‚JDK1.5å¼€å§‹ï¼Œæä¾›äº†<code>AtomicStampedReference</code>ç±»æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå˜é‡ä¼šåŠ ä¸€ä¸ªç±»ä¼¼ä¹è§‚é”çš„ç‰ˆæœ¬å·ï¼š1A-2B-3Aã€‚è¿™æ ·å°±å¯ä»¥å‡†ç¡®çš„åˆ¤æ–­å˜é‡æ˜¯å¦è¢«ä¿®æ”¹è¿‡äº†ã€‚</p><h4 id="ç»“æœåˆ†æ-1"><a href="#ç»“æœåˆ†æ-1" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h4><p>æ ¹æ®åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥é’ˆå¯¹ i3 çš„æ¯æ¬¡ä¿®æ”¹éƒ½æ˜¯åŸå­æ€§çš„ï¼Œæ²¡å•¥å¥½è¯´çš„ï½<br>synchronized å’Œ ReentrantLock ä¹Ÿä¸å†è¿›è¡Œç»“æœåˆ†æã€‚</p><h4 id="å»¶ä¼¸"><a href="#å»¶ä¼¸" class="headerlink" title="å»¶ä¼¸"></a>å»¶ä¼¸</h4><p>volatile å’Œ CAS åœ¨ Java ä¸­ä¸¾è¶³è½»é‡ã€‚å€Ÿä¸€å¼ å›¾è¡¨ç¤º Java concurrent åŒ…çš„å®ç°ã€‚</p><img src="/2018/11/24/volatileã€CASã€synchronizedã€ReentrantLock-ç®€ä»‹/concurrentåŒ….png" title="concurrent åŒ…å®ç°"><h3 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h3><p>synchronized æ˜¯ Java æä¾›çš„ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨æ¥é”ä½ä¸€ä¸ªå¯¹è±¡ï¼Œè¢«é”çš„å¯¹è±¡ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼ˆåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŠ å¤šä¸ªé”è¿›è¡Œé‡å¤è®¿é—®ï¼‰ã€‚<br>synchronized ä¿®é¥°ä¸åŒçš„åœ°æ–¹ï¼ŒåŠ çš„é”çš„ç±»å‹ä¹Ÿä¸ä¸€æ ·ï¼š</p><ol><li>ä¿®é¥°éé™æ€æ–¹æ³•ï¼Œé”çš„æ˜¯è¯¥æ–¹æ³•æ‰€åœ¨çš„å®ä¾‹å¯¹è±¡ã€‚</li><li>ä¿®é¥°é™æ€æ–¹æ³•ï¼Œé”çš„æ˜¯è¯¥ç±»çš„ç±»å¯¹è±¡ã€‚</li><li>ä¿®é¥°ä»£ç å—æ—¶ï¼Œé”çš„æ˜¯æ‰€æŒ‡å®šçš„å¯¹è±¡ã€‚</li></ol><h4 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><p>ä»»ä½•ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ª monitor ä¸ä¹‹å…³è”ï¼Œå½“ monitor è¢«æŒæœ‰åï¼Œå®ƒå°±å°†å¤„äºé”å®šçŠ¶æ€ã€‚synchronized å°±æ˜¯é€šè¿‡è·å–å’Œé‡Šæ”¾ monitor å®ç°çš„ã€‚</p><img src="/2018/11/24/volatileã€CASã€synchronizedã€ReentrantLock-ç®€ä»‹/synchronized.png" title="synchronizedï¼ˆé‡é‡çº§é”ï¼‰åŸç†"><h4 id="é”çŠ¶æ€"><a href="#é”çŠ¶æ€" class="headerlink" title="é”çŠ¶æ€"></a>é”çŠ¶æ€</h4><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œä¸ºäº†è®©çº¿ç¨‹è·å¾—é”çš„ä»£ä»·æ›´ä½ï¼ŒJava6 å¼€å§‹ï¼Œå¼•å…¥äº†<code>åå‘é”</code>å’Œ<code>è½»é‡çº§</code>é”çš„æ¦‚å¿µã€‚</p><h5 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h5><p>è·å–åˆ°é”åï¼Œé”é»˜è®¤å¤„äº<code>åå‘é”</code>çŠ¶æ€ï¼Œåœ¨é”å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­å‚¨å­˜ä¸€ä¸ªçº¿ç¨‹IDï¼Œå½“ä¸‹æ¬¡è¯¥çº¿ç¨‹å°è¯•è·å–è¯¥é”æ—¶ï¼Œä¸éœ€è¦è¿›è¡Œå¾ªç¯CASå–é”ï¼Œåªéœ€è¦æ£€æµ‹åå‘é”çš„çº¿ç¨‹IDæ˜¯å¦ä¸ä¹‹ä¸€è‡´å³å¯ã€‚<br>å½“å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªé”ç«äº‰æ¿€çƒˆæ—¶ï¼Œåå‘é”ä¼šå‡çº§ä¸º<code>è½»é‡çº§é”</code>ã€‚</p><h5 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h5><p>åŠ é”ï¼š<br>çº¿ç¨‹åœ¨æ‰§è¡ŒåŒæ­¥å—ä¹‹å‰ï¼ŒJVMä¼šå…ˆåœ¨å½“å‰çº¿ç¨‹çš„æ ˆæ¡¢ä¸­åˆ›å»ºç”¨äºå­˜å‚¨é”è®°å½•çš„ç©ºé—´ï¼Œå¹¶å°†å¯¹è±¡å¤´ä¸­çš„ Mark Word å¤åˆ¶åˆ°é”è®°å½•ä¸­ï¼Œå®˜æ–¹ç§°ä¸º Displaced Mark Wordã€‚<br>ç„¶åçº¿ç¨‹å°è¯•ä½¿ç”¨CASå°†å¯¹è±¡å¤´ä¸­çš„Mark Wordæ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚å¦‚æœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹è·å¾—é”ï¼Œå¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹ç«äº‰é”ï¼Œå½“å‰çº¿ç¨‹ä¾¿å°è¯•ä½¿ç”¨è‡ªæ—‹æ¥è·å–é”ã€‚<br>è§£é”ï¼š<br>è½»é‡çº§è§£é”æ—¶ï¼Œä¼šä½¿ç”¨åŸå­çš„CASæ“ä½œå°†Displaced Mark Wordæ›¿æ¢å›åˆ°å¯¹è±¡å¤´ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰ç«äº‰å‘ç”Ÿã€‚å¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå½“å‰é”å­˜åœ¨ç«äº‰ï¼Œé”å°±ä¼šè†¨èƒ€æˆé‡é‡çº§é”ã€‚</p><p>è½»é‡çº§é”èƒ½æé«˜ç¨‹åºåŒæ­¥æ€§èƒ½çš„ä¾æ®æ˜¯â€œå¯¹äºç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½æ˜¯ä¸å­˜åœ¨ç«äº‰çš„â€ï¼Œè¿™æ˜¯ä¸€ä¸ªç»éªŒæ•°æ®ã€‚å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œè½»é‡çº§é”ä½¿ç”¨CASæ“ä½œé¿å…äº†ä½¿ç”¨äº’æ–¥é‡çš„å¼€é”€ï¼Œ<br>ä½†å¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œé™¤äº†äº’æ–¥é‡çš„å¼€é”€å¤–ï¼Œè¿˜é¢å¤–å‘ç”Ÿäº†CASæ“ä½œï¼Œå› æ­¤åœ¨æœ‰ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè½»é‡çº§é”ä¼šæ¯”ä¼ ç»Ÿçš„é‡é‡çº§é”æ›´æ…¢ã€‚</p><h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p>ReentrantLock å®ç°äº† Lock æ¥å£ï¼Œä¹Ÿæ˜¯ JDK ä¸­è¯¥æ¥å£çš„å”¯ä¸€å®ç°ã€‚Lock æ¥å£æ˜¯åœ¨Java5æ–°å¢çš„ï¼Œæä¾›äº†ä¸ synchronized ç›¸ä¼¼çš„åŠŸèƒ½ã€‚</p><h4 id="ä¸-synchronized-çš„åŒºåˆ«"><a href="#ä¸-synchronized-çš„åŒºåˆ«" class="headerlink" title="ä¸ synchronized çš„åŒºåˆ«"></a>ä¸ synchronized çš„åŒºåˆ«</h4><ol><li><code>ReentrantLock</code>å¯ä»¥æ˜¾ç¤ºçš„è¿›è¡ŒåŠ é”å’Œè§£é”ã€‚</li><li><code>ReentrantLock</code>å¯ä¸­æ–­çš„è·å–é”ã€‚</li><li><code>ReentrantLock</code>å¯ä»¥æä¾›å…¬å¹³é”ã€‚</li><li><code>ReentrantLock</code>å¯ä»¥æä¾›è¶…æ—¶ç­‰å¾…æœºåˆ¶ã€‚</li></ol><h4 id="å®ç°åŸç†-1"><a href="#å®ç°åŸç†-1" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><p>ReentrantLock çš„å®ç°ä¾èµ–äº AbstractQueueSynchronizer(AQS),å®ƒæ˜¯å®ç°é”æˆ–å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ã€‚<br>AQS å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒæ­¥çŠ¶æ€å˜é‡å’Œä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œè·å–åˆ°è¯¥åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹è§†ä¸ºè·å–åˆ°é”ï¼›è·å–å¤±è´¥çš„çº¿ç¨‹è¿åŒå®ƒçš„ç­‰å¾…çŠ¶æ€ä¿¡æ¯ä¼šè¢«æ„é€ æˆåŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶é˜»å¡å®ƒã€‚<br>å½“åŒæ­¥çŠ¶æ€è¢«é‡Šæ”¾æ—¶ï¼ŒåŒæ­¥é˜Ÿåˆ—ä¸­çš„é¦–èŠ‚ç‚¹ä¼šè¢«å”¤é†’å°è¯•å»è·å–åŒæ­¥çŠ¶æ€ã€‚</p><h4 id="è¯»å†™é”"><a href="#è¯»å†™é”" class="headerlink" title="è¯»å†™é”"></a>è¯»å†™é”</h4><p>å¦‚æœä¸€æ®µä»£ç ä¸­å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨æ‰§è¡Œè¯»æ“ä½œï¼Œå¤šä¸ªè¯»æ“ä½œåŒæ—¶è¿›è¡Œä¸ä¼šå½±å“çº¿ç¨‹å®‰å…¨æ€§ï¼Œè¿™æ—¶å‰é¢æåˆ°çš„ç‹¬å é”æ˜æ˜¾ä¼šå½±å“å¤šçº¿ç¨‹çš„è¯»å–æ€§èƒ½ã€‚<br><code>ReentrantReadWriteLock</code>æ˜¯ä¸€ä¸ªè¯»å†™é”ï¼Œå¤šä¸ªè·å–äº†è¯»é”ä¹‹é—´çš„çº¿ç¨‹å¯ä»¥åŒæ­¥æ‰§è¡Œï¼›è€Œå†™é”ä¸å¯ä»¥å’Œè¯»/å†™é”åŒæ­¥æ‰§è¡Œã€‚<br>è¯»å†™é”é”é™çº§ï¼šä¸€ä¸ªçº¿ç¨‹åœ¨è·å–äº†å†™é”åï¼Œæœ‰è·å–äº†è¯»é”ï¼Œåœ¨é‡Šæ”¾å†™é”åï¼Œå°±å˜æˆäº†åªè·å–äº†è¯»é”ï¼Œå³é”é™çº§ã€‚</p><h4 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h4><p>ReentrantLock ä½¿ç”¨ Condition çš„ <code>await()</code>ã€<code>signal()</code>ã€<code>signalAll()</code>æ–¹æ³•åˆ†åˆ«ä»£æ›¿ Object çš„<code>wait()</code>ã€<code>notify()</code>ã€<code>notifyAll()</code> æ–¹æ³•ã€‚</p><h3 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h3><p>ä»¥ä¸Šæ˜¯å…³äºè¿™å››è€…çš„ç®€å•ä»‹ç»ï¼Œä¸ºäº†åé¢çš„ç³»åˆ—å†…å®¹åšä¸‹é“ºå«ï¼Œæƒ³è¦äº†è§£è¯¦æƒ…å¯ä»¥å‚è€ƒæ›´å¤šä¹¦ç±ã€èµ„æ–™ã€‚</p><hr><img src="/2018/11/24/volatileã€CASã€synchronizedã€ReentrantLock-ç®€ä»‹/img-6806f.gif">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š10åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h3&gt;&lt;p&gt;volatileã€CASã€synchronizedã€ReentrantLock éƒ½æ˜¯
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å¤šçº¿ç¨‹" scheme="https://jasonsonghoho.github.io/public/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="volatile" scheme="https://jasonsonghoho.github.io/public/tags/volatile/"/>
    
      <category term="CAS" scheme="https://jasonsonghoho.github.io/public/tags/CAS/"/>
    
      <category term="synchronized" scheme="https://jasonsonghoho.github.io/public/tags/synchronized/"/>
    
      <category term="ReentrantLock" scheme="https://jasonsonghoho.github.io/public/tags/ReentrantLock/"/>
    
  </entry>
  
  <entry>
    <title>Java8 ArrayList æºç è§£è¯»</title>
    <link href="https://jasonsonghoho.github.io/2018/11/12/Java-ArrayList-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    <id>https://jasonsonghoho.github.io/2018/11/12/Java-ArrayList-æºç è§£è¯»/</id>
    <published>2018-11-12T13:07:33.000Z</published>
    <updated>2018-11-15T12:31:07.331Z</updated>
    
    <content type="html"><![CDATA[<p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š10åˆ†é’Ÿ</em></p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>ArrayList æ˜¯æ—¥å¸¸å¼€å‘ä¸­å¾ˆå¸¸è§çš„é›†åˆç±»å‹ï¼Œåœ¨ Java é›†åˆä¸­ç›¸å¯¹å®¹æ˜“é˜…è¯»ã€‚å®ƒæ˜¯åŸºäºæ•°ç»„å®ç°çš„ä¸€ç§åˆ—è¡¨ï¼Œè¯»å–ã€ä¿®æ”¹çš„æ—¶é—´å¤æ‚åº¦å¾ˆå°ï¼ˆO(1)ï¼‰, æ’å…¥ã€remove æ—¶æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚ArrayList å¯ä»¥å­˜æ”¾ null å€¼ï¼Œåˆ—è¡¨æ¸…ç©ºå°±æ˜¯é€šè¿‡æŠŠæ‰€æœ‰çš„å…ƒç´ ç½®ä¸º null å®ç°çš„ã€‚</p><h3 id="Arrays-copyOf-å’Œ-System-arraycopy"><a href="#Arrays-copyOf-å’Œ-System-arraycopy" class="headerlink" title="Arrays.copyOf() å’Œ System.arraycopy()"></a>Arrays.copyOf() å’Œ System.arraycopy()</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸‹ä»£ç é‡Œåå¤å‡ºç°çš„ä¸¤ä¸ªæ–¹æ³•ï¼šArrays.copyOf() å’Œ System.arraycopy()ã€‚å…¶å® <code>public static &lt;T&gt; T[] copyOf(T[] original, int newLength)</code> æ˜¯é€šè¿‡è°ƒç”¨åè€…å®ç°çš„ï¼Œè¾“å…¥å¾…æ‹·è´çš„æ•°ç»„å’Œè¦è¿”å›æ•°ç»„çš„é•¿åº¦ï¼Œæ‹·è´å‡ºä¸€ä¸ªæ–°çš„æ•°ç»„ã€‚è€Œ<code>public static native void arraycopy(Object src,  int  srcPos, Object dest, int destPos,int length)</code>æ˜¯çœŸæ­£æ‰§è¡Œæ‹·è´çš„æ–¹æ³•ã€‚å®ƒæ˜¯ä¸ª native æ–¹æ³•ï¼Œäº”ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨ å¾…æ‹·è´æ•°ç»„ã€å¾…æ‹·è´æ•°ç»„çš„èµ·å§‹ä½ç½®ã€ç›®æ ‡æ•°ç»„ã€ç›®æ ‡æ•°ç»„çš„æ’å…¥ä½ç½®ã€æ‹·è´çš„é•¿åº¦ã€‚æ¯æ¬¡æ‹·è´éƒ½æ˜¯å…¨é‡æ‹·è´ï¼Œå› æ­¤å®¹é‡å˜åŒ–çš„æ“ä½œè¾ƒå¤šæ—¶ï¼Œä¼šå¯¹å®ƒé€ æˆæ€§èƒ½å½±å“ã€‚</p><h3 id="RandomAccess"><a href="#RandomAccess" class="headerlink" title="RandomAccess"></a>RandomAccess</h3><p>ArrayList å®ç°äº† RandomAccess æ¥å£è¡¨ç¤ºæ”¯æŒå¿«é€Ÿéšæœºè®¿é—®ï¼Œå°†ä½¿ç”¨ for å¾ªç¯æŸ¥æ‰¾å…ƒç´ ã€‚å¦‚æœæ²¡æœ‰å®ç°è¯¥æ¥å£ï¼ˆå¦‚ LinkedListï¼‰ï¼Œåœ¨æŸ¥æ‰¾æ—¶ï¼Œåªèƒ½é€šè¿‡ è¿­ä»£å™¨ è¿›è¡ŒæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾é€Ÿåº¦è¦ä½äºå‰è€…ã€‚</p><p>Java doc ä¸­å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* &lt;pre&gt;</span><br><span class="line">*     for (int i=0, n=list.size(); i &amp;lt; n; i++)</span><br><span class="line">*         list.get(i);</span><br><span class="line">* &lt;/pre&gt;</span><br><span class="line">* runs faster than this loop:</span><br><span class="line">* &lt;pre&gt;</span><br><span class="line">*     for (Iterator i=list.iterator(); i.hasNext(); )</span><br><span class="line">*         i.next();</span><br><span class="line">* &lt;/pre&gt;</span><br></pre></td></tr></table></figure></p><h3 id="â­æ³¨é‡Šç‰ˆæºç â­"><a href="#â­æ³¨é‡Šç‰ˆæºç â­" class="headerlink" title="â­æ³¨é‡Šç‰ˆæºç â­"></a>â­æ³¨é‡Šç‰ˆæºç â­</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ArrayList&lt;E&gt; extends AbstractList&lt;E&gt;</span><br><span class="line">        implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable &#123;</span><br><span class="line">    private static final long serialVersionUID = 8683452581122892189L;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * é»˜è®¤çš„åˆå§‹åŒ–å®¹é‡ï¼š10</span><br><span class="line">     */</span><br><span class="line">    private static final int DEFAULT_CAPACITY = 10;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Object[]ï¼Œç”¨æ¥å­˜å‚¨åˆ—è¡¨å…ƒç´ </span><br><span class="line">     */</span><br><span class="line">    transient Object[] elementData; // non-private to simplify nested class access</span><br><span class="line">    /**</span><br><span class="line">     * æŒ‰é»˜è®¤å®¹é‡åˆ›å»ºçš„ç©ºåˆ—è¡¨å…±äº«çš„å­˜å‚¨å¯¹è±¡</span><br><span class="line">     */</span><br><span class="line">    private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line">    /**</span><br><span class="line">     * æŒ‡å®šå®¹é‡åˆ›å»ºçš„ç©ºåˆ—è¡¨å…±äº«çš„å­˜å‚¨å¯¹è±¡</span><br><span class="line">     */</span><br><span class="line">    private static final Object[]</span><br><span class="line">            EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line">    /**</span><br><span class="line">     * åˆ—è¡¨ä¸­å…ƒç´ æ•°é‡</span><br><span class="line">     */</span><br><span class="line">    private int size;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ„é€ å‡½æ•°ï¼ŒæŒ‡å®šå®¹é‡å¤§å°</span><br><span class="line">     */</span><br><span class="line">    public ArrayList(int initialCapacity) &#123;</span><br><span class="line">        if (initialCapacity &gt; 0) &#123;</span><br><span class="line">            this.elementData = new Object[initialCapacity];</span><br><span class="line">        &#125; else if (initialCapacity == 0) &#123;</span><br><span class="line">            //å¦‚æœæŒ‡å®šå®¹é‡ä¸º0ï¼Œä½¿ç”¨ EMPTY_ELEMENTDATA</span><br><span class="line">            this.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Illegal Capacity: &quot;+</span><br><span class="line">                    initialCapacity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ— å‚æ„é€ å‡½æ•°</span><br><span class="line">     */</span><br><span class="line">    public ArrayList() &#123;</span><br><span class="line">        //ä½¿ç”¨ DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><br><span class="line">        this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ„é€ å‡½æ•°ï¼Œå…¥å‚ä¸ºä¸€ä¸ªé›†åˆç±»å‹</span><br><span class="line">     */</span><br><span class="line">    public ArrayList(Collection&lt;? extends E&gt; c) &#123;</span><br><span class="line">        //è°ƒç”¨ Collection çš„ toArray() æ–¹æ³•ï¼Œè½¬æ¢ä¸º Object[]</span><br><span class="line">        elementData = c.toArray();</span><br><span class="line">        if ((size = elementData.length) != 0) &#123;</span><br><span class="line">            // c.toArray æ–¹æ³•å¯èƒ½ä¼šè½¬æ¢å‡ºé”™ï¼Œå¯¼è‡´ç”Ÿæˆ Object[] å¤±è´¥</span><br><span class="line">            if (elementData.getClass() != Object[].class)</span><br><span class="line">                elementData = Arrays.copyOf(elementData, size, Object[].class);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // replace with empty array.</span><br><span class="line">            this.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æŒ‰å®é™…å…ƒç´ æ•°é‡é‡æ–°ç”³è¯·å­˜å‚¨ç©ºé—´ä»¥å‡å°‘å†…å­˜ä½¿ç”¨</span><br><span class="line">     */</span><br><span class="line">    public void trimToSize() &#123;</span><br><span class="line">        //ä¿®æ”¹æ¬¡æ•°ã€‚è®°å½•è¯¥ ArrayList å¯¹è±¡ä¿®æ”¹æ¬¡æ•°ï¼Œé˜²æ­¢å¹¶å‘æ‰§è¡Œä¿®æ”¹æ“ä½œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</span><br><span class="line">        modCount++;</span><br><span class="line">        if (size &lt; elementData.length) &#123;</span><br><span class="line">            elementData = (size == 0)</span><br><span class="line">                    ? EMPTY_ELEMENTDATA</span><br><span class="line">                    : Arrays.copyOf(elementData, size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ç¡®ä¿å®¹é‡è¶³å¤Ÿï¼Œå¦‚æœå®¹é‡ä¸å¤Ÿå°±æ‰©å®¹</span><br><span class="line">     */</span><br><span class="line">    public void ensureCapacity(int minCapacity) &#123;</span><br><span class="line">        //å¦‚æœæ˜¯æŒ‰é»˜è®¤å®¹é‡åˆ›å»ºçš„ç©º ArrayList,åˆ™å½“æŒ‡å®šçš„å®¹é‡è¶…è¿‡10æ—¶ï¼Œæ‰ä¼šæ‰©å®¹</span><br><span class="line">        int minExpand = (elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA)</span><br><span class="line">                // any size if not default element table</span><br><span class="line">                ? 0</span><br><span class="line">                // larger than default for default empty table. It&apos;s already supposed to be at default size.</span><br><span class="line">                : DEFAULT_CAPACITY;</span><br><span class="line"></span><br><span class="line">        if (minCapacity &gt; minExpand) &#123;</span><br><span class="line">            ensureExplicitCapacity(minCapacity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //è®¡ç®—æœ€å°å®¹é‡</span><br><span class="line">    private static int calculateCapacity(Object[] elementData, int minCapacity) &#123;</span><br><span class="line">        if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class="line">            return Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">        &#125;</span><br><span class="line">        return minCapacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //è®¡ç®—å‡ºéœ€è¦æ‰©å®¹çš„æœ€å°å®¹é‡ç„¶åç¡®ä¿å¢åŠ åˆ°è¯¥å®¹é‡</span><br><span class="line">    private void ensureCapacityInternal(int minCapacity) &#123;</span><br><span class="line">        ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //ç¡®ä¿å¢åŠ åˆ°æŒ‡å®šçš„å®¹é‡</span><br><span class="line">    private void ensureExplicitCapacity(int minCapacity) &#123;</span><br><span class="line">        modCount++;</span><br><span class="line"></span><br><span class="line">        // overflow-conscious code</span><br><span class="line">        if (minCapacity - elementData.length &gt; 0)</span><br><span class="line">            grow(minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å…ƒç´ æœ€å¤§æ•°é‡ã€‚å› ä¸ºæœ‰çš„è™šæ‹Ÿæœºé¢„ç•™äº†ç”¨äºä¿å­˜æ•°ç»„å¯¹è±¡å¤§å°ç­‰ä¿¡æ¯çš„å…ƒæ•°æ®ï¼Œæ•…å‡å»äº†8ä½ã€‚</span><br><span class="line">     */</span><br><span class="line">    private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å®é™…æ‰§è¡Œ æ‰©å®¹æ–¹æ³•</span><br><span class="line">     */</span><br><span class="line">    private void grow(int minCapacity) &#123;</span><br><span class="line">        // overflow-conscious code</span><br><span class="line">        int oldCapacity = elementData.length;</span><br><span class="line">        //æ‰©å®¹åˆ°åŸæ¥çš„ 1.5å€</span><br><span class="line">        int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1);</span><br><span class="line">        //å¦‚æœæ‰©å®¹åä»å°äºè¦æœ€å°å®¹é‡åˆ™ç›´æ¥å–æœ€å°å®¹é‡ä½œä¸ºæ–°çš„å®¹é‡</span><br><span class="line">        if (newCapacity - minCapacity &lt; 0)</span><br><span class="line">            newCapacity = minCapacity;</span><br><span class="line">        //å¦‚æœæ‰©å®¹åå¤§äºæœ€å¤§å…è®¸çš„å®¹é‡ï¼Œåˆ™æ‰§è¡Œ hugeCapacity</span><br><span class="line">        if (newCapacity - MAX_ARRAY_SIZE &gt; 0)</span><br><span class="line">            newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">        // minCapacity is usually close to size, so this is a win:</span><br><span class="line">        elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ±‚æ‰©å®¹å®¹é‡ï¼Œå¦‚æœå®é™…æŒ‡å®šçš„æœ€å°å®¹é‡è¶…è¿‡ MAX_ARRAY_SIZE ï¼Œ</span><br><span class="line">     * åˆ™å– Integer.MAX_VALUEã€‚å¦åˆ™å– MAX_ARRAY_SIZEã€‚</span><br><span class="line">     */</span><br><span class="line">    private static int hugeCapacity(int minCapacity) &#123;</span><br><span class="line">        if (minCapacity &lt; 0) // overflow</span><br><span class="line">            throw new OutOfMemoryError();</span><br><span class="line">        return (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">                Integer.MAX_VALUE :</span><br><span class="line">                MAX_ARRAY_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è¿”å›å®é™…å…ƒç´ ä¸ªæ•°</span><br><span class="line">     */</span><br><span class="line">    public int size() &#123;</span><br><span class="line">        return size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ˜¯å¦ä¸ºç©º</span><br><span class="line">     */</span><br><span class="line">    public boolean isEmpty() &#123;</span><br><span class="line">        return size == 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ˜¯å¦åŒ…å«ä¸€ä¸ªå…ƒç´ </span><br><span class="line">     */</span><br><span class="line">    public boolean contains(Object o) &#123;</span><br><span class="line">        return indexOf(o) &gt;= 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ±‚æŒ‡å®šå…ƒç´ é¦–æ¬¡å‡ºç°çš„ä¸‹æ ‡ã€‚-1 è¡¨ç¤ºä¸å­˜åœ¨</span><br><span class="line">     */</span><br><span class="line">    public int indexOf(Object o) &#123;</span><br><span class="line">        //å•ç‹¬è€ƒè™‘æ‰€æŸ¥å…ƒç´ ä¸º null æ—¶çš„æƒ…å†µ</span><br><span class="line">        if (o == null) &#123;</span><br><span class="line">            for (int i = 0; i &lt; size; i++)</span><br><span class="line">                if (elementData[i]==null)</span><br><span class="line">                    return i;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            for (int i = 0; i &lt; size; i++)</span><br><span class="line">                if (o.equals(elementData[i]))</span><br><span class="line">                    return i;</span><br><span class="line">        &#125;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æŒ‡å®šå…ƒç´ æœ€åä¸€æ¬¡å‡ºç°çš„ä¸‹æ ‡ã€‚é ä»åé¢éå†æ¥å®ç°çš„ã€‚</span><br><span class="line">     */</span><br><span class="line">    public int lastIndexOf(Object o) &#123;</span><br><span class="line">        if (o == null) &#123;</span><br><span class="line">            for (int i = size-1; i &gt;= 0; i--)</span><br><span class="line">                if (elementData[i]==null)</span><br><span class="line">                    return i;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            for (int i = size-1; i &gt;= 0; i--)</span><br><span class="line">                if (o.equals(elementData[i]))</span><br><span class="line">                    return i;</span><br><span class="line">        &#125;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æµ…æ‹·è´ï¼Œåªæ‹·è´ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå…ƒç´ æœªæ‹·è´ã€‚</span><br><span class="line">     */</span><br><span class="line">    public Object clone() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ArrayList&lt;?&gt; v = (ArrayList&lt;?&gt;) super.clone();</span><br><span class="line">            v.elementData = Arrays.copyOf(elementData, size);</span><br><span class="line">            v.modCount = 0;</span><br><span class="line">            return v;</span><br><span class="line">        &#125; catch (CloneNotSupportedException e) &#123;</span><br><span class="line">            // this shouldn&apos;t happen, since we are Cloneable</span><br><span class="line">            throw new InternalError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è½¬æ¢ä¸º Object[]</span><br><span class="line">     */</span><br><span class="line">    public Object[] toArray() &#123;</span><br><span class="line">        return Arrays.copyOf(elementData, size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è½¬æ¢ä¸ºæŒ‡å®šç±»å‹æ•°ç»„ã€‚</span><br><span class="line">     * æ³¨æ„ï¼šè‹¥æŒ‡å®šæ•°ç»„ç±»å‹ä¸æ˜¯åˆ—è¡¨å…ƒç´ çš„è¶…ç±»ï¼Œåˆ™ä¼šæŠ¥ ArrayStoreException å¼‚å¸¸ã€‚</span><br><span class="line">     * è‹¥æŒ‡å®šæ•°ç»„ä¸º null ,ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public &lt;T&gt; T[] toArray(T[] a) &#123;</span><br><span class="line">        if (a.length &lt; size)</span><br><span class="line">            // Make a new array of a&apos;s runtime type, but my contents:</span><br><span class="line">            return (T[]) Arrays.copyOf(elementData, size, a.getClass());</span><br><span class="line">        System.arraycopy(elementData, 0, a, 0, size);</span><br><span class="line">        if (a.length &gt; size)</span><br><span class="line">            a[size] = null;</span><br><span class="line">        return a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Positional Access Operations</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    E elementData(int index) &#123;</span><br><span class="line">        return (E) elementData[index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * get</span><br><span class="line">     */</span><br><span class="line">    public E get(int index) &#123;</span><br><span class="line">        //æ£€æµ‹ä¸‹æ ‡æ˜¯å¦è¶Šç•Œ</span><br><span class="line">        rangeCheck(index);</span><br><span class="line"></span><br><span class="line">        return elementData(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * set</span><br><span class="line">     */</span><br><span class="line">    public E set(int index, E element) &#123;</span><br><span class="line">        rangeCheck(index);</span><br><span class="line"></span><br><span class="line">        E oldValue = elementData(index);</span><br><span class="line">        elementData[index] = element;</span><br><span class="line">        return oldValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * add</span><br><span class="line">     */</span><br><span class="line">    public boolean add(E e) &#123;</span><br><span class="line">        //å…ˆåˆ¤æ–­å®¹é‡æ˜¯å¦è¶³å¤Ÿ</span><br><span class="line">        ensureCapacityInternal(size + 1);  // Increments modCount!!</span><br><span class="line">        elementData[size++] = e;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void add(int index, E element) &#123;</span><br><span class="line">        rangeCheckForAdd(index);</span><br><span class="line"></span><br><span class="line">        ensureCapacityInternal(size + 1);  // Increments modCount!!</span><br><span class="line">        System.arraycopy(elementData, index, elementData, index + 1,</span><br><span class="line">                size - index);</span><br><span class="line">        elementData[index] = element;</span><br><span class="line">        size++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®ä¸‹æ ‡åˆ é™¤</span><br><span class="line">     */</span><br><span class="line">    public E remove(int index) &#123;</span><br><span class="line">        rangeCheck(index);</span><br><span class="line"></span><br><span class="line">        modCount++;</span><br><span class="line">        E oldValue = elementData(index);</span><br><span class="line">        //éœ€è¦ç§»åŠ¨çš„å…ƒç´ æ•°é‡</span><br><span class="line">        int numMoved = size - index - 1;</span><br><span class="line">        if (numMoved &gt; 0)</span><br><span class="line">            System.arraycopy(elementData, index+1, elementData, index,</span><br><span class="line">                    numMoved);</span><br><span class="line">        //å°†æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ è®¾ä¸º null,é€šè¿‡GCæœºåˆ¶è‡ªåŠ¨å»å›æ”¶ç©ºé—´</span><br><span class="line">        elementData[--size] = null; // clear to let GC do its work</span><br><span class="line"></span><br><span class="line">        return oldValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ ¹æ®å…ƒç´ åˆ é™¤</span><br><span class="line">     */</span><br><span class="line">    public boolean remove(Object o) &#123;</span><br><span class="line">        if (o == null) &#123;</span><br><span class="line">            for (int index = 0; index &lt; size; index++)</span><br><span class="line">                if (elementData[index] == null) &#123;</span><br><span class="line">                    fastRemove(index);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            for (int index = 0; index &lt; size; index++)</span><br><span class="line">                if (o.equals(elementData[index])) &#123;</span><br><span class="line">                    fastRemove(index);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ä¸ remove(int index) æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯æ²¡æœ‰ä¸‹æ ‡è¶Šç•Œæ£€æŸ¥ã€ä¸è¿”å›æ—§å€¼ã€‚</span><br><span class="line">     * æå‡åˆ é™¤æ€§èƒ½ï¼Œä½œä¸ºç§æœ‰æ–¹æ³•ã€‚</span><br><span class="line">     */</span><br><span class="line">    private void fastRemove(int index) &#123;</span><br><span class="line">        modCount++;</span><br><span class="line">        int numMoved = size - index - 1;</span><br><span class="line">        if (numMoved &gt; 0)</span><br><span class="line">            System.arraycopy(elementData, index+1, elementData, index,</span><br><span class="line">                    numMoved);</span><br><span class="line">        elementData[--size] = null; // clear to let GC do its work</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ‰€æœ‰å…ƒç´ å…¨éƒ¨ç½®ä¸º null</span><br><span class="line">     */</span><br><span class="line">    public void clear() &#123;</span><br><span class="line">        modCount++;</span><br><span class="line"></span><br><span class="line">        // clear to let GC do its work</span><br><span class="line">        for (int i = 0; i &lt; size; i++)</span><br><span class="line">            elementData[i] = null;</span><br><span class="line"></span><br><span class="line">        size = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è¿½åŠ ä¸€ä¸ªé›†åˆçš„å…ƒç´ </span><br><span class="line">     */</span><br><span class="line">    public boolean addAll(Collection&lt;? extends E&gt; c) &#123;</span><br><span class="line">        Object[] a = c.toArray();</span><br><span class="line">        int numNew = a.length;</span><br><span class="line">        ensureCapacityInternal(size + numNew);  // Increments modCount</span><br><span class="line">        System.arraycopy(a, 0, elementData, size, numNew);</span><br><span class="line">        size += numNew;</span><br><span class="line">        return numNew != 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ’å…¥ä¸€ä¸ªé›†åˆçš„å…ƒç´ </span><br><span class="line">     */</span><br><span class="line">    public boolean addAll(int index, Collection&lt;? extends E&gt; c) &#123;</span><br><span class="line">        rangeCheckForAdd(index);</span><br><span class="line"></span><br><span class="line">        Object[] a = c.toArray();</span><br><span class="line">        int numNew = a.length;</span><br><span class="line">        ensureCapacityInternal(size + numNew);  // Increments modCount</span><br><span class="line"></span><br><span class="line">        int numMoved = size - index;</span><br><span class="line">        if (numMoved &gt; 0)</span><br><span class="line">            System.arraycopy(elementData, index, elementData, index + numNew,</span><br><span class="line">                    numMoved);</span><br><span class="line"></span><br><span class="line">        System.arraycopy(a, 0, elementData, index, numNew);</span><br><span class="line">        size += numNew;</span><br><span class="line">        return numNew != 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * åˆ é™¤æŒ‡å®šä¸‹æ ‡èŒƒå›´çš„å…ƒç´ </span><br><span class="line">     */</span><br><span class="line">    protected void removeRange(int fromIndex, int toIndex) &#123;</span><br><span class="line">        modCount++;</span><br><span class="line">        int numMoved = size - toIndex;</span><br><span class="line">        System.arraycopy(elementData, toIndex, elementData, fromIndex,</span><br><span class="line">                numMoved);</span><br><span class="line"></span><br><span class="line">        // clear to let GC do its work</span><br><span class="line">        int newSize = size - (toIndex-fromIndex);</span><br><span class="line">        for (int i = newSize; i &lt; size; i++) &#123;</span><br><span class="line">            elementData[i] = null;</span><br><span class="line">        &#125;</span><br><span class="line">        size = newSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ£€æµ‹ä¸‹æ ‡æ˜¯å¦è¶Šç•Œ</span><br><span class="line">     */</span><br><span class="line">    private void rangeCheck(int index) &#123;</span><br><span class="line">        if (index &gt;= size)</span><br><span class="line">            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * add å’Œ addAll æ–¹æ³•ä¸­ æ£€æµ‹ä¸‹æ ‡æ˜¯å¦è¶Šç•Œã€‚</span><br><span class="line">     */</span><br><span class="line">    private void rangeCheckForAdd(int index) &#123;</span><br><span class="line">        if (index &gt; size || index &lt; 0)</span><br><span class="line">            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String outOfBoundsMsg(int index) &#123;</span><br><span class="line">        return &quot;Index: &quot;+index+&quot;, Size: &quot;+size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * åˆ é™¤åœ¨é›†åˆä¸­å‡ºç°çš„å…ƒç´ </span><br><span class="line">     * å¯èƒ½ä¼šæŠ¥ ClassCastException å’Œ ç©ºæŒ‡é’ˆå¼‚å¸¸</span><br><span class="line">     */</span><br><span class="line">    public boolean removeAll(Collection&lt;?&gt; c) &#123;</span><br><span class="line">        Objects.requireNonNull(c);</span><br><span class="line">        return batchRemove(c, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ä¿ç•™åœ¨é›†åˆä¸­å­˜åœ¨çš„å…ƒç´ </span><br><span class="line">     * å¯èƒ½ä¼šæŠ¥ ClassCastException å’Œ ç©ºæŒ‡é’ˆå¼‚å¸¸</span><br><span class="line">     */</span><br><span class="line">    public boolean retainAll(Collection&lt;?&gt; c) &#123;</span><br><span class="line">        Objects.requireNonNull(c);</span><br><span class="line">        return batchRemove(c, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean batchRemove(Collection&lt;?&gt; c, boolean complement) &#123;</span><br><span class="line">        final Object[] elementData = this.elementData;</span><br><span class="line">        int r = 0, w = 0;</span><br><span class="line">        boolean modified = false;</span><br><span class="line">        try &#123;</span><br><span class="line">            //éå†åˆ—è¡¨ï¼Œæ ¹æ® complementï¼Œé€‰æ‹©æ˜¯å¦ä¿ç•™å…ƒç´ </span><br><span class="line">            for (; r &lt; size; r++)</span><br><span class="line">                if (c.contains(elementData[r]) == complement)</span><br><span class="line">                    elementData[w++] = elementData[r];</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            //å¦‚æœéå†è¿‡ç¨‹ä¸­æŠ¥é”™äº†ï¼Œå°†å‰©ä½™æœªéå†çš„å…ƒç´ è¿½åŠ åˆ°ä¸å®Œæ•´çš„æ–°åˆ—è¡¨çš„åé¢</span><br><span class="line">            if (r != size) &#123;</span><br><span class="line">                System.arraycopy(elementData, r,</span><br><span class="line">                        elementData, w,</span><br><span class="line">                        size - r);</span><br><span class="line">                w += size - r;</span><br><span class="line">            &#125;</span><br><span class="line">            //å¦‚æœåˆ—è¡¨æœ‰è¢«ä¿®æ”¹ï¼Œåˆ™å°†æ— æ•ˆå­˜å‚¨ä½ç½®ç½®ä¸º null</span><br><span class="line">            if (w != size) &#123;</span><br><span class="line">                // clear to let GC do its work</span><br><span class="line">                for (int i = w; i &lt; size; i++)</span><br><span class="line">                    elementData[i] = null;</span><br><span class="line">                modCount += size - w;</span><br><span class="line">                size = w;</span><br><span class="line">                modified = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //è¿”å›æ˜¯å¦åšäº†ä¿®æ”¹</span><br><span class="line">        return modified;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å¯¹è±¡åºåˆ—åŒ–å‡½æ•°</span><br><span class="line">     */</span><br><span class="line">    private void writeObject(java.io.ObjectOutputStream s)</span><br><span class="line">            throws java.io.IOException&#123;</span><br><span class="line">        // Write out element count, and any hidden stuff</span><br><span class="line">        int expectedModCount = modCount;</span><br><span class="line">        //æ‰§è¡Œé»˜è®¤çš„åºåˆ—åŒ–å‡½æ•°ï¼Œå°†é™¤ elementData[] å¤–çš„å±æ€§åºåˆ—åŒ–</span><br><span class="line">        s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">        // Write out size as capacity for behavioural compatibility with clone()</span><br><span class="line">        // å†™å…¥ size</span><br><span class="line">        s.writeInt(size);</span><br><span class="line"></span><br><span class="line">        // Write out all elements in the proper order.</span><br><span class="line">        // å°† elementData[] ä¸­çš„å…ƒç´ åºåˆ—åŒ–è¿›å»</span><br><span class="line">        for (int i=0; i&lt;size; i++) &#123;</span><br><span class="line">            s.writeObject(elementData[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        //åºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯¹è±¡è¢«ä¿®æ”¹ï¼Œåˆ™æŠ¥ ConcurrentModificationException å¼‚å¸¸</span><br><span class="line">        if (modCount != expectedModCount) &#123;</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ååºåˆ—åŒ–å‡½æ•°</span><br><span class="line">     */</span><br><span class="line">    private void readObject(java.io.ObjectInputStream s)</span><br><span class="line">            throws java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        elementData = EMPTY_ELEMENTDATA;</span><br><span class="line"></span><br><span class="line">        // Read in size, and any hidden stuff</span><br><span class="line">        // ååºåˆ—åŒ–å‡ºé™¤ elementData[] å¤–çš„å±æ€§</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        // Read in capacity</span><br><span class="line">        // è¯»å‡º size ,å¯å¿½ç•¥</span><br><span class="line">        s.readInt(); // ignored</span><br><span class="line"></span><br><span class="line">        if (size &gt; 0) &#123;</span><br><span class="line">            // be like clone(), allocate array based upon size not capacity</span><br><span class="line">            // è®¡ç®—å‡ºå®é™…å®¹é‡</span><br><span class="line">            int capacity = calculateCapacity(elementData, size);</span><br><span class="line">            // æ£€æŸ¥æ˜¯å¦è½¬æ¢ä¸ºæ•°ç»„ç±»å‹ï¼Œå®¹é‡æ˜¯å¦å°äº0ã€‚æ­¤å¤„å®é™…ä¸Šä¸éœ€è¦ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</span><br><span class="line">            SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, capacity);</span><br><span class="line">            ensureCapacityInternal(size);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            Object[] a = elementData;</span><br><span class="line">            // Read in all elements in the proper order.</span><br><span class="line">            // æ‰§è¡Œååºåˆ—åŒ–</span><br><span class="line">            for (int i=0; i&lt;size; i++) &#123;</span><br><span class="line">                a[i] = s.readObject();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ ListIterator</span><br><span class="line">     */</span><br><span class="line">    public ListIterator&lt;E&gt; listIterator() &#123;</span><br><span class="line">        return new ListItr(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ ListIteratorï¼ŒæŒ‡å®šåˆå§‹è¿­ä»£ä½ç½®</span><br><span class="line">     */</span><br><span class="line">    public ListIterator&lt;E&gt; listIterator(int index) &#123;</span><br><span class="line">        if (index &lt; 0 || index &gt; size)</span><br><span class="line">            throw new IndexOutOfBoundsException(&quot;Index: &quot;+index);</span><br><span class="line">        return new ListItr(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ Iterator</span><br><span class="line">     */</span><br><span class="line">    public Iterator&lt;E&gt; iterator() &#123;</span><br><span class="line">        return new Itr();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è·å–å­list</span><br><span class="line">     */</span><br><span class="line">    public List&lt;E&gt; subList(int fromIndex, int toIndex) &#123;</span><br><span class="line">        subListRangeCheck(fromIndex, toIndex, size);</span><br><span class="line">        return new SubList(this, 0, fromIndex, toIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //å­listèŒƒå›´æ£€æŸ¥</span><br><span class="line">    static void subListRangeCheck(int fromIndex, int toIndex, int size) &#123;</span><br><span class="line">        if (fromIndex &lt; 0)</span><br><span class="line">            throw new IndexOutOfBoundsException(&quot;fromIndex = &quot; + fromIndex);</span><br><span class="line">        if (toIndex &gt; size)</span><br><span class="line">            throw new IndexOutOfBoundsException(&quot;toIndex = &quot; + toIndex);</span><br><span class="line">        if (fromIndex &gt; toIndex)</span><br><span class="line">            throw new IllegalArgumentException(&quot;fromIndex(&quot; + fromIndex +</span><br><span class="line">                    &quot;) &gt; toIndex(&quot; + toIndex + &quot;)&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // Java8 æ–°åŠ ï¼Œä¾›å‡½æ•°å¼ç¼–ç¨‹éå†</span><br><span class="line">    @Override</span><br><span class="line">    public void forEach(Consumer&lt;? super E&gt; action) &#123;</span><br><span class="line">        Objects.requireNonNull(action);</span><br><span class="line">        final int expectedModCount = modCount;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        final E[] elementData = (E[]) this.elementData;</span><br><span class="line">        final int size = this.size;</span><br><span class="line">        for (int i=0; modCount == expectedModCount &amp;&amp; i &lt; size; i++) &#123;</span><br><span class="line">            action.accept(elementData[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        if (modCount != expectedModCount) &#123;</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è¿”å›ä¸€ä¸ª Spliterator å¯¹è±¡ã€‚</span><br><span class="line">     * Spliterator æ˜¯ Java8 æ–°åŠ çš„ã€å¯åˆ†å‰²çš„è¿­ä»£å™¨(splitable iterator)ï¼Œå¯¹äºå¹¶è¡Œå¤„ç†çš„èƒ½åŠ›å¤§å¤§å¢å¼ºã€‚</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public Spliterator&lt;E&gt; spliterator() &#123;</span><br><span class="line">        return new ArrayListSpliterator&lt;&gt;(this, 0, -1, 0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Predicate æ˜¯Java8 æ–°åŠ çš„ç±»ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç”¨æ¥æ–­è¨€çš„ç±»ã€‚</span><br><span class="line">     * è¯¥æ–¹æ³•åº”è¯¥æ˜¯ä¸ºäº†å‡½æ•°å¼ç¼–ç¨‹æ–°åŠ çš„ã€‚</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public boolean removeIf(Predicate&lt;? super E&gt; filter) &#123;</span><br><span class="line">        Objects.requireNonNull(filter);</span><br><span class="line">        // figure out which elements are to be removed</span><br><span class="line">        // any exception thrown from the filter predicate at this stage</span><br><span class="line">        // will leave the collection unmodified</span><br><span class="line">        int removeCount = 0;</span><br><span class="line">        final BitSet removeSet = new BitSet(size);</span><br><span class="line">        final int expectedModCount = modCount;</span><br><span class="line">        final int size = this.size;</span><br><span class="line">        for (int i=0; modCount == expectedModCount &amp;&amp; i &lt; size; i++) &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            final E element = (E) elementData[i];</span><br><span class="line">            if (filter.test(element)) &#123;</span><br><span class="line">                removeSet.set(i);</span><br><span class="line">                removeCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (modCount != expectedModCount) &#123;</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // shift surviving elements left over the spaces left by removed elements</span><br><span class="line">        final boolean anyToRemove = removeCount &gt; 0;</span><br><span class="line">        if (anyToRemove) &#123;</span><br><span class="line">            final int newSize = size - removeCount;</span><br><span class="line">            for (int i=0, j=0; (i &lt; size) &amp;&amp; (j &lt; newSize); i++, j++) &#123;</span><br><span class="line">                i = removeSet.nextClearBit(i);</span><br><span class="line">                elementData[j] = elementData[i];</span><br><span class="line">            &#125;</span><br><span class="line">            for (int k=newSize; k &lt; size; k++) &#123;</span><br><span class="line">                elementData[k] = null;  // Let gc do its work</span><br><span class="line">            &#125;</span><br><span class="line">            this.size = newSize;</span><br><span class="line">            if (modCount != expectedModCount) &#123;</span><br><span class="line">                throw new ConcurrentModificationException();</span><br><span class="line">            &#125;</span><br><span class="line">            modCount++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return anyToRemove;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Java8 æ–°åŠ ï¼Œå¯ä»¥æŒ‰æŒ‡å®šè§„åˆ™æ›¿æ¢æ‰€æœ‰å…ƒç´ ã€‚</span><br><span class="line">     * UnaryOperator å®ç°äº† Function æ¥å£ï¼Œå¯ä»¥æ¥æ”¶ä¸€ä¸ªå…¥å‚ï¼Œå¤„ç†åè¿”å›ã€‚</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public void replaceAll(UnaryOperator&lt;E&gt; operator) &#123;</span><br><span class="line">        Objects.requireNonNull(operator);</span><br><span class="line">        final int expectedModCount = modCount;</span><br><span class="line">        final int size = this.size;</span><br><span class="line">        for (int i=0; modCount == expectedModCount &amp;&amp; i &lt; size; i++) &#123;</span><br><span class="line">            elementData[i] = operator.apply((E) elementData[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        if (modCount != expectedModCount) &#123;</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * æ’åºï¼ŒComparator æŒ‡å®šæ’åºè§„åˆ™</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public void sort(Comparator&lt;? super E&gt; c) &#123;</span><br><span class="line">        final int expectedModCount = modCount;</span><br><span class="line">        //è°ƒç”¨ Arrays çš„æ’åºæ–¹æ³•ï¼Œç„äº†ä¸€çœ¼ï¼Œå¾ˆå¤æ‚çš„æ ·å­...</span><br><span class="line">        Arrays.sort((E[]) elementData, 0, size, c);</span><br><span class="line">        if (modCount != expectedModCount) &#123;</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="writeObject-å’Œ-readObject"><a href="#writeObject-å’Œ-readObject" class="headerlink" title="writeObject å’Œ readObject"></a>writeObject å’Œ readObject</h3><p>ArrayList å®ç°äº† Serializable æ¥å£ï¼Œæ‰€ä»¥å¯¹è±¡ä¼šè¢«åºåˆ—åŒ–ã€‚è€Œå­˜æ”¾å…ƒç´ çš„ elementData ä¸­å¯èƒ½ä¼šå­˜åœ¨å…ƒç´ æ•°é‡æ¯”æ•°ç»„å®¹é‡å°å¾ˆå¤šçš„æƒ…å†µï¼Œåºåˆ—åŒ–æ—¶å°±ä¼šé€ æˆå¤§é‡çš„ç©ºé—´æµªè´¹ï¼Œå› æ­¤é€šè¿‡å®ç° writeObject å’Œ readObject æ–¹æ³•ï¼Œå³å¯é‡æ–°å®šä¹‰åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„è§„åˆ™ã€‚ArrayList åœ¨ elementData å‰åŠ ä¸Šäº† transient å–æ¶ˆå…¶é»˜è®¤åºåˆ—åŒ–è§„åˆ™ï¼Œå…¶ä»–å±æ€§åˆ™æ‰§è¡Œé»˜è®¤çš„è§„åˆ™ã€‚</p><h3 id="è¿­ä»£å™¨"><a href="#è¿­ä»£å™¨" class="headerlink" title="è¿­ä»£å™¨"></a>è¿­ä»£å™¨</h3><p><code>iterator()</code>æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª Iterator è¿­ä»£å™¨ï¼Œéå†æ—¶è¾ƒå¸¸è§ã€‚<br>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * AbstractList.Itr çš„ä¼˜åŒ–ç‰ˆ è¿­ä»£å™¨</span><br><span class="line"> */</span><br><span class="line">private class Itr implements Iterator&lt;E&gt; &#123;</span><br><span class="line">    // å½“å‰ä¸‹æ ‡</span><br><span class="line">    int cursor;       // index of next element to return</span><br><span class="line">    // ä¸Šä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡ï¼Œ-1 è¡¨ç¤ºè¿˜æ²¡æœ‰ä¸Šä¸€ä¸ªå…ƒç´ </span><br><span class="line">    int lastRet = -1; // index of last element returned; -1 if no such</span><br><span class="line">    int expectedModCount = modCount;</span><br><span class="line"></span><br><span class="line">    Itr() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    public boolean hasNext() &#123;</span><br><span class="line">        return cursor != size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public E next() &#123;</span><br><span class="line">        checkForComodification();</span><br><span class="line">        int i = cursor;</span><br><span class="line">        if (i &gt;= size)</span><br><span class="line">            throw new NoSuchElementException();</span><br><span class="line">        Object[] elementData = ArrayList.this.elementData;</span><br><span class="line">        if (i &gt;= elementData.length)</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">        cursor = i + 1;</span><br><span class="line">        return (E) elementData[lastRet = i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void remove() &#123;</span><br><span class="line">        //</span><br><span class="line">        if (lastRet &lt; 0)</span><br><span class="line">            throw new IllegalStateException();</span><br><span class="line">        checkForComodification();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            ArrayList.this.remove(lastRet);</span><br><span class="line">            cursor = lastRet;</span><br><span class="line">            lastRet = -1;</span><br><span class="line">            expectedModCount = modCount;</span><br><span class="line">        &#125; catch (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //Java8 æ–°åŠ çš„ éå†æ–¹æ³•ï¼Œä¾›å‡½æ•°å¼ç¼–ç¨‹ä½¿ç”¨</span><br><span class="line">    @Override</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public void forEachRemaining(Consumer&lt;? super E&gt; consumer) &#123;</span><br><span class="line">        Objects.requireNonNull(consumer);</span><br><span class="line">        final int size = ArrayList.this.size;</span><br><span class="line">        int i = cursor;</span><br><span class="line">        if (i &gt;= size) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        final Object[] elementData = ArrayList.this.elementData;</span><br><span class="line">        if (i &gt;= elementData.length) &#123;</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">        while (i != size &amp;&amp; modCount == expectedModCount) &#123;</span><br><span class="line">            consumer.accept((E) elementData[i++]);</span><br><span class="line">        &#125;</span><br><span class="line">        // update once at end of iteration to reduce heap write traffic</span><br><span class="line">        cursor = i;</span><br><span class="line">        lastRet = i - 1;</span><br><span class="line">        checkForComodification();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ£€æŸ¥æ˜¯å¦è¢«ä¿®æ”¹è¿‡</span><br><span class="line">    final void checkForComodification() &#123;</span><br><span class="line">        if (modCount != expectedModCount)</span><br><span class="line">            throw new ConcurrentModificationException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>listIterator(int index)</code>ã€<code>listIterator()</code>è¿™ä¸¤ä¸ªæ–¹æ³•è¿”å›çš„æ˜¯ ListIterator è¿­ä»£å™¨ï¼Œä¸ Iterator ç›¸æ¯”ï¼Œå®ƒæ”¯æŒåå‘éå†å’Œ add() æ–¹æ³•ï¼Œæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¸å†èµ˜è¿°ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>spliterator()</code>æ–¹æ³•ï¼Œå®ƒè¿”å›çš„æ˜¯ä¸€ä¸ª Java8 æ–°åŠ çš„ Spliterator è¿­ä»£å™¨ã€‚Spliterator æ˜¯ä¸€ä¸ªå¯åˆ†å‰²è¿­ä»£å™¨(splitable iterator)ï¼Œä¸ºäº†å¹¶è¡Œéå†å…ƒç´ è€Œè®¾è®¡ã€‚å¦‚æœæœ‰æœºä¼šæˆ‘ä»¬å†åˆ†æå®ƒã€‚</p><h3 id="sublist"><a href="#sublist" class="headerlink" title="sublist"></a>sublist</h3><p>ArrayList æä¾›çš„<code>public List&lt;E&gt; subList(int fromIndex, int toIndex)</code>æ–¹æ³•å…è®¸è¿”å›ä¸€ä¸ªå­listã€‚<br>æ ¹æ®æ³¨é‡Šå¾—çŸ¥ï¼š</p><ol><li>è¯¥æ–¹æ³•è¿”å›çš„æ˜¯çˆ¶listçš„ä¸€ä¸ªè§†å›¾ï¼Œä»fromIndexï¼ˆåŒ…å«ï¼‰ï¼Œåˆ°toIndexï¼ˆä¸åŒ…å«ï¼‰ã€‚fromIndex=toIndex è¡¨ç¤ºå­listä¸ºç©º</li><li>çˆ¶å­liståšçš„éç»“æ„æ€§ä¿®æ”¹ï¼ˆnon-structural changesï¼‰éƒ½ä¼šå½±å“åˆ°å½¼æ­¤ï¼šæ‰€è°“çš„â€œéç»“æ„æ€§ä¿®æ”¹â€ï¼Œæ˜¯æŒ‡ä¸æ¶‰åŠåˆ°listçš„å¤§å°æ”¹å˜çš„ä¿®æ”¹ã€‚ç›¸åï¼Œç»“æ„æ€§ä¿®æ”¹ï¼ŒæŒ‡æ”¹å˜äº†listå¤§å°çš„ä¿®æ”¹ã€‚</li><li>å¯¹äºç»“æ„æ€§ä¿®æ”¹ï¼Œå­listçš„æ‰€æœ‰æ“ä½œéƒ½ä¼šåæ˜ åˆ°çˆ¶listä¸Šã€‚ä½†çˆ¶listçš„ä¿®æ”¹å°†ä¼šå¯¼è‡´è¿”å›çš„å­listå¤±æ•ˆã€‚</li><li>tipsï¼šåˆ é™¤listä¸­çš„æŸæ®µæ•°æ®çš„æ–¹æ³•ï¼š<code>list.subList(from, to).clear();</code></li></ol><hr><p>è§‰å¾—æœ‰ç‚¹æ”¶è·çš„åŒå­¦å¯ä»¥åœ¨æ‰‹æœºä¸Šç‚¹å‡»è¿™ä¸ª<a href="https://m.luckincoffee.com/invited/register?activityNo=NR201801030001&amp;inviteCode=8lB4421fo_6iv_eidD4_Fg%3D%3D&amp;secondfrom=0&amp;title=%E4%BB%8A%E5%A4%A9%E6%98%9F%E6%9C%9F%E4%B8%89%EF%BC%8C%E8%AF%B7%E4%BD%A0%E5%96%9D%E6%9D%AF%E5%85%8D%E8%B4%B9%E5%A4%A7%E5%B8%88%E5%92%96%E5%95%A1%EF%BC%8C%E6%96%B9%E6%A1%88%E4%B8%80%E7%A8%BF%E8%BF%87&amp;timestamp=1542129222502&amp;from=singlemessage" target="_blank" rel="noopener">é“¾æ¥</a> å…è´¹é¢†å–ä¸€æ¯å’–å•¡ï¼ˆç‘å¹¸å’–å•¡åˆ¸ï¼Œä½¿ç”¨åæˆ‘ä¹Ÿå¾—ä¸€å¼ ğŸ˜ƒï¼‰</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š10åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h3&gt;&lt;p&gt;ArrayList æ˜¯æ—¥å¸¸å¼€å‘ä¸­å¾ˆå¸¸è§çš„é›†åˆç±»å‹ï¼Œåœ¨ Java é›†åˆä¸­ç›¸å¯¹å®¹æ˜“é˜…è¯»ã€‚
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="ArrayList" scheme="https://jasonsonghoho.github.io/public/tags/ArrayList/"/>
    
  </entry>
  
  <entry>
    <title>BitMapã€BitSetä¸Bloom Filter</title>
    <link href="https://jasonsonghoho.github.io/2018/10/08/BitMap%E3%80%81BitSet%E4%B8%8EBloom%20Filter/"/>
    <id>https://jasonsonghoho.github.io/2018/10/08/BitMapã€BitSetä¸Bloom Filter/</id>
    <published>2018-10-08T02:36:11.000Z</published>
    <updated>2018-10-30T09:03:13.706Z</updated>
    
    <content type="html"><![CDATA[<p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š5åˆ†é’Ÿ</em></p><h3 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h3><p>å…ˆæ¥çœ‹ä¸€ä¸ªé—®é¢˜ï¼Œå‡è®¾ç°åœ¨æœ‰èŒƒå›´ä¸º 1-10 äº¿çš„ 11 äº¿ä¸ª int å‹æ•´æ•°ï¼Œå¦‚ä½•æ’é™¤æ‰å…¶ä¸­çš„é‡å¤æ•°å­—ï¼Ÿint å  4 ä¸ªå­—èŠ‚ï¼Œå¯ä»¥è¡¨ç¤º -2,147,483,648 ~ +2,147,483,647 çš„æ•°æ®ã€‚<br>æ‰€ä»¥ä¸€èˆ¬çš„æ€è·¯æ˜¯ä¼šå°†è¿™ 11 äº¿ä¸ªæ•°ä½œä¸º int å‹æ•°æ®å­˜åˆ°ä¸€ä¸ª HashSet é›†åˆä¸­è¿›è¡Œå»é‡ã€‚ä½†æ˜¯ï¼Œè¿™æ ·ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬çŸ¥é“ 1GB=1024KB=1024 <em> 1024Byte,é‚£ä¹ˆ 10äº¿ </em> 4Byte å°†å ç”¨æ¥è¿‘ 4GB çš„å†…å­˜ï¼Œè¿™å°†æ˜¯æå¤§çš„æ€§èƒ½æµªè´¹ï¼Œå¾ˆå¯èƒ½ä¼šå½±å“ç¨‹åºçš„å¥åº·è¿è¡Œã€‚</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>æˆ‘ä»¬å¯ä»¥è€ƒè™‘ç”¨â€ä½æ˜ å°„ï¼ˆBitMapï¼‰â€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä½æ•°ç»„ï¼ˆbit[n]ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨ bit[i] æ¥è¡¨ç¤º 0-n ä¸­å¯¹åº”çš„æ•°å­—ï¼Œæ¯ä¸ªå…ƒç´ æœ‰ 1 å’Œ 0 ä¸¤ä¸ªå–å€¼ï¼Œåˆ†åˆ«ä»£è¡¨è¯¥æ•°å­—å­˜åœ¨ä¸å¦ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è®°å½•ä¸€ä¸ªæ•°å­—åªéœ€è¦ä¸€ä¸ª bitï¼Œç›¸å¯¹äºä¹‹å‰çš„ int ç±»å‹(32 bit)ï¼Œæ•´æ•´ç¼©å°äº† 32 å€çš„å­˜å‚¨å¤§å°(4GB/32=125MB)!</p><p>æ‰©å±•ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬éœ€è¦è®°å½•æ¯ä¸ªæ•°å­—å‡ºç°æ¬¡æ•°æ˜¯å¦è¶…è¿‡ 2 æ¬¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿ç»­çš„ä¸¤ä½æ¥è®°å½•ä¸€ä¸ªæ•°å­—ï¼šä¸€ä½ç”¨æ¥è®°å½•æ˜¯å¦å‡ºç°ï¼Œå¦ä¸€ä½ç”¨æ¥è®°å½•æ˜¯å¦è¶…è¿‡ 2 æ¬¡ã€‚</p><p>ä¸è¿‡ï¼ŒJava ä¸­æ— æ³•åˆ›å»º bit æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ int æˆ– long æ•°ç»„æ¥å®ç°è¿™ä¸ªç›®çš„ã€‚å»ºç«‹ä¸€ä¸ª int æ•°ç»„ int[n]ï¼Œint[0] è®°å½•äº† 0-31ï¼Œint[1] è®°å½•äº† 32-63 â€¦â€¦ ä¾æ­¤ç±»æ¨ã€‚</p><h3 id="Java-BitSet"><a href="#Java-BitSet" class="headerlink" title="Java BitSet"></a>Java BitSet</h3><p>Java ä¸­æœ‰ä¸€ä¸ª BitSet ç±»ï¼Œä»å‘½åå°±å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ç”¨æ¥å­˜å‚¨å»é‡çš„ä½å…ƒç´ é›†åˆï¼Œå®ƒè¿˜æ”¯æŒ andã€or ç­‰ä½è¿ç®—ã€‚ç”¨æ¥è§£å†³æ–‡ç« å¼€å¤´çš„é—®é¢˜éå¸¸åˆé€‚ï¼Œæ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitSetStudy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BitSet bitSet = <span class="keyword">new</span> BitSet(<span class="number">1000000000</span>);</span><br><span class="line">        <span class="comment">//éšæœºç”Ÿæˆ 11 äº¿ä¸ªæ•°å­—</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1100000000</span>; i++) &#123;</span><br><span class="line">            bitSet.set((<span class="keyword">int</span>) (Math.random() * <span class="number">1000000000</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(bitSet.size());</span><br><span class="line">        System.out.println(<span class="string">"end"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å¼€ jconsole,å¯ä»¥çœ‹åˆ°å­˜å‚¨äº† bitset å¯¹è±¡çš„è€å¹´ä»£æ‰€å ç”¨çš„å†…å­˜ç¨³å®šåœ¨ 125MB å·¦å³ã€‚</p><img src="/2018/10/08/BitMapã€BitSetä¸Bloom%20Filter/bitset-mem.png"><p>å…³äº BitSet çš„ andã€andNotã€orã€xor æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    BitSet bitSet = <span class="keyword">new</span> BitSet();</span><br><span class="line">    bitSet.set(<span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">    BitSet bitSet1 = <span class="keyword">new</span> BitSet();</span><br><span class="line">    bitSet1.set(<span class="number">4</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    BitSet bitSetAnd = (BitSet) bitSet.clone();</span><br><span class="line">    BitSet bitSetAndNot = (BitSet) bitSet.clone();</span><br><span class="line">    BitSet bitSetOr = (BitSet) bitSet.clone();</span><br><span class="line">    BitSet bitSetXor = (BitSet) bitSet.clone();</span><br><span class="line"></span><br><span class="line">    bitSetAnd.and(bitSet1);</span><br><span class="line">    bitSetAndNot.andNot(bitSet1);</span><br><span class="line">    bitSetOr.or(bitSet1);</span><br><span class="line">    bitSetXor.xor(bitSet1);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"bitSet is : "</span> + bitSet + <span class="string">" , and bitSet1 is: "</span> + bitSet1);</span><br><span class="line">    System.out.println(<span class="string">"run bitSet.XMethod(bitSet1) , result is : "</span>);</span><br><span class="line">    System.out.println(<span class="string">"and:"</span> + bitSetAnd);</span><br><span class="line">    System.out.println(<span class="string">"andNot:"</span> + bitSetAndNot);</span><br><span class="line">    System.out.println(<span class="string">"or:"</span> + bitSetOr);</span><br><span class="line">    System.out.println(<span class="string">"xor:"</span> + bitSetXor);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bitSet is : &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125; , and bitSet1 is: &#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br><span class="line">run bitSet.XMethod(bitSet1) , result is :</span><br><span class="line">and:&#123;<span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">andNot:&#123;<span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">or:&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br><span class="line">xor:&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br></pre></td></tr></table></figure></p><h3 id="è‡ªå·±å®ç°-BitMap"><a href="#è‡ªå·±å®ç°-BitMap" class="headerlink" title="è‡ªå·±å®ç° BitMap"></a>è‡ªå·±å®ç° BitMap</h3><p>Java çš„ BitSet ä½¿ç”¨èµ·æ¥å­˜åœ¨å±€é™æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ BitSet å®ç°è‡ªå·±çš„ BitMap æ¥æ‰©å±•åº”ç”¨åœºæ™¯ã€‚æ ¸å¿ƒè¿˜æ˜¯é€šè¿‡ int/long æ•°ç»„å…ƒç´ çš„ä½æ¥è®°å½•æœ‰åºæ•°æ®ï¼Œä¸€ä¸ªå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitMap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] words;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitMap</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        size = n;</span><br><span class="line">        <span class="comment">//æ¯ä¸ªintå 32ä½ï¼Œæ•°ç»„å¤§å°ä¸º n/32+1</span></span><br><span class="line">        words = <span class="keyword">new</span> <span class="keyword">int</span>[(size &gt;&gt; <span class="number">5</span>) + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> bit)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//è·å¾—æ•°æ®æ‰€åœ¨çš„æ•°ç»„åºå·ï¼ˆintï¼‰ï¼Œç›¸å½“äº bit/32</span></span><br><span class="line">        <span class="keyword">int</span> i = bit &gt;&gt; <span class="number">5</span>;</span><br><span class="line">        <span class="comment">//è·å¾—è¯¥intå…ƒç´ ä¸­è¦ä¿®æ”¹ä¸º1çš„æ•°å­—,ç›¸å½“äº bit%32</span></span><br><span class="line">        <span class="keyword">int</span> j = bit &amp; <span class="number">31</span>;</span><br><span class="line">        <span class="comment">//è·å¾—è¦ä¿®æ”¹çš„ä½</span></span><br><span class="line">        <span class="keyword">int</span> k = <span class="number">1</span> &lt;&lt; j;</span><br><span class="line">        <span class="comment">//å°†è¯¥å…ƒç´ ç›¸åº”çš„äºŒè¿›åˆ¶ä½è®¾ä¸º1</span></span><br><span class="line">        words[i] |= k ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> bit)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å‚è€ƒsetæ–¹æ³•ç†è§£</span></span><br><span class="line">        <span class="keyword">return</span> (words[bit &gt;&gt; <span class="number">5</span>] &amp; (<span class="number">1</span> &lt;&lt; (bit &amp; <span class="number">31</span>))) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°äº†æ ¸å¿ƒçš„å­˜å‚¨ç»“æ„ã€set å’Œ get æ–¹æ³•ã€‚</p><h3 id="å¸ƒéš†è¿‡æ»¤å™¨-Bloom-Filter"><a href="#å¸ƒéš†è¿‡æ»¤å™¨-Bloom-Filter" class="headerlink" title="å¸ƒéš†è¿‡æ»¤å™¨(Bloom Filter)"></a>å¸ƒéš†è¿‡æ»¤å™¨(Bloom Filter)</h3><p>äº†è§£å®Œ BitMap,æˆ‘ä»¬æŒæ¡äº†ä¸€ç§å¤„ç†å¤§é‡è¿ç»­æ•°æ®çš„å¥½æ–¹æ³•ã€‚ç°åœ¨ç»§ç»­æ‰©å±•ä¸€ä¸‹ï¼Œç°åœ¨å¦‚æœæˆ‘ä»¬è¦è®°å½•çš„æ˜¯æµ·é‡çš„åˆ†å¸ƒå¾ˆä¸å‡åŒ€çš„æ•°æ®ï¼Œå¦‚æœç»§ç»­ç”¨ BitMap çš„æ–¹å¼ï¼Œå°†ä¼šæµªè´¹å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œæˆ–è€…æ•°æ®é‡å·²ç»å¤§åˆ°ä½¿ç”¨ BitMap çš„æ–¹å¼ï¼Œä»ç„¶ä¼šæµªè´¹å¤§é‡çš„å†…å­˜ç©ºé—´ã€‚é¢å¯¹è¿™ä¸¤ç§æƒ…æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ã€‚</p><p>å¸ƒéš†è¿‡æ»¤å™¨æ ¸å¿ƒæ˜¯å¯¹ä¸€ä¸ª key ä½¿ç”¨å¤šä¸ª hash å‡½æ•°æ±‚å‡ºå¤šä¸ªå€¼ï¼Œå°†è¿™äº›å€¼æ•£åˆ—åœ¨ä¸€ä¸ªæœ‰é™çš„æ•°ç»„ä¸­ï¼Œè¿™æ ·ï¼Œå½“è¿™äº› hash å‡½æ•°æ±‚å‡ºçš„å€¼éƒ½ç¬¦åˆé¢„æœŸå°±è®¤ä¸ºè¯¥ key å­˜åœ¨ï¼›è‹¥åªè¦å­˜åœ¨ hash å‡½æ•°çš„å€¼ä¸ç¬¦åˆï¼Œå°±å¯ä»¥ç¡®å®šå®ƒä¸å­˜åœ¨ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè¿™ç§æ–¹æ³•æ•ˆæœéå¸¸å¥½ã€‚å›¾ç¤ºå¦‚ä¸‹ï¼š</p><img src="/2018/10/08/BitMapã€BitSetä¸Bloom%20Filter/bloom_filter.jpeg"><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ç§æ–¹æ³•å­˜åœ¨ä¸€å®šè¯¯å·®ï¼Œä¸è¿‡è¯¯å·®å‡ ç‡å¯ä»¥é€šè¿‡å¢åŠ  hash å‡½æ•°å’Œæ•£åˆ—æ•°ç»„å¤§å°æ¥å‡å°ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå½“æŸä¸ª key è¢«åˆ é™¤åï¼Œä¸èƒ½ç›´æ¥åœ¨æ•£åˆ—è¡¨ä¸­å°†å¯¹åº”çš„ value å»æ‰ï¼Œå› ä¸ºå¯èƒ½ä¼šå½±å“å…¶ä»– keyã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªé»‘åå•ï¼Œæ¯æ¬¡è®¡ç®— hash å‰ï¼Œå…ˆåˆ¤æ–­ key æ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Œæœ‰åˆ™è¡¨ç¤ºè¯¥ key å·²åˆ æ‰ã€‚</p><img src="/2018/10/08/BitMapã€BitSetä¸Bloom%20Filter/IMG_1753.GIF" title="10æ ‹*7å±‚*2ï¼ˆè‡³å°‘2ï¼‰å¥—=140å¥— å‘µå‘µğŸ˜…">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š5åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h3&gt;&lt;p&gt;å…ˆæ¥çœ‹ä¸€ä¸ªé—®é¢˜ï¼Œå‡è®¾ç°åœ¨æœ‰èŒƒå›´ä¸º 1-10 äº¿çš„ 11 äº¿ä¸ª int å‹æ•´æ•°ï¼Œå¦‚ä½•æ’é™¤
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="BitMap" scheme="https://jasonsonghoho.github.io/public/tags/BitMap/"/>
    
      <category term="BitSet" scheme="https://jasonsonghoho.github.io/public/tags/BitSet/"/>
    
      <category term="å¸ƒéš†è¿‡æ»¤å™¨" scheme="https://jasonsonghoho.github.io/public/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/"/>
    
      <category term="Bloom Filter" scheme="https://jasonsonghoho.github.io/public/tags/Bloom-Filter/"/>
    
  </entry>
  
  <entry>
    <title>Java 8 HashMap(ä¸Š)â€”â€” çº¢é»‘æ ‘</title>
    <link href="https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMap-%E4%B8%8A-%E2%80%94%E2%80%94-%E7%BA%A2%E9%BB%91%E6%A0%91/"/>
    <id>https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMap-ä¸Š-â€”â€”-çº¢é»‘æ ‘/</id>
    <published>2018-09-23T16:19:04.000Z</published>
    <updated>2018-09-23T16:45:18.176Z</updated>
    
    <content type="html"><![CDATA[<p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š10åˆ†é’Ÿ</em></p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><blockquote><p>Java8çš„æœ€å¤§ç‰¹æ€§æ˜¯ä½¿ç”¨çº¢é»‘æ ‘ç»“æ„æ¥å­˜å‚¨æ¯ä¸ªï¼ˆæ¡¶ï¼‰bucketä¸­çš„æ•°æ®ï¼ˆå½“é“¾è¡¨é•¿åº¦è¶…è¿‡8æ—¶ï¼‰ã€‚<br>ä¸ºä»€ä¹ˆå¼•å…¥çº¢é»‘æ ‘å‘¢ï¼Ÿå…¶å®æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¹³å‡æ¯ä¸ªæ¡¶ä¸­åº”è¯¥åªä¼šæœ‰ä¸åˆ°1ä¸ªæ•°æ®ï¼Œä½†å½“å‘ç”Ÿå¤§é‡Hashç¢°æ’æ—¶ï¼Œæ¯ä¸ªæ¡¶ä¸­çš„æ•°æ®ä¹Ÿå°†ä¼šå¤§é‡å¢åŠ ï¼Œè¿™å°†ä¼šå½±å“åˆ°æ•°æ®çš„æŸ¥è¯¢é€Ÿåº¦ã€‚åœ¨Java7ä¸­ï¼Œæ¯ä¸ªæ¡¶ä½¿ç”¨é“¾è¡¨å­˜å‚¨æ•°æ®ï¼ŒæŸ¥æ‰¾æ•°æ®é‡‡ç”¨éå†çš„æ–¹å¼ï¼ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚Java7ä¸­ä¸ºäº†é¿å…å¤§é‡Hashç¢°æ’çš„é—®é¢˜ï¼Œå¼•å…¥äº†hashseedæ–¹å¼ï¼Œå¢å¼ºäº†Hashå‡½æ•°çš„æ•£åˆ—æ€§ã€‚ä½†æ˜¯randomHashSeedæ–¹æ³•è°ƒç”¨çš„nextæ–¹æ³•åœ¨å¤šçº¿ç¨‹è¿ç®—æ—¶å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼ˆå¾…è€ƒè¯ï¼‰ï¼Œæ•…åœ¨Java8ä¸­è¢«å¼ƒç”¨ã€‚Java8ä¸­æ¢äº†ä¸€ä¸ªæ€è·¯ï¼šä½¿ç”¨çº¢é»‘æ ‘æ¥æé«˜æŸ¥æ‰¾é€Ÿåº¦ï¼ˆO(logN)ï¼‰ï¼Œå³ä½¿å‘ç”Ÿå¤§é‡hashç¢°æ’ä¹Ÿä¸ä¼šé€ æˆæ€§èƒ½å½±å“ï¼Œè¿™ä¾¿æ˜¯çº¢é»‘æ ‘ç”±æ¥çš„åŸå› ã€‚<br>Java7çš„HashMapä¸€å…±æœ‰æ¥è¿‘1200è¡Œä»£ç ï¼Œè€Œåˆ°äº†Java8ç›´æ¥å¢åŠ åˆ°äº†2400è¡Œï¼Œå‡å»å…¨å±€å˜é‡å‰æ–°åŠ çš„100è¡Œæ³¨é‡Šï¼Œç›¸å·®1100è¡Œã€‚å…¶ä¸­TreeNode(çº¢é»‘æ ‘)å®ç°éƒ¨åˆ†æœ‰600è¡Œä»£ç ï¼Œå†åŠ ä¸Šå…¶ä»–æ–¹æ³•å¯¹çº¢é»‘æ ‘çš„é€‚åº”æ€§æ”¹åŠ¨ï¼Œå¯è§çº¢é»‘æ ‘éƒ¨åˆ†æ˜¯Java8 HashMapçš„ä¸»è¦æ”¹åŠ¨ã€‚  </p></blockquote><h3 id="è¯¦æƒ…"><a href="#è¯¦æƒ…" class="headerlink" title="è¯¦æƒ…"></a>è¯¦æƒ…</h3><h4 id="ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š"><a href="#ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š" class="headerlink" title="ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š"></a>ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</h4><img src="/2018/09/24/Java-8-HashMap-ä¸Š-â€”â€”-çº¢é»‘æ ‘/20180923214733.png"><p>TreeNodeç»§æ‰¿äº†LinkedHashMap.Entryï¼ŒLinkedHashMap.Entryç»§æ‰¿äº†HashMap.Nodeï¼Œè€ŒNodeå…¶å®å°±æ˜¯ä¸Šä¸ªç‰ˆæœ¬çš„Entryï¼ˆé“¾è¡¨ï¼‰ç»“æ„ã€‚æ­¤å¤„æœ‰ä¸ªç–‘æƒ‘ï¼šTreeNodeå¹¶æ²¡æœ‰ä½¿ç”¨LinkedHashMap.Entryçš„beforeå’Œafterå­—æ®µï¼Œä¸çŸ¥é“ä¸ºå•¥ä¸ç›´æ¥ç»§æ‰¿Nodeç±»ã€‚</p><h4 id="å­—æ®µå’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š"><a href="#å­—æ®µå’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š" class="headerlink" title="å­—æ®µå’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š"></a>å­—æ®µå’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//å¸¸è§çš„æ ‘ç»“æ„</span></span><br><span class="line">    HashMap.TreeNode&lt;K, V&gt; parent;</span><br><span class="line">    HashMap.TreeNode&lt;K, V&gt; left;</span><br><span class="line">    HashMap.TreeNode&lt;K, V&gt; right;</span><br><span class="line">    HashMap.TreeNode&lt;K, V&gt; prev;</span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line"></span><br><span class="line">    TreeNode(<span class="keyword">int</span> hash, K key, V val, HashMap.Node&lt;K, V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="çº¢é»‘æ ‘å…¨éƒ¨æ–¹æ³•å¦‚ä¸‹ï¼š"><a href="#çº¢é»‘æ ‘å…¨éƒ¨æ–¹æ³•å¦‚ä¸‹ï¼š" class="headerlink" title="çº¢é»‘æ ‘å…¨éƒ¨æ–¹æ³•å¦‚ä¸‹ï¼š"></a>çº¢é»‘æ ‘å…¨éƒ¨æ–¹æ³•å¦‚ä¸‹ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–æ ¹ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; r = <span class="keyword">this</span>, p;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((p = r.parent) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        r = p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€‰å–æ ¹ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘è¿›è¡Œå·¦æ—‹ã€å³æ—‹åï¼Œæ ¹ç»“ç‚¹å¯èƒ½ç§»åŠ¨ï¼Œå¤´ç»“ç‚¹éœ€è¦é‡æ–°æŒ‡å‘æ–°çš„æ ¹ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">moveRootToFront</span><span class="params">(HashMap.Node&lt;K,V&gt;[] tab, HashMap.TreeNode&lt;K,V&gt; root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; tab != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> index = (n - <span class="number">1</span>) &amp; root.hash;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; first = (HashMap.TreeNode&lt;K,V&gt;)tab[index];</span><br><span class="line">        <span class="comment">//å¦‚æœæ ¹ç»“ç‚¹ä¸æ˜¯æ¡¶çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™å°†æ ¹ç»“ç‚¹ç§»åŠ¨åˆ°å¤´ç»“ç‚¹ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> (root != first) &#123;</span><br><span class="line">            HashMap.Node&lt;K,V&gt; rn;</span><br><span class="line">            tab[index] = root;</span><br><span class="line">            HashMap.TreeNode&lt;K,V&gt; rp = root.prev;</span><br><span class="line">            <span class="keyword">if</span> ((rn = root.next) != <span class="keyword">null</span>)</span><br><span class="line">                ((HashMap.TreeNode&lt;K,V&gt;)rn).prev = rp;</span><br><span class="line">            <span class="keyword">if</span> (rp != <span class="keyword">null</span>)</span><br><span class="line">                rp.next = rn;</span><br><span class="line">            <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">                first.prev = root;</span><br><span class="line">            root.next = first;</span><br><span class="line">            root.prev = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ–­è¨€çº¢é»‘æ ‘ç»“æ„æ˜¯å¦æ­£å¸¸ï¼Œä¸æ­£å¸¸åˆ™æŠ¥å¼‚å¸¸åœæ­¢</span></span><br><span class="line">        <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç»“ç‚¹hashå€¼ã€keyå’Œkeyçš„ç±»å‹ è¿›è¡Œçº¢é»‘æ ‘æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ph, dir; K pk;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; pl = p.left, pr = p.right, q;</span><br><span class="line">        <span class="comment">//å¾…æŸ¥è¯¢ç»“ç‚¹çš„keyçš„hashå€¼è‹¥å°äºå½“å‰ç»“ç‚¹åˆ™è¿›å…¥å·¦å­æ ‘ï¼Œå¦åˆ™è¿›å…¥å³å­æ ‘</span></span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="comment">//å¦‚æœhashå€¼ç›¸ç­‰å†æ¯”è¾ƒkeyï¼Œä¸€è‡´åˆ™è¡¨ç¤ºæ‰¾åˆ°ï¼Œè¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pl == <span class="keyword">null</span>)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pr == <span class="keyword">null</span>)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="comment">//å¦‚æœkeyä¸åŒï¼Œåˆ™çœ‹keyçš„ç±»å‹æ˜¯å¦å¯æ¯”è¾ƒï¼Œ</span></span><br><span class="line">        <span class="comment">//å¦‚æœå¯ä»¥æ¯”è¾ƒåˆ™æ ¹æ®æ¯”è¾ƒç»“æœé€‰æ‹©æ˜¯å¦è¿”å›æŸ¥è¯¢ç»“æœï¼Œè¿˜æ˜¯ç»§ç»­æŸ¥è¯¢å·¦ã€å³å­æ ‘</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="keyword">null</span> ||</span><br><span class="line">                (kc = comparableClassFor(k)) != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                (dir = compareComparables(kc, k, pk)) != <span class="number">0</span>)</span><br><span class="line">            p = (dir &lt; <span class="number">0</span>) ? pl : pr;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((q = pr.find(h, k, kc)) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> q;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p = pl;</span><br><span class="line">    &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç»“ç‚¹hashå€¼ã€key è¿›è¡Œçº¢é»‘æ ‘æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">getTreeNode</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>).find(h, k, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼ºåˆ¶æ¯”è¾ƒä¸¤ä¸ªç»“ç‚¹çš„key</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å½“ä¸¤ä¸ªç±»å‹ä¸èƒ½ç›´æ¥æ¯”è¾ƒæ—¶ï¼Œé€šè¿‡å¯¹ç±»åè¿›è¡Œhashè¿›è¡Œæ¯”è¾ƒï¼›è‹¥hashå€¼ä¹Ÿç›¸ç­‰ï¼Œåˆ¤å®šbå¤§ã€‚</span></span><br><span class="line"><span class="comment"> * æ•…ä¸€å®šä¼šæ’å‡ºå…ˆåé¡ºåºã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tieBreakOrder</span><span class="params">(Object a, Object b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> d;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="keyword">null</span> || b == <span class="keyword">null</span> ||</span><br><span class="line">            (d = a.getClass().getName().</span><br><span class="line">                    compareTo(b.getClass().getName())) == <span class="number">0</span>)</span><br><span class="line">        d = (System.identityHashCode(a) &lt;= System.identityHashCode(b) ?</span><br><span class="line">                -<span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line"><span class="comment"> * é‡è¦æ–¹æ³•ï¼å½“é“¾è¡¨é•¿åº¦å¢åŠ åˆ°çº¢é»‘æ ‘è½¬æ¢é˜ˆå€¼ï¼ˆé»˜è®¤8ï¼‰ï¼Œä¸”æ¡¶çš„æ•°é‡ä¸å°äº64 æ—¶è§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeify</span><span class="params">(HashMap.Node&lt;K,V&gt;[] tab)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; root = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//éå†é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; x = <span class="keyword">this</span>, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">        next = (HashMap.TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">        x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//é¦–ç»“ç‚¹ä½œä¸ºæ ¹ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.parent = <span class="keyword">null</span>;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            root = x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            K k = x.key;</span><br><span class="line">            <span class="keyword">int</span> h = x.hash;</span><br><span class="line">            Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> dir, ph;</span><br><span class="line">                K pk = p.key;</span><br><span class="line">                <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                    dir = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                    dir = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                        (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//å¦‚æœæœªèƒ½æ¯”è¾ƒï¼Œè°ƒç”¨å¼ºåˆ¶æ¯”è¾ƒæ–¹æ³•ï¼Œç¡®ä¿æœ‰åº</span></span><br><span class="line">                    dir = tieBreakOrder(k, pk);</span><br><span class="line"></span><br><span class="line">                HashMap.TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                <span class="comment">//å½“å·¦æˆ–å³å­æ ‘ä¸ºç©ºæ—¶ï¼Œæ’å…¥é“¾è¡¨ä¸Šçš„ä¸€ä¸ªç»“ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = xp;</span><br><span class="line">                    <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                        xp.left = x;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        xp.right = x;</span><br><span class="line">                    <span class="comment">//æ’å…¥ç»“ç‚¹åï¼Œè¿›è¡Œå·¦æ—‹ã€å³æ—‹é‡å¹³è¡¡ï¼Œè½¬æ¢ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                    root = balanceInsertion(root, x);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç¡®ä¿æ ¹ç»“ç‚¹æ˜¯é¦–ç»“ç‚¹</span></span><br><span class="line">    moveRootToFront(tab, root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘è½¬æ¢ä¸ºé“¾è¡¨</span></span><br><span class="line"><span class="comment"> * å½“çº¢é»‘æ ‘ç»“ç‚¹å‡å°‘åˆ°é“¾è¡¨è¿˜åŸé˜ˆå€¼ï¼ˆé»˜è®¤6ï¼‰æ—¶è§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">Node&lt;K,V&gt; <span class="title">untreeify</span><span class="params">(HashMap&lt;K,V&gt; map)</span> </span>&#123;</span><br><span class="line">    HashMap.Node&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.Node&lt;K,V&gt; q = <span class="keyword">this</span>; q != <span class="keyword">null</span>; q = q.next) &#123;</span><br><span class="line">        HashMap.Node&lt;K,V&gt; p = map.replacementNode(q, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">            hd = p;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            tl.next = p;</span><br><span class="line">        tl = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘æ’å…¥æ–°ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">putTreeVal</span><span class="params">(HashMap&lt;K,V&gt; map, HashMap.Node&lt;K,V&gt;[] tab,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> searched = <span class="keyword">false</span>;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; root = (parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> dir, ph; K pk;</span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">            dir = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">            dir = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!searched) &#123;</span><br><span class="line">                HashMap.TreeNode&lt;K,V&gt; q, ch;</span><br><span class="line">                searched = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//æ’å…¥ç»“ç‚¹ä¸å½“å‰ç»“ç‚¹hashå€¼ç›¸ç­‰æ—¶ï¼ŒæŸ¥æ‰¾å·¦å­æ ‘æˆ–å³å­æ ‘ï¼Œè‹¥å·²åŒ…å«å¾…æ’å…¥ç»“ç‚¹åˆ™ç›´æ¥è¿”å›ç»“æœ</span></span><br><span class="line">                <span class="keyword">if</span> (((ch = p.left) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        (q = ch.find(h, k, kc)) != <span class="keyword">null</span>) ||</span><br><span class="line">                        ((ch = p.right) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (q = ch.find(h, k, kc)) != <span class="keyword">null</span>))</span><br><span class="line">                    <span class="keyword">return</span> q;</span><br><span class="line">            &#125;</span><br><span class="line">            dir = tieBreakOrder(k, pk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">        <span class="comment">//è‹¥å·²æ¯”è¾ƒåˆ°å·¦å­æ ‘æˆ–å³å­æ ‘ä¸ºç©ºæ—¶è¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æ’å…¥è¯¥ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            HashMap.Node&lt;K,V&gt; xpn = xp.next;</span><br><span class="line">            HashMap.TreeNode&lt;K,V&gt; x = map.newTreeNode(h, k, v, xpn);</span><br><span class="line">            <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                xp.left = x;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                xp.right = x;</span><br><span class="line">            xp.next = x;</span><br><span class="line">            x.parent = x.prev = xp;</span><br><span class="line">            <span class="keyword">if</span> (xpn != <span class="keyword">null</span>)</span><br><span class="line">                ((HashMap.TreeNode&lt;K,V&gt;)xpn).prev = x;</span><br><span class="line">            moveRootToFront(tab, balanceInsertion(root, x));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ é™¤çº¢é»‘æ ‘ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> * å‘ƒï¼Œè¿™ä¸ªæ–¹æ³•å’Œå‰é¢çš„æ¯”èµ·æ¥å¤§åŒå°å¼‚ï¼Œä¸ç»†çœ‹äº†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">removeTreeNode</span><span class="params">(HashMap&lt;K,V&gt; map, HashMap.Node&lt;K,V&gt;[] tab,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> index = (n - <span class="number">1</span>) &amp; hash;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; first = (HashMap.TreeNode&lt;K,V&gt;)tab[index], root = first, rl;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; succ = (HashMap.TreeNode&lt;K,V&gt;)next, pred = prev;</span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">        tab[index] = first = succ;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pred.next = succ;</span><br><span class="line">    <span class="keyword">if</span> (succ != <span class="keyword">null</span>)</span><br><span class="line">        succ.prev = pred;</span><br><span class="line">    <span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (root.parent != <span class="keyword">null</span>)</span><br><span class="line">        root = root.root();</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span> || root.right == <span class="keyword">null</span> ||</span><br><span class="line">            (rl = root.left) == <span class="keyword">null</span> || rl.left == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è‹¥åˆ é™¤ç»“ç‚¹åï¼Œè¾¾åˆ°é“¾è¡¨è¿˜åŸé˜ˆå€¼ï¼Œåˆ™è¿˜åŸä¸ºé“¾è¡¨</span></span><br><span class="line">        tab[index] = first.untreeify(map);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>, pl = left, pr = right, replacement;</span><br><span class="line">    <span class="keyword">if</span> (pl != <span class="keyword">null</span> &amp;&amp; pr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; s = pr, sl;</span><br><span class="line">        <span class="keyword">while</span> ((sl = s.left) != <span class="keyword">null</span>) <span class="comment">// find successor</span></span><br><span class="line">            s = sl;</span><br><span class="line">        <span class="keyword">boolean</span> c = s.red; s.red = p.red; p.red = c; <span class="comment">// swap colors</span></span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; sr = s.right;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (s == pr) &#123; <span class="comment">// p was s's direct parent</span></span><br><span class="line">            p.parent = s;</span><br><span class="line">            s.right = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            HashMap.TreeNode&lt;K,V&gt; sp = s.parent;</span><br><span class="line">            <span class="keyword">if</span> ((p.parent = sp) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (s == sp.left)</span><br><span class="line">                    sp.left = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    sp.right = p;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((s.right = pr) != <span class="keyword">null</span>)</span><br><span class="line">                pr.parent = s;</span><br><span class="line">        &#125;</span><br><span class="line">        p.left = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> ((p.right = sr) != <span class="keyword">null</span>)</span><br><span class="line">            sr.parent = p;</span><br><span class="line">        <span class="keyword">if</span> ((s.left = pl) != <span class="keyword">null</span>)</span><br><span class="line">            pl.parent = s;</span><br><span class="line">        <span class="keyword">if</span> ((s.parent = pp) == <span class="keyword">null</span>)</span><br><span class="line">            root = s;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">            pp.left = s;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = s;</span><br><span class="line">        <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">            replacement = sr;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            replacement = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pl != <span class="keyword">null</span>)</span><br><span class="line">        replacement = pl;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pr != <span class="keyword">null</span>)</span><br><span class="line">        replacement = pr;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        replacement = p;</span><br><span class="line">    <span class="keyword">if</span> (replacement != p) &#123;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; pp = replacement.parent = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (pp == <span class="keyword">null</span>)</span><br><span class="line">            root = replacement;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">            pp.left = replacement;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = replacement;</span><br><span class="line">        p.left = p.right = p.parent = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; r = p.red ? root : balanceDeletion(root, replacement);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (replacement == p) &#123;  <span class="comment">// detach</span></span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">        p.parent = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">                pp.left = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.right)</span><br><span class="line">                pp.right = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (movable)</span><br><span class="line">        moveRootToFront(tab, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†çº¢é»‘æ ‘åˆ†ä¸ºä¸¤åŠ</span></span><br><span class="line"><span class="comment"> * æ‰©å®¹æ—¶ï¼Œä¼šå°†ä¸€ä¸ªæ¡¶ä¸­çš„çº¢é»‘æ ‘æ‹†åˆ†ä¸ºä¸¤ä¸ªï¼›è‹¥æ‹†åˆ†åçº¢é»‘æ ‘ä¸å¤Ÿå¤§ï¼Œä¼šè¢«è¿˜åŸä¸ºé“¾è¡¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">split</span><span class="params">(HashMap&lt;K,V&gt; map, HashMap.Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index, <span class="keyword">int</span> bit)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; b = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// Relink into lo and hi lists, preserving order</span></span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; e = b, next; e != <span class="keyword">null</span>; e = next) &#123;</span><br><span class="line">        next = (HashMap.TreeNode&lt;K,V&gt;)e.next;</span><br><span class="line">        e.next = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash &amp; bit) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                loHead = e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                loTail.next = e;</span><br><span class="line">            loTail = e;</span><br><span class="line">            ++lc;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                hiHead = e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                hiTail.next = e;</span><br><span class="line">            hiTail = e;</span><br><span class="line">            ++hc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class="line">            tab[index] = loHead.untreeify(map);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[index] = loHead;</span><br><span class="line">            <span class="keyword">if</span> (hiHead != <span class="keyword">null</span>) <span class="comment">// (else is already treeified)</span></span><br><span class="line">                loHead.treeify(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hiHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class="line">            tab[index + bit] = hiHead.untreeify(map);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[index + bit] = hiHead;</span><br><span class="line">            <span class="keyword">if</span> (loHead != <span class="keyword">null</span>)</span><br><span class="line">                hiHead.treeify(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------------------------------------------------ */</span></span><br><span class="line"><span class="comment">// Red-black tree methods, all adapted from CLR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘çš„å·¦æ—‹</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘ç›¸å…³çŸ¥è¯†å¾…æ·±å…¥å­¦ä¹ åè¿›ä¸€æ­¥æ¢è®¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateLeft</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              HashMap.TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; r, pp, rl;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (r = p.right) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((rl = p.right = r.left) != <span class="keyword">null</span>)</span><br><span class="line">            rl.parent = p;</span><br><span class="line">        <span class="keyword">if</span> ((pp = r.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">            (root = r).red = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pp.left == p)</span><br><span class="line">            pp.left = r;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = r;</span><br><span class="line">        r.left = p;</span><br><span class="line">        p.parent = r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘çš„å³æ—‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateRight</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               HashMap.TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; l, pp, lr;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (l = p.left) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((lr = p.left = l.right) != <span class="keyword">null</span>)</span><br><span class="line">            lr.parent = p;</span><br><span class="line">        <span class="keyword">if</span> ((pp = l.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">            (root = l).red = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pp.right == p)</span><br><span class="line">            pp.right = l;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.left = l;</span><br><span class="line">        l.right = p;</span><br><span class="line">        p.parent = l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ’å…¥ç»“ç‚¹åè¿›è¡Œé‡å¹³è¡¡</span></span><br><span class="line"><span class="comment"> * è¿™éƒ¨åˆ†åªçœ‹æ‡‚ä»£ç äº†ï¼Œç®—æ³•æ¯”è¾ƒæ‡µï¼Œæœ‰æœºä¼šå†æ¢è®¨çº¢é»‘æ ‘ç®—æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceInsertion</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; root, HashMap.TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å°†æ’å…¥çš„ç»“ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">    x.red = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123;</span><br><span class="line">        <span class="comment">//xä¸ºæ ¹ç»“ç‚¹æ—¶ï¼Œè®¾ä¸ºé»‘è‰²ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//çˆ¶ç»“ç‚¹ä¸ºé»‘ä¸”ä¸ºæ ¹ç»“ç‚¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!xp.red || (xpp = xp.parent) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        <span class="comment">//çˆ¶ç»“ç‚¹ä¸ºç¥–çˆ¶ç»“ç‚¹çš„å·¦å­©å­ç»“ç‚¹æ—¶ï¼š</span></span><br><span class="line">        <span class="keyword">if</span> (xp == (xppl = xpp.left)) &#123;</span><br><span class="line">            <span class="comment">//ç¥–çˆ¶ç»“ç‚¹çš„å³å­©å­ç»“ç‚¹ä¸ºçº¢è‰²æ—¶ï¼Œå”å”ç»“ç‚¹å’Œçˆ¶ç»“ç‚¹ç½®é»‘ï¼Œç¥–çˆ¶ç»“ç‚¹ç½®çº¢ï¼Œè®¾ç½®å½“å‰ç»“ç‚¹ä¸ºç¥–çˆ¶ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> ((xppr = xpp.right) != <span class="keyword">null</span> &amp;&amp; xppr.red) &#123;</span><br><span class="line">                xppr.red = <span class="keyword">false</span>;</span><br><span class="line">                xp.red = <span class="keyword">false</span>;</span><br><span class="line">                xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                x = xpp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//å¦åˆ™ï¼Œå¦‚æœå½“å‰ç»“ç‚¹ä¸ºçˆ¶ç»“ç‚¹çš„å³å­©å­ç»“ç‚¹ï¼Œè¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                <span class="keyword">if</span> (x == xp.right) &#123;</span><br><span class="line">                    root = rotateLeft(root, x = xp);</span><br><span class="line">                    xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœçˆ¶ç»“ç‚¹ä¸ä¸ºç©ºè®¾ä¸ºé»‘è‰²ï¼Œä¸”å¦‚æœç¥–çˆ¶ç»“ç‚¹ä¸ä¸ºç©ºåˆ™è®¾ä¸ºçº¢è‰²å¹¶è¿›è¡Œå³æ—‹</span></span><br><span class="line">                <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    xp.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateRight(root, xpp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (xppl != <span class="keyword">null</span> &amp;&amp; xppl.red) &#123;</span><br><span class="line">                xppl.red = <span class="keyword">false</span>;</span><br><span class="line">                xp.red = <span class="keyword">false</span>;</span><br><span class="line">                xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                x = xpp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (x == xp.left) &#123;</span><br><span class="line">                    root = rotateRight(root, x = xp);</span><br><span class="line">                    xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    xp.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateLeft(root, xpp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ é™¤ç»“ç‚¹åè¿›è¡Œé‡å¹³è¡¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceDeletion</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                   HashMap.TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; xp, xpl, xpr;;)  &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span> || x == root)</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x.red) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((xpl = xp.left) == x) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((xpr = xp.right) != <span class="keyword">null</span> &amp;&amp; xpr.red) &#123;</span><br><span class="line">                xpr.red = <span class="keyword">false</span>;</span><br><span class="line">                xp.red = <span class="keyword">true</span>;</span><br><span class="line">                root = rotateLeft(root, xp);</span><br><span class="line">                xpr = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.right;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (xpr == <span class="keyword">null</span>)</span><br><span class="line">                x = xp;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                HashMap.TreeNode&lt;K,V&gt; sl = xpr.left, sr = xpr.right;</span><br><span class="line">                <span class="keyword">if</span> ((sr == <span class="keyword">null</span> || !sr.red) &amp;&amp;</span><br><span class="line">                        (sl == <span class="keyword">null</span> || !sl.red)) &#123;</span><br><span class="line">                    xpr.red = <span class="keyword">true</span>;</span><br><span class="line">                    x = xp;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sr == <span class="keyword">null</span> || !sr.red) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sl != <span class="keyword">null</span>)</span><br><span class="line">                            sl.red = <span class="keyword">false</span>;</span><br><span class="line">                        xpr.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateRight(root, xpr);</span><br><span class="line">                        xpr = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                                <span class="keyword">null</span> : xp.right;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xpr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpr.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = xpr.right) != <span class="keyword">null</span>)</span><br><span class="line">                            sr.red = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>;</span><br><span class="line">                        root = rotateLeft(root, xp);</span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// symmetric</span></span><br><span class="line">            <span class="keyword">if</span> (xpl != <span class="keyword">null</span> &amp;&amp; xpl.red) &#123;</span><br><span class="line">                xpl.red = <span class="keyword">false</span>;</span><br><span class="line">                xp.red = <span class="keyword">true</span>;</span><br><span class="line">                root = rotateRight(root, xp);</span><br><span class="line">                xpl = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.left;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (xpl == <span class="keyword">null</span>)</span><br><span class="line">                x = xp;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                HashMap.TreeNode&lt;K,V&gt; sl = xpl.left, sr = xpl.right;</span><br><span class="line">                <span class="keyword">if</span> ((sl == <span class="keyword">null</span> || !sl.red) &amp;&amp;</span><br><span class="line">                        (sr == <span class="keyword">null</span> || !sr.red)) &#123;</span><br><span class="line">                    xpl.red = <span class="keyword">true</span>;</span><br><span class="line">                    x = xp;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sl == <span class="keyword">null</span> || !sl.red) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">                            sr.red = <span class="keyword">false</span>;</span><br><span class="line">                        xpl.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateLeft(root, xpl);</span><br><span class="line">                        xpl = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                                <span class="keyword">null</span> : xp.left;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpl.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                        <span class="keyword">if</span> ((sl = xpl.left) != <span class="keyword">null</span>)</span><br><span class="line">                            sl.red = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>;</span><br><span class="line">                        root = rotateRight(root, xp);</span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥çº¢é»‘æ ‘ç»“æ„æ˜¯å¦æ­£å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">checkInvariants</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; t)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; tp = t.parent, tl = t.left, tr = t.right,</span><br><span class="line">            tb = t.prev, tn = (HashMap.TreeNode&lt;K,V&gt;)t.next;</span><br><span class="line">    <span class="keyword">if</span> (tb != <span class="keyword">null</span> &amp;&amp; tb.next != t)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tn != <span class="keyword">null</span> &amp;&amp; tn.prev != t)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tp != <span class="keyword">null</span> &amp;&amp; t != tp.left &amp;&amp; t != tp.right)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; (tl.parent != t || tl.hash &gt; t.hash))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; (tr.parent != t || tr.hash &lt; t.hash))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (t.red &amp;&amp; tl != <span class="keyword">null</span> &amp;&amp; tl.red &amp;&amp; tr != <span class="keyword">null</span> &amp;&amp; tr.red)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tl))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tr))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2018/09/24/Java-8-HashMap-ä¸Š-â€”â€”-çº¢é»‘æ ‘/IMG_1756.GIF"><p>Java8çš„HashMapè§£è¯»æš‚å‘Šä¸€æ®µè½ï¼Œä¸‹æœŸç»§ç»­æ¢è®¨å…¶ä»–ç‰¹æ€§ï¼Œå¸Œæœ›ä¸è¦å¤ªä¹…ğŸ˜‚</p><p><a href="https://y.qq.com/n/yqq/song/004dbfuf1jEjpI.html#stat=y_new.index.new_song.songname" target="_blank" rel="noopener">https://y.qq.com/n/yqq/song/004dbfuf1jEjpI.html#stat=y_new.index.new_song.songname</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š10åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;Java8çš„æœ€å¤§ç‰¹æ€§æ˜¯ä½¿ç”¨çº¢é»‘æ ‘ç»“æ„æ¥å­˜å‚¨æ¯ä¸ªï¼ˆæ¡¶ï¼‰buc
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="HashMap" scheme="https://jasonsonghoho.github.io/public/tags/HashMap/"/>
    
      <category term="çº¢é»‘æ ‘" scheme="https://jasonsonghoho.github.io/public/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/"/>
    
  </entry>
  
  <entry>
    <title>Java 8 HashMap(ä¸‹)â€”â€” compute</title>
    <link href="https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMap%EF%BC%88%E4%B8%8B%EF%BC%89%E2%80%94%E2%80%94%20compute/"/>
    <id>https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMapï¼ˆä¸‹ï¼‰â€”â€” compute/</id>
    <published>2018-09-23T16:19:04.000Z</published>
    <updated>2018-10-04T07:57:06.137Z</updated>
    
    <content type="html"><![CDATA[<img src="/2018/09/24/Java-8-HashMapï¼ˆä¸‹ï¼‰â€”â€”%20compute/IMG_0011.JPG" title="æ•…ä¹¡çš„æœˆ"><p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š5åˆ†é’Ÿ</em></p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>æœ¬ç¯‡æ¥ä¸Šç¯‡ <a href="https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMap-%E4%B8%8A-%E2%80%94%E2%80%94-%E7%BA%A2%E9%BB%91%E6%A0%91/">Java 8 HashMap (ä¸Š)â€”â€” çº¢é»‘æ ‘</a>ï¼Œ<br>ç»§ç»­æ¢è®¨ Java8 çš„HashMap çš„æ–°ç‰¹æ€§ã€‚å†…å®¹ä¸å¤šï¼Œé‡ç‚¹ä»‹ç» compute æ–¹æ³•ã€‚</p><h3 id="compute"><a href="#compute" class="headerlink" title="compute"></a>compute</h3><p>compute æ–¹æ³•ä¸»è¦ç”¨æ¥å°†ä¸€ä¸ªå¤æ‚è®¡ç®—çš„ç»“æœä½œä¸ºå€¼èµ‹ç»™æŒ‡å®šçš„é”®ã€‚key æŒ‡å¾…ä¿®æ”¹æˆ–æ’å…¥çš„é”®ï¼ŒremappingFunction æ˜¯ä¸€ä¸ª BiFunction å¯¹è±¡ã€‚<br>BiFunction æ˜¯æŒ‡ä¸€ä¸ª äºŒå…ƒï¼ˆbinaryï¼‰å‡½æ•°ï¼›å®šä¹‰æ—¶ï¼ŒæŒ‡å®šä¸¤ä¸ªå…¥å‚å­—æ®µç±»å‹å’Œä¸€ä¸ªç»“æœå­—æ®µç±»å‹ã€‚é€šè¿‡å®ç° apply æ–¹æ³•æ¥è‡ªå®šä¹‰è®¡ç®—é€»è¾‘ã€‚</p><p>BiFunction éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BiFunction</span>&lt;<span class="title">T</span>, <span class="title">U</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Applies this function to the given arguments.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the first function argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> u the second function argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the function result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">R <span class="title">apply</span><span class="params">(T t, U u)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>compute æ–¹æ³•æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">compute</span><span class="params">(K key, BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; t = <span class="keyword">null</span>;</span><br><span class="line">    Node&lt;K,V&gt; old = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; threshold || (tab = table) == <span class="keyword">null</span> ||</span><br><span class="line">        (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//æ ¹æ® key å€¼ï¼Œæ‰¾åˆ°å¯¹åº”çš„ æ—§å€¼</span></span><br><span class="line">    <span class="keyword">if</span> ((first = tab[i = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            old = (t = (TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt; e = first; K k;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    old = e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ++binCount;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    V oldValue = (old == <span class="keyword">null</span>) ? <span class="keyword">null</span> : old.value;</span><br><span class="line">    <span class="comment">//è®¡ç®—å‡ºæ–°å€¼</span></span><br><span class="line">    V v = remappingFunction.apply(key, oldValue);</span><br><span class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">            old.value = v;</span><br><span class="line">            afterNodeAccess(old);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ–°å€¼ä¸º nullï¼Œåˆ æ‰è¿™ä¸ª Node</span></span><br><span class="line">            removeNode(hash, key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæ–°å€¼ä¸ä¸º nullï¼Œæ›¿æ¢è¿™ä¸ª Node</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>)</span><br><span class="line">            t.putTreeVal(<span class="keyword">this</span>, tab, hash, key, v);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[i] = newNode(hash, key, v, first);</span><br><span class="line">            <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                treeifyBin(tab, hash);</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        ++size;</span><br><span class="line">        afterNodeInsertion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>computeIfAbsentã€computeIfPresent æ–¹æ³•ä¸ compute ç±»ä¼¼ï¼Œåˆ†åˆ«è¡¨ç¤ºå½“ç›¸åº”é”®çš„å€¼ç¼ºå¸­ã€å­˜åœ¨æ—¶ï¼Œæ‰è¿›è¡Œ compute æ–¹æ³•ã€‚<br>æºç ä¸ compute åŸºæœ¬ä¸€è‡´ï¼Œä¸èµ˜è¿°ã€‚</p><p>demo å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, String&gt; hashMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    hashMap.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">    hashMap.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line">    hashMap.put(<span class="string">"k3"</span>, <span class="string">"v3"</span>);</span><br><span class="line">    Function&lt;String, String&gt; function = <span class="keyword">new</span> Function&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"test_"</span> + s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    BiFunction&lt;String, String, String&gt; biFunction = <span class="keyword">new</span> BiFunction&lt;String, String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(String s, String s2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"test_"</span> + s + <span class="string">"_"</span> + s2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    hashMap.compute(<span class="string">"k1"</span>, biFunction);<span class="comment">//ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.compute(<span class="string">"k11"</span>, biFunction);<span class="comment">//ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.computeIfAbsent(<span class="string">"k2"</span>, function);<span class="comment">//ä¸ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.computeIfAbsent(<span class="string">"k21"</span>, function);<span class="comment">//ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.computeIfPresent(<span class="string">"k3"</span>, biFunction);<span class="comment">//ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.computeIfPresent(<span class="string">"k31"</span>, biFunction);<span class="comment">//ä¸ç”Ÿæ•ˆ</span></span><br><span class="line">    System.out.println(hashMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;k1=test_k1_v1, k2=v2, k3=test_k3_v3, k11=test_k11_null, k21=test_k21&#125;</span><br></pre></td></tr></table></figure></p><h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><p>merge æ–¹æ³•æ˜¯æ ¹æ®æ—§å€¼è¿›è¡Œè®¡ç®—ï¼Œä¿®æ”¹ç›¸åº” Nodeã€‚ä¸ compute ç»“æ„ç›¸ä¼¼ï¼Œä¸è¿‡ BiFunction å…¥å‚ä¸º oldValue,newValueã€‚<br>æºç ä¸ compute åŸºæœ¬ä¸€è‡´ï¼Œä¸èµ˜è¿°ã€‚</p><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å…¶ä»–æ–°å¢çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">getOrDefault</span><span class="params">(Object key, V defaultValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? defaultValue : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">putIfAbsent</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> removeNode(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e; V v;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        ((v = e.value) == oldValue || (v != <span class="keyword">null</span> &amp;&amp; v.equals(oldValue)))) &#123;</span><br><span class="line">        e.value = newValue;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        V oldValue = e.value;</span><br><span class="line">        e.value = value;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>getOrDefault æ–¹æ³•æ ¹æ® key è·å–ç›¸åº”çš„å€¼ï¼Œå¦‚æœä¸º nullï¼Œåˆ™è¿”å›è®¾ç½®çš„é»˜è®¤å€¼ã€‚</li><li>putIfAbsent æ–¹æ³•ä¼šåœ¨ æŒ‡å®šçš„ key ä¸å­˜åœ¨æ—¶ï¼Œæ’å…¥ç›¸åº”çš„å€¼ã€‚</li><li>remove(Object key, Object value) æ–¹æ³•ä¼šæ ¹æ® key å’Œ value è¿›è¡Œåˆ é™¤ï¼Œå¦‚æœ ç›¸åº” key çš„å€¼ä¸ä¸ºè¯¥ valueï¼Œåˆ™ä¸æ‰§è¡Œåˆ é™¤å¹¶è¿”å› falseã€‚</li><li>replace(K key, V oldValue, V newValue) ä¸ replace(K key, V value) éƒ½æ˜¯æ›¿æ¢å€¼çš„æ“ä½œï¼Œå…·ä½“åŒºåˆ«ä¸ä¸Šè¿°æ–¹æ³•ç±»ä¼¼ã€‚</li></ol><h3 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h3><p>HashMapå†æ—¶ä¸€ä¸ªåŠæœˆï¼Œç»ˆäºå‘Šä¸€æ®µè½äº†ğŸ˜‚ã€‚</p><p>ç”±äºåœ¨æºç åˆ†æç³»åˆ—å«æœ‰å¤§é‡ä»£ç ï¼Œæ”¾åœ¨å…¬ä¼—å·ä¸Šä¸æ–¹ä¾¿é˜…è¯»ï¼Œåç»­å†™çš„è¯ä¼šå‘åœ¨åšå®¢ä¸Šã€‚æœ‰å…´è¶£çš„æ¬¢è¿è®¿é—® <a href="http://jasonsonghoho.github.io">http://jasonsonghoho.github.io</a> ã€‚</p><hr><img src="/2018/09/24/Java-8-HashMapï¼ˆä¸‹ï¼‰â€”â€”%20compute/IMG_0007.JPG"><p><em>â€œä½ ä¸çŸ¥<br>è¿™é£é›ªä¸€ç¨‹<br>æœ‰å¤ªå¤šä¸æ˜“â€</em></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/2018/09/24/Java-8-HashMapï¼ˆä¸‹ï¼‰â€”â€”%20compute/IMG_0011.JPG&quot; title=&quot;æ•…ä¹¡çš„æœˆ&quot;&gt;
&lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š5åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="HashMap" scheme="https://jasonsonghoho.github.io/public/tags/HashMap/"/>
    
  </entry>
  
  <entry>
    <title>Java 7 HashMap æºç è§£è¯»</title>
    <link href="https://jasonsonghoho.github.io/2018/08/18/Java-7-HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    <id>https://jasonsonghoho.github.io/2018/08/18/Java-7-HashMap-æºç è§£è¯»/</id>
    <published>2018-08-18T02:31:46.000Z</published>
    <updated>2018-09-22T02:33:29.034Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/nHk9jKapNVVkBDnKChgK0Q" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/nHk9jKapNVVkBDnKChgK0Q</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/nHk9jKapNVVkBDnKChgK0Q&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/nHk9jKapNVVkBDn
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="HashMap" scheme="https://jasonsonghoho.github.io/public/tags/HashMap/"/>
    
  </entry>
  
  <entry>
    <title>Reactå¿«é€Ÿå…¥é—¨</title>
    <link href="https://jasonsonghoho.github.io/2018/06/24/React%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>https://jasonsonghoho.github.io/2018/06/24/Reactå¿«é€Ÿå…¥é—¨/</id>
    <published>2018-06-24T02:34:27.000Z</published>
    <updated>2018-09-22T02:52:12.539Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/fDXQe_QCBN4q6zfzKQr1jQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/fDXQe_QCBN4q6zfzKQr1jQ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/fDXQe_QCBN4q6zfzKQr1jQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/fDXQe_QCBN4q6zf
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://jasonsonghoho.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="React" scheme="https://jasonsonghoho.github.io/public/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨ç‰©å›­ç®¡ç†å‘˜â€”â€”ZooKeeper</title>
    <link href="https://jasonsonghoho.github.io/2018/06/05/%E5%8A%A8%E7%89%A9%E5%9B%AD%E7%AE%A1%E7%90%86%E5%91%98%E2%80%94%E2%80%94ZooKeeper/"/>
    <id>https://jasonsonghoho.github.io/2018/06/05/åŠ¨ç‰©å›­ç®¡ç†å‘˜â€”â€”ZooKeeper/</id>
    <published>2018-06-05T02:35:00.000Z</published>
    <updated>2018-09-22T02:52:12.560Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/hnfWq1sHD8qxKoXHKwJhiw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/hnfWq1sHD8qxKoXHKwJhiw</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/hnfWq1sHD8qxKoXHKwJhiw&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/hnfWq1sHD8qxKoX
      
    
    </summary>
    
      <category term="ä¸­é—´ä»¶" scheme="https://jasonsonghoho.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="ZooKeeper" scheme="https://jasonsonghoho.github.io/public/tags/ZooKeeper/"/>
    
  </entry>
  
  <entry>
    <title>MySQLç©¶ç«Ÿå¦‚ä½•è§£å†³â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€çš„</title>
    <link href="https://jasonsonghoho.github.io/2018/05/27/MySQL%E7%A9%B6%E7%AB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E2%80%9C%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E2%80%9D%E5%92%8C%E2%80%9C%E5%B9%BB%E8%AF%BB%E2%80%9D%E7%9A%84/"/>
    <id>https://jasonsonghoho.github.io/2018/05/27/MySQLç©¶ç«Ÿå¦‚ä½•è§£å†³â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€çš„/</id>
    <published>2018-05-26T16:35:44.000Z</published>
    <updated>2018-09-22T02:30:44.066Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/Ej3coEuouPqbzkL0-J8tIQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Ej3coEuouPqbzkL0-J8tIQ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/Ej3coEuouPqbzkL0-J8tIQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/Ej3coEuouPqbzkL
      
    
    </summary>
    
      <category term="æ•°æ®åº“" scheme="https://jasonsonghoho.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="mysql" scheme="https://jasonsonghoho.github.io/public/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>æˆ‘ä»¬ä¸ºæå‡ Cassandra è¯»æ€§èƒ½åšäº†å“ªäº›åŠªåŠ›ï¼Ÿ</title>
    <link href="https://jasonsonghoho.github.io/2018/05/21/180521/"/>
    <id>https://jasonsonghoho.github.io/2018/05/21/180521/</id>
    <published>2018-05-21T14:08:41.000Z</published>
    <updated>2018-09-20T15:23:28.340Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><ul><li>å…³äºCassandra</li><li>æå‡è¯»æ€§èƒ½</li></ul><h2 id="å…³äºCassandra"><a href="#å…³äºCassandra" class="headerlink" title="å…³äºCassandra"></a>å…³äºCassandra</h2><p>Apache Cassandraæ˜¯ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œ<br>ç”¨äºå¤„ç†å¤§é‡å¸¸è§„æœåŠ¡å™¨ä¸Šçš„å¤§é‡æ•°æ®ï¼Œæä¾›é«˜å¯ç”¨æ€§ï¼Œæ— å•ç‚¹æ•…éšœã€‚å®ƒæ˜¯ä¸€ç§NoSQLç±»å‹çš„æ•°æ®åº“ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å›½å¤–æƒå¨æœºæ„<a href="https://db-engines.com/en/ranking" target="_blank" rel="noopener">DB-Engines</a>æœ€è¿‘çš„æ•°æ®åº“å…¨çƒæµè¡Œç¨‹åº¦æ’åï¼š</p><img src="/2018/05/21/180521/database_rank.png" title="æ•°æ®åº“æ’å"><p>å¯ä»¥çœ‹å‡ºï¼ŒCassandra æ˜¯æ’åå‰åä¸­å››ä¸ªä»…æœ‰çš„NoSQLæ•°æ®åº“ä¹‹ä¸€ã€‚Cassandraåœ¨å›½å¤–è¿™æ ·å—æ¬¢è¿ï¼Œå…¶æ€§èƒ½å¯æƒ³è€ŒçŸ¥ä¸ä¼šå·®ï¼Œ<br>ä½†æ˜¯åœ¨å›½å†…è²Œä¼¼è¿˜æ²¡æœ‰å¤šå°‘å…¬å¸ä½¿ç”¨ï¼Œä¸”å›½å†…å…³äº Cassandraæ–¹é¢çš„èµ„æ–™è¾ƒå°‘ã€‚</p><h2 id="æå‡è¯»æ€§èƒ½"><a href="#æå‡è¯»æ€§èƒ½" class="headerlink" title="æå‡è¯»æ€§èƒ½"></a>æå‡è¯»æ€§èƒ½</h2><p>Cassandra åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ç”¨æ¥å­˜å‚¨æ—¶åºæ•°æ®ï¼Œç»è¿‡æµ‹è¯•ï¼Œåœ¨ä¸‰å°4æ ¸16Gçš„è™šæ‹Ÿæœºä¸Šï¼Œ<br>æŒ‡æ ‡æ•°æ®çš„å†™å…¥TPSå¯ä»¥è¾¾åˆ°6.5W/sï¼ŒåŸºæœ¬å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ã€‚<br>ä½†æ˜¯è¯»å–æ€§èƒ½å¯èƒ½å°±ä¼šå·®å¾ˆå¤šï¼Œå› ä¸ºæ•°æ®æŸ¥è¯¢é€Ÿåº¦è·Ÿæ¯æ¬¡æŸ¥è¯¢çš„æ•°æ®é‡å…³ç³»æ¯”è¾ƒå¤§ï¼Œæ­¤å¤„ä¹Ÿä¸å¥½å®šä¹‰TPSã€‚<br>äº§å“æŸ¥è¯¢ä¸€å‘¨ä»¥ä¸Šçš„æŒ‡æ ‡æ•°æ®æ—¶ï¼Œç»å¸¸ä¼šå‡ºç°åŠ è½½ç¼“æ…¢ï¼Œç”šè‡³æŸ¥è¯¢è¶…æ—¶ã€‚ä¸ºäº†æ”¹å–„æŸ¥è¯¢çŠ¶å†µï¼Œæˆ‘ä»¬è¿›è¡Œäº†ä¸å°‘åŠªåŠ›ã€‚</p><p>æ­¤å¤„ä¸è®¨è®ºçºµå‘æ‰©å±•å’Œæ¨ªå‘æ‰©å±•å¸¦æ¥çš„æ€§èƒ½æå‡ã€‚</p><h3 id="1-åŠ å¿«å¢“ç¢‘å›æ”¶ç”šè‡³å»é™¤å¢“ç¢‘"><a href="#1-åŠ å¿«å¢“ç¢‘å›æ”¶ç”šè‡³å»é™¤å¢“ç¢‘" class="headerlink" title="1. åŠ å¿«å¢“ç¢‘å›æ”¶ç”šè‡³å»é™¤å¢“ç¢‘"></a>1. åŠ å¿«å¢“ç¢‘å›æ”¶ç”šè‡³å»é™¤å¢“ç¢‘</h3><p>åœ¨Cassandraä¸­ï¼Œå½“ä½ åˆ é™¤ä¸€æ¡æ•°æ®æ—¶ï¼Œå…¶å®æ˜¯ç»™è¿™æ¡æ•°æ®è¿›è¡Œupdateï¼Œç»™å®ƒupdateä¸Šä¸€ä¸ªæ ‡è¯†ï¼Œå°±æ˜¯ä¸€ä¸ªå¢“ç¢‘æ ‡è¯†ã€‚<br> å½“Cassandraé›†ç¾¤åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´åŒæ­¥åˆ é™¤ä¿¡æ¯çš„æ—¶å€™ï¼Œä¹Ÿä¼šç”¨åˆ°Tombstones(å¢“ç¢‘)ï¼Œå¯ä»¥è¯´å¢“ç¢‘æ˜¯ä¸€ç§å…è®¸Cassandraå¿«é€Ÿå†™å…¥çš„æœºåˆ¶ã€‚</p><p>å…³äºå¢“ç¢‘çš„æ›´å¤šæ¶ˆæ¯ï¼Œå¯å‚è€ƒ <a href="https://docs.datastax.com/en/Cassandra/3.0/Cassandra/dml/dmlHowDataMaintain.html" target="_blank" rel="noopener">Cassandra æ•°æ®ç»´æŠ¤å®˜æ–¹æ–‡æ¡£</a></p><p>å¯ä»¥è¿™æ ·ç†è§£ï¼Œå¤§é‡çš„å¢“ç¢‘æ•°æ®ä¼šä½¿æŸ¥è¯¢æ—¶æœç´¢çš„æ•°æ®é‡å˜å¤§ï¼Œç›´æ¥å½±å“æŸ¥è¯¢æ—¶çš„æ•ˆç‡ã€‚<br>æ‰€ä»¥ï¼Œä¸ºäº†æ¶ˆé™¤è¿™ç§å½±å“ï¼Œæˆ‘ä»¬å¯ä»¥åŠ å¿«å¢“ç¢‘æ•°æ®çš„å›æ”¶ï¼Œé¿å…äº§ç”Ÿå¤§é‡çš„å¢“ç¢‘æ•°æ®ã€‚<br>ç”šè‡³ï¼Œå½“æˆ‘ä»¬åœ¨å†™å…¥æ—¶ï¼Œè‹¥å†™å…¥ä¸€è‡´æ€§çš„å€¼ä¸å‰¯æœ¬å› å­æ•°é‡ç›¸ç­‰æ—¶ï¼Œå¯ä»¥ä¸äº§ç”Ÿå¢“ç¢‘æ•°æ®ï¼Œç›´æ¥åˆ æ‰è¯¥æ— æ•ˆæ•°æ®ã€‚<br>å…·ä½“å¯é€šè¿‡ è°ƒæ•´ table ä¸­ gc_grace_seconds å‚æ•°æ¥å®ç°ï¼Œé»˜è®¤ä¸º 864000ï¼ˆ10å¤©ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ä¸º 86400ï¼ˆ1å¤©ï¼‰æˆ–è€…0ï¼ˆç›´æ¥åˆ é™¤ï¼‰ã€‚</p><h3 id="2-é™ä½read-repair-çš„å‡ ç‡"><a href="#2-é™ä½read-repair-çš„å‡ ç‡" class="headerlink" title="2. é™ä½read repair çš„å‡ ç‡"></a>2. é™ä½read repair çš„å‡ ç‡</h3><p>æ¯ä¸€æ¬¡è¯»æ“ä½œï¼ŒCassandraéƒ½ä¼šåœ¨åå°è¿›è¡Œread repairæ“ä½œã€‚<br>å¦‚æœåªè¦æ±‚è¯»ä¸€ä¸ªèŠ‚ç‚¹æ•°æ®ï¼ŒCassandraåœ¨è¯»åˆ°ä¸€ä¸ªèŠ‚ç‚¹åï¼Œå°±å°†ç»“æœè¿”å›å®¢æˆ·ç«¯ï¼Œ<br>ç„¶åç”¨read repairå¯¹å…¶ä»–çš„replicasè¿›è¡ŒåŒæ­¥ï¼ˆæ ¹æ®timestampï¼‰ã€‚<br>å¦‚æœè¦æ±‚è¯»å¤šä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆCassandraå°±è¯»å¤šä¸ªèŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®timestampè¿›è¡Œæ¯”è¾ƒï¼Œè¿”å›å®¢æˆ·ç«¯æœ€æ–°çš„æ•°æ®ï¼Œ<br>ç„¶åå†è°ƒç”¨read repairå¯¹å…¶ä»–èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ã€‚<br>Read repairåœ¨åå°çš„æ“ä½œï¼Œä¼šå ç”¨ä¸€å®šçš„CPUå’ŒI/O,æ‰€ä»¥å½±å“è¯»æ€§èƒ½ã€‚<br>æˆ‘ä»¬å¯ä»¥é™ä½read repair çš„å‡ ç‡ï¼Œä»¥æé«˜è¯»å–æ€§èƒ½ã€‚</p><p>é€šè¿‡ä¿®æ”¹ table ä¸­ read_repair_chanceï¼ˆå–å€¼èŒƒå›´ 0-1ï¼‰å‚æ•°æ¥è®¾ç½®read repair çš„å‡ ç‡ï¼Œå»ºè®®è®¾ä¸º 0.1ã€‚</p><h3 id="3-æŒ‡æ ‡æ•°æ®é¢„èšåˆ"><a href="#3-æŒ‡æ ‡æ•°æ®é¢„èšåˆ" class="headerlink" title="3. æŒ‡æ ‡æ•°æ®é¢„èšåˆ"></a>3. æŒ‡æ ‡æ•°æ®é¢„èšåˆ</h3><p>æ€è·¯ï¼šæˆ‘ä»¬å­˜åœ¨æ•°æ®åº“ä¸­çš„æŒ‡æ ‡æ•°æ®ï¼Œè¯»å–æ—¶ä¼šå°†æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ•°æ®è¿›è¡Œèšåˆã€‚<br>å¦‚æœæå‰å°†æ•°æ®æŒ‰åŸºæœ¬æ—¶é—´æ®µæå‰èšåˆä¸ºä¸€ä¸ªå€¼ï¼Œè¯»å–æ—¶ï¼Œåªè¯»å–æ—¶é—´èŒƒå›´å†…çš„æ—¶é—´æ®µçš„æ±‡èšç»“æœï¼Œå°†å¤§å¤§å‡å°‘æŸ¥è¯¢è€—æ—¶ã€‚</p><h3 id="4-åˆç†éƒ¨ç½²äº§å“"><a href="#4-åˆç†éƒ¨ç½²äº§å“" class="headerlink" title="4. åˆç†éƒ¨ç½²äº§å“"></a>4. åˆç†éƒ¨ç½²äº§å“</h3><p>å…¬å¸çš„å…¶ä»–äº§å“ä½¿ç”¨äº†mongoDBï¼Œçº¿ä¸Šç¯å¢ƒä¸­å‘ç°ï¼Œè¿™ä¸¤ä¸ªNoSQLæ•°æ®åº“éƒ¨ç½²åœ¨ä¸€èµ·æ—¶ä¼šç›¸äº’äº‰å¤ºå†…å­˜èµ„æºï¼Œ<br>ååˆ†å½±å“æ€§èƒ½ï¼Œå› æ­¤æœ€å¥½å°†è¿™ä¸¤ä¸ªæ•°æ®åº“åˆ†å¼€éƒ¨ç½²ã€‚</p><h3 id="5-è®¾ç½®åˆç†çš„å †å†…å­˜å¤§å°å’ŒGCç­–ç•¥"><a href="#5-è®¾ç½®åˆç†çš„å †å†…å­˜å¤§å°å’ŒGCç­–ç•¥" class="headerlink" title="5. è®¾ç½®åˆç†çš„å †å†…å­˜å¤§å°å’ŒGCç­–ç•¥"></a>5. è®¾ç½®åˆç†çš„å †å†…å­˜å¤§å°å’ŒGCç­–ç•¥</h3><p>å †å†…å­˜è®¾ç½®çš„å¤ªå°ï¼Œå°†å¯¼è‡´é¢‘ç¹GCç”šè‡³OOMï¼Œè®¾ç½®çš„å¤ªå¤§åŒæ ·ä¹Ÿä¸å¥½ã€‚å¯å‚è€ƒå®˜æ–¹çš„å…¬å¼:<br><code>MAX_HEAP_SIZE=max(min(1/2 ram, 1024MB), min(1/4 ram, 8GB)</code></p><p>å…³äºGCç­–ç•¥ï¼Œå®˜æ–¹çš„å»ºè®®æ˜¯ï¼šå°äº16Gï¼Œç”¨CMSæ”¶é›†å™¨ï¼›16-64Gï¼Œç”¨G1æ”¶é›†å™¨ã€‚</p><h3 id="6-è®¾ç½®åˆç†çš„å‹å¼ç­–ç•¥"><a href="#6-è®¾ç½®åˆç†çš„å‹å¼ç­–ç•¥" class="headerlink" title="6. è®¾ç½®åˆç†çš„å‹å¼ç­–ç•¥"></a>6. è®¾ç½®åˆç†çš„å‹å¼ç­–ç•¥</h3><p>Cassandra å°†è½åˆ°ç£ç›˜çš„æ•°æ®å­˜æ”¾åœ¨SStableä¸­ï¼Œå‹å®æ˜¯å°†å¤šä¸ªSSTable æ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªçš„è¿‡ç¨‹ã€‚åˆå¹¶åå°†å‡å°‘é‡å¤çš„æ•°æ®ï¼Œä½¿æ•°æ®æ›´ç´§å‡‘ã€‚<br>Cassandra æœ‰å¤šç§è§¦å‘å‹å®çš„ç­–ç•¥ï¼Œé€‰ä¸€ä¸ªé€‚åˆçš„å‹å®ç­–ç•¥ï¼Œå¯ä»¥æ›´å¥½åœ°å‹å®æ•°æ®ã€‚<br>æ¯”å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„Kairosdbå»ºè®®é‡‡ç”¨ DateTieredCompactionStrategy (<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataMaintain.html#dmlHowDataMaintain__dtcs-compaction" target="_blank" rel="noopener">DTCS</a>))å‹å®ç­–ç•¥ã€‚</p><h3 id="7-å¯ç”¨-row-cache"><a href="#7-å¯ç”¨-row-cache" class="headerlink" title="7. å¯ç”¨ row cache"></a>7. å¯ç”¨ row cache</h3><p>row cache æŠŠæ•´ä¸ªrow çš„å†…å®¹éƒ½æ”¾åœ¨å†…å­˜ä¸­ã€‚<br>é€‚åˆçš„æƒ…å†µæ˜¯ï¼Œæœ‰ä¸€å°éƒ¨åˆ†hot dataæ˜¯ç»å¸¸åé—®çš„ï¼Œæˆ–è€…è¦è¿”å›æ•´ä¸ªcolumns.åœ¨ä½¿ç”¨row cacheæ—¶ï¼Œç”¨æ³¨æ„å®ƒå¯¹å†…å­˜çš„å½±å“ã€‚<br>å¯å‚è€ƒ Cassandra çš„<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/operations/opsConfiguringCaches.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>è®¾ç½®row cacheã€‚</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>å®‰åˆ©ä¸€ä¸ªå…¥é—¨Cassandra çš„å¥½åšå®¢ï¼š<a href="http://teddymaef.github.io/learnCassandra/cn/" target="_blank" rel="noopener">learn Cassandra</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of Contents)&quot;&gt;&lt;/a&gt; &lt;strong&gt;ç›®å½• (Table of C
      
    
    </summary>
    
      <category term="æ•°æ®åº“" scheme="https://jasonsonghoho.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="cassandra" scheme="https://jasonsonghoho.github.io/public/tags/cassandra/"/>
    
      <category term="å¤§æ•°æ®" scheme="https://jasonsonghoho.github.io/public/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
  </entry>
  
  <entry>
    <title>Linuxä¸­çš„topå‘½ä»¤è¯¦è§£</title>
    <link href="https://jasonsonghoho.github.io/2018/05/20/Linux%E4%B8%AD%E7%9A%84top%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/"/>
    <id>https://jasonsonghoho.github.io/2018/05/20/Linuxä¸­çš„topå‘½ä»¤è¯¦è§£/</id>
    <published>2018-05-20T02:41:23.000Z</published>
    <updated>2018-09-22T02:52:12.563Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/xyYn6xaahQ4hv1y9MM-7JA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/xyYn6xaahQ4hv1y9MM-7JA</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/xyYn6xaahQ4hv1y9MM-7JA&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/xyYn6xaahQ4hv1y
      
    
    </summary>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/categories/Linux/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/public/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux çš„ Cacheã€Bufferã€MemAvailableã€Swapç®€ä»‹</title>
    <link href="https://jasonsonghoho.github.io/2018/05/20/Linux-%E7%9A%84-Cache%E3%80%81Buffer%E3%80%81MemAvailable%E3%80%81Swap%E7%AE%80%E4%BB%8B/"/>
    <id>https://jasonsonghoho.github.io/2018/05/20/Linux-çš„-Cacheã€Bufferã€MemAvailableã€Swapç®€ä»‹/</id>
    <published>2018-05-20T02:40:08.000Z</published>
    <updated>2018-09-22T02:52:12.543Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/59oH1hMMXy6YC618gZkm1g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/59oH1hMMXy6YC618gZkm1g</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/59oH1hMMXy6YC618gZkm1g&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/59oH1hMMXy6YC61
      
    
    </summary>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/categories/Linux/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/public/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>å…‹æ‹‰ä¸çš„é¢è¯•</title>
    <link href="https://jasonsonghoho.github.io/2018/05/13/%E5%85%8B%E6%8B%89%E4%B8%9D%E7%9A%84%E9%9D%A2%E8%AF%95/"/>
    <id>https://jasonsonghoho.github.io/2018/05/13/å…‹æ‹‰ä¸çš„é¢è¯•/</id>
    <published>2018-05-13T02:39:39.000Z</published>
    <updated>2018-09-22T02:52:46.942Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/boQUsfwjf0pPtcU_mAUWbA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/boQUsfwjf0pPtcU_mAUWbA</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/boQUsfwjf0pPtcU_mAUWbA&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/boQUsfwjf0pPtcU
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="JVM" scheme="https://jasonsonghoho.github.io/public/tags/JVM/"/>
    
      <category term="ç±»åŠ è½½" scheme="https://jasonsonghoho.github.io/public/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>å·¥å‚æ¨¡å¼ã€ç®€å•å·¥å‚æ¨¡å¼ä¸æŠ½è±¡å·¥å‚æ¨¡å¼</title>
    <link href="https://jasonsonghoho.github.io/2018/05/10/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E3%80%81%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <id>https://jasonsonghoho.github.io/2018/05/10/å·¥å‚æ¨¡å¼ã€ç®€å•å·¥å‚æ¨¡å¼ä¸æŠ½è±¡å·¥å‚æ¨¡å¼/</id>
    <published>2018-05-10T02:39:16.000Z</published>
    <updated>2018-09-22T02:52:12.556Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/ccNz_veqyb4UYBpH-UpZfA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ccNz_veqyb4UYBpH-UpZfA</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/ccNz_veqyb4UYBpH-UpZfA&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/ccNz_veqyb4UYBp
      
    
    </summary>
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="https://jasonsonghoho.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="https://jasonsonghoho.github.io/public/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>å›­ä¸ä¸ç›†æ ½ï¼ˆJVM åƒåœ¾å›æ”¶ï¼‰</title>
    <link href="https://jasonsonghoho.github.io/2018/05/01/%E5%9B%AD%E4%B8%81%E4%B8%8E%E7%9B%86%E6%A0%BD/"/>
    <id>https://jasonsonghoho.github.io/2018/05/01/å›­ä¸ä¸ç›†æ ½/</id>
    <published>2018-05-01T02:38:55.000Z</published>
    <updated>2018-09-22T02:52:12.553Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/2GO3Sc4mD8BVN3PnfJQixg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/2GO3Sc4mD8BVN3PnfJQixg</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/2GO3Sc4mD8BVN3PnfJQixg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/2GO3Sc4mD8BVN3P
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="JVM" scheme="https://jasonsonghoho.github.io/public/tags/JVM/"/>
    
      <category term="GC" scheme="https://jasonsonghoho.github.io/public/tags/GC/"/>
    
  </entry>
  
  <entry>
    <title>å…‹æ‹‰ä¸çš„JVMå·¥å‚ä¹‹æ—…ï¼ˆä¸Šï¼‰</title>
    <link href="https://jasonsonghoho.github.io/2018/04/15/%E5%85%8B%E6%8B%89%E4%B8%9D%E7%9A%84JVM%E5%B7%A5%E5%8E%82%E4%B9%8B%E6%97%85%EF%BC%88%E4%B8%8A%EF%BC%89/"/>
    <id>https://jasonsonghoho.github.io/2018/04/15/å…‹æ‹‰ä¸çš„JVMå·¥å‚ä¹‹æ—…ï¼ˆä¸Šï¼‰/</id>
    <published>2018-04-15T02:37:32.000Z</published>
    <updated>2018-09-22T02:52:12.549Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/X_tO5Lgjof_RTlyN_xtSHw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/X_tO5Lgjof_RTlyN_xtSHw</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/X_tO5Lgjof_RTlyN_xtSHw&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/X_tO5Lgjof_RTly
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="JVM" scheme="https://jasonsonghoho.github.io/public/tags/JVM/"/>
    
      <category term="ç±»åŠ è½½" scheme="https://jasonsonghoho.github.io/public/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>Metricä½¿ç”¨</title>
    <link href="https://jasonsonghoho.github.io/2017/12/18/2017-12-18-doc/"/>
    <id>https://jasonsonghoho.github.io/2017/12/18/2017-12-18-doc/</id>
    <published>2017-12-18T14:08:41.000Z</published>
    <updated>2018-09-22T02:49:05.202Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><ul><li>ç®€ä»‹</li><li>MAVENè®¾ç½®</li><li>The Registry</li><li>äº”ç§åº¦é‡ç±»å‹<ul><li>Gauges</li><li>Counters</li><li>Histograms</li><li>Meters</li><li>Timers</li></ul></li><li>Reporter</li><li>å¥åº·æ£€æŸ¥</li></ul><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Metricsæ˜¯ä¸€ä¸ªç»™JAVAæä¾›åº¦é‡å·¥å…·çš„åŒ…ï¼Œåœ¨JAVAä»£ç ä¸­åµŒå…¥Metricsä»£ç ï¼Œå¯ä»¥æ–¹ä¾¿çš„å¯¹ä¸šåŠ¡ä»£ç çš„å„ä¸ªæŒ‡æ ‡è¿›è¡Œç›‘æ§ã€‚<br>Metric çš„ä½¿ç”¨å¯å‚è€ƒ<a href="http://metrics.dropwizard.io/3.2.3/getting-started.html" target="_blank" rel="noopener">å®˜ç½‘</a>ã€‚</p><h2 id="MAVENè®¾ç½®"><a href="#MAVENè®¾ç½®" class="headerlink" title="MAVENè®¾ç½®"></a>MAVENè®¾ç½®</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt; </span><br><span class="line">    &lt;dependency&gt; </span><br><span class="line">        &lt;groupId&gt; io.dropwizard.metrics &lt;/ groupId&gt; </span><br><span class="line">        &lt;artifactId&gt; metrics-core &lt;/ artifactId&gt; </span><br><span class="line">        &lt;version&gt; $ &#123;metrics.version&#125; &lt;/ version&gt; </span><br><span class="line">    &lt;/ dependency&gt; </span><br><span class="line">&lt;/ dependencies&gt;</span><br></pre></td></tr></table></figure><h2 id="The-Registry"><a href="#The-Registry" class="headerlink" title="The Registry"></a>The Registry</h2><p>Metricsçš„æ ¸å¿ƒæ˜¯MetricRegistryç±»ï¼Œå®ƒæ˜¯æ‰€æœ‰åº”ç”¨ç¨‹åºæŒ‡æ ‡çš„å®¹å™¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">final MetricRegistry metrics = new MetricRegistry();</span><br></pre></td></tr></table></figure><h2 id="äº”ç§åº¦é‡ç±»å‹"><a href="#äº”ç§åº¦é‡ç±»å‹" class="headerlink" title="äº”ç§åº¦é‡ç±»å‹"></a>äº”ç§åº¦é‡ç±»å‹</h2><h3 id="Gauges"><a href="#Gauges" class="headerlink" title="Gauges"></a>Gauges</h3><p>æœ€åŸºæœ¬çš„åº¦é‡æŒ‡æ ‡ï¼Œè¿”å›ä¸€ä¸ªå€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class QueueManager &#123;</span><br><span class="line">    private final Queue queue;</span><br><span class="line"></span><br><span class="line">    public QueueManager(MetricRegistry metrics, String name) &#123;</span><br><span class="line">        this.queue = new Queue();</span><br><span class="line">        metrics.register(MetricRegistry.name(QueueManager.class, name, &quot;size&quot;),</span><br><span class="line">                         new Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">                             @Override</span><br><span class="line">                             public Integer getValue() &#123;</span><br><span class="line">                                 return queue.size();</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹é‡æ­¤é‡è¡¨æ—¶ï¼Œå°†è¿”å›é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡ã€‚</p><p>åœ¨æ³¨å†Œè¡¨ä¸­çš„æ¯ä¸ªæŒ‡æ ‡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼Œä¾‹å¦‚ â€œthings.countâ€æˆ–â€com.example.Thing.latencyâ€ã€‚MetricRegistryæœ‰ä¸€ä¸ªç”¨äºæ„é€ è¿™äº›åå­—çš„é™æ€è¾…åŠ©æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MetricRegistry.name(QueueManager.class, &quot;jobs&quot;, &quot;size&quot;)</span><br></pre></td></tr></table></figure><p>å®ƒå°†è¿”å›ä¸€ä¸ªç±»ä¼¼â€com.example.QueueManager.jobs.sizeâ€çš„å­—ç¬¦ä¸²ã€‚</p><h3 id="Counters"><a href="#Counters" class="headerlink" title="Counters"></a>Counters</h3><p>Countersåªæ˜¯ä¸€ä¸ªAtomicLongå®ä¾‹çš„è¡¡é‡æ ‡å‡†ã€‚æ‚¨å¯ä»¥å¢åŠ æˆ–å‡å°‘å…¶å€¼ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€ä¸ªæ›´æœ‰æ•ˆçš„æ–¹å¼æ¥è¡¡é‡é˜Ÿåˆ—ä¸­å¾…å¤„ç†çš„ä»»åŠ¡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private final Counter pendingJobs = metrics.counter(name(QueueManager.class, &quot;pending-jobs&quot;));</span><br><span class="line"></span><br><span class="line">public void addJob(Job job) &#123;</span><br><span class="line">    pendingJobs.inc();</span><br><span class="line">    queue.offer(job);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Job takeJob() &#123;</span><br><span class="line">    pendingJobs.dec();</span><br><span class="line">    return queue.take();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¯æ¬¡æµ‹é‡è¿™ä¸ªè®¡æ•°å™¨æ—¶ï¼Œå®ƒéƒ½ä¼šè¿”å›é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡ã€‚</p><p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼ŒCountersçš„APIç•¥æœ‰ä¸åŒï¼šç”¨ counter(String)è€Œä¸æ˜¯ register(String, Metric) ã€‚</p><h3 id="Histograms"><a href="#Histograms" class="headerlink" title="Histograms"></a>Histograms</h3><p>Histogramsï¼ˆç›´æ–¹å›¾ ï¼‰ç»Ÿè®¡ æ•°æ®æµä¸­å€¼çš„åˆ†å¸ƒã€‚é™¤äº†æœ€å°å€¼ï¼Œæœ€å¤§å€¼ï¼Œå¹³å‡å€¼ç­‰ä¹‹å¤–ï¼Œå®ƒè¿˜æµ‹é‡ä¸­å€¼ï¼Œç¬¬75,90,95,98,99å’Œ99.9ç™¾åˆ†ä½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private final Histogram responseSizes = metrics.histogram(name(RequestHandler.class, &quot;response-sizes&quot;));</span><br><span class="line"></span><br><span class="line">public void handleRequest(Request request, Response response) &#123;</span><br><span class="line">    // etc</span><br><span class="line">    responseSizes.update(response.getContent().length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç›´æ–¹å›¾å°†ä»¥å­—èŠ‚ä¸ºå•ä½æ¥æµ‹é‡å“åº”çš„å¤§å°ã€‚</p><h3 id="Meters"><a href="#Meters" class="headerlink" title="Meters"></a>Meters</h3><p>Metersæµ‹é‡ä¸€æ®µæ—¶é—´å†…çš„äº‹ä»¶å‘ç”Ÿç‡ï¼ˆä¾‹å¦‚â€œæ¯ç§’è¯·æ±‚æ•°â€ï¼‰ã€‚é™¤äº†å¹³å‡é€Ÿåº¦ä¹‹å¤–ï¼ŒMetersè¿˜è·Ÿè¸ª1ï¼Œ5å’Œ15åˆ†é’Ÿçš„å‡å€¼ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private final MetricRegistry metrics = new MetricRegistry();</span><br><span class="line">private final Meter requests = metrics.meter(&quot;requests&quot;);</span><br><span class="line"></span><br><span class="line">public void handleRequest(Request request, Response response) &#123;</span><br><span class="line">    requests.mark();</span><br><span class="line">    // etc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å°†æµ‹é‡æ¯ç§’è¯·æ±‚çš„è¯·æ±‚ç‡ã€‚</p><h3 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h3><p>Timeræµ‹é‡ä¸€æ®µä»£ç è¢«è°ƒç”¨çš„é€Ÿç‡å’Œå®ƒçš„æŒç»­æ—¶é—´çš„åˆ†å¸ƒã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private final Timer responses = metrics.timer(name(RequestHandler.class, &quot;responses&quot;));</span><br><span class="line"></span><br><span class="line">public String handleRequest(Request request, Response response) &#123;</span><br><span class="line">    final Timer.Context context = responses.time(); //ç›¸å½“äºMeter.mark()</span><br><span class="line">    try &#123;</span><br><span class="line">        // etc;</span><br><span class="line">        return &quot;OK&quot;;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        context.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥Timer å°†æµ‹é‡å¤„ç†æ¯ä¸ªè¯·æ±‚æ‰€éœ€çš„æ—¶é—´ï¼ˆä»¥çº³ç§’ä¸ºå•ä½ï¼‰ï¼Œå¹¶æä¾›æ¯ç§’è¯·æ±‚çš„è¯·æ±‚é€Ÿç‡ã€‚</p><p>Timer å…¶å®æ˜¯ Histogram å’Œ Meter çš„ç»“åˆ</p><h2 id="Reporter"><a href="#Reporter" class="headerlink" title="Reporter"></a>Reporter</h2><p>æŠ¥è¡¨ï¼Œç”¨äºå±•ç¤ºç»Ÿè®¡ç»“æœ</p><ol><li><p>é€šè¿‡JMXæŠ¥å‘ŠMetric</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">final JmxReporter reporter = JmxReporter.forRegistry(registry).build();</span><br><span class="line">reporter.start();</span><br></pre></td></tr></table></figure></li><li><p>STDOUT, using ConsoleReporter from metrics-core</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">final ConsoleReporter reporter = ConsoleReporter.forRegistry(registry)</span><br><span class="line">                                                .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                                .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                                .build();</span><br><span class="line">reporter.start(1, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure></li><li><p>CSV files, using CsvReporter from metrics-core</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final CsvReporter reporter = CsvReporter.forRegistry(registry)</span><br><span class="line">                                        .formatFor(Locale.US)</span><br><span class="line">                                        .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                        .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                        .build(new File(&quot;~/projects/data/&quot;));</span><br><span class="line">reporter.start(1, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure></li><li><p>SLF4J loggers, using Slf4jReporter from metrics-core</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final Slf4jReporter reporter = Slf4jReporter.forRegistry(registry)</span><br><span class="line">                                            .outputTo(LoggerFactory.getLogger(&quot;com.example.metrics&quot;))</span><br><span class="line">                                            .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                            .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                            .build();</span><br><span class="line">reporter.start(1, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure></li><li><p>Ganglia, using GangliaReporter from metrics-ganglia</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final GMetric ganglia = new GMetric(&quot;ganglia.example.com&quot;, 8649, UDPAddressingMode.MULTICAST, 1);</span><br><span class="line">final GangliaReporter reporter = GangliaReporter.forRegistry(registry)</span><br><span class="line">                                                .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                                .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                                .build(ganglia);</span><br><span class="line">reporter.start(1, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure></li><li><p>Graphite, using GraphiteReporter from metrics-graphite</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">final Graphite graphite = new Graphite(new InetSocketAddress(&quot;graphite.example.com&quot;, 2003));</span><br><span class="line">final GraphiteReporter reporter = GraphiteReporter.forRegistry(registry)</span><br><span class="line">                                                  .prefixedWith(&quot;web1.example.com&quot;)</span><br><span class="line">                                                  .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                                  .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                                  .filter(MetricFilter.ALL)</span><br><span class="line">                                                  .build(graphite);</span><br><span class="line">reporter.start(1, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure></li></ol><h2 id="å¥åº·æ£€æŸ¥"><a href="#å¥åº·æ£€æŸ¥" class="headerlink" title="å¥åº·æ£€æŸ¥"></a>å¥åº·æ£€æŸ¥</h2><p>åº¦é‡æ ‡å‡†è¿˜èƒ½å¤Ÿå¯¹æœåŠ¡çš„å¥åº·çŠ¶å†µè¿›è¡Œæ£€æŸ¥ï¼Œéœ€è¦å¼•ç”¨metrics-healthchecksæ¨¡å— ã€‚</p><p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„HealthCheckRegistryå®ä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">final HealthCheckRegistry healthChecks = new HealthCheckRegistry();</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œå®ç°ä¸€ä¸ªHealthCheckå­ç±»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class DatabaseHealthCheck extends HealthCheck &#123;</span><br><span class="line">    private final Database database;</span><br><span class="line"></span><br><span class="line">    public DatabaseHealthCheck(Database database) &#123;</span><br><span class="line">        this.database = database;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public HealthCheck.Result check() throws Exception &#123;</span><br><span class="line">        if (database.isConnected()) &#123;</span><br><span class="line">            return HealthCheck.Result.healthy();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return HealthCheck.Result.unhealthy(&quot;Cannot connect to &quot; + database.getUrl());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨Metricsæ³¨å†Œå®ƒçš„ä¸€ä¸ªå®ä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">healthChecks.register(&quot;postgres&quot;, new DatabaseHealthCheck(database));</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ‰€æœ‰æ³¨å†Œçš„å¥åº·æ£€æŸ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">final Map&lt;String, HealthCheck.Result&gt; results = healthChecks.runHealthChecks();</span><br><span class="line">for (Entry&lt;String, HealthCheck.Result&gt; entry : results.entrySet()) &#123;</span><br><span class="line">    if (entry.getValue().isHealthy()) &#123;</span><br><span class="line">        System.out.println(entry.getKey() + &quot; is healthy&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        System.err.println(entry.getKey() + &quot; is UNHEALTHY: &quot; + entry.getValue().getMessage());</span><br><span class="line">        final Throwable e = entry.getValue().getError();</span><br><span class="line">        if (e != null) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº¦é‡æ ‡å‡†å¸¦æœ‰é¢„å…ˆæ„å»ºçš„è¿è¡ŒçŠ¶å†µæ£€æŸ¥ï¼šThreadDeadlockHealthCheckä½¿ç”¨Javaçš„å†…ç½®çº¿ç¨‹æ­»é”æ£€æµ‹æ¥ç¡®å®šæ˜¯å¦æœ‰çº¿ç¨‹æ­»é”ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of Contents)&quot;&gt;&lt;/a&gt; &lt;strong&gt;ç›®å½• (Table of C
      
    
    </summary>
    
      <category term="ä¸­é—´ä»¶" scheme="https://jasonsonghoho.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="java" scheme="https://jasonsonghoho.github.io/public/tags/java/"/>
    
      <category term="Metric" scheme="https://jasonsonghoho.github.io/public/tags/Metric/"/>
    
  </entry>
  
  <entry>
    <title>äº§å“æ€§èƒ½è‡ªæµ‹</title>
    <link href="https://jasonsonghoho.github.io/2017/12/10/171210/"/>
    <id>https://jasonsonghoho.github.io/2017/12/10/171210/</id>
    <published>2017-12-10T14:08:41.000Z</published>
    <updated>2018-09-22T02:46:04.906Z</updated>
    
    <content type="html"><![CDATA[<p>*æœ¬æ–‡æ˜¯ä»å…¬å¸å†…ç½‘KBè½¬è¿‡æ¥çš„ï¼Œæ ¼å¼æœ‰ç‚¹æ··ä¹±æ‡’å¾—æ”¹äº†QAZ~~</p><h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><ul><li>FAQ</li><li>ä¸€ã€æµ‹è¯•ç›®çš„</li><li>äºŒã€æµ‹è¯•ç¯å¢ƒ</li><li>ä¸‰ã€æµ‹è¯•æ–¹æ³•</li><li>å››ã€æµ‹è¯•ç»“æœ<ul><li>å†™:</li><li>è¯»ï¼š</li></ul></li><li>äº”ã€ç»“è®º<ul><li>1ã€æŒ‡æ ‡åº“å†™æ€§èƒ½ï¼š</li><li>2ã€æŒ‡æ ‡åº“è¯»æ€§èƒ½ï¼š</li></ul></li></ul><p></p><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-FAQ">FAQ</h2><p></p><p><strong>1.å†™å…¥èƒ½åŠ›ï¼šå¤šå°‘ä¸ª15ç§’ç›‘æ§å‘¨æœŸçš„ä¸»æœºï¼Œæˆ–180ç§’ç›‘æ§å‘¨æœŸçš„ç½‘ç»œè®¾å¤‡çš„æ•°æ®å†™å…¥</strong></p><br><p style="margin-left: 30.0px;">å‡è®¾ç°åœº1ä¸ªèµ„æºæ¯15 Sä¸ŠæŠ¥100ä¸ªæŒ‡æ ‡ï¼Œåˆ™æ¯åˆ†é’Ÿä¸ŠæŠ¥400ä¸ªï¼Œ</p><br><p style="margin-left: 30.0px;">è‹¥éƒ¨ç½²å•èŠ‚ç‚¹Cassandraï¼Œåœ¨redisé›†ç¾¤çŠ¶å†µè‰¯å¥½çš„æƒ…å†µä¸‹ï¼Œæ¯åˆ†é’Ÿå¯å†™å…¥80Wä¸ªæŒ‡æ ‡ï¼Œå¯æ”¯æŒ800000/400=2000ä¸ªèµ„æºå·¦å³;</p><br><p style="margin-left: 30.0px;">è‹¥éƒ¨ç½²Cassandra é›†ç¾¤ï¼Œæ¯åˆ†é’Ÿå¯å†™å…¥110Wä¸ªæŒ‡æ ‡ï¼Œå¯æ”¯æŒ1100000/400=2750ä¸ªèµ„æºå·¦å³;</p><br><p style="margin-left: 30.0px;">è€ƒè™‘åˆ°ç¨³å®šæ€§å¯é…Œæƒ…å‡å°‘èµ„æºé‡æˆ–å¢åŠ é…ç½®ã€‚</p><br><p><strong>2.è¯»å‡ºèƒ½åŠ›ï¼šæ¯ç§’å®ŒæˆæŒ‡å®šæ•°æ®ç‚¹æ•°æŸ¥è¯¢çš„TPSæ€§èƒ½å³°å€¼ï¼Œä»¥ä¾¿é¢„æµ‹å¯ä»¥æ”¯æŒä»€ä¹ˆæ•°é‡çš„ä»ªè¡¨ç›˜</strong></p><br><p style="margin-left: 30.0px;">åœ¨ä¸‰å°4C*16Gçš„CassandraèŠ‚ç‚¹çš„é…ç½®ä¸‹ï¼Œç¨³å®šæŸ¥è¯¢çš„å‰æä¸‹ï¼Œæ¯åˆ†é’Ÿè‡³å°‘400æ¡å¹¶å‘è¯·æ±‚ï¼ˆæ¯æ¡è¯·æ±‚è‡³å°‘6000æ¡å…ƒæ•°æ®ï¼Œå¤§çº¦ä¸º15åˆ†é’Ÿçš„æ•°æ®ï¼‰ã€‚</p><br><p style="margin-left: 30.0px;"></p><br><p></p><br><p></p><br><p></p><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-ä¸€ã€æµ‹è¯•ç›®çš„">ä¸€ã€æµ‹è¯•ç›®çš„</h2><br><p>æµ‹è¯•åœ¨æŒ‡å®šç¡¬ä»¶æ¡ä»¶ä¸‹ï¼ŒæŒ‡æ ‡åº“å†™å…¥èƒ½åŠ›ä¸è¯»å–èƒ½åŠ›ã€‚</p><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-äºŒã€æµ‹è¯•ç¯å¢ƒ">äºŒã€æµ‹è¯•ç¯å¢ƒ</h2><br><div class="table-wrap"><br>    <table class="confluenceTable"><br>        <tbody><br>        <tr><br>            <th class="confluenceTh">ip</th><br>            <th colspan="1" class="confluenceTh">cpu</th><br>            <th class="confluenceTh">å†…å­˜</th><br>            <th colspan="1" class="confluenceTh">ç£ç›˜</th><br>            <th colspan="1" class="confluenceTh">ç”¨é€”</th><br>            <th colspan="1" class="confluenceTh">å¤‡æ³¨</th><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd">ä¸ªäººç”µè„‘</td><br>            <td colspan="1" class="confluenceTd">4æ ¸</td><br>            <td colspan="1" class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd"></td><br>            <td colspan="1" class="confluenceTd"><span>éƒ¨ç½²jmeter</span></td><br>            <td colspan="1" class="confluenceTd"></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd"><span>10.1.53.37</span></td><br>            <td colspan="1" class="confluenceTd">6<span>æ ¸</span></td><br>            <td colspan="1" class="confluenceTd">8G</td><br>            <td colspan="1" class="confluenceTd"></td><br>            <td rowspan="4" class="confluenceTd">éƒ¨ç½²jmeter-server</td><br>            <td rowspan="4" class="confluenceTd"><p><span>é€šè¿‡jmeteræ¥å‘é€æµ‹è¯•è¯·æ±‚ï¼Œ</span></p><br>                <p>è¿™äº›æœºå™¨åŒæ—¶éƒ¨ç½²ç€å…¶ä»–äº§å“ã€‚<br><br></p></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd"><span>10.1.53.38</span></td><br>            <td colspan="1" class="confluenceTd"><span>4æ ¸</span></td><br>            <td colspan="1" class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd"></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd"><span>10.1.53.65</span></td><br>            <td colspan="1" class="confluenceTd"><span>4æ ¸</span></td><br>            <td colspan="1" class="confluenceTd"><span>8G</span></td><br>            <td colspan="1" class="confluenceTd"></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd"><span>10.1.61.10</span></td><br>            <td colspan="1" class="confluenceTd"><span>4æ ¸</span></td><br>            <td colspan="1" class="confluenceTd">24G</td><br>            <td colspan="1" class="confluenceTd"></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd">10.1.53.39</td><br>            <td colspan="1" class="confluenceTd"><span>4æ ¸</span></td><br>            <td colspan="1" class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd"></td><br>            <td colspan="1" class="confluenceTd">æŒ‡æ ‡åº“ã€ESã€ç§Ÿæˆ·ç­‰ç»„ä»¶</td><br>            <td colspan="1" class="confluenceTd">è¯¥æœºå™¨ä¸»è¦ç”¨æ¥éƒ¨ç½²æŒ‡æ ‡åº“</td><br>        </tr><br>        <tr><br>            <td class="confluenceTd">10.1.61.117</td><br>            <td colspan="1" class="confluenceTd">4æ ¸</td><br>            <td class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd">38G</td><br>            <td colspan="1" class="confluenceTd">kairosdbã€ompç­‰</td><br>            <td colspan="1" class="confluenceTd"><span>kairosdb å †å†…å­˜ä¸ºé»˜è®¤çš„3g</span></td><br>        </tr><br>        <tr><br>            <td class="confluenceTd">10.1.61.118</td><br>            <td colspan="1" class="confluenceTd">4æ ¸</td><br>            <td class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd">38G</td><br>            <td colspan="1" class="confluenceTd">Cassandra</td><br>            <td colspan="1" class="confluenceTd"><p><span>kairosdb å †å†…å­˜ä¸º<span>ä¸ºé»˜è®¤çš„4</span>gï¼Œ</span></p><br>                <p>è®¡ç®—å…¬å¼ max(min(1/2 ram, 1024MB),min(1/4 ram, 8GB))</p></td><br>        </tr><br>        </tbody><br>    </table><br></div><br><p></p><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-ä¸‰ã€æµ‹è¯•æ–¹æ³•">ä¸‰ã€æµ‹è¯•æ–¹æ³•</h2><br><p>æµ‹è¯•å·¥å…·ä¸ºJmeterï¼Œé€šè¿‡è°ƒç”¨æŒ‡æ ‡åº“ç›¸åº”çš„openApiæµ‹è¯•ï¼Œç”¨jconsole ç›‘æ§è¿›ç¨‹å ç”¨èµ„æºå˜åŒ–ã€‚</p><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-å››ã€æµ‹è¯•ç»“æœ">å››ã€æµ‹è¯•ç»“æœ</h2><h4 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-å†™:">å†™:</h4><br><p style="margin-left: 30.0px;"><span>Ramp-up Period <span>å†³å®šå¤šé•¿æ—¶é—´å¯åŠ¨æ‰€æœ‰çº¿ç¨‹ã€‚å¦‚æœä½¿ç”¨10ä¸ªçº¿ç¨‹ï¼Œramp-up periodæ˜¯100ç§’ï¼Œé‚£ä¹ˆJMeterç”¨100ç§’ä½¿æ‰€æœ‰10ä¸ªçº¿ç¨‹å¯åŠ¨å¹¶è¿è¡Œã€‚æ¯ä¸ªçº¿ç¨‹ä¼šåœ¨ä¸Šä¸€ä¸ªçº¿ç¨‹å¯åŠ¨å10ç§’ï¼ˆ100/10ï¼‰å¯åŠ¨ã€‚</span></span><br></p><br><p style="margin-left: 30.0px;">monitor æŒ‡æ ‡ä¸ŠæŠ¥çš„é¢‘ç‡æ˜¯15Sä¸€æ¬¡ï¼Œæ•…æ­¤å¤„ä» ä»¥15S/s çš„é¢‘ç‡å¯åŠ¨ä¸€ä¸ªä¸ŠæŠ¥çº¿ç¨‹å¼€å§‹æµ‹è¯•ã€‚</p><br><p style="margin-left: 30.0px;">å¦‚ç»„1ï¼Œæµ‹è¯•é€»è¾‘ä¸ºï¼š</p><br><p style="margin-left: 60.0px;">æ¯15ç§’å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå•ä¸ªçº¿ç¨‹æ¯æ¬¡ä¸ŠæŠ¥25ä¸ªæŒ‡æ ‡ï¼Œé‡å¤ä¸ŠæŠ¥500æ¬¡ï¼Œæ¯åˆ†é’ŸæŒ‡æ ‡å†™å…¥è¯·æ±‚æ¬¡æ•°ä¸º5Wæ¡ã€‚</p><br><p style="margin-left: 60.0px;">jmeter-serverä¸º1ï¼Œè¡¨ç¤ºåªåœ¨æœ¬æœºè¿è¡Œæµ‹è¯•ï¼›è‹¥ä¸º4ï¼Œè¡¨ç¤ºåœ¨4ä¸ªæœºå™¨ä¸ŠåŒæ—¶å¯¹æŒ‡æ ‡åº“å‘èµ·è¯·æ±‚æµ‹è¯•ã€‚</p><br><p style="margin-left: 30.0px;"></p><br><p></p><br><p></p><br><p style="margin-left: 30.0px;">1.kairosdb è‡ªå¸¦å†™å…¥ç»Ÿè®¡æŒ‡æ ‡ï¼š</p><br><p style="margin-left: 60.0px;">kairosdb.metric_counters - Counts the number of data points received since the last<br>    report. Tags are used to separate one metric from another.ï¼ˆç»Ÿè®¡è‡ªä¸Šæ¬¡ä¸ŠæŠ¥åæ¥æ”¶çš„æ•°æ®é‡ã€‚æ ‡ç­¾ç”¨äºåŒºåˆ†æŒ‡æ ‡ã€‚ï¼‰</p><br><p style="margin-left: 60.0px;"></p><br><p style="margin-left: 30.0px;">kairosdb ç»Ÿè®¡ç»“æœï¼š</p><br><p style="margin-left: 30.0px;"><br><img src="/2017/12/10/171210/kairosdb_metric_count.png"><br><br></p><br><p style="margin-left: 30.0px;">â€œ1â€å¤„ä¸ºç»„åˆ«12çš„æµ‹è¯•ç»“æœï¼Œâ€œ2â€å¤„ä¸ºç›´æ¥è°ƒç”¨kairosdb restApi å†™å…¥æ¥å£ï¼Œâ€œ3â€å¤„ä¸ºç»„åˆ«14 çš„ç»“æœã€‚ç»“æœä¸æŒ‡æ ‡åº“çš„ç»Ÿè®¡æ—¥å¿—ä¸€è‡´ã€‚<br><br></p><p style="margin-left: 30.0px;">2.æ—¶é—´æœ‰é™ï¼Œæ¯ç»„æµ‹è¯•æ—¶é—´é—´éš”è¾ƒçŸ­ï¼Œå› æ­¤å¯èƒ½ä¼šå¯¹CPUã€å†…å­˜ä»¥åŠCassandraçŠ¶æ€äº§ç”Ÿå½±å“ï¼Œä½¿ç»“æœä¸å¤Ÿå‡†ç¡®ã€‚</p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;"><strong>æ³¨ï¼š</strong></p><br><p style="margin-left: 30.0px;">ã€1ã€‘ï¼šæŒ‡æ ‡åº“redis æŠ¥å†…å­˜ä¸å¤Ÿï¼Œå¼‚å¸¸ï¼š Canâ€™t save in background: fork: Cannot allocate memory</p><br><p style="margin-left: 30.0px;">ã€2ã€‘ï¼š<span style="background-color: transparent;">çŸ­æ—¶é—´æ’å…¥å¤§é‡æŒ‡æ ‡ä¼šå¯¼è‡´æœªå‹å®çš„sstableæ•°æ®å¤ªå¤šï¼Œå‹å®è¿›ç¨‹æŠ¥å¯ç”¨ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œé‡æ–°å‹å®â€¦æ¶æ€§å¾ªç¯ã€‚</span><br></p><br><p style="margin-left: 30.0px;"><span style="background-color: transparent;"><br></span></p><br><div class="code panel pdl" style="border-width: 1px;"><br>    <div class="codeContent panelContent pdl"><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[[root@localhost data_points-1e09be40c3c811e7977aa147ea7baf03]# /opt/cassandra/bin/nodetool compactionstats -H</span><br><span class="line">pending tasks: 2</span><br><span class="line">- kairosdb.data_points: 2</span><br><span class="line">id                                   compaction type keyspace table       completed total    unit  progress</span><br><span class="line">ef340e00-d4d8-11e7-a239-0d717928a22e Compaction      kairosdb data_points 6.23 GB   11.42 GB bytes 54.56%</span><br><span class="line">Active compaction remaining time :   0h05m32s</span><br><span class="line">]]&gt;</span><br></pre></td></tr></table></figure><br><br>    </div><br></div><br><p style="margin-left: 30.0px;"><span><br></span></p><br><p style="margin-left: 30.0px;"><span>CassandraæŠ¥å¼‚å¸¸:</span></p><br><div class="code panel pdl" style="border-width: 1px;"><br>    <div class="codeContent panelContent pdl"><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[WARN  [CompactionExecutor:46] 2017-11-28 22:26:29,785 CompactionTask.java:91 - insufficient space to compact all requested files BigTableReader(path=&amp;#39;/opt/dbdata/cassandra/data/kairosdb/data_points-1e09be40c3c811e7977aa147ea7baf03/ma-216-big-Data.db&amp;#39;), BigTableReader(path=&amp;#39;/opt/dbdata/cassandra/data/kairosdb/data_points-1e09be40c3c811e7977aa147ea7baf03/ma-237-big-Data.db&amp;#39;)</span><br><span class="line">ERROR [CompactionExecutor:46] 2017-11-28 22:26:29,827 CassandraDaemon.java:195 - Exception in thread Thread[CompactionExecutor:46,1,main]</span><br><span class="line">java.lang.RuntimeException: Not enough space for compaction, estimated sstables = 1, expected write size = 2395303467</span><br><span class="line">at org.apache.cassandra.db.compaction.CompactionTask.checkAvailableDiskSpace(CompactionTask.java:278) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:126) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:82) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:264) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_144]</span><br><span class="line">at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_144]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[na:1.8.0_144]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [na:1.8.0_144]</span><br><span class="line">at java.lang.Thread.run(Thread.java:748) [na:1.8.0_144]</span><br><span class="line"></span><br><span class="line">]]&gt;</span><br></pre></td></tr></table></figure><br><br>    </div><br></div><br><p></p><br><p style="margin-left: 30.0px;">è§£å†³æ–¹æ³•ï¼š</p><br><p style="margin-left: 60.0px;">1ã€å¢å¤§ç£ç›˜ç©ºé—´ã€</p><br><p style="margin-left: 60.0px;">2ã€ç›´æ¥åˆ é™¤åŒä¸€ç¼–å·çš„sstable å¤§æ–‡ä»¶</p><br><p style="margin-left: 60.0px;">3ã€é‡è£…Cassandra</p><h4 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-å¤šèŠ‚ç‚¹å†™:">å¤šèŠ‚ç‚¹å†™:</h4><br><p style="margin-left: 30.0px;">1.é€šè¿‡è§‚å¯Ÿå‘ç°ï¼Œå†™çš„ç“¶é¢ˆåœ¨æŒ‡æ ‡åº“çš„gatewayï¼Œç„¶åå¢åŠ å¤šèŠ‚ç‚¹çš„æµ‹è¯•å¦‚ä¸‹ï¼š</p><br><ul><br>    <li style="margin-left: 30.0px;">å¼€å¯ä¸€ä¸ªgatewayã€ä¸€ä¸ªwriteræ¨¡å—åï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›åœ¨ <strong>50W/åˆ†é’Ÿ</strong>ï¼›</li><br>    <li style="margin-left: 30.0px;">å¼€å¯ä¸‰ä¸ªgatewayã€ä¸€ä¸ªwriteræ¨¡å—åï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›åœ¨ <strong>80W/åˆ†é’Ÿ</strong>ï¼›</li><br>    <li style="margin-left: 30.0px;">å¼€å¯ä¸‰ä¸ªä¸‰ä¸ªgatewayã€ä¸‰ä¸ªwriter æ¨¡å—åï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›åœ¨ <strong>85W/åˆ†é’Ÿ</strong>ã€‚</li><br></ul><br><br><p><br><img src="/2017/12/10/171210/kairosdb_metric_count_70W_75W.png"><br><br></p><p style="margin-left: 30.0px;">2.å½“éƒ¨ç½²Cassandraé›†ç¾¤ï¼ˆ3ä¸ªèŠ‚ç‚¹ï¼‰åï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›å¯ä»¥å†æ¬¡æå‡ï¼Œ<span style="background-color: transparent;">å¼€å¯ä¸‰ä¸ªgatewayã€ä¸€ä¸ªwriteræ¨¡å—ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›åœ¨ <strong>100W/åˆ†é’Ÿ</strong> ï¼Œæ­¤çŠ¶æ€ä¸‹å¯æŒç»­å†™å…¥å››ä¸ªå°æ—¶ï¼ŒæœŸé—´redisä¼šæŠ¥å†…å­˜ä¸å¤Ÿçš„å¼‚å¸¸ã€‚</span><br></p>&lt;p style=â€margin-left: 30.0px; &gt;<br><br><br><p></p><p style="margin-left: 30.0px;"><span style="background-color: transparent;">å¦å¤–ï¼Œå½“æŒ‡æ ‡åº“å†™å…¥åœ¨æ»¡è½½çš„æƒ…å†µä¸‹ï¼ŒæŒ‡æ ‡çš„è¯»å–èƒ½åŠ›ä¼šå—åˆ°å¾ˆå¤§å½±å“ï¼Œä¸”å†™å…¥ä¹Ÿä¼šå¶å°”æŠ¥è¿æ¥è¶…æ—¶ç°è±¡ã€‚</span><br></p><br><p style="margin-left: 30.0px;"><span style="background-color: transparent;"><br></span></p><h4 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-è¯»ï¼š"><br>    è¯»ï¼š</h4><br><p>æŒ‡æ ‡çš„æŸ¥è¯¢ï¼Œå…¶å®æ˜¯kairosdbå»æŸ¥Cassandraä¸­æ•°æ®ã€‚å› æ­¤kairosdbæŸ¥Cassandraçš„é€Ÿåº¦æ‰æ˜¯å…³é”®å› ç´ ã€‚è€ŒæŸ¥Cassandraæ•°æ®çš„é€Ÿåº¦ï¼Œè·ŸæŸ¥è¯¢çš„Cassandraçš„rowæ•°é‡ã€å…ƒæ•°æ®é‡ç­‰å› ç´ ç›¸å…³ã€‚</p><br><p>è¦æ¨¡æ‹Ÿè¯»å–æµ‹è¯•ï¼Œå°±éœ€è¦å…ˆè°ƒæŸ¥ç°åœºå®é™…æŸ¥è¯¢çš„rowå’Œå…ƒæ•°æ®å¤§å°ã€‚</p><br><p>ç»Ÿè®¡å±€çš„ç»Ÿè®¡å¦‚ä¸‹ï¼š</p><br><p style="margin-left: 30.0px;">ä¸Šå›¾ä¸ºå¯†é›†æŸ¥è¯¢30åˆ†é’Ÿå†…æŒ‡æ ‡æ—¶ï¼Œä»Cassandraä¸­æŸ¥è¯¢çš„rowçš„è¡Œæ•°ï¼›</p><br><p style="margin-left: 30.0px;">ä¸­å›¾ä¸ºå¯†é›†æŸ¥è¯¢30åˆ†é’Ÿå†…æŒ‡æ ‡æ—¶ï¼Œä»Cassandraä¸­æŸ¥è¯¢çš„å…ƒæ•°æ®çš„æ•°é‡ï¼›</p><br><p style="margin-left: 30.0px;">ä¸‹å›¾ä¸ºå®šæ—¶æŸ¥è¯¢æ—¶rowçš„è¡Œæ•°ã€‚</p><br><p><br><br></p><br><p style="margin-left: 30.0px;"><br><img src="/2017/12/10/171210/ç»Ÿè®¡å±€_query_row_count2.png"><br><br></p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;"><br><img src="/2017/12/10/171210/ç»Ÿè®¡å±€_query_sample_size.png"><br><br></p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;"><br><img src="/2017/12/10/171210/ç»Ÿè®¡å±€_query_row_count.png"><br><br></p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;">å¯ä»¥çœ‹å‡ºï¼š</p><br><p style="margin-left: 30.0px;">å¯†é›†æŸ¥è¯¢æ—¶ï¼Œrowæœ€å¤§çš„åœ¨4000ï¼Œå¤§éƒ¨åˆ†æ¯”è¾ƒå°ï¼Œæ¥è¿‘1ã€‚å®šæ—¶æŸ¥è¯¢æ—¶ï¼Œrowåœ¨100è¡Œä»¥ä¸‹ã€‚</p><br><p style="margin-left: 30.0px;">ç°åœº400ä¸ªè®¾å¤‡ï¼ŒæŸ¥è¯¢30åˆ†é’ŸæŒ‡æ ‡æ—¶ï¼Œç†è®ºä¸Šåº”è¯¥æœ‰å¤§çº¦400<em>4</em>30=48000 çš„å…ƒæ•°æ®ï¼Œå®é™…æŸ¥è¯¢æ—¶ï¼Œè¦å°äºè¯¥å€¼ã€‚åŸºæœ¬éƒ½åœ¨å‡ ç™¾æ¡ã€‚</p><br><p></p><br><p></p><p></p><p style="margin-left: 30.0px;">è¿‡ç¨‹ï¼š</p><p></p><ol><br>    <li>å¯ä»¥çœ‹åˆ°å•CassandraèŠ‚ç‚¹ä¸‹ï¼ŒkairosdbæŸ¥è¯¢Cassandraæœ€çŸ­è€—æ—¶å·²ç»åœ¨2Så·¦å³ï¼Œè€Œé›†ç¾¤æ¨¡å¼ä¸‹ï¼ŒkairosdbæŸ¥è¯¢Cassandraçš„æœ€çŸ­è€—æ—¶åœ¨200ms<br>        å·¦å³ï¼Œå¯ä»¥çœ‹å‡ºåœ¨ä½ç¡¬ä»¶é…ç½®ä¸‹ï¼ŒCassandraéƒ¨ç½²é›†ç¾¤æ¨¡å¼æ¯”å•æœºæ¨¡å¼çš„æ€§èƒ½æå‡å¾ˆå¤§ã€‚<br>    </li><br>    <li>Cassandraåˆšéƒ¨ç½²æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½è¡¨ç°ä¼˜ç§€ï¼Œè¿ç»­å†™å…¥ä¸€ä¸ªå°æ—¶æ•°æ®åï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™ã€‚</li><br>    <li>2-5ç»„å‘ç°kairosdb æŸ¥è¯¢æ—¶é—´æ­£å¸¸ï¼Œ ä½†æŒ‡æ ‡åº“æŸ¥è¯¢å‡ºç°è¶…æ—¶ï¼Œç»å»ºé£æ’æŸ¥ï¼ŒåŸå› æ˜¯è°ƒç”¨kairosdb clientæ—¶åˆ›å»ºçš„ httpè¿æ¥ æœ€å¤§æ•°é‡æœ€2ï¼Œä¿®æ”¹ä¸º200åï¼Œæƒ…å†µå¥½è½¬ã€‚<br><br><br><br>  <img src="/2017/12/10/171210/image2017-12-8_11_24_9.png"><br><br>    </li><br>    <li>ä»æµ‹è¯•è¿‡ç¨‹å¯ä»¥çœ‹åˆ°ï¼Œéƒ¨åˆ†æŒ‡æ ‡åº“çš„æŸ¥è¯¢è€—æ—¶æ¯”kairosdbæŸ¥Cassandraçš„è€—æ—¶é•¿å¾ˆå¤šï¼ŒæŸ¥è¯¢kairosdb.datastore.queries_waiting<br>        æŒ‡æ ‡ï¼Œå‘ç°kairosdbå­˜åœ¨å¤§é‡ç­‰å¾…çº¿ç¨‹ã€‚å¦‚ä¸‹ï¼š<br><br><br><br><img src="/2017/12/10/171210/kairosdb.datastore.queries_waiting.png"><br><br>          <br>ä¿®æ”¹<br>        kairosdb çš„é…ç½®ï¼škairosdb.datastore.concurrentQueryThread ï¼Œå†æ¬¡æŸ¥è¯¢ï¼Œä¾ç„¶ä¼šæœ‰ç­‰å¾…çš„æŸ¥è¯¢çº¿ç¨‹ã€‚<br>æ®æ­¤åˆ¤æ–­ï¼Œå½“æŸ¥è¯¢15ä¸ªæŒ‡æ ‡æ—¶ï¼Œæ¯ä¸ªæŒ‡æ ‡è€—æ—¶åœ¨2.5Så·¦å³æ—¶ï¼Œæ­¤ç¡¬ä»¶é…ç½®ä¸‹çš„kairosdbæ€§èƒ½å·²è¾¾ç“¶é¢ˆï¼Œå½±å“å› ç´ ä¸ºCPUæ ¸æ•°ã€‚å½“æ›´æ”¹éƒ¨ç½²kairosdb<br>        æœºå™¨çš„æ ¸æ•°åï¼Œæ€§èƒ½å¾—åˆ°äº†æå‡ã€‚<br>    </li><br>    <li>åŒæ ·çš„æŸ¥è¯¢æ¡ä»¶ä¸‹ï¼ŒCPUæ ¸æ•°ä¸kairosdb çš„concurrentQueryThread å‚æ•°ä¸€è‡´æ—¶ï¼Œæ€§èƒ½æœ€ä¼˜ï¼›ä¸”è¯¥å‚æ•°åªåœ¨kairosdb æŸ¥Cassandraè¾ƒæ…¢ï¼ˆ2Sä»¥ä¸Šï¼‰æ—¶ï¼Œæ‰ä¼šäº§ç”Ÿå½±å“ã€‚</li><br></ol><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-äº”ã€ç»“è®º"><br>äº”ã€ç»“è®º</h2><br><h3 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-1ã€æŒ‡æ ‡åº“å†™æ€§èƒ½ï¼š">1ã€æŒ‡æ ‡åº“å†™æ€§èƒ½ï¼š</h3><br><ol><br>    <li>ç”±3ã€5ã€6ç»„å¯çŸ¥ï¼Œæ¯åˆ†é’Ÿè¯·æ±‚æ€»é‡ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œåœ¨æœªåˆ°è¾¾ç“¶é¢ˆå‰ï¼Œå¹¶å‘çº¿ç¨‹è¶Šå¤šï¼ŒæŒ‡æ ‡å†™å…¥é‡è¶Šå¤§ã€‚</li><br>    <li>ç”±6ã€8ç»„å¯çŸ¥ï¼Œæœ¬æœºçš„æœºå™¨æ€§èƒ½å¹¶æœªæˆä¸ºå½±å“æŒ‡æ ‡å†™å…¥çš„å› ç´ ã€‚</li><br>    <li>ç”±6ã€7å’Œ8ã€9ä¸¤ç»„å¯çŸ¥ï¼Œåœ¨4æ ¸16Gå•èŠ‚ç‚¹Cassandra é…ç½®ä¸‹ï¼Œè¯·æ±‚æ•°åœ¨50W/min å·¦å³æ—¶ï¼ŒæŒ‡æ ‡åº“çš„gateway æ¨¡å—æ¥æ”¶è¯·æ±‚å·²åˆ°è¾¾ç“¶é¢ˆï¼Œä¸º <strong>50W /min</strong> å·¦å³ã€‚</li><br>    <li>ç”±9ã€10ã€11ä¸‰ç»„å¯çŸ¥ï¼Œåœ¨æŒ‡æ ‡å†™å…¥èƒ½åŠ›åˆ°è¾¾ç“¶é¢ˆåï¼Œæ”¹å˜å¹¶å‘çš„çº¿ç¨‹æ•°ï¼Œä¸å†äº§ç”Ÿå½±å“ã€‚</li><br>    <li>ç”±9ã€12ç»„å¯çŸ¥ï¼Œå¾…å†™å…¥çš„æŒ‡æ ‡ç±»å‹é‡ä¸æ˜¯å½±å“å› ç´ ã€‚</li><br>    <li>ç”±15ç»„å¯çŸ¥ï¼Œå½“æŒ‡æ ‡åº“å†™å…¥è¯·æ±‚é‡æ¯åˆ†é’Ÿåˆ°åƒä¸‡çº§æ—¶ï¼Œä¼šå‡ºç°redis å†…å­˜é—®é¢˜ã€‚</li><br>    <li>å•æŒ‡æ ‡åº“ã€å•CassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›ç“¶é¢ˆåœ¨Cassandraå¤„ï¼Œä¸º <strong>80W/min</strong>ï¼›<br>å¤šæŒ‡æ ‡åº“ã€å•CassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›ç“¶é¢ˆåœ¨Cassandraå¤„ï¼Œä¸º<br>        <strong>85W/min</strong>ï¼›<br>å•æŒ‡æ ‡åº“ã€å¤šCassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›ç“¶é¢ˆä¸º <strong>100W/min</strong>ï¼›<br>å¤šæŒ‡æ ‡åº“ã€å¤šCassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›ç“¶é¢ˆä¸º<strong><br>            <strong>110W/min</strong></strong>ã€‚<br><br><br></li><br></ol><br><p></p><br><p>é…ç½®é¢„ä¼°ï¼š</p><br><p style="margin-left: 30.0px;">å‡è®¾ç°åœº1ä¸ªèµ„æºæ¯15 Sä¸ŠæŠ¥100ä¸ªæŒ‡æ ‡ï¼Œåˆ™æ¯åˆ†é’Ÿä¸ŠæŠ¥400ä¸ªï¼Œè‹¥é‡‡ç”¨å•èŠ‚ç‚¹Cassandra<br>    é…ç½®ï¼Œåœ¨redisé›†ç¾¤çŠ¶å†µè‰¯å¥½çš„æƒ…å†µä¸‹ï¼Œå¯æ”¯æŒ1750ä¸ªèµ„æºå·¦å³ï¼Œè€ƒè™‘åˆ°ç¨³å®šæ€§å¯é…Œæƒ…å‡å°‘èµ„æºé‡æˆ–å¢åŠ é…ç½®ã€‚</p><br><p style="margin-left: 30.0px;"></p><br><h3 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-2ã€æŒ‡æ ‡åº“è¯»æ€§èƒ½ï¼š">2ã€æŒ‡æ ‡åº“è¯»æ€§èƒ½ï¼š</h3><br><ol><br>    <li>ç”±1ã€2ç»„å¯çŸ¥R12ç‰ˆæœ¬æŒ‡æ ‡åº“åœ¨ç°æœ‰é…ç½®ä¸‹ï¼Œæœ€å¤šæ”¯æŒæ¯åˆ†é’Ÿ30æ¬¡çš„æŸ¥è¯¢ã€‚</li><br>    <li>ç”±2ã€3ç»„å¯çŸ¥ï¼ŒæŸ¥è¯¢è¾ƒæ…¢æ—¶ï¼Œæ¯10Sé’ŸæŸ¥è¯¢10æ¬¡ï¼Œæ¯”æ¯5Sé’ŸæŸ¥è¯¢5æ¬¡ï¼ŒæŸ¥è¯¢è¦å¿«ã€‚</li><br>    <li>ç”±2ã€4ç»„å¯çŸ¥ï¼Œç›¸åŒçš„è¯·æ±‚é‡ä¸‹ï¼ŒåŒä¸€ä¸ªæŒ‡æ ‡å¯†é›†æŸ¥è¯¢2æ¬¡ï¼Œæ¯”ä¸¤ä¸ªæŒ‡æ ‡åŒæ—¶å„æŸ¥ä¸€æ¬¡è¦æ…¢å¾ˆå¤šã€‚</li><br>    <li>ç”±1ã€5ç»„å¯çŸ¥ï¼ŒæŸ¥è¯¢çš„æ•°æ®é‡ä»600åˆ°7200ï¼ŒæŸ¥è¯¢çš„Cassandra rowä» 77åˆ°740ï¼ŒæŸ¥è¯¢è€—æ—¶åŸºæœ¬æ²¡æœ‰å˜åŒ–ï¼Œä¸è¿‡Cassandraçš„èµ„æºæ¶ˆè€—å¢åŠ å¾ˆå¤šã€‚</li><br>    <li>ç”±2ã€7ç»„å¯çŸ¥ï¼Œkairosdb client åˆ›å»ºçš„ httpè¿æ¥ æœ€å¤§æ•°é‡ä¸æŸ¥è¯¢æ€§èƒ½ååˆ†ç›¸å…³ï¼ŒR13ä¸­å·²è°ƒæ•´è¯¥å‚æ•°ä¸º200ã€‚</li><br>    <li>ç”±6-8ã€14ã€15ç»„å¯çŸ¥ï¼Œå•CassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡æŸ¥è¯¢çš„ç“¶é¢ˆä¸º <strong>90æ¬¡/åˆ†é’Ÿ</strong>ï¼Œä¸”å½“ æŒ‡æ ‡åº“çš„æŸ¥è¯¢è€—æ—¶ ä¸<br>        kairosdbæŸ¥Cassandraçš„è€—æ—¶ç›¸å·®ä¸å¤§æ—¶ï¼Œå¯ä»¥ç»´æŒç¨³å®šæŸ¥è¯¢çŠ¶æ€ï¼Œå¦åˆ™æŒ‡æ ‡åº“æŸ¥è¯¢è¶…æ—¶ä¼šè¶Šæ¥è¶Šä¸¥é‡ã€‚<br>    </li><br>    <li>ç”±8-13ã€17-19ç»„å¯çŸ¥ï¼Œkairosdbçš„concurrentQueryThread å‚æ•°å€¼ä¸CPUæ ¸æ•°ä¸€è‡´æ—¶ï¼Œæ€§èƒ½æœ€ä¼˜ï¼›ä¸”è¯¥å‚æ•°åªåœ¨kairosdb æŸ¥Cassandraè¾ƒæ…¢ï¼ˆ2Sä»¥ä¸Šï¼‰æ—¶ï¼Œæ‰ä¼šäº§ç”Ÿå½±å“ã€‚</li><br>    <li>ç”±8ã€16ç»„å¯çŸ¥ï¼ŒæŒ‡æ ‡åº“æ˜¯å¦é›†ç¾¤æ¨¡å¼ä¸æ˜¯ç“¶é¢ˆã€‚</li><br>    <li>ç”±19ã€22å’Œ20ã€23ä¸¤ç»„å¯çŸ¥ï¼Œå•kairosdb 8æ ¸çš„æŸ¥è¯¢æ€§èƒ½ ä¸åŒkairosdb 4æ ¸åŸºæœ¬ç›¸åŒï¼Œæ‰€ä»¥kairosdb çš„æŸ¥è¯¢æ€§èƒ½ä¸æœºå™¨çš„CPUæ ¸æ•°æœ‰å…³ã€‚</li><br>    <li>ç”±19ã€24ç»„å¯çŸ¥ï¼Œå½“å‰çš„æŸ¥è¯¢ç“¶é¢ˆåœ¨Cassandra å¤„ï¼ŒCassandra é›†ç¾¤çš„æŸ¥è¯¢æ€§èƒ½æ˜¯å•èŠ‚ç‚¹çš„10å€ã€‚</li><br>    <li>ç”±24-29ç»„å¯çŸ¥ï¼ŒCassandraé›†ç¾¤ä¸‹ï¼ŒæŸ¥è¯¢æ€§èƒ½ç“¶é¢ˆä¸º<strong>1400æ¬¡/åˆ†é’Ÿ</strong>ï¼Œå½“æŸ¥è¯¢åˆ°1500æ¬¡/åˆ†é’Ÿæ—¶ï¼Œkairosdbå‡ºç°ç“¶é¢ˆï¼Œç­‰å¾…æŸ¥è¯¢çº¿ç¨‹ä¸æ–­å¢åŠ ã€‚</li><br>    <li>ç”±30ã€31ç»„å¯çŸ¥ï¼Œå½“Cassandraå†™å…¥ä¸€æ®µæ—¶é—´æ•°æ®åï¼ŒæŒ‡æ ‡æŸ¥è¯¢æ€§èƒ½ä¸‹é™å¾ˆå¤šã€‚</li><br></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;*æœ¬æ–‡æ˜¯ä»å…¬å¸å†…ç½‘KBè½¬è¿‡æ¥çš„ï¼Œæ ¼å¼æœ‰ç‚¹æ··ä¹±æ‡’å¾—æ”¹äº†QAZ~~&lt;/p&gt;
&lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of
      
    
    </summary>
    
      <category term="æœªåˆ†ç±»" scheme="https://jasonsonghoho.github.io/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="cassandra" scheme="https://jasonsonghoho.github.io/public/tags/cassandra/"/>
    
      <category term="kairosdb" scheme="https://jasonsonghoho.github.io/public/tags/kairosdb/"/>
    
      <category term="jmeter" scheme="https://jasonsonghoho.github.io/public/tags/jmeter/"/>
    
  </entry>
  
</feed>
