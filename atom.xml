<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>jason&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://jasonsonghoho.github.io/"/>
  <updated>2018-10-30T09:03:13.706Z</updated>
  <id>https://jasonsonghoho.github.io/</id>
  
  <author>
    <name>jason song</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>BitMapã€BitSetä¸Bloom Filter</title>
    <link href="https://jasonsonghoho.github.io/2018/10/08/BitMap%E3%80%81BitSet%E4%B8%8EBloom%20Filter/"/>
    <id>https://jasonsonghoho.github.io/2018/10/08/BitMapã€BitSetä¸Bloom Filter/</id>
    <published>2018-10-08T02:36:11.000Z</published>
    <updated>2018-10-30T09:03:13.706Z</updated>
    
    <content type="html"><![CDATA[<p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š5åˆ†é’Ÿ</em></p><h3 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h3><p>å…ˆæ¥çœ‹ä¸€ä¸ªé—®é¢˜ï¼Œå‡è®¾ç°åœ¨æœ‰èŒƒå›´ä¸º 1-10 äº¿çš„ 11 äº¿ä¸ª int å‹æ•´æ•°ï¼Œå¦‚ä½•æ’é™¤æ‰å…¶ä¸­çš„é‡å¤æ•°å­—ï¼Ÿint å  4 ä¸ªå­—èŠ‚ï¼Œå¯ä»¥è¡¨ç¤º -2,147,483,648 ~ +2,147,483,647 çš„æ•°æ®ã€‚<br>æ‰€ä»¥ä¸€èˆ¬çš„æ€è·¯æ˜¯ä¼šå°†è¿™ 11 äº¿ä¸ªæ•°ä½œä¸º int å‹æ•°æ®å­˜åˆ°ä¸€ä¸ª HashSet é›†åˆä¸­è¿›è¡Œå»é‡ã€‚ä½†æ˜¯ï¼Œè¿™æ ·ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬çŸ¥é“ 1GB=1024KB=1024 <em> 1024Byte,é‚£ä¹ˆ 10äº¿ </em> 4Byte å°†å ç”¨æ¥è¿‘ 4GB çš„å†…å­˜ï¼Œè¿™å°†æ˜¯æå¤§çš„æ€§èƒ½æµªè´¹ï¼Œå¾ˆå¯èƒ½ä¼šå½±å“ç¨‹åºçš„å¥åº·è¿è¡Œã€‚</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>æˆ‘ä»¬å¯ä»¥è€ƒè™‘ç”¨â€ä½æ˜ å°„ï¼ˆBitMapï¼‰â€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªä½æ•°ç»„ï¼ˆbit[n]ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨ bit[i] æ¥è¡¨ç¤º 0-n ä¸­å¯¹åº”çš„æ•°å­—ï¼Œæ¯ä¸ªå…ƒç´ æœ‰ 1 å’Œ 0 ä¸¤ä¸ªå–å€¼ï¼Œåˆ†åˆ«ä»£è¡¨è¯¥æ•°å­—å­˜åœ¨ä¸å¦ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬è®°å½•ä¸€ä¸ªæ•°å­—åªéœ€è¦ä¸€ä¸ª bitï¼Œç›¸å¯¹äºä¹‹å‰çš„ int ç±»å‹(32 bit)ï¼Œæ•´æ•´ç¼©å°äº† 32 å€çš„å­˜å‚¨å¤§å°(4GB/32=125MB)!</p><p>æ‰©å±•ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬éœ€è¦è®°å½•æ¯ä¸ªæ•°å­—å‡ºç°æ¬¡æ•°æ˜¯å¦è¶…è¿‡ 2 æ¬¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿ç»­çš„ä¸¤ä½æ¥è®°å½•ä¸€ä¸ªæ•°å­—ï¼šä¸€ä½ç”¨æ¥è®°å½•æ˜¯å¦å‡ºç°ï¼Œå¦ä¸€ä½ç”¨æ¥è®°å½•æ˜¯å¦è¶…è¿‡ 2 æ¬¡ã€‚</p><p>ä¸è¿‡ï¼ŒJava ä¸­æ— æ³•åˆ›å»º bit æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ int æˆ– long æ•°ç»„æ¥å®ç°è¿™ä¸ªç›®çš„ã€‚å»ºç«‹ä¸€ä¸ª int æ•°ç»„ int[n]ï¼Œint[0] è®°å½•äº† 0-31ï¼Œint[1] è®°å½•äº† 32-63 â€¦â€¦ ä¾æ­¤ç±»æ¨ã€‚</p><h3 id="Java-BitSet"><a href="#Java-BitSet" class="headerlink" title="Java BitSet"></a>Java BitSet</h3><p>Java ä¸­æœ‰ä¸€ä¸ª BitSet ç±»ï¼Œä»å‘½åå°±å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ç”¨æ¥å­˜å‚¨å»é‡çš„ä½å…ƒç´ é›†åˆï¼Œå®ƒè¿˜æ”¯æŒ andã€or ç­‰ä½è¿ç®—ã€‚ç”¨æ¥è§£å†³æ–‡ç« å¼€å¤´çš„é—®é¢˜éå¸¸åˆé€‚ï¼Œæ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitSetStudy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BitSet bitSet = <span class="keyword">new</span> BitSet(<span class="number">1000000000</span>);</span><br><span class="line">        <span class="comment">//éšæœºç”Ÿæˆ 11 äº¿ä¸ªæ•°å­—</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1100000000</span>; i++) &#123;</span><br><span class="line">            bitSet.set((<span class="keyword">int</span>) (Math.random() * <span class="number">1000000000</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(bitSet.size());</span><br><span class="line">        System.out.println(<span class="string">"end"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å¼€ jconsole,å¯ä»¥çœ‹åˆ°å­˜å‚¨äº† bitset å¯¹è±¡çš„è€å¹´ä»£æ‰€å ç”¨çš„å†…å­˜ç¨³å®šåœ¨ 125MB å·¦å³ã€‚</p><img src="/2018/10/08/BitMapã€BitSetä¸Bloom%20Filter/bitset-mem.png"><p>å…³äº BitSet çš„ andã€andNotã€orã€xor æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    BitSet bitSet = <span class="keyword">new</span> BitSet();</span><br><span class="line">    bitSet.set(<span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">    BitSet bitSet1 = <span class="keyword">new</span> BitSet();</span><br><span class="line">    bitSet1.set(<span class="number">4</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    BitSet bitSetAnd = (BitSet) bitSet.clone();</span><br><span class="line">    BitSet bitSetAndNot = (BitSet) bitSet.clone();</span><br><span class="line">    BitSet bitSetOr = (BitSet) bitSet.clone();</span><br><span class="line">    BitSet bitSetXor = (BitSet) bitSet.clone();</span><br><span class="line"></span><br><span class="line">    bitSetAnd.and(bitSet1);</span><br><span class="line">    bitSetAndNot.andNot(bitSet1);</span><br><span class="line">    bitSetOr.or(bitSet1);</span><br><span class="line">    bitSetXor.xor(bitSet1);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"bitSet is : "</span> + bitSet + <span class="string">" , and bitSet1 is: "</span> + bitSet1);</span><br><span class="line">    System.out.println(<span class="string">"run bitSet.XMethod(bitSet1) , result is : "</span>);</span><br><span class="line">    System.out.println(<span class="string">"and:"</span> + bitSetAnd);</span><br><span class="line">    System.out.println(<span class="string">"andNot:"</span> + bitSetAndNot);</span><br><span class="line">    System.out.println(<span class="string">"or:"</span> + bitSetOr);</span><br><span class="line">    System.out.println(<span class="string">"xor:"</span> + bitSetXor);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bitSet is : &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125; , and bitSet1 is: &#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br><span class="line">run bitSet.XMethod(bitSet1) , result is :</span><br><span class="line">and:&#123;<span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">andNot:&#123;<span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">or:&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br><span class="line">xor:&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>&#125;</span><br></pre></td></tr></table></figure></p><h3 id="è‡ªå·±å®ç°-BitMap"><a href="#è‡ªå·±å®ç°-BitMap" class="headerlink" title="è‡ªå·±å®ç° BitMap"></a>è‡ªå·±å®ç° BitMap</h3><p>Java çš„ BitSet ä½¿ç”¨èµ·æ¥å­˜åœ¨å±€é™æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ BitSet å®ç°è‡ªå·±çš„ BitMap æ¥æ‰©å±•åº”ç”¨åœºæ™¯ã€‚æ ¸å¿ƒè¿˜æ˜¯é€šè¿‡ int/long æ•°ç»„å…ƒç´ çš„ä½æ¥è®°å½•æœ‰åºæ•°æ®ï¼Œä¸€ä¸ªå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitMap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] words;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BitMap</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        size = n;</span><br><span class="line">        <span class="comment">//æ¯ä¸ªintå 32ä½ï¼Œæ•°ç»„å¤§å°ä¸º n/32+1</span></span><br><span class="line">        words = <span class="keyword">new</span> <span class="keyword">int</span>[(size &gt;&gt; <span class="number">5</span>) + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> bit)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//è·å¾—æ•°æ®æ‰€åœ¨çš„æ•°ç»„åºå·ï¼ˆintï¼‰ï¼Œç›¸å½“äº bit/32</span></span><br><span class="line">        <span class="keyword">int</span> i = bit &gt;&gt; <span class="number">5</span>;</span><br><span class="line">        <span class="comment">//è·å¾—è¯¥intå…ƒç´ ä¸­è¦ä¿®æ”¹ä¸º1çš„æ•°å­—,ç›¸å½“äº bit%32</span></span><br><span class="line">        <span class="keyword">int</span> j = bit &amp; <span class="number">31</span>;</span><br><span class="line">        <span class="comment">//è·å¾—è¦ä¿®æ”¹çš„ä½</span></span><br><span class="line">        <span class="keyword">int</span> k = <span class="number">1</span> &lt;&lt; j;</span><br><span class="line">        <span class="comment">//å°†è¯¥å…ƒç´ ç›¸åº”çš„äºŒè¿›åˆ¶ä½è®¾ä¸º1</span></span><br><span class="line">        words[i] |= k ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> bit)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å‚è€ƒsetæ–¹æ³•ç†è§£</span></span><br><span class="line">        <span class="keyword">return</span> (words[bit &gt;&gt; <span class="number">5</span>] &amp; (<span class="number">1</span> &lt;&lt; (bit &amp; <span class="number">31</span>))) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°äº†æ ¸å¿ƒçš„å­˜å‚¨ç»“æ„ã€set å’Œ get æ–¹æ³•ã€‚</p><h3 id="å¸ƒéš†è¿‡æ»¤å™¨-Bloom-Filter"><a href="#å¸ƒéš†è¿‡æ»¤å™¨-Bloom-Filter" class="headerlink" title="å¸ƒéš†è¿‡æ»¤å™¨(Bloom Filter)"></a>å¸ƒéš†è¿‡æ»¤å™¨(Bloom Filter)</h3><p>äº†è§£å®Œ BitMap,æˆ‘ä»¬æŒæ¡äº†ä¸€ç§å¤„ç†å¤§é‡è¿ç»­æ•°æ®çš„å¥½æ–¹æ³•ã€‚ç°åœ¨ç»§ç»­æ‰©å±•ä¸€ä¸‹ï¼Œç°åœ¨å¦‚æœæˆ‘ä»¬è¦è®°å½•çš„æ˜¯æµ·é‡çš„åˆ†å¸ƒå¾ˆä¸å‡åŒ€çš„æ•°æ®ï¼Œå¦‚æœç»§ç»­ç”¨ BitMap çš„æ–¹å¼ï¼Œå°†ä¼šæµªè´¹å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œæˆ–è€…æ•°æ®é‡å·²ç»å¤§åˆ°ä½¿ç”¨ BitMap çš„æ–¹å¼ï¼Œä»ç„¶ä¼šæµªè´¹å¤§é‡çš„å†…å­˜ç©ºé—´ã€‚é¢å¯¹è¿™ä¸¤ç§æƒ…æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ã€‚</p><p>å¸ƒéš†è¿‡æ»¤å™¨æ ¸å¿ƒæ˜¯å¯¹ä¸€ä¸ª key ä½¿ç”¨å¤šä¸ª hash å‡½æ•°æ±‚å‡ºå¤šä¸ªå€¼ï¼Œå°†è¿™äº›å€¼æ•£åˆ—åœ¨ä¸€ä¸ªæœ‰é™çš„æ•°ç»„ä¸­ï¼Œè¿™æ ·ï¼Œå½“è¿™äº› hash å‡½æ•°æ±‚å‡ºçš„å€¼éƒ½ç¬¦åˆé¢„æœŸå°±è®¤ä¸ºè¯¥ key å­˜åœ¨ï¼›è‹¥åªè¦å­˜åœ¨ hash å‡½æ•°çš„å€¼ä¸ç¬¦åˆï¼Œå°±å¯ä»¥ç¡®å®šå®ƒä¸å­˜åœ¨ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè¿™ç§æ–¹æ³•æ•ˆæœéå¸¸å¥½ã€‚å›¾ç¤ºå¦‚ä¸‹ï¼š</p><img src="/2018/10/08/BitMapã€BitSetä¸Bloom%20Filter/bloom_filter.jpeg"><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ç§æ–¹æ³•å­˜åœ¨ä¸€å®šè¯¯å·®ï¼Œä¸è¿‡è¯¯å·®å‡ ç‡å¯ä»¥é€šè¿‡å¢åŠ  hash å‡½æ•°å’Œæ•£åˆ—æ•°ç»„å¤§å°æ¥å‡å°ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå½“æŸä¸ª key è¢«åˆ é™¤åï¼Œä¸èƒ½ç›´æ¥åœ¨æ•£åˆ—è¡¨ä¸­å°†å¯¹åº”çš„ value å»æ‰ï¼Œå› ä¸ºå¯èƒ½ä¼šå½±å“å…¶ä»– keyã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªé»‘åå•ï¼Œæ¯æ¬¡è®¡ç®— hash å‰ï¼Œå…ˆåˆ¤æ–­ key æ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Œæœ‰åˆ™è¡¨ç¤ºè¯¥ key å·²åˆ æ‰ã€‚</p><img src="/2018/10/08/BitMapã€BitSetä¸Bloom%20Filter/IMG_1753.GIF" title="10æ ‹*7å±‚*2ï¼ˆè‡³å°‘2ï¼‰å¥—=140å¥— å‘µå‘µğŸ˜…">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š5åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h3&gt;&lt;p&gt;å…ˆæ¥çœ‹ä¸€ä¸ªé—®é¢˜ï¼Œå‡è®¾ç°åœ¨æœ‰èŒƒå›´ä¸º 1-10 äº¿çš„ 11 äº¿ä¸ª int å‹æ•´æ•°ï¼Œå¦‚ä½•æ’é™¤
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="BitMap" scheme="https://jasonsonghoho.github.io/public/tags/BitMap/"/>
    
      <category term="BitSet" scheme="https://jasonsonghoho.github.io/public/tags/BitSet/"/>
    
      <category term="å¸ƒéš†è¿‡æ»¤å™¨" scheme="https://jasonsonghoho.github.io/public/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/"/>
    
      <category term="Bloom Filter" scheme="https://jasonsonghoho.github.io/public/tags/Bloom-Filter/"/>
    
  </entry>
  
  <entry>
    <title>Java 8 HashMap(ä¸Š)â€”â€” çº¢é»‘æ ‘</title>
    <link href="https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMap-%E4%B8%8A-%E2%80%94%E2%80%94-%E7%BA%A2%E9%BB%91%E6%A0%91/"/>
    <id>https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMap-ä¸Š-â€”â€”-çº¢é»‘æ ‘/</id>
    <published>2018-09-23T16:19:04.000Z</published>
    <updated>2018-09-23T16:45:18.176Z</updated>
    
    <content type="html"><![CDATA[<p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š10åˆ†é’Ÿ</em></p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><blockquote><p>Java8çš„æœ€å¤§ç‰¹æ€§æ˜¯ä½¿ç”¨çº¢é»‘æ ‘ç»“æ„æ¥å­˜å‚¨æ¯ä¸ªï¼ˆæ¡¶ï¼‰bucketä¸­çš„æ•°æ®ï¼ˆå½“é“¾è¡¨é•¿åº¦è¶…è¿‡8æ—¶ï¼‰ã€‚<br>ä¸ºä»€ä¹ˆå¼•å…¥çº¢é»‘æ ‘å‘¢ï¼Ÿå…¶å®æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¹³å‡æ¯ä¸ªæ¡¶ä¸­åº”è¯¥åªä¼šæœ‰ä¸åˆ°1ä¸ªæ•°æ®ï¼Œä½†å½“å‘ç”Ÿå¤§é‡Hashç¢°æ’æ—¶ï¼Œæ¯ä¸ªæ¡¶ä¸­çš„æ•°æ®ä¹Ÿå°†ä¼šå¤§é‡å¢åŠ ï¼Œè¿™å°†ä¼šå½±å“åˆ°æ•°æ®çš„æŸ¥è¯¢é€Ÿåº¦ã€‚åœ¨Java7ä¸­ï¼Œæ¯ä¸ªæ¡¶ä½¿ç”¨é“¾è¡¨å­˜å‚¨æ•°æ®ï¼ŒæŸ¥æ‰¾æ•°æ®é‡‡ç”¨éå†çš„æ–¹å¼ï¼ŒæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚Java7ä¸­ä¸ºäº†é¿å…å¤§é‡Hashç¢°æ’çš„é—®é¢˜ï¼Œå¼•å…¥äº†hashseedæ–¹å¼ï¼Œå¢å¼ºäº†Hashå‡½æ•°çš„æ•£åˆ—æ€§ã€‚ä½†æ˜¯randomHashSeedæ–¹æ³•è°ƒç”¨çš„nextæ–¹æ³•åœ¨å¤šçº¿ç¨‹è¿ç®—æ—¶å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼ˆå¾…è€ƒè¯ï¼‰ï¼Œæ•…åœ¨Java8ä¸­è¢«å¼ƒç”¨ã€‚Java8ä¸­æ¢äº†ä¸€ä¸ªæ€è·¯ï¼šä½¿ç”¨çº¢é»‘æ ‘æ¥æé«˜æŸ¥æ‰¾é€Ÿåº¦ï¼ˆO(logN)ï¼‰ï¼Œå³ä½¿å‘ç”Ÿå¤§é‡hashç¢°æ’ä¹Ÿä¸ä¼šé€ æˆæ€§èƒ½å½±å“ï¼Œè¿™ä¾¿æ˜¯çº¢é»‘æ ‘ç”±æ¥çš„åŸå› ã€‚<br>Java7çš„HashMapä¸€å…±æœ‰æ¥è¿‘1200è¡Œä»£ç ï¼Œè€Œåˆ°äº†Java8ç›´æ¥å¢åŠ åˆ°äº†2400è¡Œï¼Œå‡å»å…¨å±€å˜é‡å‰æ–°åŠ çš„100è¡Œæ³¨é‡Šï¼Œç›¸å·®1100è¡Œã€‚å…¶ä¸­TreeNode(çº¢é»‘æ ‘)å®ç°éƒ¨åˆ†æœ‰600è¡Œä»£ç ï¼Œå†åŠ ä¸Šå…¶ä»–æ–¹æ³•å¯¹çº¢é»‘æ ‘çš„é€‚åº”æ€§æ”¹åŠ¨ï¼Œå¯è§çº¢é»‘æ ‘éƒ¨åˆ†æ˜¯Java8 HashMapçš„ä¸»è¦æ”¹åŠ¨ã€‚  </p></blockquote><h3 id="è¯¦æƒ…"><a href="#è¯¦æƒ…" class="headerlink" title="è¯¦æƒ…"></a>è¯¦æƒ…</h3><h4 id="ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š"><a href="#ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š" class="headerlink" title="ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š"></a>ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</h4><img src="/2018/09/24/Java-8-HashMap-ä¸Š-â€”â€”-çº¢é»‘æ ‘/20180923214733.png"><p>TreeNodeç»§æ‰¿äº†LinkedHashMap.Entryï¼ŒLinkedHashMap.Entryç»§æ‰¿äº†HashMap.Nodeï¼Œè€ŒNodeå…¶å®å°±æ˜¯ä¸Šä¸ªç‰ˆæœ¬çš„Entryï¼ˆé“¾è¡¨ï¼‰ç»“æ„ã€‚æ­¤å¤„æœ‰ä¸ªç–‘æƒ‘ï¼šTreeNodeå¹¶æ²¡æœ‰ä½¿ç”¨LinkedHashMap.Entryçš„beforeå’Œafterå­—æ®µï¼Œä¸çŸ¥é“ä¸ºå•¥ä¸ç›´æ¥ç»§æ‰¿Nodeç±»ã€‚</p><h4 id="å­—æ®µå’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š"><a href="#å­—æ®µå’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š" class="headerlink" title="å­—æ®µå’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š"></a>å­—æ®µå’Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//å¸¸è§çš„æ ‘ç»“æ„</span></span><br><span class="line">    HashMap.TreeNode&lt;K, V&gt; parent;</span><br><span class="line">    HashMap.TreeNode&lt;K, V&gt; left;</span><br><span class="line">    HashMap.TreeNode&lt;K, V&gt; right;</span><br><span class="line">    HashMap.TreeNode&lt;K, V&gt; prev;</span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line"></span><br><span class="line">    TreeNode(<span class="keyword">int</span> hash, K key, V val, HashMap.Node&lt;K, V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="çº¢é»‘æ ‘å…¨éƒ¨æ–¹æ³•å¦‚ä¸‹ï¼š"><a href="#çº¢é»‘æ ‘å…¨éƒ¨æ–¹æ³•å¦‚ä¸‹ï¼š" class="headerlink" title="çº¢é»‘æ ‘å…¨éƒ¨æ–¹æ³•å¦‚ä¸‹ï¼š"></a>çº¢é»‘æ ‘å…¨éƒ¨æ–¹æ³•å¦‚ä¸‹ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–æ ¹ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">root</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; r = <span class="keyword">this</span>, p;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((p = r.parent) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        r = p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€‰å–æ ¹ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘è¿›è¡Œå·¦æ—‹ã€å³æ—‹åï¼Œæ ¹ç»“ç‚¹å¯èƒ½ç§»åŠ¨ï¼Œå¤´ç»“ç‚¹éœ€è¦é‡æ–°æŒ‡å‘æ–°çš„æ ¹ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">moveRootToFront</span><span class="params">(HashMap.Node&lt;K,V&gt;[] tab, HashMap.TreeNode&lt;K,V&gt; root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; tab != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> index = (n - <span class="number">1</span>) &amp; root.hash;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; first = (HashMap.TreeNode&lt;K,V&gt;)tab[index];</span><br><span class="line">        <span class="comment">//å¦‚æœæ ¹ç»“ç‚¹ä¸æ˜¯æ¡¶çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™å°†æ ¹ç»“ç‚¹ç§»åŠ¨åˆ°å¤´ç»“ç‚¹ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> (root != first) &#123;</span><br><span class="line">            HashMap.Node&lt;K,V&gt; rn;</span><br><span class="line">            tab[index] = root;</span><br><span class="line">            HashMap.TreeNode&lt;K,V&gt; rp = root.prev;</span><br><span class="line">            <span class="keyword">if</span> ((rn = root.next) != <span class="keyword">null</span>)</span><br><span class="line">                ((HashMap.TreeNode&lt;K,V&gt;)rn).prev = rp;</span><br><span class="line">            <span class="keyword">if</span> (rp != <span class="keyword">null</span>)</span><br><span class="line">                rp.next = rn;</span><br><span class="line">            <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">                first.prev = root;</span><br><span class="line">            root.next = first;</span><br><span class="line">            root.prev = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ–­è¨€çº¢é»‘æ ‘ç»“æ„æ˜¯å¦æ­£å¸¸ï¼Œä¸æ­£å¸¸åˆ™æŠ¥å¼‚å¸¸åœæ­¢</span></span><br><span class="line">        <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç»“ç‚¹hashå€¼ã€keyå’Œkeyçš„ç±»å‹ è¿›è¡Œçº¢é»‘æ ‘æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ph, dir; K pk;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; pl = p.left, pr = p.right, q;</span><br><span class="line">        <span class="comment">//å¾…æŸ¥è¯¢ç»“ç‚¹çš„keyçš„hashå€¼è‹¥å°äºå½“å‰ç»“ç‚¹åˆ™è¿›å…¥å·¦å­æ ‘ï¼Œå¦åˆ™è¿›å…¥å³å­æ ‘</span></span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="comment">//å¦‚æœhashå€¼ç›¸ç­‰å†æ¯”è¾ƒkeyï¼Œä¸€è‡´åˆ™è¡¨ç¤ºæ‰¾åˆ°ï¼Œè¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pl == <span class="keyword">null</span>)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pr == <span class="keyword">null</span>)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="comment">//å¦‚æœkeyä¸åŒï¼Œåˆ™çœ‹keyçš„ç±»å‹æ˜¯å¦å¯æ¯”è¾ƒï¼Œ</span></span><br><span class="line">        <span class="comment">//å¦‚æœå¯ä»¥æ¯”è¾ƒåˆ™æ ¹æ®æ¯”è¾ƒç»“æœé€‰æ‹©æ˜¯å¦è¿”å›æŸ¥è¯¢ç»“æœï¼Œè¿˜æ˜¯ç»§ç»­æŸ¥è¯¢å·¦ã€å³å­æ ‘</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="keyword">null</span> ||</span><br><span class="line">                (kc = comparableClassFor(k)) != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                (dir = compareComparables(kc, k, pk)) != <span class="number">0</span>)</span><br><span class="line">            p = (dir &lt; <span class="number">0</span>) ? pl : pr;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((q = pr.find(h, k, kc)) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> q;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p = pl;</span><br><span class="line">    &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç»“ç‚¹hashå€¼ã€key è¿›è¡Œçº¢é»‘æ ‘æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">getTreeNode</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>).find(h, k, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¼ºåˆ¶æ¯”è¾ƒä¸¤ä¸ªç»“ç‚¹çš„key</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å½“ä¸¤ä¸ªç±»å‹ä¸èƒ½ç›´æ¥æ¯”è¾ƒæ—¶ï¼Œé€šè¿‡å¯¹ç±»åè¿›è¡Œhashè¿›è¡Œæ¯”è¾ƒï¼›è‹¥hashå€¼ä¹Ÿç›¸ç­‰ï¼Œåˆ¤å®šbå¤§ã€‚</span></span><br><span class="line"><span class="comment"> * æ•…ä¸€å®šä¼šæ’å‡ºå…ˆåé¡ºåºã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tieBreakOrder</span><span class="params">(Object a, Object b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> d;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="keyword">null</span> || b == <span class="keyword">null</span> ||</span><br><span class="line">            (d = a.getClass().getName().</span><br><span class="line">                    compareTo(b.getClass().getName())) == <span class="number">0</span>)</span><br><span class="line">        d = (System.identityHashCode(a) &lt;= System.identityHashCode(b) ?</span><br><span class="line">                -<span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line"><span class="comment"> * é‡è¦æ–¹æ³•ï¼å½“é“¾è¡¨é•¿åº¦å¢åŠ åˆ°çº¢é»‘æ ‘è½¬æ¢é˜ˆå€¼ï¼ˆé»˜è®¤8ï¼‰ï¼Œä¸”æ¡¶çš„æ•°é‡ä¸å°äº64 æ—¶è§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeify</span><span class="params">(HashMap.Node&lt;K,V&gt;[] tab)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; root = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//éå†é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; x = <span class="keyword">this</span>, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">        next = (HashMap.TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">        x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//é¦–ç»“ç‚¹ä½œä¸ºæ ¹ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.parent = <span class="keyword">null</span>;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            root = x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            K k = x.key;</span><br><span class="line">            <span class="keyword">int</span> h = x.hash;</span><br><span class="line">            Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">                <span class="keyword">int</span> dir, ph;</span><br><span class="line">                K pk = p.key;</span><br><span class="line">                <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                    dir = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                    dir = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                        (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//å¦‚æœæœªèƒ½æ¯”è¾ƒï¼Œè°ƒç”¨å¼ºåˆ¶æ¯”è¾ƒæ–¹æ³•ï¼Œç¡®ä¿æœ‰åº</span></span><br><span class="line">                    dir = tieBreakOrder(k, pk);</span><br><span class="line"></span><br><span class="line">                HashMap.TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                <span class="comment">//å½“å·¦æˆ–å³å­æ ‘ä¸ºç©ºæ—¶ï¼Œæ’å…¥é“¾è¡¨ä¸Šçš„ä¸€ä¸ªç»“ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = xp;</span><br><span class="line">                    <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                        xp.left = x;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        xp.right = x;</span><br><span class="line">                    <span class="comment">//æ’å…¥ç»“ç‚¹åï¼Œè¿›è¡Œå·¦æ—‹ã€å³æ—‹é‡å¹³è¡¡ï¼Œè½¬æ¢ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                    root = balanceInsertion(root, x);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç¡®ä¿æ ¹ç»“ç‚¹æ˜¯é¦–ç»“ç‚¹</span></span><br><span class="line">    moveRootToFront(tab, root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘è½¬æ¢ä¸ºé“¾è¡¨</span></span><br><span class="line"><span class="comment"> * å½“çº¢é»‘æ ‘ç»“ç‚¹å‡å°‘åˆ°é“¾è¡¨è¿˜åŸé˜ˆå€¼ï¼ˆé»˜è®¤6ï¼‰æ—¶è§¦å‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">Node&lt;K,V&gt; <span class="title">untreeify</span><span class="params">(HashMap&lt;K,V&gt; map)</span> </span>&#123;</span><br><span class="line">    HashMap.Node&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.Node&lt;K,V&gt; q = <span class="keyword">this</span>; q != <span class="keyword">null</span>; q = q.next) &#123;</span><br><span class="line">        HashMap.Node&lt;K,V&gt; p = map.replacementNode(q, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">            hd = p;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            tl.next = p;</span><br><span class="line">        tl = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘æ’å…¥æ–°ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">putTreeVal</span><span class="params">(HashMap&lt;K,V&gt; map, HashMap.Node&lt;K,V&gt;[] tab,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> searched = <span class="keyword">false</span>;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; root = (parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> dir, ph; K pk;</span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">            dir = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">            dir = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!searched) &#123;</span><br><span class="line">                HashMap.TreeNode&lt;K,V&gt; q, ch;</span><br><span class="line">                searched = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//æ’å…¥ç»“ç‚¹ä¸å½“å‰ç»“ç‚¹hashå€¼ç›¸ç­‰æ—¶ï¼ŒæŸ¥æ‰¾å·¦å­æ ‘æˆ–å³å­æ ‘ï¼Œè‹¥å·²åŒ…å«å¾…æ’å…¥ç»“ç‚¹åˆ™ç›´æ¥è¿”å›ç»“æœ</span></span><br><span class="line">                <span class="keyword">if</span> (((ch = p.left) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        (q = ch.find(h, k, kc)) != <span class="keyword">null</span>) ||</span><br><span class="line">                        ((ch = p.right) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (q = ch.find(h, k, kc)) != <span class="keyword">null</span>))</span><br><span class="line">                    <span class="keyword">return</span> q;</span><br><span class="line">            &#125;</span><br><span class="line">            dir = tieBreakOrder(k, pk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">        <span class="comment">//è‹¥å·²æ¯”è¾ƒåˆ°å·¦å­æ ‘æˆ–å³å­æ ‘ä¸ºç©ºæ—¶è¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æ’å…¥è¯¥ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            HashMap.Node&lt;K,V&gt; xpn = xp.next;</span><br><span class="line">            HashMap.TreeNode&lt;K,V&gt; x = map.newTreeNode(h, k, v, xpn);</span><br><span class="line">            <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                xp.left = x;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                xp.right = x;</span><br><span class="line">            xp.next = x;</span><br><span class="line">            x.parent = x.prev = xp;</span><br><span class="line">            <span class="keyword">if</span> (xpn != <span class="keyword">null</span>)</span><br><span class="line">                ((HashMap.TreeNode&lt;K,V&gt;)xpn).prev = x;</span><br><span class="line">            moveRootToFront(tab, balanceInsertion(root, x));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ é™¤çº¢é»‘æ ‘ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> * å‘ƒï¼Œè¿™ä¸ªæ–¹æ³•å’Œå‰é¢çš„æ¯”èµ·æ¥å¤§åŒå°å¼‚ï¼Œä¸ç»†çœ‹äº†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">removeTreeNode</span><span class="params">(HashMap&lt;K,V&gt; map, HashMap.Node&lt;K,V&gt;[] tab,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> index = (n - <span class="number">1</span>) &amp; hash;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; first = (HashMap.TreeNode&lt;K,V&gt;)tab[index], root = first, rl;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; succ = (HashMap.TreeNode&lt;K,V&gt;)next, pred = prev;</span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">        tab[index] = first = succ;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pred.next = succ;</span><br><span class="line">    <span class="keyword">if</span> (succ != <span class="keyword">null</span>)</span><br><span class="line">        succ.prev = pred;</span><br><span class="line">    <span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (root.parent != <span class="keyword">null</span>)</span><br><span class="line">        root = root.root();</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span> || root.right == <span class="keyword">null</span> ||</span><br><span class="line">            (rl = root.left) == <span class="keyword">null</span> || rl.left == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è‹¥åˆ é™¤ç»“ç‚¹åï¼Œè¾¾åˆ°é“¾è¡¨è¿˜åŸé˜ˆå€¼ï¼Œåˆ™è¿˜åŸä¸ºé“¾è¡¨</span></span><br><span class="line">        tab[index] = first.untreeify(map);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>, pl = left, pr = right, replacement;</span><br><span class="line">    <span class="keyword">if</span> (pl != <span class="keyword">null</span> &amp;&amp; pr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; s = pr, sl;</span><br><span class="line">        <span class="keyword">while</span> ((sl = s.left) != <span class="keyword">null</span>) <span class="comment">// find successor</span></span><br><span class="line">            s = sl;</span><br><span class="line">        <span class="keyword">boolean</span> c = s.red; s.red = p.red; p.red = c; <span class="comment">// swap colors</span></span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; sr = s.right;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (s == pr) &#123; <span class="comment">// p was s's direct parent</span></span><br><span class="line">            p.parent = s;</span><br><span class="line">            s.right = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            HashMap.TreeNode&lt;K,V&gt; sp = s.parent;</span><br><span class="line">            <span class="keyword">if</span> ((p.parent = sp) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (s == sp.left)</span><br><span class="line">                    sp.left = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    sp.right = p;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((s.right = pr) != <span class="keyword">null</span>)</span><br><span class="line">                pr.parent = s;</span><br><span class="line">        &#125;</span><br><span class="line">        p.left = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> ((p.right = sr) != <span class="keyword">null</span>)</span><br><span class="line">            sr.parent = p;</span><br><span class="line">        <span class="keyword">if</span> ((s.left = pl) != <span class="keyword">null</span>)</span><br><span class="line">            pl.parent = s;</span><br><span class="line">        <span class="keyword">if</span> ((s.parent = pp) == <span class="keyword">null</span>)</span><br><span class="line">            root = s;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">            pp.left = s;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = s;</span><br><span class="line">        <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">            replacement = sr;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            replacement = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pl != <span class="keyword">null</span>)</span><br><span class="line">        replacement = pl;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pr != <span class="keyword">null</span>)</span><br><span class="line">        replacement = pr;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        replacement = p;</span><br><span class="line">    <span class="keyword">if</span> (replacement != p) &#123;</span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; pp = replacement.parent = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (pp == <span class="keyword">null</span>)</span><br><span class="line">            root = replacement;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">            pp.left = replacement;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = replacement;</span><br><span class="line">        p.left = p.right = p.parent = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; r = p.red ? root : balanceDeletion(root, replacement);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (replacement == p) &#123;  <span class="comment">// detach</span></span><br><span class="line">        HashMap.TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">        p.parent = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p == pp.left)</span><br><span class="line">                pp.left = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == pp.right)</span><br><span class="line">                pp.right = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (movable)</span><br><span class="line">        moveRootToFront(tab, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†çº¢é»‘æ ‘åˆ†ä¸ºä¸¤åŠ</span></span><br><span class="line"><span class="comment"> * æ‰©å®¹æ—¶ï¼Œä¼šå°†ä¸€ä¸ªæ¡¶ä¸­çš„çº¢é»‘æ ‘æ‹†åˆ†ä¸ºä¸¤ä¸ªï¼›è‹¥æ‹†åˆ†åçº¢é»‘æ ‘ä¸å¤Ÿå¤§ï¼Œä¼šè¢«è¿˜åŸä¸ºé“¾è¡¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">split</span><span class="params">(HashMap&lt;K,V&gt; map, HashMap.Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index, <span class="keyword">int</span> bit)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; b = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// Relink into lo and hi lists, preserving order</span></span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; e = b, next; e != <span class="keyword">null</span>; e = next) &#123;</span><br><span class="line">        next = (HashMap.TreeNode&lt;K,V&gt;)e.next;</span><br><span class="line">        e.next = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash &amp; bit) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                loHead = e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                loTail.next = e;</span><br><span class="line">            loTail = e;</span><br><span class="line">            ++lc;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((e.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                hiHead = e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                hiTail.next = e;</span><br><span class="line">            hiTail = e;</span><br><span class="line">            ++hc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class="line">            tab[index] = loHead.untreeify(map);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[index] = loHead;</span><br><span class="line">            <span class="keyword">if</span> (hiHead != <span class="keyword">null</span>) <span class="comment">// (else is already treeified)</span></span><br><span class="line">                loHead.treeify(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hiHead != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class="line">            tab[index + bit] = hiHead.untreeify(map);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[index + bit] = hiHead;</span><br><span class="line">            <span class="keyword">if</span> (loHead != <span class="keyword">null</span>)</span><br><span class="line">                hiHead.treeify(tab);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ------------------------------------------------------------ */</span></span><br><span class="line"><span class="comment">// Red-black tree methods, all adapted from CLR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘çš„å·¦æ—‹</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘ç›¸å…³çŸ¥è¯†å¾…æ·±å…¥å­¦ä¹ åè¿›ä¸€æ­¥æ¢è®¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateLeft</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              HashMap.TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; r, pp, rl;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (r = p.right) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((rl = p.right = r.left) != <span class="keyword">null</span>)</span><br><span class="line">            rl.parent = p;</span><br><span class="line">        <span class="keyword">if</span> ((pp = r.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">            (root = r).red = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pp.left == p)</span><br><span class="line">            pp.left = r;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.right = r;</span><br><span class="line">        r.left = p;</span><br><span class="line">        p.parent = r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¢é»‘æ ‘çš„å³æ—‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">rotateRight</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               HashMap.TreeNode&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; l, pp, lr;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (l = p.left) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((lr = p.left = l.right) != <span class="keyword">null</span>)</span><br><span class="line">            lr.parent = p;</span><br><span class="line">        <span class="keyword">if</span> ((pp = l.parent = p.parent) == <span class="keyword">null</span>)</span><br><span class="line">            (root = l).red = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pp.right == p)</span><br><span class="line">            pp.right = l;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pp.left = l;</span><br><span class="line">        l.right = p;</span><br><span class="line">        p.parent = l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ’å…¥ç»“ç‚¹åè¿›è¡Œé‡å¹³è¡¡</span></span><br><span class="line"><span class="comment"> * è¿™éƒ¨åˆ†åªçœ‹æ‡‚ä»£ç äº†ï¼Œç®—æ³•æ¯”è¾ƒæ‡µï¼Œæœ‰æœºä¼šå†æ¢è®¨çº¢é»‘æ ‘ç®—æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceInsertion</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; root, HashMap.TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å°†æ’å…¥çš„ç»“ç‚¹è®¾ä¸ºçº¢è‰²</span></span><br><span class="line">    x.red = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123;</span><br><span class="line">        <span class="comment">//xä¸ºæ ¹ç»“ç‚¹æ—¶ï¼Œè®¾ä¸ºé»‘è‰²ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//çˆ¶ç»“ç‚¹ä¸ºé»‘ä¸”ä¸ºæ ¹ç»“ç‚¹æ—¶ï¼Œç›´æ¥è¿”å›ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!xp.red || (xpp = xp.parent) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        <span class="comment">//çˆ¶ç»“ç‚¹ä¸ºç¥–çˆ¶ç»“ç‚¹çš„å·¦å­©å­ç»“ç‚¹æ—¶ï¼š</span></span><br><span class="line">        <span class="keyword">if</span> (xp == (xppl = xpp.left)) &#123;</span><br><span class="line">            <span class="comment">//ç¥–çˆ¶ç»“ç‚¹çš„å³å­©å­ç»“ç‚¹ä¸ºçº¢è‰²æ—¶ï¼Œå”å”ç»“ç‚¹å’Œçˆ¶ç»“ç‚¹ç½®é»‘ï¼Œç¥–çˆ¶ç»“ç‚¹ç½®çº¢ï¼Œè®¾ç½®å½“å‰ç»“ç‚¹ä¸ºç¥–çˆ¶ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> ((xppr = xpp.right) != <span class="keyword">null</span> &amp;&amp; xppr.red) &#123;</span><br><span class="line">                xppr.red = <span class="keyword">false</span>;</span><br><span class="line">                xp.red = <span class="keyword">false</span>;</span><br><span class="line">                xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                x = xpp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//å¦åˆ™ï¼Œå¦‚æœå½“å‰ç»“ç‚¹ä¸ºçˆ¶ç»“ç‚¹çš„å³å­©å­ç»“ç‚¹ï¼Œè¿›è¡Œå·¦æ—‹</span></span><br><span class="line">                <span class="keyword">if</span> (x == xp.right) &#123;</span><br><span class="line">                    root = rotateLeft(root, x = xp);</span><br><span class="line">                    xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœçˆ¶ç»“ç‚¹ä¸ä¸ºç©ºè®¾ä¸ºé»‘è‰²ï¼Œä¸”å¦‚æœç¥–çˆ¶ç»“ç‚¹ä¸ä¸ºç©ºåˆ™è®¾ä¸ºçº¢è‰²å¹¶è¿›è¡Œå³æ—‹</span></span><br><span class="line">                <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    xp.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateRight(root, xpp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (xppl != <span class="keyword">null</span> &amp;&amp; xppl.red) &#123;</span><br><span class="line">                xppl.red = <span class="keyword">false</span>;</span><br><span class="line">                xp.red = <span class="keyword">false</span>;</span><br><span class="line">                xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                x = xpp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (x == xp.left) &#123;</span><br><span class="line">                    root = rotateRight(root, x = xp);</span><br><span class="line">                    xpp = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    xp.red = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (xpp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpp.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateLeft(root, xpp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ é™¤ç»“ç‚¹åè¿›è¡Œé‡å¹³è¡¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; HashMap.<span class="function">TreeNode&lt;K,V&gt; <span class="title">balanceDeletion</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; root,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                   HashMap.TreeNode&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (HashMap.TreeNode&lt;K,V&gt; xp, xpl, xpr;;)  &#123;</span><br><span class="line">        <span class="keyword">if</span> (x == <span class="keyword">null</span> || x == root)</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((xp = x.parent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x.red) &#123;</span><br><span class="line">            x.red = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((xpl = xp.left) == x) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((xpr = xp.right) != <span class="keyword">null</span> &amp;&amp; xpr.red) &#123;</span><br><span class="line">                xpr.red = <span class="keyword">false</span>;</span><br><span class="line">                xp.red = <span class="keyword">true</span>;</span><br><span class="line">                root = rotateLeft(root, xp);</span><br><span class="line">                xpr = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.right;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (xpr == <span class="keyword">null</span>)</span><br><span class="line">                x = xp;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                HashMap.TreeNode&lt;K,V&gt; sl = xpr.left, sr = xpr.right;</span><br><span class="line">                <span class="keyword">if</span> ((sr == <span class="keyword">null</span> || !sr.red) &amp;&amp;</span><br><span class="line">                        (sl == <span class="keyword">null</span> || !sl.red)) &#123;</span><br><span class="line">                    xpr.red = <span class="keyword">true</span>;</span><br><span class="line">                    x = xp;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sr == <span class="keyword">null</span> || !sr.red) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sl != <span class="keyword">null</span>)</span><br><span class="line">                            sl.red = <span class="keyword">false</span>;</span><br><span class="line">                        xpr.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateRight(root, xpr);</span><br><span class="line">                        xpr = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                                <span class="keyword">null</span> : xp.right;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xpr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpr.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                        <span class="keyword">if</span> ((sr = xpr.right) != <span class="keyword">null</span>)</span><br><span class="line">                            sr.red = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>;</span><br><span class="line">                        root = rotateLeft(root, xp);</span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// symmetric</span></span><br><span class="line">            <span class="keyword">if</span> (xpl != <span class="keyword">null</span> &amp;&amp; xpl.red) &#123;</span><br><span class="line">                xpl.red = <span class="keyword">false</span>;</span><br><span class="line">                xp.red = <span class="keyword">true</span>;</span><br><span class="line">                root = rotateRight(root, xp);</span><br><span class="line">                xpl = (xp = x.parent) == <span class="keyword">null</span> ? <span class="keyword">null</span> : xp.left;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (xpl == <span class="keyword">null</span>)</span><br><span class="line">                x = xp;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                HashMap.TreeNode&lt;K,V&gt; sl = xpl.left, sr = xpl.right;</span><br><span class="line">                <span class="keyword">if</span> ((sl == <span class="keyword">null</span> || !sl.red) &amp;&amp;</span><br><span class="line">                        (sr == <span class="keyword">null</span> || !sr.red)) &#123;</span><br><span class="line">                    xpl.red = <span class="keyword">true</span>;</span><br><span class="line">                    x = xp;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sl == <span class="keyword">null</span> || !sl.red) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (sr != <span class="keyword">null</span>)</span><br><span class="line">                            sr.red = <span class="keyword">false</span>;</span><br><span class="line">                        xpl.red = <span class="keyword">true</span>;</span><br><span class="line">                        root = rotateLeft(root, xpl);</span><br><span class="line">                        xpl = (xp = x.parent) == <span class="keyword">null</span> ?</span><br><span class="line">                                <span class="keyword">null</span> : xp.left;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xpl.red = (xp == <span class="keyword">null</span>) ? <span class="keyword">false</span> : xp.red;</span><br><span class="line">                        <span class="keyword">if</span> ((sl = xpl.left) != <span class="keyword">null</span>)</span><br><span class="line">                            sl.red = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (xp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        xp.red = <span class="keyword">false</span>;</span><br><span class="line">                        root = rotateRight(root, xp);</span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥çº¢é»‘æ ‘ç»“æ„æ˜¯å¦æ­£å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">checkInvariants</span><span class="params">(HashMap.TreeNode&lt;K,V&gt; t)</span> </span>&#123;</span><br><span class="line">    HashMap.TreeNode&lt;K,V&gt; tp = t.parent, tl = t.left, tr = t.right,</span><br><span class="line">            tb = t.prev, tn = (HashMap.TreeNode&lt;K,V&gt;)t.next;</span><br><span class="line">    <span class="keyword">if</span> (tb != <span class="keyword">null</span> &amp;&amp; tb.next != t)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tn != <span class="keyword">null</span> &amp;&amp; tn.prev != t)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tp != <span class="keyword">null</span> &amp;&amp; t != tp.left &amp;&amp; t != tp.right)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; (tl.parent != t || tl.hash &gt; t.hash))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; (tr.parent != t || tr.hash &lt; t.hash))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (t.red &amp;&amp; tl != <span class="keyword">null</span> &amp;&amp; tl.red &amp;&amp; tr != <span class="keyword">null</span> &amp;&amp; tr.red)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tl != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tl))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (tr != <span class="keyword">null</span> &amp;&amp; !checkInvariants(tr))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2018/09/24/Java-8-HashMap-ä¸Š-â€”â€”-çº¢é»‘æ ‘/IMG_1756.GIF"><p>Java8çš„HashMapè§£è¯»æš‚å‘Šä¸€æ®µè½ï¼Œä¸‹æœŸç»§ç»­æ¢è®¨å…¶ä»–ç‰¹æ€§ï¼Œå¸Œæœ›ä¸è¦å¤ªä¹…ğŸ˜‚</p><p><a href="https://y.qq.com/n/yqq/song/004dbfuf1jEjpI.html#stat=y_new.index.new_song.songname" target="_blank" rel="noopener">https://y.qq.com/n/yqq/song/004dbfuf1jEjpI.html#stat=y_new.index.new_song.songname</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š10åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;Java8çš„æœ€å¤§ç‰¹æ€§æ˜¯ä½¿ç”¨çº¢é»‘æ ‘ç»“æ„æ¥å­˜å‚¨æ¯ä¸ªï¼ˆæ¡¶ï¼‰buc
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="HashMap" scheme="https://jasonsonghoho.github.io/public/tags/HashMap/"/>
    
      <category term="çº¢é»‘æ ‘" scheme="https://jasonsonghoho.github.io/public/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/"/>
    
  </entry>
  
  <entry>
    <title>Java 8 HashMap(ä¸‹)â€”â€” compute</title>
    <link href="https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMap%EF%BC%88%E4%B8%8B%EF%BC%89%E2%80%94%E2%80%94%20compute/"/>
    <id>https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMapï¼ˆä¸‹ï¼‰â€”â€” compute/</id>
    <published>2018-09-23T16:19:04.000Z</published>
    <updated>2018-10-04T07:57:06.137Z</updated>
    
    <content type="html"><![CDATA[<img src="/2018/09/24/Java-8-HashMapï¼ˆä¸‹ï¼‰â€”â€”%20compute/IMG_0011.JPG" title="æ•…ä¹¡çš„æœˆ"><p><em>æ¨èé˜…è¯»æ—¶é—´ï¼š5åˆ†é’Ÿ</em></p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>æœ¬ç¯‡æ¥ä¸Šç¯‡ <a href="https://jasonsonghoho.github.io/2018/09/24/Java-8-HashMap-%E4%B8%8A-%E2%80%94%E2%80%94-%E7%BA%A2%E9%BB%91%E6%A0%91/">Java 8 HashMap (ä¸Š)â€”â€” çº¢é»‘æ ‘</a>ï¼Œ<br>ç»§ç»­æ¢è®¨ Java8 çš„HashMap çš„æ–°ç‰¹æ€§ã€‚å†…å®¹ä¸å¤šï¼Œé‡ç‚¹ä»‹ç» compute æ–¹æ³•ã€‚</p><h3 id="compute"><a href="#compute" class="headerlink" title="compute"></a>compute</h3><p>compute æ–¹æ³•ä¸»è¦ç”¨æ¥å°†ä¸€ä¸ªå¤æ‚è®¡ç®—çš„ç»“æœä½œä¸ºå€¼èµ‹ç»™æŒ‡å®šçš„é”®ã€‚key æŒ‡å¾…ä¿®æ”¹æˆ–æ’å…¥çš„é”®ï¼ŒremappingFunction æ˜¯ä¸€ä¸ª BiFunction å¯¹è±¡ã€‚<br>BiFunction æ˜¯æŒ‡ä¸€ä¸ª äºŒå…ƒï¼ˆbinaryï¼‰å‡½æ•°ï¼›å®šä¹‰æ—¶ï¼ŒæŒ‡å®šä¸¤ä¸ªå…¥å‚å­—æ®µç±»å‹å’Œä¸€ä¸ªç»“æœå­—æ®µç±»å‹ã€‚é€šè¿‡å®ç° apply æ–¹æ³•æ¥è‡ªå®šä¹‰è®¡ç®—é€»è¾‘ã€‚</p><p>BiFunction éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BiFunction</span>&lt;<span class="title">T</span>, <span class="title">U</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Applies this function to the given arguments.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the first function argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> u the second function argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the function result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">R <span class="title">apply</span><span class="params">(T t, U u)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>compute æ–¹æ³•æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">compute</span><span class="params">(K key, BiFunction&lt;? <span class="keyword">super</span> K, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remappingFunction == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; t = <span class="keyword">null</span>;</span><br><span class="line">    Node&lt;K,V&gt; old = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; threshold || (tab = table) == <span class="keyword">null</span> ||</span><br><span class="line">        (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">//æ ¹æ® key å€¼ï¼Œæ‰¾åˆ°å¯¹åº”çš„ æ—§å€¼</span></span><br><span class="line">    <span class="keyword">if</span> ((first = tab[i = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            old = (t = (TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt; e = first; K k;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                    old = e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ++binCount;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    V oldValue = (old == <span class="keyword">null</span>) ? <span class="keyword">null</span> : old.value;</span><br><span class="line">    <span class="comment">//è®¡ç®—å‡ºæ–°å€¼</span></span><br><span class="line">    V v = remappingFunction.apply(key, oldValue);</span><br><span class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">            old.value = v;</span><br><span class="line">            afterNodeAccess(old);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ–°å€¼ä¸º nullï¼Œåˆ æ‰è¿™ä¸ª Node</span></span><br><span class="line">            removeNode(hash, key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæ–°å€¼ä¸ä¸º nullï¼Œæ›¿æ¢è¿™ä¸ª Node</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>)</span><br><span class="line">            t.putTreeVal(<span class="keyword">this</span>, tab, hash, key, v);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tab[i] = newNode(hash, key, v, first);</span><br><span class="line">            <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                treeifyBin(tab, hash);</span><br><span class="line">        &#125;</span><br><span class="line">        ++modCount;</span><br><span class="line">        ++size;</span><br><span class="line">        afterNodeInsertion(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>computeIfAbsentã€computeIfPresent æ–¹æ³•ä¸ compute ç±»ä¼¼ï¼Œåˆ†åˆ«è¡¨ç¤ºå½“ç›¸åº”é”®çš„å€¼ç¼ºå¸­ã€å­˜åœ¨æ—¶ï¼Œæ‰è¿›è¡Œ compute æ–¹æ³•ã€‚<br>æºç ä¸ compute åŸºæœ¬ä¸€è‡´ï¼Œä¸èµ˜è¿°ã€‚</p><p>demo å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, String&gt; hashMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    hashMap.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">    hashMap.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line">    hashMap.put(<span class="string">"k3"</span>, <span class="string">"v3"</span>);</span><br><span class="line">    Function&lt;String, String&gt; function = <span class="keyword">new</span> Function&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"test_"</span> + s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    BiFunction&lt;String, String, String&gt; biFunction = <span class="keyword">new</span> BiFunction&lt;String, String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(String s, String s2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"test_"</span> + s + <span class="string">"_"</span> + s2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    hashMap.compute(<span class="string">"k1"</span>, biFunction);<span class="comment">//ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.compute(<span class="string">"k11"</span>, biFunction);<span class="comment">//ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.computeIfAbsent(<span class="string">"k2"</span>, function);<span class="comment">//ä¸ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.computeIfAbsent(<span class="string">"k21"</span>, function);<span class="comment">//ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.computeIfPresent(<span class="string">"k3"</span>, biFunction);<span class="comment">//ç”Ÿæ•ˆ</span></span><br><span class="line">    hashMap.computeIfPresent(<span class="string">"k31"</span>, biFunction);<span class="comment">//ä¸ç”Ÿæ•ˆ</span></span><br><span class="line">    System.out.println(hashMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;k1=test_k1_v1, k2=v2, k3=test_k3_v3, k11=test_k11_null, k21=test_k21&#125;</span><br></pre></td></tr></table></figure></p><h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><p>merge æ–¹æ³•æ˜¯æ ¹æ®æ—§å€¼è¿›è¡Œè®¡ç®—ï¼Œä¿®æ”¹ç›¸åº” Nodeã€‚ä¸ compute ç»“æ„ç›¸ä¼¼ï¼Œä¸è¿‡ BiFunction å…¥å‚ä¸º oldValue,newValueã€‚<br>æºç ä¸ compute åŸºæœ¬ä¸€è‡´ï¼Œä¸èµ˜è¿°ã€‚</p><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å…¶ä»–æ–°å¢çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">getOrDefault</span><span class="params">(Object key, V defaultValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? defaultValue : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">putIfAbsent</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> removeNode(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e; V v;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        ((v = e.value) == oldValue || (v != <span class="keyword">null</span> &amp;&amp; v.equals(oldValue)))) &#123;</span><br><span class="line">        e.value = newValue;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        V oldValue = e.value;</span><br><span class="line">        e.value = value;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>getOrDefault æ–¹æ³•æ ¹æ® key è·å–ç›¸åº”çš„å€¼ï¼Œå¦‚æœä¸º nullï¼Œåˆ™è¿”å›è®¾ç½®çš„é»˜è®¤å€¼ã€‚</li><li>putIfAbsent æ–¹æ³•ä¼šåœ¨ æŒ‡å®šçš„ key ä¸å­˜åœ¨æ—¶ï¼Œæ’å…¥ç›¸åº”çš„å€¼ã€‚</li><li>remove(Object key, Object value) æ–¹æ³•ä¼šæ ¹æ® key å’Œ value è¿›è¡Œåˆ é™¤ï¼Œå¦‚æœ ç›¸åº” key çš„å€¼ä¸ä¸ºè¯¥ valueï¼Œåˆ™ä¸æ‰§è¡Œåˆ é™¤å¹¶è¿”å› falseã€‚</li><li>replace(K key, V oldValue, V newValue) ä¸ replace(K key, V value) éƒ½æ˜¯æ›¿æ¢å€¼çš„æ“ä½œï¼Œå…·ä½“åŒºåˆ«ä¸ä¸Šè¿°æ–¹æ³•ç±»ä¼¼ã€‚</li></ol><h3 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h3><p>HashMapå†æ—¶ä¸€ä¸ªåŠæœˆï¼Œç»ˆäºå‘Šä¸€æ®µè½äº†ğŸ˜‚ã€‚</p><p>ç”±äºåœ¨æºç åˆ†æç³»åˆ—å«æœ‰å¤§é‡ä»£ç ï¼Œæ”¾åœ¨å…¬ä¼—å·ä¸Šä¸æ–¹ä¾¿é˜…è¯»ï¼Œåç»­å†™çš„è¯ä¼šå‘åœ¨åšå®¢ä¸Šã€‚æœ‰å…´è¶£çš„æ¬¢è¿è®¿é—® <a href="http://jasonsonghoho.github.io">http://jasonsonghoho.github.io</a> ã€‚</p><hr><img src="/2018/09/24/Java-8-HashMapï¼ˆä¸‹ï¼‰â€”â€”%20compute/IMG_0007.JPG"><p><em>â€œä½ ä¸çŸ¥<br>è¿™é£é›ªä¸€ç¨‹<br>æœ‰å¤ªå¤šä¸æ˜“â€</em></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;img src=&quot;/2018/09/24/Java-8-HashMapï¼ˆä¸‹ï¼‰â€”â€”%20compute/IMG_0011.JPG&quot; title=&quot;æ•…ä¹¡çš„æœˆ&quot;&gt;
&lt;p&gt;&lt;em&gt;æ¨èé˜…è¯»æ—¶é—´ï¼š5åˆ†é’Ÿ&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="HashMap" scheme="https://jasonsonghoho.github.io/public/tags/HashMap/"/>
    
  </entry>
  
  <entry>
    <title>Java 7 HashMap æºç è§£è¯»</title>
    <link href="https://jasonsonghoho.github.io/2018/08/18/Java-7-HashMap-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    <id>https://jasonsonghoho.github.io/2018/08/18/Java-7-HashMap-æºç è§£è¯»/</id>
    <published>2018-08-18T02:31:46.000Z</published>
    <updated>2018-09-22T02:33:29.034Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/nHk9jKapNVVkBDnKChgK0Q" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/nHk9jKapNVVkBDnKChgK0Q</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/nHk9jKapNVVkBDnKChgK0Q&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/nHk9jKapNVVkBDn
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/public/tags/Java/"/>
    
      <category term="HashMap" scheme="https://jasonsonghoho.github.io/public/tags/HashMap/"/>
    
  </entry>
  
  <entry>
    <title>Reactå¿«é€Ÿå…¥é—¨</title>
    <link href="https://jasonsonghoho.github.io/2018/06/24/React%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>https://jasonsonghoho.github.io/2018/06/24/Reactå¿«é€Ÿå…¥é—¨/</id>
    <published>2018-06-24T02:34:27.000Z</published>
    <updated>2018-09-22T02:52:12.539Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/fDXQe_QCBN4q6zfzKQr1jQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/fDXQe_QCBN4q6zfzKQr1jQ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/fDXQe_QCBN4q6zfzKQr1jQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/fDXQe_QCBN4q6zf
      
    
    </summary>
    
      <category term="å‰ç«¯" scheme="https://jasonsonghoho.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="React" scheme="https://jasonsonghoho.github.io/public/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨ç‰©å›­ç®¡ç†å‘˜â€”â€”ZooKeeper</title>
    <link href="https://jasonsonghoho.github.io/2018/06/05/%E5%8A%A8%E7%89%A9%E5%9B%AD%E7%AE%A1%E7%90%86%E5%91%98%E2%80%94%E2%80%94ZooKeeper/"/>
    <id>https://jasonsonghoho.github.io/2018/06/05/åŠ¨ç‰©å›­ç®¡ç†å‘˜â€”â€”ZooKeeper/</id>
    <published>2018-06-05T02:35:00.000Z</published>
    <updated>2018-09-22T02:52:12.560Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/hnfWq1sHD8qxKoXHKwJhiw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/hnfWq1sHD8qxKoXHKwJhiw</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/hnfWq1sHD8qxKoXHKwJhiw&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/hnfWq1sHD8qxKoX
      
    
    </summary>
    
      <category term="ä¸­é—´ä»¶" scheme="https://jasonsonghoho.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="ZooKeeper" scheme="https://jasonsonghoho.github.io/public/tags/ZooKeeper/"/>
    
  </entry>
  
  <entry>
    <title>MySQLç©¶ç«Ÿå¦‚ä½•è§£å†³â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€çš„</title>
    <link href="https://jasonsonghoho.github.io/2018/05/27/MySQL%E7%A9%B6%E7%AB%9F%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E2%80%9C%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E2%80%9D%E5%92%8C%E2%80%9C%E5%B9%BB%E8%AF%BB%E2%80%9D%E7%9A%84/"/>
    <id>https://jasonsonghoho.github.io/2018/05/27/MySQLç©¶ç«Ÿå¦‚ä½•è§£å†³â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€çš„/</id>
    <published>2018-05-26T16:35:44.000Z</published>
    <updated>2018-09-22T02:30:44.066Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/Ej3coEuouPqbzkL0-J8tIQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/Ej3coEuouPqbzkL0-J8tIQ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/Ej3coEuouPqbzkL0-J8tIQ&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/Ej3coEuouPqbzkL
      
    
    </summary>
    
      <category term="æ•°æ®åº“" scheme="https://jasonsonghoho.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="mysql" scheme="https://jasonsonghoho.github.io/public/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>æˆ‘ä»¬ä¸ºæå‡ Cassandra è¯»æ€§èƒ½åšäº†å“ªäº›åŠªåŠ›ï¼Ÿ</title>
    <link href="https://jasonsonghoho.github.io/2018/05/21/180521/"/>
    <id>https://jasonsonghoho.github.io/2018/05/21/180521/</id>
    <published>2018-05-21T14:08:41.000Z</published>
    <updated>2018-09-20T15:23:28.340Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><ul><li>å…³äºCassandra</li><li>æå‡è¯»æ€§èƒ½</li></ul><h2 id="å…³äºCassandra"><a href="#å…³äºCassandra" class="headerlink" title="å…³äºCassandra"></a>å…³äºCassandra</h2><p>Apache Cassandraæ˜¯ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œ<br>ç”¨äºå¤„ç†å¤§é‡å¸¸è§„æœåŠ¡å™¨ä¸Šçš„å¤§é‡æ•°æ®ï¼Œæä¾›é«˜å¯ç”¨æ€§ï¼Œæ— å•ç‚¹æ•…éšœã€‚å®ƒæ˜¯ä¸€ç§NoSQLç±»å‹çš„æ•°æ®åº“ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å›½å¤–æƒå¨æœºæ„<a href="https://db-engines.com/en/ranking" target="_blank" rel="noopener">DB-Engines</a>æœ€è¿‘çš„æ•°æ®åº“å…¨çƒæµè¡Œç¨‹åº¦æ’åï¼š</p><img src="/2018/05/21/180521/database_rank.png" title="æ•°æ®åº“æ’å"><p>å¯ä»¥çœ‹å‡ºï¼ŒCassandra æ˜¯æ’åå‰åä¸­å››ä¸ªä»…æœ‰çš„NoSQLæ•°æ®åº“ä¹‹ä¸€ã€‚Cassandraåœ¨å›½å¤–è¿™æ ·å—æ¬¢è¿ï¼Œå…¶æ€§èƒ½å¯æƒ³è€ŒçŸ¥ä¸ä¼šå·®ï¼Œ<br>ä½†æ˜¯åœ¨å›½å†…è²Œä¼¼è¿˜æ²¡æœ‰å¤šå°‘å…¬å¸ä½¿ç”¨ï¼Œä¸”å›½å†…å…³äº Cassandraæ–¹é¢çš„èµ„æ–™è¾ƒå°‘ã€‚</p><h2 id="æå‡è¯»æ€§èƒ½"><a href="#æå‡è¯»æ€§èƒ½" class="headerlink" title="æå‡è¯»æ€§èƒ½"></a>æå‡è¯»æ€§èƒ½</h2><p>Cassandra åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ç”¨æ¥å­˜å‚¨æ—¶åºæ•°æ®ï¼Œç»è¿‡æµ‹è¯•ï¼Œåœ¨ä¸‰å°4æ ¸16Gçš„è™šæ‹Ÿæœºä¸Šï¼Œ<br>æŒ‡æ ‡æ•°æ®çš„å†™å…¥TPSå¯ä»¥è¾¾åˆ°6.5W/sï¼ŒåŸºæœ¬å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ã€‚<br>ä½†æ˜¯è¯»å–æ€§èƒ½å¯èƒ½å°±ä¼šå·®å¾ˆå¤šï¼Œå› ä¸ºæ•°æ®æŸ¥è¯¢é€Ÿåº¦è·Ÿæ¯æ¬¡æŸ¥è¯¢çš„æ•°æ®é‡å…³ç³»æ¯”è¾ƒå¤§ï¼Œæ­¤å¤„ä¹Ÿä¸å¥½å®šä¹‰TPSã€‚<br>äº§å“æŸ¥è¯¢ä¸€å‘¨ä»¥ä¸Šçš„æŒ‡æ ‡æ•°æ®æ—¶ï¼Œç»å¸¸ä¼šå‡ºç°åŠ è½½ç¼“æ…¢ï¼Œç”šè‡³æŸ¥è¯¢è¶…æ—¶ã€‚ä¸ºäº†æ”¹å–„æŸ¥è¯¢çŠ¶å†µï¼Œæˆ‘ä»¬è¿›è¡Œäº†ä¸å°‘åŠªåŠ›ã€‚</p><p>æ­¤å¤„ä¸è®¨è®ºçºµå‘æ‰©å±•å’Œæ¨ªå‘æ‰©å±•å¸¦æ¥çš„æ€§èƒ½æå‡ã€‚</p><h3 id="1-åŠ å¿«å¢“ç¢‘å›æ”¶ç”šè‡³å»é™¤å¢“ç¢‘"><a href="#1-åŠ å¿«å¢“ç¢‘å›æ”¶ç”šè‡³å»é™¤å¢“ç¢‘" class="headerlink" title="1. åŠ å¿«å¢“ç¢‘å›æ”¶ç”šè‡³å»é™¤å¢“ç¢‘"></a>1. åŠ å¿«å¢“ç¢‘å›æ”¶ç”šè‡³å»é™¤å¢“ç¢‘</h3><p>åœ¨Cassandraä¸­ï¼Œå½“ä½ åˆ é™¤ä¸€æ¡æ•°æ®æ—¶ï¼Œå…¶å®æ˜¯ç»™è¿™æ¡æ•°æ®è¿›è¡Œupdateï¼Œç»™å®ƒupdateä¸Šä¸€ä¸ªæ ‡è¯†ï¼Œå°±æ˜¯ä¸€ä¸ªå¢“ç¢‘æ ‡è¯†ã€‚<br> å½“Cassandraé›†ç¾¤åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´åŒæ­¥åˆ é™¤ä¿¡æ¯çš„æ—¶å€™ï¼Œä¹Ÿä¼šç”¨åˆ°Tombstones(å¢“ç¢‘)ï¼Œå¯ä»¥è¯´å¢“ç¢‘æ˜¯ä¸€ç§å…è®¸Cassandraå¿«é€Ÿå†™å…¥çš„æœºåˆ¶ã€‚</p><p>å…³äºå¢“ç¢‘çš„æ›´å¤šæ¶ˆæ¯ï¼Œå¯å‚è€ƒ <a href="https://docs.datastax.com/en/Cassandra/3.0/Cassandra/dml/dmlHowDataMaintain.html" target="_blank" rel="noopener">Cassandra æ•°æ®ç»´æŠ¤å®˜æ–¹æ–‡æ¡£</a></p><p>å¯ä»¥è¿™æ ·ç†è§£ï¼Œå¤§é‡çš„å¢“ç¢‘æ•°æ®ä¼šä½¿æŸ¥è¯¢æ—¶æœç´¢çš„æ•°æ®é‡å˜å¤§ï¼Œç›´æ¥å½±å“æŸ¥è¯¢æ—¶çš„æ•ˆç‡ã€‚<br>æ‰€ä»¥ï¼Œä¸ºäº†æ¶ˆé™¤è¿™ç§å½±å“ï¼Œæˆ‘ä»¬å¯ä»¥åŠ å¿«å¢“ç¢‘æ•°æ®çš„å›æ”¶ï¼Œé¿å…äº§ç”Ÿå¤§é‡çš„å¢“ç¢‘æ•°æ®ã€‚<br>ç”šè‡³ï¼Œå½“æˆ‘ä»¬åœ¨å†™å…¥æ—¶ï¼Œè‹¥å†™å…¥ä¸€è‡´æ€§çš„å€¼ä¸å‰¯æœ¬å› å­æ•°é‡ç›¸ç­‰æ—¶ï¼Œå¯ä»¥ä¸äº§ç”Ÿå¢“ç¢‘æ•°æ®ï¼Œç›´æ¥åˆ æ‰è¯¥æ— æ•ˆæ•°æ®ã€‚<br>å…·ä½“å¯é€šè¿‡ è°ƒæ•´ table ä¸­ gc_grace_seconds å‚æ•°æ¥å®ç°ï¼Œé»˜è®¤ä¸º 864000ï¼ˆ10å¤©ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ä¸º 86400ï¼ˆ1å¤©ï¼‰æˆ–è€…0ï¼ˆç›´æ¥åˆ é™¤ï¼‰ã€‚</p><h3 id="2-é™ä½read-repair-çš„å‡ ç‡"><a href="#2-é™ä½read-repair-çš„å‡ ç‡" class="headerlink" title="2. é™ä½read repair çš„å‡ ç‡"></a>2. é™ä½read repair çš„å‡ ç‡</h3><p>æ¯ä¸€æ¬¡è¯»æ“ä½œï¼ŒCassandraéƒ½ä¼šåœ¨åå°è¿›è¡Œread repairæ“ä½œã€‚<br>å¦‚æœåªè¦æ±‚è¯»ä¸€ä¸ªèŠ‚ç‚¹æ•°æ®ï¼ŒCassandraåœ¨è¯»åˆ°ä¸€ä¸ªèŠ‚ç‚¹åï¼Œå°±å°†ç»“æœè¿”å›å®¢æˆ·ç«¯ï¼Œ<br>ç„¶åç”¨read repairå¯¹å…¶ä»–çš„replicasè¿›è¡ŒåŒæ­¥ï¼ˆæ ¹æ®timestampï¼‰ã€‚<br>å¦‚æœè¦æ±‚è¯»å¤šä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆCassandraå°±è¯»å¤šä¸ªèŠ‚ç‚¹ï¼Œç„¶åæ ¹æ®timestampè¿›è¡Œæ¯”è¾ƒï¼Œè¿”å›å®¢æˆ·ç«¯æœ€æ–°çš„æ•°æ®ï¼Œ<br>ç„¶åå†è°ƒç”¨read repairå¯¹å…¶ä»–èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ã€‚<br>Read repairåœ¨åå°çš„æ“ä½œï¼Œä¼šå ç”¨ä¸€å®šçš„CPUå’ŒI/O,æ‰€ä»¥å½±å“è¯»æ€§èƒ½ã€‚<br>æˆ‘ä»¬å¯ä»¥é™ä½read repair çš„å‡ ç‡ï¼Œä»¥æé«˜è¯»å–æ€§èƒ½ã€‚</p><p>é€šè¿‡ä¿®æ”¹ table ä¸­ read_repair_chanceï¼ˆå–å€¼èŒƒå›´ 0-1ï¼‰å‚æ•°æ¥è®¾ç½®read repair çš„å‡ ç‡ï¼Œå»ºè®®è®¾ä¸º 0.1ã€‚</p><h3 id="3-æŒ‡æ ‡æ•°æ®é¢„èšåˆ"><a href="#3-æŒ‡æ ‡æ•°æ®é¢„èšåˆ" class="headerlink" title="3. æŒ‡æ ‡æ•°æ®é¢„èšåˆ"></a>3. æŒ‡æ ‡æ•°æ®é¢„èšåˆ</h3><p>æ€è·¯ï¼šæˆ‘ä»¬å­˜åœ¨æ•°æ®åº“ä¸­çš„æŒ‡æ ‡æ•°æ®ï¼Œè¯»å–æ—¶ä¼šå°†æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ•°æ®è¿›è¡Œèšåˆã€‚<br>å¦‚æœæå‰å°†æ•°æ®æŒ‰åŸºæœ¬æ—¶é—´æ®µæå‰èšåˆä¸ºä¸€ä¸ªå€¼ï¼Œè¯»å–æ—¶ï¼Œåªè¯»å–æ—¶é—´èŒƒå›´å†…çš„æ—¶é—´æ®µçš„æ±‡èšç»“æœï¼Œå°†å¤§å¤§å‡å°‘æŸ¥è¯¢è€—æ—¶ã€‚</p><h3 id="4-åˆç†éƒ¨ç½²äº§å“"><a href="#4-åˆç†éƒ¨ç½²äº§å“" class="headerlink" title="4. åˆç†éƒ¨ç½²äº§å“"></a>4. åˆç†éƒ¨ç½²äº§å“</h3><p>å…¬å¸çš„å…¶ä»–äº§å“ä½¿ç”¨äº†mongoDBï¼Œçº¿ä¸Šç¯å¢ƒä¸­å‘ç°ï¼Œè¿™ä¸¤ä¸ªNoSQLæ•°æ®åº“éƒ¨ç½²åœ¨ä¸€èµ·æ—¶ä¼šç›¸äº’äº‰å¤ºå†…å­˜èµ„æºï¼Œ<br>ååˆ†å½±å“æ€§èƒ½ï¼Œå› æ­¤æœ€å¥½å°†è¿™ä¸¤ä¸ªæ•°æ®åº“åˆ†å¼€éƒ¨ç½²ã€‚</p><h3 id="5-è®¾ç½®åˆç†çš„å †å†…å­˜å¤§å°å’ŒGCç­–ç•¥"><a href="#5-è®¾ç½®åˆç†çš„å †å†…å­˜å¤§å°å’ŒGCç­–ç•¥" class="headerlink" title="5. è®¾ç½®åˆç†çš„å †å†…å­˜å¤§å°å’ŒGCç­–ç•¥"></a>5. è®¾ç½®åˆç†çš„å †å†…å­˜å¤§å°å’ŒGCç­–ç•¥</h3><p>å †å†…å­˜è®¾ç½®çš„å¤ªå°ï¼Œå°†å¯¼è‡´é¢‘ç¹GCç”šè‡³OOMï¼Œè®¾ç½®çš„å¤ªå¤§åŒæ ·ä¹Ÿä¸å¥½ã€‚å¯å‚è€ƒå®˜æ–¹çš„å…¬å¼:<br><code>MAX_HEAP_SIZE=max(min(1/2 ram, 1024MB), min(1/4 ram, 8GB)</code></p><p>å…³äºGCç­–ç•¥ï¼Œå®˜æ–¹çš„å»ºè®®æ˜¯ï¼šå°äº16Gï¼Œç”¨CMSæ”¶é›†å™¨ï¼›16-64Gï¼Œç”¨G1æ”¶é›†å™¨ã€‚</p><h3 id="6-è®¾ç½®åˆç†çš„å‹å¼ç­–ç•¥"><a href="#6-è®¾ç½®åˆç†çš„å‹å¼ç­–ç•¥" class="headerlink" title="6. è®¾ç½®åˆç†çš„å‹å¼ç­–ç•¥"></a>6. è®¾ç½®åˆç†çš„å‹å¼ç­–ç•¥</h3><p>Cassandra å°†è½åˆ°ç£ç›˜çš„æ•°æ®å­˜æ”¾åœ¨SStableä¸­ï¼Œå‹å®æ˜¯å°†å¤šä¸ªSSTable æ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªçš„è¿‡ç¨‹ã€‚åˆå¹¶åå°†å‡å°‘é‡å¤çš„æ•°æ®ï¼Œä½¿æ•°æ®æ›´ç´§å‡‘ã€‚<br>Cassandra æœ‰å¤šç§è§¦å‘å‹å®çš„ç­–ç•¥ï¼Œé€‰ä¸€ä¸ªé€‚åˆçš„å‹å®ç­–ç•¥ï¼Œå¯ä»¥æ›´å¥½åœ°å‹å®æ•°æ®ã€‚<br>æ¯”å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„Kairosdbå»ºè®®é‡‡ç”¨ DateTieredCompactionStrategy (<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataMaintain.html#dmlHowDataMaintain__dtcs-compaction" target="_blank" rel="noopener">DTCS</a>))å‹å®ç­–ç•¥ã€‚</p><h3 id="7-å¯ç”¨-row-cache"><a href="#7-å¯ç”¨-row-cache" class="headerlink" title="7. å¯ç”¨ row cache"></a>7. å¯ç”¨ row cache</h3><p>row cache æŠŠæ•´ä¸ªrow çš„å†…å®¹éƒ½æ”¾åœ¨å†…å­˜ä¸­ã€‚<br>é€‚åˆçš„æƒ…å†µæ˜¯ï¼Œæœ‰ä¸€å°éƒ¨åˆ†hot dataæ˜¯ç»å¸¸åé—®çš„ï¼Œæˆ–è€…è¦è¿”å›æ•´ä¸ªcolumns.åœ¨ä½¿ç”¨row cacheæ—¶ï¼Œç”¨æ³¨æ„å®ƒå¯¹å†…å­˜çš„å½±å“ã€‚<br>å¯å‚è€ƒ Cassandra çš„<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/operations/opsConfiguringCaches.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>è®¾ç½®row cacheã€‚</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>å®‰åˆ©ä¸€ä¸ªå…¥é—¨Cassandra çš„å¥½åšå®¢ï¼š<a href="http://teddymaef.github.io/learnCassandra/cn/" target="_blank" rel="noopener">learn Cassandra</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of Contents)&quot;&gt;&lt;/a&gt; &lt;strong&gt;ç›®å½• (Table of C
      
    
    </summary>
    
      <category term="æ•°æ®åº“" scheme="https://jasonsonghoho.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="cassandra" scheme="https://jasonsonghoho.github.io/public/tags/cassandra/"/>
    
      <category term="å¤§æ•°æ®" scheme="https://jasonsonghoho.github.io/public/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
  </entry>
  
  <entry>
    <title>Linuxä¸­çš„topå‘½ä»¤è¯¦è§£</title>
    <link href="https://jasonsonghoho.github.io/2018/05/20/Linux%E4%B8%AD%E7%9A%84top%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/"/>
    <id>https://jasonsonghoho.github.io/2018/05/20/Linuxä¸­çš„topå‘½ä»¤è¯¦è§£/</id>
    <published>2018-05-20T02:41:23.000Z</published>
    <updated>2018-09-22T02:52:12.563Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/xyYn6xaahQ4hv1y9MM-7JA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/xyYn6xaahQ4hv1y9MM-7JA</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/xyYn6xaahQ4hv1y9MM-7JA&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/xyYn6xaahQ4hv1y
      
    
    </summary>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/categories/Linux/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/public/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux çš„ Cacheã€Bufferã€MemAvailableã€Swapç®€ä»‹</title>
    <link href="https://jasonsonghoho.github.io/2018/05/20/Linux-%E7%9A%84-Cache%E3%80%81Buffer%E3%80%81MemAvailable%E3%80%81Swap%E7%AE%80%E4%BB%8B/"/>
    <id>https://jasonsonghoho.github.io/2018/05/20/Linux-çš„-Cacheã€Bufferã€MemAvailableã€Swapç®€ä»‹/</id>
    <published>2018-05-20T02:40:08.000Z</published>
    <updated>2018-09-22T02:52:12.543Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/59oH1hMMXy6YC618gZkm1g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/59oH1hMMXy6YC618gZkm1g</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/59oH1hMMXy6YC618gZkm1g&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/59oH1hMMXy6YC61
      
    
    </summary>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/categories/Linux/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/public/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>å…‹æ‹‰ä¸çš„é¢è¯•</title>
    <link href="https://jasonsonghoho.github.io/2018/05/13/%E5%85%8B%E6%8B%89%E4%B8%9D%E7%9A%84%E9%9D%A2%E8%AF%95/"/>
    <id>https://jasonsonghoho.github.io/2018/05/13/å…‹æ‹‰ä¸çš„é¢è¯•/</id>
    <published>2018-05-13T02:39:39.000Z</published>
    <updated>2018-09-22T02:52:46.942Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/boQUsfwjf0pPtcU_mAUWbA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/boQUsfwjf0pPtcU_mAUWbA</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/boQUsfwjf0pPtcU_mAUWbA&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/boQUsfwjf0pPtcU
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="JVM" scheme="https://jasonsonghoho.github.io/public/tags/JVM/"/>
    
      <category term="ç±»åŠ è½½" scheme="https://jasonsonghoho.github.io/public/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>å·¥å‚æ¨¡å¼ã€ç®€å•å·¥å‚æ¨¡å¼ä¸æŠ½è±¡å·¥å‚æ¨¡å¼</title>
    <link href="https://jasonsonghoho.github.io/2018/05/10/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E3%80%81%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <id>https://jasonsonghoho.github.io/2018/05/10/å·¥å‚æ¨¡å¼ã€ç®€å•å·¥å‚æ¨¡å¼ä¸æŠ½è±¡å·¥å‚æ¨¡å¼/</id>
    <published>2018-05-10T02:39:16.000Z</published>
    <updated>2018-09-22T02:52:12.556Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/ccNz_veqyb4UYBpH-UpZfA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ccNz_veqyb4UYBpH-UpZfA</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/ccNz_veqyb4UYBpH-UpZfA&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/ccNz_veqyb4UYBp
      
    
    </summary>
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="https://jasonsonghoho.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="https://jasonsonghoho.github.io/public/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>å›­ä¸ä¸ç›†æ ½ï¼ˆJVM åƒåœ¾å›æ”¶ï¼‰</title>
    <link href="https://jasonsonghoho.github.io/2018/05/01/%E5%9B%AD%E4%B8%81%E4%B8%8E%E7%9B%86%E6%A0%BD/"/>
    <id>https://jasonsonghoho.github.io/2018/05/01/å›­ä¸ä¸ç›†æ ½/</id>
    <published>2018-05-01T02:38:55.000Z</published>
    <updated>2018-09-22T02:52:12.553Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/2GO3Sc4mD8BVN3PnfJQixg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/2GO3Sc4mD8BVN3PnfJQixg</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/2GO3Sc4mD8BVN3PnfJQixg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/2GO3Sc4mD8BVN3P
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="JVM" scheme="https://jasonsonghoho.github.io/public/tags/JVM/"/>
    
      <category term="GC" scheme="https://jasonsonghoho.github.io/public/tags/GC/"/>
    
  </entry>
  
  <entry>
    <title>å…‹æ‹‰ä¸çš„JVMå·¥å‚ä¹‹æ—…ï¼ˆä¸Šï¼‰</title>
    <link href="https://jasonsonghoho.github.io/2018/04/15/%E5%85%8B%E6%8B%89%E4%B8%9D%E7%9A%84JVM%E5%B7%A5%E5%8E%82%E4%B9%8B%E6%97%85%EF%BC%88%E4%B8%8A%EF%BC%89/"/>
    <id>https://jasonsonghoho.github.io/2018/04/15/å…‹æ‹‰ä¸çš„JVMå·¥å‚ä¹‹æ—…ï¼ˆä¸Šï¼‰/</id>
    <published>2018-04-15T02:37:32.000Z</published>
    <updated>2018-09-22T02:52:12.549Z</updated>
    
    <content type="html"><![CDATA[<p>è§é“¾æ¥ï¼š<a href="https://mp.weixin.qq.com/s/X_tO5Lgjof_RTlyN_xtSHw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/X_tO5Lgjof_RTlyN_xtSHw</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è§é“¾æ¥ï¼š&lt;a href=&quot;https://mp.weixin.qq.com/s/X_tO5Lgjof_RTlyN_xtSHw&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/X_tO5Lgjof_RTly
      
    
    </summary>
    
      <category term="Java" scheme="https://jasonsonghoho.github.io/categories/Java/"/>
    
    
      <category term="å…¬ä¼—å·æ–‡ç« " scheme="https://jasonsonghoho.github.io/public/tags/%E5%85%AC%E4%BC%97%E5%8F%B7%E6%96%87%E7%AB%A0/"/>
    
      <category term="JVM" scheme="https://jasonsonghoho.github.io/public/tags/JVM/"/>
    
      <category term="ç±»åŠ è½½" scheme="https://jasonsonghoho.github.io/public/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/"/>
    
  </entry>
  
  <entry>
    <title>Metricä½¿ç”¨</title>
    <link href="https://jasonsonghoho.github.io/2017/12/18/2017-12-18-doc/"/>
    <id>https://jasonsonghoho.github.io/2017/12/18/2017-12-18-doc/</id>
    <published>2017-12-18T14:08:41.000Z</published>
    <updated>2018-09-22T02:49:05.202Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><ul><li>ç®€ä»‹</li><li>MAVENè®¾ç½®</li><li>The Registry</li><li>äº”ç§åº¦é‡ç±»å‹<ul><li>Gauges</li><li>Counters</li><li>Histograms</li><li>Meters</li><li>Timers</li></ul></li><li>Reporter</li><li>å¥åº·æ£€æŸ¥</li></ul><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Metricsæ˜¯ä¸€ä¸ªç»™JAVAæä¾›åº¦é‡å·¥å…·çš„åŒ…ï¼Œåœ¨JAVAä»£ç ä¸­åµŒå…¥Metricsä»£ç ï¼Œå¯ä»¥æ–¹ä¾¿çš„å¯¹ä¸šåŠ¡ä»£ç çš„å„ä¸ªæŒ‡æ ‡è¿›è¡Œç›‘æ§ã€‚<br>Metric çš„ä½¿ç”¨å¯å‚è€ƒ<a href="http://metrics.dropwizard.io/3.2.3/getting-started.html" target="_blank" rel="noopener">å®˜ç½‘</a>ã€‚</p><h2 id="MAVENè®¾ç½®"><a href="#MAVENè®¾ç½®" class="headerlink" title="MAVENè®¾ç½®"></a>MAVENè®¾ç½®</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt; </span><br><span class="line">    &lt;dependency&gt; </span><br><span class="line">        &lt;groupId&gt; io.dropwizard.metrics &lt;/ groupId&gt; </span><br><span class="line">        &lt;artifactId&gt; metrics-core &lt;/ artifactId&gt; </span><br><span class="line">        &lt;version&gt; $ &#123;metrics.version&#125; &lt;/ version&gt; </span><br><span class="line">    &lt;/ dependency&gt; </span><br><span class="line">&lt;/ dependencies&gt;</span><br></pre></td></tr></table></figure><h2 id="The-Registry"><a href="#The-Registry" class="headerlink" title="The Registry"></a>The Registry</h2><p>Metricsçš„æ ¸å¿ƒæ˜¯MetricRegistryç±»ï¼Œå®ƒæ˜¯æ‰€æœ‰åº”ç”¨ç¨‹åºæŒ‡æ ‡çš„å®¹å™¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">final MetricRegistry metrics = new MetricRegistry();</span><br></pre></td></tr></table></figure><h2 id="äº”ç§åº¦é‡ç±»å‹"><a href="#äº”ç§åº¦é‡ç±»å‹" class="headerlink" title="äº”ç§åº¦é‡ç±»å‹"></a>äº”ç§åº¦é‡ç±»å‹</h2><h3 id="Gauges"><a href="#Gauges" class="headerlink" title="Gauges"></a>Gauges</h3><p>æœ€åŸºæœ¬çš„åº¦é‡æŒ‡æ ‡ï¼Œè¿”å›ä¸€ä¸ªå€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class QueueManager &#123;</span><br><span class="line">    private final Queue queue;</span><br><span class="line"></span><br><span class="line">    public QueueManager(MetricRegistry metrics, String name) &#123;</span><br><span class="line">        this.queue = new Queue();</span><br><span class="line">        metrics.register(MetricRegistry.name(QueueManager.class, name, &quot;size&quot;),</span><br><span class="line">                         new Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">                             @Override</span><br><span class="line">                             public Integer getValue() &#123;</span><br><span class="line">                                 return queue.size();</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹é‡æ­¤é‡è¡¨æ—¶ï¼Œå°†è¿”å›é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡ã€‚</p><p>åœ¨æ³¨å†Œè¡¨ä¸­çš„æ¯ä¸ªæŒ‡æ ‡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼Œä¾‹å¦‚ â€œthings.countâ€æˆ–â€com.example.Thing.latencyâ€ã€‚MetricRegistryæœ‰ä¸€ä¸ªç”¨äºæ„é€ è¿™äº›åå­—çš„é™æ€è¾…åŠ©æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MetricRegistry.name(QueueManager.class, &quot;jobs&quot;, &quot;size&quot;)</span><br></pre></td></tr></table></figure><p>å®ƒå°†è¿”å›ä¸€ä¸ªç±»ä¼¼â€com.example.QueueManager.jobs.sizeâ€çš„å­—ç¬¦ä¸²ã€‚</p><h3 id="Counters"><a href="#Counters" class="headerlink" title="Counters"></a>Counters</h3><p>Countersåªæ˜¯ä¸€ä¸ªAtomicLongå®ä¾‹çš„è¡¡é‡æ ‡å‡†ã€‚æ‚¨å¯ä»¥å¢åŠ æˆ–å‡å°‘å…¶å€¼ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€ä¸ªæ›´æœ‰æ•ˆçš„æ–¹å¼æ¥è¡¡é‡é˜Ÿåˆ—ä¸­å¾…å¤„ç†çš„ä»»åŠ¡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private final Counter pendingJobs = metrics.counter(name(QueueManager.class, &quot;pending-jobs&quot;));</span><br><span class="line"></span><br><span class="line">public void addJob(Job job) &#123;</span><br><span class="line">    pendingJobs.inc();</span><br><span class="line">    queue.offer(job);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Job takeJob() &#123;</span><br><span class="line">    pendingJobs.dec();</span><br><span class="line">    return queue.take();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¯æ¬¡æµ‹é‡è¿™ä¸ªè®¡æ•°å™¨æ—¶ï¼Œå®ƒéƒ½ä¼šè¿”å›é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡ã€‚</p><p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼ŒCountersçš„APIç•¥æœ‰ä¸åŒï¼šç”¨ counter(String)è€Œä¸æ˜¯ register(String, Metric) ã€‚</p><h3 id="Histograms"><a href="#Histograms" class="headerlink" title="Histograms"></a>Histograms</h3><p>Histogramsï¼ˆç›´æ–¹å›¾ ï¼‰ç»Ÿè®¡ æ•°æ®æµä¸­å€¼çš„åˆ†å¸ƒã€‚é™¤äº†æœ€å°å€¼ï¼Œæœ€å¤§å€¼ï¼Œå¹³å‡å€¼ç­‰ä¹‹å¤–ï¼Œå®ƒè¿˜æµ‹é‡ä¸­å€¼ï¼Œç¬¬75,90,95,98,99å’Œ99.9ç™¾åˆ†ä½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private final Histogram responseSizes = metrics.histogram(name(RequestHandler.class, &quot;response-sizes&quot;));</span><br><span class="line"></span><br><span class="line">public void handleRequest(Request request, Response response) &#123;</span><br><span class="line">    // etc</span><br><span class="line">    responseSizes.update(response.getContent().length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç›´æ–¹å›¾å°†ä»¥å­—èŠ‚ä¸ºå•ä½æ¥æµ‹é‡å“åº”çš„å¤§å°ã€‚</p><h3 id="Meters"><a href="#Meters" class="headerlink" title="Meters"></a>Meters</h3><p>Metersæµ‹é‡ä¸€æ®µæ—¶é—´å†…çš„äº‹ä»¶å‘ç”Ÿç‡ï¼ˆä¾‹å¦‚â€œæ¯ç§’è¯·æ±‚æ•°â€ï¼‰ã€‚é™¤äº†å¹³å‡é€Ÿåº¦ä¹‹å¤–ï¼ŒMetersè¿˜è·Ÿè¸ª1ï¼Œ5å’Œ15åˆ†é’Ÿçš„å‡å€¼ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private final MetricRegistry metrics = new MetricRegistry();</span><br><span class="line">private final Meter requests = metrics.meter(&quot;requests&quot;);</span><br><span class="line"></span><br><span class="line">public void handleRequest(Request request, Response response) &#123;</span><br><span class="line">    requests.mark();</span><br><span class="line">    // etc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å°†æµ‹é‡æ¯ç§’è¯·æ±‚çš„è¯·æ±‚ç‡ã€‚</p><h3 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h3><p>Timeræµ‹é‡ä¸€æ®µä»£ç è¢«è°ƒç”¨çš„é€Ÿç‡å’Œå®ƒçš„æŒç»­æ—¶é—´çš„åˆ†å¸ƒã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private final Timer responses = metrics.timer(name(RequestHandler.class, &quot;responses&quot;));</span><br><span class="line"></span><br><span class="line">public String handleRequest(Request request, Response response) &#123;</span><br><span class="line">    final Timer.Context context = responses.time(); //ç›¸å½“äºMeter.mark()</span><br><span class="line">    try &#123;</span><br><span class="line">        // etc;</span><br><span class="line">        return &quot;OK&quot;;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        context.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥Timer å°†æµ‹é‡å¤„ç†æ¯ä¸ªè¯·æ±‚æ‰€éœ€çš„æ—¶é—´ï¼ˆä»¥çº³ç§’ä¸ºå•ä½ï¼‰ï¼Œå¹¶æä¾›æ¯ç§’è¯·æ±‚çš„è¯·æ±‚é€Ÿç‡ã€‚</p><p>Timer å…¶å®æ˜¯ Histogram å’Œ Meter çš„ç»“åˆ</p><h2 id="Reporter"><a href="#Reporter" class="headerlink" title="Reporter"></a>Reporter</h2><p>æŠ¥è¡¨ï¼Œç”¨äºå±•ç¤ºç»Ÿè®¡ç»“æœ</p><ol><li><p>é€šè¿‡JMXæŠ¥å‘ŠMetric</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">final JmxReporter reporter = JmxReporter.forRegistry(registry).build();</span><br><span class="line">reporter.start();</span><br></pre></td></tr></table></figure></li><li><p>STDOUT, using ConsoleReporter from metrics-core</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">final ConsoleReporter reporter = ConsoleReporter.forRegistry(registry)</span><br><span class="line">                                                .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                                .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                                .build();</span><br><span class="line">reporter.start(1, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure></li><li><p>CSV files, using CsvReporter from metrics-core</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final CsvReporter reporter = CsvReporter.forRegistry(registry)</span><br><span class="line">                                        .formatFor(Locale.US)</span><br><span class="line">                                        .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                        .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                        .build(new File(&quot;~/projects/data/&quot;));</span><br><span class="line">reporter.start(1, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure></li><li><p>SLF4J loggers, using Slf4jReporter from metrics-core</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final Slf4jReporter reporter = Slf4jReporter.forRegistry(registry)</span><br><span class="line">                                            .outputTo(LoggerFactory.getLogger(&quot;com.example.metrics&quot;))</span><br><span class="line">                                            .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                            .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                            .build();</span><br><span class="line">reporter.start(1, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure></li><li><p>Ganglia, using GangliaReporter from metrics-ganglia</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final GMetric ganglia = new GMetric(&quot;ganglia.example.com&quot;, 8649, UDPAddressingMode.MULTICAST, 1);</span><br><span class="line">final GangliaReporter reporter = GangliaReporter.forRegistry(registry)</span><br><span class="line">                                                .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                                .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                                .build(ganglia);</span><br><span class="line">reporter.start(1, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure></li><li><p>Graphite, using GraphiteReporter from metrics-graphite</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">final Graphite graphite = new Graphite(new InetSocketAddress(&quot;graphite.example.com&quot;, 2003));</span><br><span class="line">final GraphiteReporter reporter = GraphiteReporter.forRegistry(registry)</span><br><span class="line">                                                  .prefixedWith(&quot;web1.example.com&quot;)</span><br><span class="line">                                                  .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                                                  .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">                                                  .filter(MetricFilter.ALL)</span><br><span class="line">                                                  .build(graphite);</span><br><span class="line">reporter.start(1, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure></li></ol><h2 id="å¥åº·æ£€æŸ¥"><a href="#å¥åº·æ£€æŸ¥" class="headerlink" title="å¥åº·æ£€æŸ¥"></a>å¥åº·æ£€æŸ¥</h2><p>åº¦é‡æ ‡å‡†è¿˜èƒ½å¤Ÿå¯¹æœåŠ¡çš„å¥åº·çŠ¶å†µè¿›è¡Œæ£€æŸ¥ï¼Œéœ€è¦å¼•ç”¨metrics-healthchecksæ¨¡å— ã€‚</p><p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„HealthCheckRegistryå®ä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">final HealthCheckRegistry healthChecks = new HealthCheckRegistry();</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œå®ç°ä¸€ä¸ªHealthCheckå­ç±»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class DatabaseHealthCheck extends HealthCheck &#123;</span><br><span class="line">    private final Database database;</span><br><span class="line"></span><br><span class="line">    public DatabaseHealthCheck(Database database) &#123;</span><br><span class="line">        this.database = database;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public HealthCheck.Result check() throws Exception &#123;</span><br><span class="line">        if (database.isConnected()) &#123;</span><br><span class="line">            return HealthCheck.Result.healthy();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return HealthCheck.Result.unhealthy(&quot;Cannot connect to &quot; + database.getUrl());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨Metricsæ³¨å†Œå®ƒçš„ä¸€ä¸ªå®ä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">healthChecks.register(&quot;postgres&quot;, new DatabaseHealthCheck(database));</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ‰€æœ‰æ³¨å†Œçš„å¥åº·æ£€æŸ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">final Map&lt;String, HealthCheck.Result&gt; results = healthChecks.runHealthChecks();</span><br><span class="line">for (Entry&lt;String, HealthCheck.Result&gt; entry : results.entrySet()) &#123;</span><br><span class="line">    if (entry.getValue().isHealthy()) &#123;</span><br><span class="line">        System.out.println(entry.getKey() + &quot; is healthy&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        System.err.println(entry.getKey() + &quot; is UNHEALTHY: &quot; + entry.getValue().getMessage());</span><br><span class="line">        final Throwable e = entry.getValue().getError();</span><br><span class="line">        if (e != null) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº¦é‡æ ‡å‡†å¸¦æœ‰é¢„å…ˆæ„å»ºçš„è¿è¡ŒçŠ¶å†µæ£€æŸ¥ï¼šThreadDeadlockHealthCheckä½¿ç”¨Javaçš„å†…ç½®çº¿ç¨‹æ­»é”æ£€æµ‹æ¥ç¡®å®šæ˜¯å¦æœ‰çº¿ç¨‹æ­»é”ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of Contents)&quot;&gt;&lt;/a&gt; &lt;strong&gt;ç›®å½• (Table of C
      
    
    </summary>
    
      <category term="ä¸­é—´ä»¶" scheme="https://jasonsonghoho.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="java" scheme="https://jasonsonghoho.github.io/public/tags/java/"/>
    
      <category term="Metric" scheme="https://jasonsonghoho.github.io/public/tags/Metric/"/>
    
  </entry>
  
  <entry>
    <title>äº§å“æ€§èƒ½è‡ªæµ‹</title>
    <link href="https://jasonsonghoho.github.io/2017/12/10/171210/"/>
    <id>https://jasonsonghoho.github.io/2017/12/10/171210/</id>
    <published>2017-12-10T14:08:41.000Z</published>
    <updated>2018-09-22T02:46:04.906Z</updated>
    
    <content type="html"><![CDATA[<p>*æœ¬æ–‡æ˜¯ä»å…¬å¸å†…ç½‘KBè½¬è¿‡æ¥çš„ï¼Œæ ¼å¼æœ‰ç‚¹æ··ä¹±æ‡’å¾—æ”¹äº†QAZ~~</p><h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><ul><li>FAQ</li><li>ä¸€ã€æµ‹è¯•ç›®çš„</li><li>äºŒã€æµ‹è¯•ç¯å¢ƒ</li><li>ä¸‰ã€æµ‹è¯•æ–¹æ³•</li><li>å››ã€æµ‹è¯•ç»“æœ<ul><li>å†™:</li><li>è¯»ï¼š</li></ul></li><li>äº”ã€ç»“è®º<ul><li>1ã€æŒ‡æ ‡åº“å†™æ€§èƒ½ï¼š</li><li>2ã€æŒ‡æ ‡åº“è¯»æ€§èƒ½ï¼š</li></ul></li></ul><p></p><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-FAQ">FAQ</h2><p></p><p><strong>1.å†™å…¥èƒ½åŠ›ï¼šå¤šå°‘ä¸ª15ç§’ç›‘æ§å‘¨æœŸçš„ä¸»æœºï¼Œæˆ–180ç§’ç›‘æ§å‘¨æœŸçš„ç½‘ç»œè®¾å¤‡çš„æ•°æ®å†™å…¥</strong></p><br><p style="margin-left: 30.0px;">å‡è®¾ç°åœº1ä¸ªèµ„æºæ¯15 Sä¸ŠæŠ¥100ä¸ªæŒ‡æ ‡ï¼Œåˆ™æ¯åˆ†é’Ÿä¸ŠæŠ¥400ä¸ªï¼Œ</p><br><p style="margin-left: 30.0px;">è‹¥éƒ¨ç½²å•èŠ‚ç‚¹Cassandraï¼Œåœ¨redisé›†ç¾¤çŠ¶å†µè‰¯å¥½çš„æƒ…å†µä¸‹ï¼Œæ¯åˆ†é’Ÿå¯å†™å…¥80Wä¸ªæŒ‡æ ‡ï¼Œå¯æ”¯æŒ800000/400=2000ä¸ªèµ„æºå·¦å³;</p><br><p style="margin-left: 30.0px;">è‹¥éƒ¨ç½²Cassandra é›†ç¾¤ï¼Œæ¯åˆ†é’Ÿå¯å†™å…¥110Wä¸ªæŒ‡æ ‡ï¼Œå¯æ”¯æŒ1100000/400=2750ä¸ªèµ„æºå·¦å³;</p><br><p style="margin-left: 30.0px;">è€ƒè™‘åˆ°ç¨³å®šæ€§å¯é…Œæƒ…å‡å°‘èµ„æºé‡æˆ–å¢åŠ é…ç½®ã€‚</p><br><p><strong>2.è¯»å‡ºèƒ½åŠ›ï¼šæ¯ç§’å®ŒæˆæŒ‡å®šæ•°æ®ç‚¹æ•°æŸ¥è¯¢çš„TPSæ€§èƒ½å³°å€¼ï¼Œä»¥ä¾¿é¢„æµ‹å¯ä»¥æ”¯æŒä»€ä¹ˆæ•°é‡çš„ä»ªè¡¨ç›˜</strong></p><br><p style="margin-left: 30.0px;">åœ¨ä¸‰å°4C*16Gçš„CassandraèŠ‚ç‚¹çš„é…ç½®ä¸‹ï¼Œç¨³å®šæŸ¥è¯¢çš„å‰æä¸‹ï¼Œæ¯åˆ†é’Ÿè‡³å°‘400æ¡å¹¶å‘è¯·æ±‚ï¼ˆæ¯æ¡è¯·æ±‚è‡³å°‘6000æ¡å…ƒæ•°æ®ï¼Œå¤§çº¦ä¸º15åˆ†é’Ÿçš„æ•°æ®ï¼‰ã€‚</p><br><p style="margin-left: 30.0px;"></p><br><p></p><br><p></p><br><p></p><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-ä¸€ã€æµ‹è¯•ç›®çš„">ä¸€ã€æµ‹è¯•ç›®çš„</h2><br><p>æµ‹è¯•åœ¨æŒ‡å®šç¡¬ä»¶æ¡ä»¶ä¸‹ï¼ŒæŒ‡æ ‡åº“å†™å…¥èƒ½åŠ›ä¸è¯»å–èƒ½åŠ›ã€‚</p><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-äºŒã€æµ‹è¯•ç¯å¢ƒ">äºŒã€æµ‹è¯•ç¯å¢ƒ</h2><br><div class="table-wrap"><br>    <table class="confluenceTable"><br>        <tbody><br>        <tr><br>            <th class="confluenceTh">ip</th><br>            <th colspan="1" class="confluenceTh">cpu</th><br>            <th class="confluenceTh">å†…å­˜</th><br>            <th colspan="1" class="confluenceTh">ç£ç›˜</th><br>            <th colspan="1" class="confluenceTh">ç”¨é€”</th><br>            <th colspan="1" class="confluenceTh">å¤‡æ³¨</th><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd">ä¸ªäººç”µè„‘</td><br>            <td colspan="1" class="confluenceTd">4æ ¸</td><br>            <td colspan="1" class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd"></td><br>            <td colspan="1" class="confluenceTd"><span>éƒ¨ç½²jmeter</span></td><br>            <td colspan="1" class="confluenceTd"></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd"><span>10.1.53.37</span></td><br>            <td colspan="1" class="confluenceTd">6<span>æ ¸</span></td><br>            <td colspan="1" class="confluenceTd">8G</td><br>            <td colspan="1" class="confluenceTd"></td><br>            <td rowspan="4" class="confluenceTd">éƒ¨ç½²jmeter-server</td><br>            <td rowspan="4" class="confluenceTd"><p><span>é€šè¿‡jmeteræ¥å‘é€æµ‹è¯•è¯·æ±‚ï¼Œ</span></p><br>                <p>è¿™äº›æœºå™¨åŒæ—¶éƒ¨ç½²ç€å…¶ä»–äº§å“ã€‚<br><br></p></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd"><span>10.1.53.38</span></td><br>            <td colspan="1" class="confluenceTd"><span>4æ ¸</span></td><br>            <td colspan="1" class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd"></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd"><span>10.1.53.65</span></td><br>            <td colspan="1" class="confluenceTd"><span>4æ ¸</span></td><br>            <td colspan="1" class="confluenceTd"><span>8G</span></td><br>            <td colspan="1" class="confluenceTd"></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd"><span>10.1.61.10</span></td><br>            <td colspan="1" class="confluenceTd"><span>4æ ¸</span></td><br>            <td colspan="1" class="confluenceTd">24G</td><br>            <td colspan="1" class="confluenceTd"></td><br>        </tr><br>        <tr><br>            <td colspan="1" class="confluenceTd">10.1.53.39</td><br>            <td colspan="1" class="confluenceTd"><span>4æ ¸</span></td><br>            <td colspan="1" class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd"></td><br>            <td colspan="1" class="confluenceTd">æŒ‡æ ‡åº“ã€ESã€ç§Ÿæˆ·ç­‰ç»„ä»¶</td><br>            <td colspan="1" class="confluenceTd">è¯¥æœºå™¨ä¸»è¦ç”¨æ¥éƒ¨ç½²æŒ‡æ ‡åº“</td><br>        </tr><br>        <tr><br>            <td class="confluenceTd">10.1.61.117</td><br>            <td colspan="1" class="confluenceTd">4æ ¸</td><br>            <td class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd">38G</td><br>            <td colspan="1" class="confluenceTd">kairosdbã€ompç­‰</td><br>            <td colspan="1" class="confluenceTd"><span>kairosdb å †å†…å­˜ä¸ºé»˜è®¤çš„3g</span></td><br>        </tr><br>        <tr><br>            <td class="confluenceTd">10.1.61.118</td><br>            <td colspan="1" class="confluenceTd">4æ ¸</td><br>            <td class="confluenceTd">16G</td><br>            <td colspan="1" class="confluenceTd">38G</td><br>            <td colspan="1" class="confluenceTd">Cassandra</td><br>            <td colspan="1" class="confluenceTd"><p><span>kairosdb å †å†…å­˜ä¸º<span>ä¸ºé»˜è®¤çš„4</span>gï¼Œ</span></p><br>                <p>è®¡ç®—å…¬å¼ max(min(1/2 ram, 1024MB),min(1/4 ram, 8GB))</p></td><br>        </tr><br>        </tbody><br>    </table><br></div><br><p></p><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-ä¸‰ã€æµ‹è¯•æ–¹æ³•">ä¸‰ã€æµ‹è¯•æ–¹æ³•</h2><br><p>æµ‹è¯•å·¥å…·ä¸ºJmeterï¼Œé€šè¿‡è°ƒç”¨æŒ‡æ ‡åº“ç›¸åº”çš„openApiæµ‹è¯•ï¼Œç”¨jconsole ç›‘æ§è¿›ç¨‹å ç”¨èµ„æºå˜åŒ–ã€‚</p><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-å››ã€æµ‹è¯•ç»“æœ">å››ã€æµ‹è¯•ç»“æœ</h2><h4 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-å†™:">å†™:</h4><br><p style="margin-left: 30.0px;"><span>Ramp-up Period <span>å†³å®šå¤šé•¿æ—¶é—´å¯åŠ¨æ‰€æœ‰çº¿ç¨‹ã€‚å¦‚æœä½¿ç”¨10ä¸ªçº¿ç¨‹ï¼Œramp-up periodæ˜¯100ç§’ï¼Œé‚£ä¹ˆJMeterç”¨100ç§’ä½¿æ‰€æœ‰10ä¸ªçº¿ç¨‹å¯åŠ¨å¹¶è¿è¡Œã€‚æ¯ä¸ªçº¿ç¨‹ä¼šåœ¨ä¸Šä¸€ä¸ªçº¿ç¨‹å¯åŠ¨å10ç§’ï¼ˆ100/10ï¼‰å¯åŠ¨ã€‚</span></span><br></p><br><p style="margin-left: 30.0px;">monitor æŒ‡æ ‡ä¸ŠæŠ¥çš„é¢‘ç‡æ˜¯15Sä¸€æ¬¡ï¼Œæ•…æ­¤å¤„ä» ä»¥15S/s çš„é¢‘ç‡å¯åŠ¨ä¸€ä¸ªä¸ŠæŠ¥çº¿ç¨‹å¼€å§‹æµ‹è¯•ã€‚</p><br><p style="margin-left: 30.0px;">å¦‚ç»„1ï¼Œæµ‹è¯•é€»è¾‘ä¸ºï¼š</p><br><p style="margin-left: 60.0px;">æ¯15ç§’å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå•ä¸ªçº¿ç¨‹æ¯æ¬¡ä¸ŠæŠ¥25ä¸ªæŒ‡æ ‡ï¼Œé‡å¤ä¸ŠæŠ¥500æ¬¡ï¼Œæ¯åˆ†é’ŸæŒ‡æ ‡å†™å…¥è¯·æ±‚æ¬¡æ•°ä¸º5Wæ¡ã€‚</p><br><p style="margin-left: 60.0px;">jmeter-serverä¸º1ï¼Œè¡¨ç¤ºåªåœ¨æœ¬æœºè¿è¡Œæµ‹è¯•ï¼›è‹¥ä¸º4ï¼Œè¡¨ç¤ºåœ¨4ä¸ªæœºå™¨ä¸ŠåŒæ—¶å¯¹æŒ‡æ ‡åº“å‘èµ·è¯·æ±‚æµ‹è¯•ã€‚</p><br><p style="margin-left: 30.0px;"></p><br><p></p><br><p></p><br><p style="margin-left: 30.0px;">1.kairosdb è‡ªå¸¦å†™å…¥ç»Ÿè®¡æŒ‡æ ‡ï¼š</p><br><p style="margin-left: 60.0px;">kairosdb.metric_counters - Counts the number of data points received since the last<br>    report. Tags are used to separate one metric from another.ï¼ˆç»Ÿè®¡è‡ªä¸Šæ¬¡ä¸ŠæŠ¥åæ¥æ”¶çš„æ•°æ®é‡ã€‚æ ‡ç­¾ç”¨äºåŒºåˆ†æŒ‡æ ‡ã€‚ï¼‰</p><br><p style="margin-left: 60.0px;"></p><br><p style="margin-left: 30.0px;">kairosdb ç»Ÿè®¡ç»“æœï¼š</p><br><p style="margin-left: 30.0px;"><br><img src="/2017/12/10/171210/kairosdb_metric_count.png"><br><br></p><br><p style="margin-left: 30.0px;">â€œ1â€å¤„ä¸ºç»„åˆ«12çš„æµ‹è¯•ç»“æœï¼Œâ€œ2â€å¤„ä¸ºç›´æ¥è°ƒç”¨kairosdb restApi å†™å…¥æ¥å£ï¼Œâ€œ3â€å¤„ä¸ºç»„åˆ«14 çš„ç»“æœã€‚ç»“æœä¸æŒ‡æ ‡åº“çš„ç»Ÿè®¡æ—¥å¿—ä¸€è‡´ã€‚<br><br></p><p style="margin-left: 30.0px;">2.æ—¶é—´æœ‰é™ï¼Œæ¯ç»„æµ‹è¯•æ—¶é—´é—´éš”è¾ƒçŸ­ï¼Œå› æ­¤å¯èƒ½ä¼šå¯¹CPUã€å†…å­˜ä»¥åŠCassandraçŠ¶æ€äº§ç”Ÿå½±å“ï¼Œä½¿ç»“æœä¸å¤Ÿå‡†ç¡®ã€‚</p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;"><strong>æ³¨ï¼š</strong></p><br><p style="margin-left: 30.0px;">ã€1ã€‘ï¼šæŒ‡æ ‡åº“redis æŠ¥å†…å­˜ä¸å¤Ÿï¼Œå¼‚å¸¸ï¼š Canâ€™t save in background: fork: Cannot allocate memory</p><br><p style="margin-left: 30.0px;">ã€2ã€‘ï¼š<span style="background-color: transparent;">çŸ­æ—¶é—´æ’å…¥å¤§é‡æŒ‡æ ‡ä¼šå¯¼è‡´æœªå‹å®çš„sstableæ•°æ®å¤ªå¤šï¼Œå‹å®è¿›ç¨‹æŠ¥å¯ç”¨ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œé‡æ–°å‹å®â€¦æ¶æ€§å¾ªç¯ã€‚</span><br></p><br><p style="margin-left: 30.0px;"><span style="background-color: transparent;"><br></span></p><br><div class="code panel pdl" style="border-width: 1px;"><br>    <div class="codeContent panelContent pdl"><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[[root@localhost data_points-1e09be40c3c811e7977aa147ea7baf03]# /opt/cassandra/bin/nodetool compactionstats -H</span><br><span class="line">pending tasks: 2</span><br><span class="line">- kairosdb.data_points: 2</span><br><span class="line">id                                   compaction type keyspace table       completed total    unit  progress</span><br><span class="line">ef340e00-d4d8-11e7-a239-0d717928a22e Compaction      kairosdb data_points 6.23 GB   11.42 GB bytes 54.56%</span><br><span class="line">Active compaction remaining time :   0h05m32s</span><br><span class="line">]]&gt;</span><br></pre></td></tr></table></figure><br><br>    </div><br></div><br><p style="margin-left: 30.0px;"><span><br></span></p><br><p style="margin-left: 30.0px;"><span>CassandraæŠ¥å¼‚å¸¸:</span></p><br><div class="code panel pdl" style="border-width: 1px;"><br>    <div class="codeContent panelContent pdl"><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[WARN  [CompactionExecutor:46] 2017-11-28 22:26:29,785 CompactionTask.java:91 - insufficient space to compact all requested files BigTableReader(path=&amp;#39;/opt/dbdata/cassandra/data/kairosdb/data_points-1e09be40c3c811e7977aa147ea7baf03/ma-216-big-Data.db&amp;#39;), BigTableReader(path=&amp;#39;/opt/dbdata/cassandra/data/kairosdb/data_points-1e09be40c3c811e7977aa147ea7baf03/ma-237-big-Data.db&amp;#39;)</span><br><span class="line">ERROR [CompactionExecutor:46] 2017-11-28 22:26:29,827 CassandraDaemon.java:195 - Exception in thread Thread[CompactionExecutor:46,1,main]</span><br><span class="line">java.lang.RuntimeException: Not enough space for compaction, estimated sstables = 1, expected write size = 2395303467</span><br><span class="line">at org.apache.cassandra.db.compaction.CompactionTask.checkAvailableDiskSpace(CompactionTask.java:278) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:126) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:82) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:264) ~[apache-cassandra-3.5.jar:3.5]</span><br><span class="line">at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_144]</span><br><span class="line">at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_144]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[na:1.8.0_144]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [na:1.8.0_144]</span><br><span class="line">at java.lang.Thread.run(Thread.java:748) [na:1.8.0_144]</span><br><span class="line"></span><br><span class="line">]]&gt;</span><br></pre></td></tr></table></figure><br><br>    </div><br></div><br><p></p><br><p style="margin-left: 30.0px;">è§£å†³æ–¹æ³•ï¼š</p><br><p style="margin-left: 60.0px;">1ã€å¢å¤§ç£ç›˜ç©ºé—´ã€</p><br><p style="margin-left: 60.0px;">2ã€ç›´æ¥åˆ é™¤åŒä¸€ç¼–å·çš„sstable å¤§æ–‡ä»¶</p><br><p style="margin-left: 60.0px;">3ã€é‡è£…Cassandra</p><h4 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-å¤šèŠ‚ç‚¹å†™:">å¤šèŠ‚ç‚¹å†™:</h4><br><p style="margin-left: 30.0px;">1.é€šè¿‡è§‚å¯Ÿå‘ç°ï¼Œå†™çš„ç“¶é¢ˆåœ¨æŒ‡æ ‡åº“çš„gatewayï¼Œç„¶åå¢åŠ å¤šèŠ‚ç‚¹çš„æµ‹è¯•å¦‚ä¸‹ï¼š</p><br><ul><br>    <li style="margin-left: 30.0px;">å¼€å¯ä¸€ä¸ªgatewayã€ä¸€ä¸ªwriteræ¨¡å—åï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›åœ¨ <strong>50W/åˆ†é’Ÿ</strong>ï¼›</li><br>    <li style="margin-left: 30.0px;">å¼€å¯ä¸‰ä¸ªgatewayã€ä¸€ä¸ªwriteræ¨¡å—åï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›åœ¨ <strong>80W/åˆ†é’Ÿ</strong>ï¼›</li><br>    <li style="margin-left: 30.0px;">å¼€å¯ä¸‰ä¸ªä¸‰ä¸ªgatewayã€ä¸‰ä¸ªwriter æ¨¡å—åï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›åœ¨ <strong>85W/åˆ†é’Ÿ</strong>ã€‚</li><br></ul><br><br><p><br><img src="/2017/12/10/171210/kairosdb_metric_count_70W_75W.png"><br><br></p><p style="margin-left: 30.0px;">2.å½“éƒ¨ç½²Cassandraé›†ç¾¤ï¼ˆ3ä¸ªèŠ‚ç‚¹ï¼‰åï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›å¯ä»¥å†æ¬¡æå‡ï¼Œ<span style="background-color: transparent;">å¼€å¯ä¸‰ä¸ªgatewayã€ä¸€ä¸ªwriteræ¨¡å—ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›åœ¨ <strong>100W/åˆ†é’Ÿ</strong> ï¼Œæ­¤çŠ¶æ€ä¸‹å¯æŒç»­å†™å…¥å››ä¸ªå°æ—¶ï¼ŒæœŸé—´redisä¼šæŠ¥å†…å­˜ä¸å¤Ÿçš„å¼‚å¸¸ã€‚</span><br></p>&lt;p style=â€margin-left: 30.0px; &gt;<br><br><br><p></p><p style="margin-left: 30.0px;"><span style="background-color: transparent;">å¦å¤–ï¼Œå½“æŒ‡æ ‡åº“å†™å…¥åœ¨æ»¡è½½çš„æƒ…å†µä¸‹ï¼ŒæŒ‡æ ‡çš„è¯»å–èƒ½åŠ›ä¼šå—åˆ°å¾ˆå¤§å½±å“ï¼Œä¸”å†™å…¥ä¹Ÿä¼šå¶å°”æŠ¥è¿æ¥è¶…æ—¶ç°è±¡ã€‚</span><br></p><br><p style="margin-left: 30.0px;"><span style="background-color: transparent;"><br></span></p><h4 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-è¯»ï¼š"><br>    è¯»ï¼š</h4><br><p>æŒ‡æ ‡çš„æŸ¥è¯¢ï¼Œå…¶å®æ˜¯kairosdbå»æŸ¥Cassandraä¸­æ•°æ®ã€‚å› æ­¤kairosdbæŸ¥Cassandraçš„é€Ÿåº¦æ‰æ˜¯å…³é”®å› ç´ ã€‚è€ŒæŸ¥Cassandraæ•°æ®çš„é€Ÿåº¦ï¼Œè·ŸæŸ¥è¯¢çš„Cassandraçš„rowæ•°é‡ã€å…ƒæ•°æ®é‡ç­‰å› ç´ ç›¸å…³ã€‚</p><br><p>è¦æ¨¡æ‹Ÿè¯»å–æµ‹è¯•ï¼Œå°±éœ€è¦å…ˆè°ƒæŸ¥ç°åœºå®é™…æŸ¥è¯¢çš„rowå’Œå…ƒæ•°æ®å¤§å°ã€‚</p><br><p>ç»Ÿè®¡å±€çš„ç»Ÿè®¡å¦‚ä¸‹ï¼š</p><br><p style="margin-left: 30.0px;">ä¸Šå›¾ä¸ºå¯†é›†æŸ¥è¯¢30åˆ†é’Ÿå†…æŒ‡æ ‡æ—¶ï¼Œä»Cassandraä¸­æŸ¥è¯¢çš„rowçš„è¡Œæ•°ï¼›</p><br><p style="margin-left: 30.0px;">ä¸­å›¾ä¸ºå¯†é›†æŸ¥è¯¢30åˆ†é’Ÿå†…æŒ‡æ ‡æ—¶ï¼Œä»Cassandraä¸­æŸ¥è¯¢çš„å…ƒæ•°æ®çš„æ•°é‡ï¼›</p><br><p style="margin-left: 30.0px;">ä¸‹å›¾ä¸ºå®šæ—¶æŸ¥è¯¢æ—¶rowçš„è¡Œæ•°ã€‚</p><br><p><br><br></p><br><p style="margin-left: 30.0px;"><br><img src="/2017/12/10/171210/ç»Ÿè®¡å±€_query_row_count2.png"><br><br></p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;"><br><img src="/2017/12/10/171210/ç»Ÿè®¡å±€_query_sample_size.png"><br><br></p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;"><br><img src="/2017/12/10/171210/ç»Ÿè®¡å±€_query_row_count.png"><br><br></p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;"></p><br><p style="margin-left: 30.0px;">å¯ä»¥çœ‹å‡ºï¼š</p><br><p style="margin-left: 30.0px;">å¯†é›†æŸ¥è¯¢æ—¶ï¼Œrowæœ€å¤§çš„åœ¨4000ï¼Œå¤§éƒ¨åˆ†æ¯”è¾ƒå°ï¼Œæ¥è¿‘1ã€‚å®šæ—¶æŸ¥è¯¢æ—¶ï¼Œrowåœ¨100è¡Œä»¥ä¸‹ã€‚</p><br><p style="margin-left: 30.0px;">ç°åœº400ä¸ªè®¾å¤‡ï¼ŒæŸ¥è¯¢30åˆ†é’ŸæŒ‡æ ‡æ—¶ï¼Œç†è®ºä¸Šåº”è¯¥æœ‰å¤§çº¦400<em>4</em>30=48000 çš„å…ƒæ•°æ®ï¼Œå®é™…æŸ¥è¯¢æ—¶ï¼Œè¦å°äºè¯¥å€¼ã€‚åŸºæœ¬éƒ½åœ¨å‡ ç™¾æ¡ã€‚</p><br><p></p><br><p></p><p></p><p style="margin-left: 30.0px;">è¿‡ç¨‹ï¼š</p><p></p><ol><br>    <li>å¯ä»¥çœ‹åˆ°å•CassandraèŠ‚ç‚¹ä¸‹ï¼ŒkairosdbæŸ¥è¯¢Cassandraæœ€çŸ­è€—æ—¶å·²ç»åœ¨2Så·¦å³ï¼Œè€Œé›†ç¾¤æ¨¡å¼ä¸‹ï¼ŒkairosdbæŸ¥è¯¢Cassandraçš„æœ€çŸ­è€—æ—¶åœ¨200ms<br>        å·¦å³ï¼Œå¯ä»¥çœ‹å‡ºåœ¨ä½ç¡¬ä»¶é…ç½®ä¸‹ï¼ŒCassandraéƒ¨ç½²é›†ç¾¤æ¨¡å¼æ¯”å•æœºæ¨¡å¼çš„æ€§èƒ½æå‡å¾ˆå¤§ã€‚<br>    </li><br>    <li>Cassandraåˆšéƒ¨ç½²æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½è¡¨ç°ä¼˜ç§€ï¼Œè¿ç»­å†™å…¥ä¸€ä¸ªå°æ—¶æ•°æ®åï¼ŒæŸ¥è¯¢æ€§èƒ½ä¸‹é™ã€‚</li><br>    <li>2-5ç»„å‘ç°kairosdb æŸ¥è¯¢æ—¶é—´æ­£å¸¸ï¼Œ ä½†æŒ‡æ ‡åº“æŸ¥è¯¢å‡ºç°è¶…æ—¶ï¼Œç»å»ºé£æ’æŸ¥ï¼ŒåŸå› æ˜¯è°ƒç”¨kairosdb clientæ—¶åˆ›å»ºçš„ httpè¿æ¥ æœ€å¤§æ•°é‡æœ€2ï¼Œä¿®æ”¹ä¸º200åï¼Œæƒ…å†µå¥½è½¬ã€‚<br><br><br><br>  <img src="/2017/12/10/171210/image2017-12-8_11_24_9.png"><br><br>    </li><br>    <li>ä»æµ‹è¯•è¿‡ç¨‹å¯ä»¥çœ‹åˆ°ï¼Œéƒ¨åˆ†æŒ‡æ ‡åº“çš„æŸ¥è¯¢è€—æ—¶æ¯”kairosdbæŸ¥Cassandraçš„è€—æ—¶é•¿å¾ˆå¤šï¼ŒæŸ¥è¯¢kairosdb.datastore.queries_waiting<br>        æŒ‡æ ‡ï¼Œå‘ç°kairosdbå­˜åœ¨å¤§é‡ç­‰å¾…çº¿ç¨‹ã€‚å¦‚ä¸‹ï¼š<br><br><br><br><img src="/2017/12/10/171210/kairosdb.datastore.queries_waiting.png"><br><br>          <br>ä¿®æ”¹<br>        kairosdb çš„é…ç½®ï¼škairosdb.datastore.concurrentQueryThread ï¼Œå†æ¬¡æŸ¥è¯¢ï¼Œä¾ç„¶ä¼šæœ‰ç­‰å¾…çš„æŸ¥è¯¢çº¿ç¨‹ã€‚<br>æ®æ­¤åˆ¤æ–­ï¼Œå½“æŸ¥è¯¢15ä¸ªæŒ‡æ ‡æ—¶ï¼Œæ¯ä¸ªæŒ‡æ ‡è€—æ—¶åœ¨2.5Så·¦å³æ—¶ï¼Œæ­¤ç¡¬ä»¶é…ç½®ä¸‹çš„kairosdbæ€§èƒ½å·²è¾¾ç“¶é¢ˆï¼Œå½±å“å› ç´ ä¸ºCPUæ ¸æ•°ã€‚å½“æ›´æ”¹éƒ¨ç½²kairosdb<br>        æœºå™¨çš„æ ¸æ•°åï¼Œæ€§èƒ½å¾—åˆ°äº†æå‡ã€‚<br>    </li><br>    <li>åŒæ ·çš„æŸ¥è¯¢æ¡ä»¶ä¸‹ï¼ŒCPUæ ¸æ•°ä¸kairosdb çš„concurrentQueryThread å‚æ•°ä¸€è‡´æ—¶ï¼Œæ€§èƒ½æœ€ä¼˜ï¼›ä¸”è¯¥å‚æ•°åªåœ¨kairosdb æŸ¥Cassandraè¾ƒæ…¢ï¼ˆ2Sä»¥ä¸Šï¼‰æ—¶ï¼Œæ‰ä¼šäº§ç”Ÿå½±å“ã€‚</li><br></ol><br><h2 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-äº”ã€ç»“è®º"><br>äº”ã€ç»“è®º</h2><br><h3 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-1ã€æŒ‡æ ‡åº“å†™æ€§èƒ½ï¼š">1ã€æŒ‡æ ‡åº“å†™æ€§èƒ½ï¼š</h3><br><ol><br>    <li>ç”±3ã€5ã€6ç»„å¯çŸ¥ï¼Œæ¯åˆ†é’Ÿè¯·æ±‚æ€»é‡ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œåœ¨æœªåˆ°è¾¾ç“¶é¢ˆå‰ï¼Œå¹¶å‘çº¿ç¨‹è¶Šå¤šï¼ŒæŒ‡æ ‡å†™å…¥é‡è¶Šå¤§ã€‚</li><br>    <li>ç”±6ã€8ç»„å¯çŸ¥ï¼Œæœ¬æœºçš„æœºå™¨æ€§èƒ½å¹¶æœªæˆä¸ºå½±å“æŒ‡æ ‡å†™å…¥çš„å› ç´ ã€‚</li><br>    <li>ç”±6ã€7å’Œ8ã€9ä¸¤ç»„å¯çŸ¥ï¼Œåœ¨4æ ¸16Gå•èŠ‚ç‚¹Cassandra é…ç½®ä¸‹ï¼Œè¯·æ±‚æ•°åœ¨50W/min å·¦å³æ—¶ï¼ŒæŒ‡æ ‡åº“çš„gateway æ¨¡å—æ¥æ”¶è¯·æ±‚å·²åˆ°è¾¾ç“¶é¢ˆï¼Œä¸º <strong>50W /min</strong> å·¦å³ã€‚</li><br>    <li>ç”±9ã€10ã€11ä¸‰ç»„å¯çŸ¥ï¼Œåœ¨æŒ‡æ ‡å†™å…¥èƒ½åŠ›åˆ°è¾¾ç“¶é¢ˆåï¼Œæ”¹å˜å¹¶å‘çš„çº¿ç¨‹æ•°ï¼Œä¸å†äº§ç”Ÿå½±å“ã€‚</li><br>    <li>ç”±9ã€12ç»„å¯çŸ¥ï¼Œå¾…å†™å…¥çš„æŒ‡æ ‡ç±»å‹é‡ä¸æ˜¯å½±å“å› ç´ ã€‚</li><br>    <li>ç”±15ç»„å¯çŸ¥ï¼Œå½“æŒ‡æ ‡åº“å†™å…¥è¯·æ±‚é‡æ¯åˆ†é’Ÿåˆ°åƒä¸‡çº§æ—¶ï¼Œä¼šå‡ºç°redis å†…å­˜é—®é¢˜ã€‚</li><br>    <li>å•æŒ‡æ ‡åº“ã€å•CassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›ç“¶é¢ˆåœ¨Cassandraå¤„ï¼Œä¸º <strong>80W/min</strong>ï¼›<br>å¤šæŒ‡æ ‡åº“ã€å•CassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›ç“¶é¢ˆåœ¨Cassandraå¤„ï¼Œä¸º<br>        <strong>85W/min</strong>ï¼›<br>å•æŒ‡æ ‡åº“ã€å¤šCassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›ç“¶é¢ˆä¸º <strong>100W/min</strong>ï¼›<br>å¤šæŒ‡æ ‡åº“ã€å¤šCassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡å†™å…¥èƒ½åŠ›ç“¶é¢ˆä¸º<strong><br>            <strong>110W/min</strong></strong>ã€‚<br><br><br></li><br></ol><br><p></p><br><p>é…ç½®é¢„ä¼°ï¼š</p><br><p style="margin-left: 30.0px;">å‡è®¾ç°åœº1ä¸ªèµ„æºæ¯15 Sä¸ŠæŠ¥100ä¸ªæŒ‡æ ‡ï¼Œåˆ™æ¯åˆ†é’Ÿä¸ŠæŠ¥400ä¸ªï¼Œè‹¥é‡‡ç”¨å•èŠ‚ç‚¹Cassandra<br>    é…ç½®ï¼Œåœ¨redisé›†ç¾¤çŠ¶å†µè‰¯å¥½çš„æƒ…å†µä¸‹ï¼Œå¯æ”¯æŒ1750ä¸ªèµ„æºå·¦å³ï¼Œè€ƒè™‘åˆ°ç¨³å®šæ€§å¯é…Œæƒ…å‡å°‘èµ„æºé‡æˆ–å¢åŠ é…ç½®ã€‚</p><br><p style="margin-left: 30.0px;"></p><br><h3 id="id-æŒ‡æ ‡åº“æ€§èƒ½æµ‹è¯•-2ã€æŒ‡æ ‡åº“è¯»æ€§èƒ½ï¼š">2ã€æŒ‡æ ‡åº“è¯»æ€§èƒ½ï¼š</h3><br><ol><br>    <li>ç”±1ã€2ç»„å¯çŸ¥R12ç‰ˆæœ¬æŒ‡æ ‡åº“åœ¨ç°æœ‰é…ç½®ä¸‹ï¼Œæœ€å¤šæ”¯æŒæ¯åˆ†é’Ÿ30æ¬¡çš„æŸ¥è¯¢ã€‚</li><br>    <li>ç”±2ã€3ç»„å¯çŸ¥ï¼ŒæŸ¥è¯¢è¾ƒæ…¢æ—¶ï¼Œæ¯10Sé’ŸæŸ¥è¯¢10æ¬¡ï¼Œæ¯”æ¯5Sé’ŸæŸ¥è¯¢5æ¬¡ï¼ŒæŸ¥è¯¢è¦å¿«ã€‚</li><br>    <li>ç”±2ã€4ç»„å¯çŸ¥ï¼Œç›¸åŒçš„è¯·æ±‚é‡ä¸‹ï¼ŒåŒä¸€ä¸ªæŒ‡æ ‡å¯†é›†æŸ¥è¯¢2æ¬¡ï¼Œæ¯”ä¸¤ä¸ªæŒ‡æ ‡åŒæ—¶å„æŸ¥ä¸€æ¬¡è¦æ…¢å¾ˆå¤šã€‚</li><br>    <li>ç”±1ã€5ç»„å¯çŸ¥ï¼ŒæŸ¥è¯¢çš„æ•°æ®é‡ä»600åˆ°7200ï¼ŒæŸ¥è¯¢çš„Cassandra rowä» 77åˆ°740ï¼ŒæŸ¥è¯¢è€—æ—¶åŸºæœ¬æ²¡æœ‰å˜åŒ–ï¼Œä¸è¿‡Cassandraçš„èµ„æºæ¶ˆè€—å¢åŠ å¾ˆå¤šã€‚</li><br>    <li>ç”±2ã€7ç»„å¯çŸ¥ï¼Œkairosdb client åˆ›å»ºçš„ httpè¿æ¥ æœ€å¤§æ•°é‡ä¸æŸ¥è¯¢æ€§èƒ½ååˆ†ç›¸å…³ï¼ŒR13ä¸­å·²è°ƒæ•´è¯¥å‚æ•°ä¸º200ã€‚</li><br>    <li>ç”±6-8ã€14ã€15ç»„å¯çŸ¥ï¼Œå•CassandraèŠ‚ç‚¹ä¸‹ï¼ŒæŒ‡æ ‡æŸ¥è¯¢çš„ç“¶é¢ˆä¸º <strong>90æ¬¡/åˆ†é’Ÿ</strong>ï¼Œä¸”å½“ æŒ‡æ ‡åº“çš„æŸ¥è¯¢è€—æ—¶ ä¸<br>        kairosdbæŸ¥Cassandraçš„è€—æ—¶ç›¸å·®ä¸å¤§æ—¶ï¼Œå¯ä»¥ç»´æŒç¨³å®šæŸ¥è¯¢çŠ¶æ€ï¼Œå¦åˆ™æŒ‡æ ‡åº“æŸ¥è¯¢è¶…æ—¶ä¼šè¶Šæ¥è¶Šä¸¥é‡ã€‚<br>    </li><br>    <li>ç”±8-13ã€17-19ç»„å¯çŸ¥ï¼Œkairosdbçš„concurrentQueryThread å‚æ•°å€¼ä¸CPUæ ¸æ•°ä¸€è‡´æ—¶ï¼Œæ€§èƒ½æœ€ä¼˜ï¼›ä¸”è¯¥å‚æ•°åªåœ¨kairosdb æŸ¥Cassandraè¾ƒæ…¢ï¼ˆ2Sä»¥ä¸Šï¼‰æ—¶ï¼Œæ‰ä¼šäº§ç”Ÿå½±å“ã€‚</li><br>    <li>ç”±8ã€16ç»„å¯çŸ¥ï¼ŒæŒ‡æ ‡åº“æ˜¯å¦é›†ç¾¤æ¨¡å¼ä¸æ˜¯ç“¶é¢ˆã€‚</li><br>    <li>ç”±19ã€22å’Œ20ã€23ä¸¤ç»„å¯çŸ¥ï¼Œå•kairosdb 8æ ¸çš„æŸ¥è¯¢æ€§èƒ½ ä¸åŒkairosdb 4æ ¸åŸºæœ¬ç›¸åŒï¼Œæ‰€ä»¥kairosdb çš„æŸ¥è¯¢æ€§èƒ½ä¸æœºå™¨çš„CPUæ ¸æ•°æœ‰å…³ã€‚</li><br>    <li>ç”±19ã€24ç»„å¯çŸ¥ï¼Œå½“å‰çš„æŸ¥è¯¢ç“¶é¢ˆåœ¨Cassandra å¤„ï¼ŒCassandra é›†ç¾¤çš„æŸ¥è¯¢æ€§èƒ½æ˜¯å•èŠ‚ç‚¹çš„10å€ã€‚</li><br>    <li>ç”±24-29ç»„å¯çŸ¥ï¼ŒCassandraé›†ç¾¤ä¸‹ï¼ŒæŸ¥è¯¢æ€§èƒ½ç“¶é¢ˆä¸º<strong>1400æ¬¡/åˆ†é’Ÿ</strong>ï¼Œå½“æŸ¥è¯¢åˆ°1500æ¬¡/åˆ†é’Ÿæ—¶ï¼Œkairosdbå‡ºç°ç“¶é¢ˆï¼Œç­‰å¾…æŸ¥è¯¢çº¿ç¨‹ä¸æ–­å¢åŠ ã€‚</li><br>    <li>ç”±30ã€31ç»„å¯çŸ¥ï¼Œå½“Cassandraå†™å…¥ä¸€æ®µæ—¶é—´æ•°æ®åï¼ŒæŒ‡æ ‡æŸ¥è¯¢æ€§èƒ½ä¸‹é™å¾ˆå¤šã€‚</li><br></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;*æœ¬æ–‡æ˜¯ä»å…¬å¸å†…ç½‘KBè½¬è¿‡æ¥çš„ï¼Œæ ¼å¼æœ‰ç‚¹æ··ä¹±æ‡’å¾—æ”¹äº†QAZ~~&lt;/p&gt;
&lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of
      
    
    </summary>
    
      <category term="æœªåˆ†ç±»" scheme="https://jasonsonghoho.github.io/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="cassandra" scheme="https://jasonsonghoho.github.io/public/tags/cassandra/"/>
    
      <category term="kairosdb" scheme="https://jasonsonghoho.github.io/public/tags/kairosdb/"/>
    
      <category term="jmeter" scheme="https://jasonsonghoho.github.io/public/tags/jmeter/"/>
    
  </entry>
  
  <entry>
    <title>linux è¿›ç¨‹ æ€§èƒ½ç›‘æ§</title>
    <link href="https://jasonsonghoho.github.io/2017/11/08/171108/"/>
    <id>https://jasonsonghoho.github.io/2017/11/08/171108/</id>
    <published>2017-11-08T14:08:41.000Z</published>
    <updated>2018-09-20T15:46:06.026Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œéœ€è¦ç»Ÿè®¡ kairosdb çš„æ€§èƒ½éšæ—¶é—´çš„å˜åŒ–æƒ…å†µã€‚</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>è€ƒè™‘è¿‡ä»¥ä¸‹æ–¹æ³•<br>sar å‘½ä»¤ï¼šå¯ä»¥æ£€æµ‹æœºå™¨çš„å„é¡¹æ€§èƒ½ï¼Œä½†ä¸èƒ½çœ‹è¿›ç¨‹çš„æ€§èƒ½å ç”¨ä¿¡æ¯<br>topï¼šå¯ä»¥ç›‘æ§åˆ°è¿›ç¨‹çš„æ€§èƒ½ä¿¡æ¯ï¼Œä½†æ²¡æœ‰è¶‹åŠ¿å›¾<br>jvisualvmï¼šå¯ä»¥ç›‘æ§åˆ°è¿›ç¨‹çš„æ€§èƒ½ä¿¡æ¯ï¼Œæœ‰è¶‹åŠ¿å›¾ï¼›ä½†å¯ç›‘æ§çš„æ—¶é—´èŒƒå›´å—é™ã€ä¸èƒ½ç»Ÿè®¡å„é¡¹çŠ¶æ€ä¿¡æ¯ã€‚å¦‚ä¸‹ï¼š</p><img src="/2017/11/08/171108/19_14_27.png" title="jvisualvm"><p>æœ€ç»ˆå‘ç°jconsole å¯ä»¥å®Œç¾å®ç°è¿™ä¸ªéœ€æ±‚ã€‚ä¹‹å‰åªæ˜¯æ„Ÿè§‰jconsolegåŠŸèƒ½ä¸å¦‚jvisualvmå¼ºå¤§ï¼Œæ‰€ä»¥æ²¡æœ‰å»çœ‹â€¦</p><h2 id="jconsole-ä½¿ç”¨æ–¹æ³•ï¼š"><a href="#jconsole-ä½¿ç”¨æ–¹æ³•ï¼š" class="headerlink" title="jconsole ä½¿ç”¨æ–¹æ³•ï¼š"></a>jconsole ä½¿ç”¨æ–¹æ³•ï¼š</h2><ol><li><p>ä¿®æ”¹è¿œç¨‹æœºå™¨JDKé…ç½®æ–‡ä»¶ (æˆ‘è¿™é‡Œè¿œç¨‹æœºå™¨æ˜¯linux).<br>a.è¿›å…¥JAVA_HOME\jre\lib\management\ç›®å½•<br>b.æ‹·è´jmxremote.password.templateè¿™ä¸ªæ–‡ä»¶åˆ°å½“å‰ç›®å½•, å¹¶æ”¹åä¸º jmxremote.password<br>  c.æ‰“å¼€jmxremote.passwordæ–‡ä»¶ï¼Œå»æ‰ # monitorRole  QED å’Œ # controlRole  R&amp;D è¿™ä¸¤è¡Œå‰é¢çš„æ³¨é‡Šç¬¦å·</p></li><li><p>ä¿®æ”¹è¿œç¨‹æœºå™¨ä¸Šéœ€è¦è¢«ç›‘æ§çš„ç¨‹åºçš„å¯åŠ¨è„šæœ¬ï¼š</p><p> <code>JAVA_OPTS=&quot;-Djava.rmi.server.hostname=10.1.61.117 -Dcom.sun.management.jmxremote.port=18999  -Dcom.sun.management.jmxremote.ssl=false  -Dcom.sun.management.jmxremote.authenticate=false&quot;</code></p><p> å¯åŠ¨è„šæœ¬ çš„java å‘½ä»¤ååŠ ä¸Š $JAVA_OPTS å‚æ•°ã€‚</p></li><li><p>æœ¬åœ°å»ºç«‹è¿æ¥ï¼Œå¦‚ä¸‹ï¼š</p></li></ol><img src="/2017/11/08/171108/19_23_5.png" title="æœ¬åœ°å»ºç«‹è¿æ¥"><p>ç•Œé¢å¦‚ä¸‹ï¼š</p><img src="/2017/11/08/171108/19_28_49.png" title="ç•Œé¢"><p>æ›´å¤šåŠŸèƒ½å¯è‡ªè¡Œå°è¯•</p><p>å¯ä»¥ä¿å­˜ç»Ÿè®¡æ•°æ® åˆ°æœ¬åœ°(CSV æ–‡ä»¶)ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2017/11/08/171108/19_29_20.png" title="ä¿å­˜ç»Ÿè®¡æ•°æ®"><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>éœ€æ±‚è§£å†³ ï¼ˆçœŸæ˜¯è¸ç ´é“é‹æ— è§…å¤„â€¦ï¼‰</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œéœ€è¦ç»Ÿè®¡ kairosdb çš„æ€§èƒ½éšæ—¶é—´çš„å˜åŒ–æƒ…å†µã€‚&lt;/p&gt;
&lt;h2 id=&quot;åˆ†æ&quot;&gt;&lt;a href=&quot;#åˆ†æ&quot; class=
      
    
    </summary>
    
      <category term="Linux" scheme="https://jasonsonghoho.github.io/categories/Linux/"/>
    
    
      <category term="è¸©å‘è®°" scheme="https://jasonsonghoho.github.io/public/tags/%E8%B8%A9%E5%9D%91%E8%AE%B0/"/>
    
      <category term="java" scheme="https://jasonsonghoho.github.io/public/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Dubbo Telnet å‘½ä»¤</title>
    <link href="https://jasonsonghoho.github.io/2017/10/23/171023/"/>
    <id>https://jasonsonghoho.github.io/2017/10/23/171023/</id>
    <published>2017-10-23T14:08:41.000Z</published>
    <updated>2018-09-22T02:45:28.893Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><div class="markdown-toc editormd-markdown-toc"><ul class="markdown-toc-list"><li><a class="toc-level-2" href="#login" level="2">login</a></li><li><a class="toc-level-2" href="#status" level="2">status</a></li><li><a class="toc-level-2" href="#ls" level="2">ls</a></li><li><a class="toc-level-2" href="#ps" level="2">ps</a></li><li><a class="toc-level-2" href="#trace" level="2">trace</a></li><li><a class="toc-level-2" href="#invoke" level="2">invoke</a></li><li><a class="toc-level-2" href="#more" level="2">more</a><ul></ul></li></ul></div><blockquote><p>ä» 2.0.5 ç‰ˆæœ¬å¼€å§‹ï¼Œdubbo å¼€å§‹æ”¯æŒé€šè¿‡ telnet å‘½ä»¤æ¥é•œåƒæœåŠ¡æ²»ç†ã€‚</p></blockquote><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>telnet localhost 20880(dubboæˆ–æœåŠ¡ç«¯å£)</p><img src="/2017/10/23/171023/login.png" title="login"><h2 id="status"><a href="#status" class="headerlink" title="status"></a>status</h2><ol><li>status: æ˜¾ç¤ºæ±‡æ€»çŠ¶æ€ï¼Œè¯¥çŠ¶æ€å°†æ±‡æ€»æ‰€æœ‰èµ„æºçš„çŠ¶æ€ï¼Œå½“å…¨éƒ¨ OK æ—¶åˆ™æ˜¾ç¤º OKï¼Œåªè¦æœ‰ä¸€ä¸ª ERROR åˆ™æ˜¾ç¤º ERRORï¼Œåªè¦æœ‰ä¸€ä¸ª WARN åˆ™æ˜¾ç¤º WARN</li><li>status -l: æ˜¾ç¤ºçŠ¶æ€åˆ—è¡¨</li></ol><p>è§ä¸Šå›¾</p><h2 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h2><p>æ˜¾ç¤ºæœåŠ¡åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨ã€å‚æ•°ç­‰</p><ol><li>ls: æ˜¾ç¤ºæœåŠ¡åˆ—è¡¨</li><li>ls -l: æ˜¾ç¤ºæœåŠ¡è¯¦ç»†ä¿¡æ¯åˆ—è¡¨</li><li>ls XxxService: æ˜¾ç¤ºæœåŠ¡çš„æ–¹æ³•åˆ—è¡¨</li><li>ls -l XxxService: æ˜¾ç¤ºæœåŠ¡çš„æ–¹æ³•è¯¦ç»†ä¿¡æ¯åˆ—è¡¨</li></ol><img src="/2017/10/23/171023/ps&ls.png" title="ls"><h2 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h2><p>æ˜¾ç¤ºæœåŠ¡ç«¯å£åˆ—è¡¨ï¼Œå¯ç”¨æ¥æŸ¥çœ‹æœåŠ¡æ˜¯å¦å·²æˆåŠŸæ³¨å†Œ</p><ol><li>ps: æ˜¾ç¤ºæœåŠ¡ç«¯å£åˆ—è¡¨</li><li>ps -l: æ˜¾ç¤ºæœåŠ¡åœ°å€åˆ—è¡¨</li><li>ps 20880: æ˜¾ç¤ºç«¯å£ä¸Šçš„è¿æ¥ä¿¡æ¯</li><li>ps -l 20880: æ˜¾ç¤ºç«¯å£ä¸Šçš„è¿æ¥è¯¦ç»†ä¿¡æ¯</li></ol><p>è§ä¸Šå›¾</p><h2 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h2><p>è·Ÿè¸ªæœåŠ¡ä»»æ„æ–¹æ³•çš„è°ƒç”¨æƒ…å†µ</p><ol><li>trace XxxService: è·Ÿè¸ª 1 æ¬¡æœåŠ¡ä»»æ„æ–¹æ³•çš„è°ƒç”¨æƒ…å†µ</li><li>trace XxxService 10: è·Ÿè¸ª 10 æ¬¡æœåŠ¡ä»»æ„æ–¹æ³•çš„è°ƒç”¨æƒ…å†µ</li><li>trace XxxService xxxMethod: è·Ÿè¸ª 1 æ¬¡æœåŠ¡æ–¹æ³•çš„è°ƒç”¨æƒ…å†µ</li><li>trace XxxService xxxMethod 10: è·Ÿè¸ª 10 æ¬¡æœåŠ¡æ–¹æ³•çš„è°ƒç”¨æƒ…å†µ</li></ol><img src="/2017/10/23/171023/trace.png" title="trace"><h2 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h2><p>è°ƒç”¨æœåŠ¡çš„æ–¹æ³•ï¼Œé€šè¿‡è¯¥å‘½ä»¤å¯ç›´æ¥è°ƒè¯•æ–¹æ³•ã€‚</p><ol><li>invoke XxxService.xxxMethod({â€œpropâ€: â€œvalueâ€}): è°ƒç”¨æœåŠ¡çš„æ–¹æ³•</li><li>invoke xxxMethod({â€œpropâ€: â€œvalueâ€}): è°ƒç”¨æœåŠ¡çš„æ–¹æ³•(è‡ªåŠ¨æŸ¥æ‰¾åŒ…å«æ­¤æ–¹æ³•çš„æœåŠ¡)</li></ol><img src="/2017/10/23/171023/invoke.png" title="invoke"><h2 id="more"><a href="#more" class="headerlink" title="more"></a>more</h2><p>æ›´å¤š Dubbo Telnet å‘½ä»¤è¯·å‚é˜…ï¼š<a href="https://dubbo.gitbooks.io/dubbo-user-book/references/telnet.html" target="_blank" rel="noopener">Telnet å‘½ä»¤å‚è€ƒæ‰‹å†Œ</a> </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of Contents)&quot;&gt;&lt;/a&gt; &lt;strong&gt;ç›®å½• (Table of C
      
    
    </summary>
    
      <category term="ä¸­é—´ä»¶" scheme="https://jasonsonghoho.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="dubbo" scheme="https://jasonsonghoho.github.io/public/tags/dubbo/"/>
    
  </entry>
  
  <entry>
    <title>Cassandra å¸¸ç”¨å‘½ä»¤åˆé›†</title>
    <link href="https://jasonsonghoho.github.io/2017/10/22/171022/"/>
    <id>https://jasonsonghoho.github.io/2017/10/22/171022/</id>
    <published>2017-10-22T14:08:41.000Z</published>
    <updated>2018-09-22T02:45:28.889Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><div class="markdown-toc editormd-markdown-toc"><ul class="markdown-toc-list"><li><a class="toc-level-2" href="#ä¿®æ”¹Cassandra æœ€å¤§å¯ç”¨å†…å­˜å¤§å°" level="2">ä¿®æ”¹Cassandra æœ€å¤§å¯ç”¨å†…å­˜å¤§å°</a></li><li><a class="toc-level-2" href="#ç™»å½•CQL" level="2">ç™»å½•CQL</a></li><li><a class="toc-level-2" href="#æŸ¥çœ‹å¢“ç¢‘æ•°æ®æ€»é‡" level="2">æŸ¥çœ‹å¢“ç¢‘æ•°æ®æ€»é‡</a></li><li><a class="toc-level-2" href="#ä¿®å¤è¡¨" level="2">ä¿®å¤è¡¨</a></li><li><a class="toc-level-2" href="#å‹å®æ•°æ®" level="2">å‹å®æ•°æ®</a></li><li><a class="toc-level-2" href="#æŸ¥çœ‹å½“å‰å‹å®æ“ä½œçŠ¶æ€å’Œå†å²å‹å®çºªå½•" level="2">æŸ¥çœ‹å½“å‰å‹å®æ“ä½œçŠ¶æ€å’Œå†å²å‹å®çºªå½•</a></li><li><a class="toc-level-2" href="#æŸ¥çœ‹è¡¨çš„çŠ¶æ€" level="2">æŸ¥çœ‹è¡¨çš„çŠ¶æ€</a></li><li><a class="toc-level-2" href="#Cassandra çº¿ç¨‹æ± çš„ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯" level="2">Cassandra çº¿ç¨‹æ± çš„ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯</a></li><li><a class="toc-level-2" href="#å…¶ä»–" level="2">å…¶ä»–</a><ul></ul></li></ul></div><blockquote><p>æ–‡ä¸­Cassandra å®‰è£…åœ¨/opt ç›®å½•ä¸‹ï¼Œå…·ä½“æ‰§è¡Œå‘½ä»¤éœ€æ ¹æ®è‡ªå·±çš„Cassandraå®‰è£…ç›®å½•è¿›è¡Œè°ƒæ•´ã€‚<br>Cassandra ç‰ˆæœ¬ä¸º 3.5ã€‚</p></blockquote><h2 id="ä¿®æ”¹Cassandra-æœ€å¤§å¯ç”¨å†…å­˜å¤§å°"><a href="#ä¿®æ”¹Cassandra-æœ€å¤§å¯ç”¨å†…å­˜å¤§å°" class="headerlink" title="ä¿®æ”¹Cassandra æœ€å¤§å¯ç”¨å†…å­˜å¤§å°"></a>ä¿®æ”¹Cassandra æœ€å¤§å¯ç”¨å†…å­˜å¤§å°</h2><p>Cassandra é»˜è®¤æœ€å¤§å¯ç”¨å†…å­˜å’Œåˆå§‹å†…å­˜å¤§å°(-Xmx ã€-Xms )ä¸º 4G ï¼Œé€šå¸¸æƒ…å†µä¸‹åå°ã€‚</p><p>ä¿®æ”¹æœ€å¤§å†…å­˜å¤§å°å¯ç›´æ¥ä¿®æ”¹ cassandra/conf/cassandra-env.sh ä¸­ MAX_HEAP_SIZE å‚æ•°ï¼š<code>MAX_HEAP_SIZE=&quot;4G&quot;</code></p><p>cassandra æœ‰ä¸¤ç§GCç­–ç•¥ï¼Œç³»ç»Ÿå†…å­˜åœ¨14Gä»¥ä¸Šï¼Œæ¨èä½¿ç”¨ G1ç­–ç•¥ã€‚é»˜è®¤ä½¿ç”¨çš„æ˜¯CMSç­–ç•¥ã€‚å‚é˜…<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/operations/opsTuneJVM.html" target="_blank" rel="noopener">Tuning Java resources </a></p><h2 id="ç™»å½•CQLã€æŸ¥çœ‹ç‰ˆæœ¬"><a href="#ç™»å½•CQLã€æŸ¥çœ‹ç‰ˆæœ¬" class="headerlink" title="ç™»å½•CQLã€æŸ¥çœ‹ç‰ˆæœ¬"></a>ç™»å½•CQLã€æŸ¥çœ‹ç‰ˆæœ¬</h2><p>ç™»å½•ï¼š<br><code>/opt/cassandra/bin/cqlsh [ip] -u [username] -p [passwd]</code></p><p>æŸ¥çœ‹ç‰ˆæœ¬ï¼š<br><code>cqlsh&gt;show version</code></p><img src="/2017/10/22/171022/logIn_showVersion.png" title="ç™»å½•CQLã€æŸ¥çœ‹ç‰ˆæœ¬"><h2 id="æŸ¥çœ‹å¢“ç¢‘æ•°æ®æ€»é‡"><a href="#æŸ¥çœ‹å¢“ç¢‘æ•°æ®æ€»é‡" class="headerlink" title="æŸ¥çœ‹å¢“ç¢‘æ•°æ®æ€»é‡"></a>æŸ¥çœ‹å¢“ç¢‘æ•°æ®æ€»é‡</h2><p>æ²¡æœ‰ç›´æ¥æŸ¥çœ‹å¢“ç¢‘æ•°é‡çš„å¥½æ–¹æ³•ï¼Œå¯åœ¨CQL ä¸­å¼€å¯tracingï¼Œæ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¼šæç¤ºå…·ä½“è¡¨å«æœ‰å¤šå°‘å¢“ç¢‘æ•°æ®ï¼š</p><img src="/2017/10/22/171022/count_tombstone.png" title="å¢“ç¢‘æ•°æ®æ€»é‡"><h2 id="ä¿®å¤è¡¨"><a href="#ä¿®å¤è¡¨" class="headerlink" title="ä¿®å¤è¡¨"></a>ä¿®å¤è¡¨</h2><p>ä¿®å¤è¡¨å¯ä»¥æ‰‹åŠ¨åŒæ­¥å„ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼ˆåŒ…æ‹¬å¢“ç¢‘æ•°æ®ï¼‰ï¼Œéœ€åœ¨å„ä¸ªèŠ‚ç‚¹åˆ†åˆ«æ‰§è¡Œ</p><p><code>/opt/cassandra/bin/nodetool  repair kairosdb string_index;</code></p><h2 id="å‹å®æ•°æ®"><a href="#å‹å®æ•°æ®" class="headerlink" title="å‹å®æ•°æ®"></a>å‹å®æ•°æ®</h2><p>å¢“ç¢‘æ•°æ®è¿‡å¤šä¼šå½±å“Cassandraæ€§èƒ½ã€‚å‹å®æ•°æ®ï¼Œå¯æ¶ˆé™¤å¢“ç¢‘æ•°æ®ã€‚å‹å®å‰ï¼Œéœ€è¿›è¡Œè¡¨æ•°æ®çš„ä¿®å¤ï¼Œä»¥é˜²åˆ é™¤æ•°æ®æ¢å¤ã€‚</p><ol><li>æ‰‹åŠ¨å‹å®ï¼š</li></ol><p><code>/opt/cassandra/bin/nodetool  compact  kairosdb string_index</code></p><ol start="2"><li><p>å¼€å¯è‡ªåŠ¨å‹å®(é»˜è®¤å·²å¼€å¯)ï¼š<code>/opt/cassandra/bin/nodetool enableautocompaction</code></p></li><li><p>ä¿®æ”¹è¡¨çš„å‹å®ç­–ç•¥ï¼š</p></li></ol><p><code>ALTER TABLE kairosdb.string_index   WITH compaction =   {&#39;class&#39; : &#39;SizeTieredCompactionStrategy&#39;, &#39;min_threshold&#39; : 6 };</code></p><ol start="4"><li>ä¿®æ”¹è‡ªåŠ¨å‹å®å‘¨æœŸï¼š</li></ol><p>é»˜è®¤å‹å®æ—¶é—´ä¸º864000ï¼Œå³10å¤©ï¼Œä¿®æ”¹ä¸ºä¸€å¤©ï¼š<code>alter table kairosdb.string_index with GC_GRACE_SECONDS = 86400;</code></p><p>å…³äºå‹å®ç­–ç•¥ï¼Œè¯·å‚é˜…ï¼š<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataMaintain.html" target="_blank" rel="noopener">How is data maintained</a></p><h2 id="æŸ¥çœ‹å½“å‰å‹å®æ“ä½œçŠ¶æ€å’Œå†å²å‹å®çºªå½•"><a href="#æŸ¥çœ‹å½“å‰å‹å®æ“ä½œçŠ¶æ€å’Œå†å²å‹å®çºªå½•" class="headerlink" title="æŸ¥çœ‹å½“å‰å‹å®æ“ä½œçŠ¶æ€å’Œå†å²å‹å®çºªå½•"></a>æŸ¥çœ‹å½“å‰å‹å®æ“ä½œçŠ¶æ€å’Œå†å²å‹å®çºªå½•</h2><p><code>/opt/cassandra/bin/nodetool  compactionstats;/opt/cassandra/bin/nodetool  compactionhistory;</code></p><img src="/2017/10/22/171022/compaction.png" title="compaction"><h2 id="æŸ¥çœ‹è¡¨çš„çŠ¶æ€"><a href="#æŸ¥çœ‹è¡¨çš„çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹è¡¨çš„çŠ¶æ€"></a>æŸ¥çœ‹è¡¨çš„çŠ¶æ€</h2><p><code>/opt/cassandra/bin/nodetool  cfstats kairosdb.data_points  æˆ–/opt/cassandra/bin/nodetool  tablestats kairosdb.data_points;</code></p><img src="/2017/10/22/171022/cfstats.png" title="cfstats"><h2 id="Cassandra-çº¿ç¨‹æ± çš„ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯"><a href="#Cassandra-çº¿ç¨‹æ± çš„ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯" class="headerlink" title="Cassandra çº¿ç¨‹æ± çš„ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯"></a>Cassandra çº¿ç¨‹æ± çš„ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯</h2><p>CassandraåŸºäºåˆ†é˜¶æ®µäº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆSEDAï¼‰ã€‚Cassandraå°†ä¸åŒçš„ä»»åŠ¡åˆ†æˆç”±æ¶ˆæ¯æœåŠ¡è¿æ¥çš„å¾ˆå¤šé˜¶æ®µã€‚æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ªé˜Ÿåˆ—å’Œä¸€ä¸ªçº¿ç¨‹æ± ã€‚å¦‚æœä¸‹ä¸€ä¸ªé˜¶æ®µå¤ªå¿™ï¼ŒCassandraä¼šå¤‡ä»½é˜Ÿåˆ—ï¼Œå¹¶å°†å¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚</p><p><code>/opt/cassandra/bin/nodetool tpstats;</code></p><img src="/2017/10/22/171022/tpstats.png" title="tpstats"><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>æ›´å¤š cassandraå‘½ä»¤è¯·å‚é˜…ï¼š<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/tools/toolsNodetool.html" target="_blank" rel="noopener">The nodetool utility</a> ã€<a href="https://docs.datastax.com/en/cassandra/3.0/index.html" target="_blank" rel="noopener">Apache Cassandra</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of Contents)&quot;&gt;&lt;/a&gt; &lt;strong&gt;ç›®å½• (Table of C
      
    
    </summary>
    
      <category term="æ•°æ®åº“" scheme="https://jasonsonghoho.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="cassandra" scheme="https://jasonsonghoho.github.io/public/tags/cassandra/"/>
    
      <category term="cql" scheme="https://jasonsonghoho.github.io/public/tags/cql/"/>
    
  </entry>
  
  <entry>
    <title>è®°ä¸€æ¬¡store æŒ‡æ ‡åº“ çº¿ä¸Šæ•…éšœçš„æ’æŸ¥</title>
    <link href="https://jasonsonghoho.github.io/2017/09/28/170928/"/>
    <id>https://jasonsonghoho.github.io/2017/09/28/170928/</id>
    <published>2017-09-28T14:08:41.000Z</published>
    <updated>2018-09-20T15:23:28.336Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›®å½•-Table-of-Contents"><a href="#ç›®å½•-Table-of-Contents" class="headerlink" title=" ç›®å½• (Table of Contents)"></a> <strong>ç›®å½• (Table of Contents)</strong></h2><div class="markdown-toc editormd-markdown-toc"><ul class="markdown-toc-list"><li><a class="toc-level-2" href="#ç¯å¢ƒ" level="2">ç¯å¢ƒ</a></li><li><a class="toc-level-2" href="#é—®é¢˜&amp;åˆ†æ&amp;è§£å†³" level="2">é—®é¢˜&amp;åˆ†æ&amp;è§£å†³</a><ul><li><a class="toc-level-4" href="#é—®é¢˜1" level="4">é—®é¢˜1</a></li><li><a class="toc-level-4" href="#åˆ†æ" level="4">åˆ†æ</a></li><li><a class="toc-level-4" href="#è§£å†³" level="4">è§£å†³</a></li><li><a class="toc-level-4" href="#é—®é¢˜2" level="4">é—®é¢˜2</a></li><li><a class="toc-level-4" href="#åˆ†æ" level="4">åˆ†æ</a></li><li><a class="toc-level-4" href="#è§£å†³" level="4">è§£å†³</a></li><li><a class="toc-level-4" href="#å…¶ä»–é—®é¢˜" level="4">å…¶ä»–é—®é¢˜</a></li><li><a class="toc-level-4" href="#åˆ†æ&amp;è§£å†³" level="4">åˆ†æ&amp;è§£å†³</a></li></ul></li><li><a class="toc-level-2" href="#å…¶ä»–" level="2">å…¶ä»–</a></li><li><a class="toc-level-2" href="#èµ„æ–™" level="2">èµ„æ–™</a><ul></ul></li></ul></div><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>ç»Ÿè®¡å±€ï¼Œä¸‰ä¸ªèŠ‚ç‚¹é…ç½®ä¸€æ ·ï¼š</p><ul><li>å†…å­˜ï¼š500+G</li><li>CPUï¼š4*13 core</li></ul><p>Cassandra ã€kaiorsdb  ã€æŒ‡æ ‡åº“éƒ½æ˜¯ä»¥é›†ç¾¤æ¨¡å¼éƒ¨ç½²åœ¨ä¸‰å°æœºå™¨ä¸Šã€‚</p><h2 id="é—®é¢˜-amp-åˆ†æ-amp-è§£å†³"><a href="#é—®é¢˜-amp-åˆ†æ-amp-è§£å†³" class="headerlink" title="é—®é¢˜&amp;åˆ†æ&amp;è§£å†³"></a>é—®é¢˜&amp;åˆ†æ&amp;è§£å†³</h2><h4 id="é—®é¢˜1"><a href="#é—®é¢˜1" class="headerlink" title="é—®é¢˜1"></a>é—®é¢˜1</h4><p>ç»Ÿè®¡å±€ monitorçº¿ä¸Šç¯å¢ƒ ç»Ÿè®¡æŠ¥è¡¨å’Œä»ªè¡¨ç›˜éƒ¨åˆ†åŠ è½½ç¼“æ…¢ï¼ŒåŠ è½½æ—¶é—´åœ¨8ç§’å·¦å³ã€‚</p><img src="/2017/09/28/170928/load_time.png" title="åŠ è½½æ—¶é—´1"><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>é¦–å…ˆçœ‹äº†æŒ‡æ ‡åº“çš„reader æ¨¡å—æ—¥å¿—ï¼Œå‘ç°query å¤§é‡timeoutå¼‚å¸¸ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">17-09-22 14:12:29.208 WARN  [DubboServerHandler-10.6.143.124:7513-thread-576] [c.a.d.rpc.filter.TimeoutFilter]  [DUBBO] invoke time out. method: queryarguments: [e10adc3949ba59abbe56e057f20f88dd, DatapointQuery&#123;metric=&apos;system.mem.pct_usage&apos;, time=DatapointQueryTime&#123;start=1506060435275, end=1506060735275, interval=1, interval_unit=&apos;seconds&apos;, aggregator=AVG, align_start_time=false, align_sampling=false&#125;, tags=&#123;tenantId=e10adc3949ba59abbe56e057f20f88dd&#125;, groupBy=DatapointQueryGroupBy&#123;tagKeys=[object]&#125;, useCache=false&#125;] , url is dubbo://10.6.143.124:7513/uyun.indian.reader.api.ReaderService?anyhost=true&amp;application=indian-reader&amp;default.accepts=1000&amp;default.threadpool=cached&amp;default.threads=500&amp;default.timeout=5000&amp;dubbo=2.8.4.170831&amp;generic=false&amp;interface=uyun.indian.reader.api.ReaderService&amp;methods=queryByResId,query,queryAllMetrics,queryTags&amp;pid=20707&amp;revision=api&amp;serialization=kryo&amp;side=provider&amp;timestamp=1505982696415, invoke elapsed 6361 ms., dubbo version: 2.8.4.170831, current host: 10.6.143.124</span><br><span class="line">17-09-22 14:13:00.201 WARN  [DubboServerHandler-10.6.143.124:7513-thread-568] [c.a.d.rpc.filter.TimeoutFilter]  [DUBBO] invoke time out. method: queryAllMetricsarguments: [e10adc3949ba59abbe56e057f20f88dd] , url is dubbo://10.6.143.124:7513/uyun.indian.reader.api.ReaderService?anyhost=true&amp;application=indian-reader&amp;default.accepts=1000&amp;default.threadpool=cached&amp;default.threads=500&amp;default.timeout=5000&amp;dubbo=2.8.4.170831&amp;generic=false&amp;interface=uyun.indian.reader.api.ReaderService&amp;methods=queryByResId,query,queryAllMetrics,queryTags&amp;pid=20707&amp;revision=api&amp;serialization=kryo&amp;side=provider&amp;timestamp=1505982696415, invoke elapsed 6939 ms., dubbo version: 2.8.4.170831, current host: 10.6.143.124</span><br></pre></td></tr></table></figure><h4 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>query ä½¿ç”¨çš„ kairosdbçš„è¯»æ–¹æ³•ã€‚<a href="https://github.com/kairosdb/kairosdb/wiki/Query-Performance" target="_blank" rel="noopener">kairosdb wiki</a>ä¸ŠæŒ‡å‡ºï¼Œå½“æŒ‡æ ‡çš„ tag/value ç»„åˆå¤ªå¤§æ—¶ï¼ŒæŸ¥è¯¢æ—¶å°†å˜å¾—éå¸¸ç¼“æ…¢ã€‚<br>è€ŒmonitoræŠ¥è¡¨ æ¯æ¬¡æŸ¥è¯¢éœ€è¦æ±‡èšä¸€å¤©çš„æ•°æ®ã€‚ä¸€å¤©çš„æŒ‡æ ‡æ•°æ®é‡å’Œè¯»å–æ—¶é—´å¦‚ä¸‹ï¼š</p><p>ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨<a href="https://github.com/zachm/tscached" target="_blank" rel="noopener">TScached</a>è¿›è¡Œè¯»å–ï¼Œtscached æ˜¯kairosdb çš„ä¸€ä¸ªç¼“å­˜ä»£ç†ï¼ŒåŠ è½½é€Ÿåº¦å¯ä»¥æ˜¯kairosdbçš„100å€ï¼ˆè¿™æ˜¯å®ƒè‡ªå·±è¯´çš„ï¼Œæ„Ÿè§‰æœ‰ç‚¹å¤¸å¼ äº†ï¼‰ã€‚<br>æŒ‡æ ‡åº“ä¹‹å‰å·²ç»é…ç½®è¿‡ TScachedï¼Œåæ¥åœç”¨äº†ã€‚é‡æ–°å¯ç”¨åï¼ŒæŠ¥è¡¨çš„åŠ è½½é€Ÿåº¦æ˜æ˜¾åŠ å¿«ï¼Œä¸å†æŠ¥è¶…æ—¶ã€‚ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">17-09-28 10:01:26.123 INFO  [reporter-thread-1   ] [u.i.method.elapsedtime.report ] ********************* start report 2017-09-28 09:56:26 to 2017-09-28 10:01:26 *********************</span><br><span class="line">17-09-28 10:01:26.131 INFO  [reporter-thread-1   ] [u.i.method.elapsedtime.report ] methodName=uyun.indian.reader.impl.KairosdbReader, count=320, min=16ms, max=1496ms, avg=116.33ms, median=66.00ms, p75=156.00ms, p95=278.95ms, p99=889.79ms</span><br><span class="line">17-09-28 10:01:26.133 INFO  [reporter-thread-1   ] [u.i.method.elapsedtime.report ] methodName=uyun.indian.reader.impl.ReaderServiceImpl.query, count=592, min=16ms, max=1732ms, avg=105.24ms, median=62.00ms, p75=105.00ms, p95=276.05ms, p99=936.27ms</span><br><span class="line">17-09-28 10:01:26.133 INFO  [reporter-thread-1   ] [u.i.method.elapsedtime.report ] methodName=uyun.indian.reader.impl.ReaderServiceImpl.queryAllMetrics, count=1, min=4ms, max=4ms, avg=4.00ms, median=4.00ms, p75=4.00ms, p95=4.00ms, p99=4.00ms</span><br><span class="line">17-09-28 10:01:26.134 INFO  [reporter-thread-1   ] [u.i.method.elapsedtime.report ] methodName=uyun.indian.reader.impl.ReaderServiceImpl.queryByResId, count=2, min=2ms, max=40ms, avg=21.00ms, median=21.00ms, p75=40.00ms, p95=40.00ms, p99=40.00ms</span><br><span class="line">17-09-28 10:01:26.134 INFO  [reporter-thread-1   ] [u.i.method.elapsedtime.report ] methodName=uyun.indian.reader.impl.ReaderServiceImpl.queryTags, count=4, min=37ms, max=38ms, avg=37.50ms, median=37.50ms, p75=38.00ms, p95=38.00ms, p99=38.00ms</span><br><span class="line">17-09-28 10:01:26.135 INFO  [reporter-thread-1   ] [u.i.method.elapsedtime.report ] methodName=uyun.indian.reader.impl.TScachedReader, count=272, min=22ms, max=1732ms, avg=91.88ms, median=57.00ms, p75=75.75ms, p95=241.05ms, p99=1092.88ms</span><br><span class="line">17-09-28 10:01:26.135 INFO  [reporter-thread-1   ] [u.i.method.elapsedtime.report ] ********************* end report *********************</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h4><p>query æ–¹æ³•é€Ÿåº¦ä¸Šæ¥ä¹‹åï¼Œå‘ç°queryAllMetrics æ–¹æ³•å‡ºç°è¶…æ—¶ç°è±¡ï¼ŒæŒ‰é—®é¢˜1çš„è§£å†³åŠæ³•å¤„ç†åï¼Œå‘ç°ä»æœ‰é—®é¢˜ï¼Œåæ”¹ç”¨è¯»redis ç¼“å­˜çš„æ–¹å¼åï¼Œæš‚æ—¶è§£å†³ã€‚<br>ä½†Cassandraçš„èµ„æºæ¶ˆè€—ä»æ¯”è¾ƒå¤§</p><img src="/2017/09/28/170928/cassandra1.png" title="Cassandra èµ„æºæ¶ˆè€—"><img src="/2017/09/28/170928/cassandra2.png" title="Cassandra èµ„æºæ¶ˆè€—"><h4 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>æŸ¥çœ‹Cassandra systemæ—¥å¿—åå‘ç° kairosdb.data_points è¡¨ä¸­å­˜åœ¨å¤§é‡<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlAboutDeletes.html" target="_blank" rel="noopener">tombstone</a>(å¢“ç¢‘)æ•°æ®è­¦å‘Šï¼Œä¸¥é‡å½±å“äº†Cassandraæ€§èƒ½ã€‚éœ€å¯¹Cassandra è¿›è¡Œæ•°æ®<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataMaintain.html" target="_blank" rel="noopener">compact</a>(å‹å®)æ“ä½œï¼Œä»¥æ¸…é™¤å¢“ç¢‘æ•°æ®ã€‚<br>åœ¨å¯¹æ•°æ®è¿›è¡Œå‹å®æ“ä½œä¹‹å‰ï¼Œéœ€è¦å…ˆ<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/operations/opsRepairNodesManualRepair.html" target="_blank" rel="noopener">repair</a>(ä¿®å¤)ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARN  [SharedPool-Worker-30] 2017-09-26 15:48:50,818 ReadCommand.java:481 - Read 1024 live rows and 22072 tombstone cells for query SELECT value FROM kairosdb.data_points WHERE key = 65313061646333393439626135396162626535366530353766323066383864647e73797374656d2e6e65742e62797465735f72637664000000015dc970d000000d6b6169726f735f646f75626c656465766963653d6962313a686f73743d646d3031646261646d30342e73746174732e676f762e636e3a69703d31302e362e3133342e38303a6f626a6563743d3539383763643931633633396438613830633433653631383a74656e616e7449643d65313061646333393439626135396162626535366530353766323066383864643a AND column1 &gt;= 00000000 AND column1 &lt;= 9dd94 (see tombstone_warn_threshold)</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨Cassandraä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯å†™å…¥ï¼ŒåŒ…æ‹¬é€»è¾‘åˆ é™¤æ•°æ®ï¼Œå½“ä½ åˆ é™¤ä¸€æ¡æ•°æ®æ—¶ï¼Œå…¶å®æ˜¯ç»™è¿™æ¡æ•°æ®è¿›è¡Œupdateï¼Œç»™å®ƒupdateä¸Šä¸€ä¸ªæ ‡è¯†ï¼Œå°±æ˜¯ä¸€ä¸ªå¢“ç¢‘æ ‡è¯†ã€‚ å½“Cassandraé›†ç¾¤åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´åŒæ­¥åˆ é™¤ä¿¡æ¯çš„æ—¶å€™ï¼Œä¹Ÿä¼šç”¨åˆ°Tombstones(å¢“ç¢‘)ï¼Œå¯ä»¥è¯´å¢“ç¢‘æ˜¯ä¸€ç§å…è®¸Cassandraå¿«é€Ÿå†™å…¥çš„æœºåˆ¶ã€‚ </p></blockquote><p>å…³äºCassandra å¦‚ä½•ç»´æŠ¤æ•°æ®ï¼Œå¯å‚è€ƒ  <a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataMaintain.html" target="_blank" rel="noopener">Cassandra æ•°æ®ç»´æŠ¤å®˜æ–¹æ–‡æ¡£</a></p><h4 id="è§£å†³-1"><a href="#è§£å†³-1" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>å…·ä½“å‹å®æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>cassandra é»˜è®¤å‹ç¼©å‘¨æœŸä¸º10å¤©ï¼Œé¦–å…ˆå°†å‹ç¼©å‘¨æœŸè®¾ä¸º1å¤©ï¼Œè®¾ç½® gc_grace_seconds å‚æ•°ï¼Œ</li></ol><p>ç™»å½•Cassandra:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cqlsh host -u user -p pswd</span><br></pre></td></tr></table></figure><p>è®¾ç½®kairosdbçš„è¡¨çš„å‹ç¼©å‘¨æœŸè®¾ä¸º ä¸€å¤©ï¼ˆ86400 sï¼‰: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alter table kairosdb.string_index with gc_grace_seconds = 86400;alter table kairosdb.data_points with GC_GRACE_SECONDS = 86400;alter table kairosdb.row_key_index with GC_GRACE_SECONDS = 86400;</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">è®¾ç½®å®Œå ï¼Œè¿è¡Œ`DESC kairosdb;`ï¼Œå¯ä»¥çœ‹åˆ° **gc_grace_seconds**å·²è¢«è®¾ä¸º86400ï¼›</span><br></pre></td></tr></table></figure><p>CREATE TABLE kairosdb.string_index (<br>    key blob,<br>    column1 text,<br>    value blob,<br>    PRIMARY KEY (key, column1)<br>) WITH COMPACT STORAGE<br>    AND CLUSTERING ORDER BY (column1 ASC)<br>    AND bloom_filter_fp_chance = 0.01<br>    AND caching = {â€˜keysâ€™: â€˜ALLâ€™, â€˜rows_per_partitionâ€™: â€˜NONEâ€™}<br>    AND comment = â€˜â€™<br>    AND compaction = {â€˜classâ€™: â€˜org.apache.cassandra.db.compaction.SizeTieredCompactionStrategyâ€™, â€˜max_thresholdâ€™: â€˜32â€™, â€˜min_thresholdâ€™: â€˜4â€™}<br>    AND compression = {â€˜chunk_length_in_kbâ€™: â€˜64â€™, â€˜classâ€™: â€˜org.apache.cassandra.io.compress.LZ4Compressorâ€™}<br>    AND crc_check_chance = 1.0<br>    AND dclocal_read_repair_chance = 0.1<br>    AND default_time_to_live = 0<br>     AND gc_grace_seconds = 86400<br>    AND max_index_interval = 2048<br>    AND memtable_flush_period_in_ms = 0<br>    AND min_index_interval = 128<br>    AND read_repair_chance = 1.0<br>    AND speculative_retry = â€˜NONEâ€™;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">2.  ä¸ºäº†ç»Ÿä¸€å„ä¸ªèŠ‚ç‚¹çš„å¢“ç¢‘æ•°æ®ï¼Œéœ€åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šåˆ†åˆ«è¿è¡Œä¿®å¤kairosdbä¸‹å„ä¸ªè¡¨ï¼Œé˜²æ­¢å·²åˆ é™¤æ•°æ®é‡ç”Ÿ;</span><br></pre></td></tr></table></figure><p>nodetool  repair kairosdb row_key_index<br>nodetool  repair kairosdb string_index<br>nodetool  repair kairosdb data_points<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*æ­¤å¤„è¿è¡Œä¿®å¤æ—¶ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„data_pointsè¡¨ç”±äºæ•°æ®å¤ªå¤§ï¼Œä¸€ç›´æ²¡æœ‰å®Œå…¨ä¿®å¤æˆåŠŸï¼ˆsome repair failed ï¼‰ã€‚ç”±äºæ•°æ®é‡è¾ƒå¤§ï¼Œä¸”æ¥å—åˆ æ‰çš„æ•°æ®å†æ¬¡æ¢å¤ï¼Œæ­¤å¤„é‡‡å–çš„æªæ–½æ˜¯å¿½ç•¥è¯¥è¡¨ã€‚</span><br><span class="line"></span><br><span class="line">3.  ä¿®å¤å®Œåå†åˆ†åˆ«è¿›è¡Œå‹å®æ“ä½œ:</span><br></pre></td></tr></table></figure></p><p>nodetool  compact  kairosdb row_key_index<br>nodetool  compact  kairosdb string_index<br>nodetool  compact  kairosdb data_points<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">å‹å®æ“ä½œå¯ç”¨`nodetool  compactionstats` å’Œ `nodetool  compactionhistory`åˆ†åˆ«æŸ¥çœ‹å½“å‰å’Œå†å²çš„å‹å®é€ ä½œ;</span><br><span class="line"></span><br><span class="line">&#123;% asset_img compactionstats.png å‹å®çŠ¶æ€ %&#125;</span><br><span class="line"></span><br><span class="line">4.  å¼€å¯è‡ªåŠ¨å‹å®æ“ä½œï¼ˆé»˜è®¤å·²å¼€å¯ï¼‰ï¼š`nodetool enableautocompaction` </span><br><span class="line"></span><br><span class="line">æ“ä½œå®Œåï¼ŒCassandra ä¼šè‡ªåŠ¨å‹ç¼©ä¸€äº›å…¶ä»–è¡¨çš„æ•°æ®ã€‚ç»“æŸåï¼ŒCassandra æ—¥å¿—ä¸­data_pointsè¡¨ å¢“ç¢‘è­¦å‘Šè®°å½•å¢“ç¢‘æ•°é‡å¤§å¹…å˜å°ï¼Œå¯ä»¥å‘ç°Cassandraå¯¹èµ„æºçš„å ç”¨å˜åˆ°æ­£å¸¸æ°´å¹³ã€‚ </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### å…¶ä»–é—®é¢˜</span><br><span class="line"></span><br><span class="line">1.  cassandra æ—¥å¿—æŠ¥ï¼š</span><br><span class="line"></span><br><span class="line">``</span><br><span class="line"> INFO  [IndexSummaryManager:1] 2017-09-28 08:16:56,278 IndexSummaryRedistribution.java:74 - Redistributing index summaries</span><br><span class="line"> INFO  [SharedPool-Worker-1] 2017-09-28 08:19:46,973 NoSpamLogger.java:91 - Maximum memory usage reached (536870912 bytes), cannot allocate chunk of 1048576 bytes</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">2.  Dubbo æ¶ˆè´¹è€…æŠ¥ï¼šNo provider available for the serviceã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### åˆ†æ&amp;è§£å†³</span><br><span class="line"></span><br><span class="line">1.  è°ƒæŸ¥å¾—çŸ¥ï¼ŒåŸå› æ˜¯file_cache_size_in_mbè¾ƒå°ï¼Œæ–‡æ¡£ä¸­æè¿°è¯¥å‚æ•°æ˜¯ç”¨æ¥è¯»[SSTables](https://stackoverflow.com/questions/2576012/what-is-an-sstable)(Sorted Strings Table , is a file of key/value string pairs, sorted by keys)çš„ç¼“å†²åŒºï¼š</span><br><span class="line">&gt;file_cache_size_in_mb :(Default: Smaller of 1/4 heap or 512) Total memory to use for SSTable-reading buffers.</span><br><span class="line"></span><br><span class="line">è°ƒåˆ°1024 ï¼ˆMï¼‰åï¼Œä¸å†æŠ¥è¯¥é—®é¢˜</span><br><span class="line"></span><br><span class="line">2.  æœåŠ¡æ³¨å†Œä¸åˆ°zookeeper ä¸Šï¼ŒçŒœæµ‹å¯èƒ½æ˜¯æœºå™¨IOè´Ÿè½½å¤ªå¤§ã€‚</span><br><span class="line">æ‰§è¡Œ`netstat -nat | awk &apos;&#123;print $6&#125;&apos; | sort | uniq -c | sort -n` ï¼Œå¯ä»¥çœ‹åˆ° CLOSE_WAIT è¿æ¥å¤ªå¤šï¼š</span><br></pre></td></tr></table></figure></p><p>[root@Uyun-DB2 logs]# netstat -nat | awk â€˜{print $6}â€™ | sort | uniq -c | sort -n<br>      1 established)<br>      1 Foreign<br>      2 TIME_WAIT<br>     47 LISTEN<br>   1088 ESTABLISHED<br>   3314 CLOSE_WAIT<br><code>`</code></p><p><code>netstat -nat | grep CLOSE_WAIT</code> åï¼Œå‘ç°æ˜¯kairosdb é€ æˆçš„ï¼ˆçŒœæµ‹æ˜¯ä¹‹å‰Cassandraè´Ÿè½½å¤ªå¤§é€ æˆ ï¼‰ï¼Œå¼ºè¡Œé‡å¯kairosdb åï¼Œå†å¯åŠ¨æŒ‡æ ‡åº“ï¼ŒæœåŠ¡æ­£å¸¸ã€‚</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><ol><li><p>kairosDB ä½œè€…å»ºè®®é‡‡ç”¨<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataMaintain.html#dmlHowDataMaintain__dtcs-compaction" target="_blank" rel="noopener">DateTieredCompactionStrategy</a> (DTCS)å‹å®ç­–ç•¥ï¼Œå‚è€ƒ <a href="https://github.com/kairosdb/kairosdb/issues/23" target="_blank" rel="noopener">kairosDB Issue 23</a>ã€‚éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ã€‚</p></li><li><p>è¿˜æ˜¯ä¼šæœ‰ Cassandra å CPUè¾ƒé«˜çš„ç°è±¡ï¼Œä½†æ—¥å¿—æ­£å¸¸ï¼Œéœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ã€‚</p></li></ol><h2 id="èµ„æ–™"><a href="#èµ„æ–™" class="headerlink" title="èµ„æ–™"></a>èµ„æ–™</h2><p><a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataMaintain.html" target="_blank" rel="noopener">Cassandraâ€“How is data maintained</a></p><p><a href="http://blog.csdn.net/nangongyanya/article/details/54018104" target="_blank" rel="noopener">æ“ä½œCassandraï¼ˆ3ï¼‰-åˆå¹¶ã€å‹å®</a></p><p><a href="http://www.cnblogs.com/didda/p/4728588.html" target="_blank" rel="noopener">Cassandra çš„å‹ç¼©ç­–ç•¥STCSï¼ŒLCS å’Œ DTCS</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç›®å½•-Table-of-Contents&quot;&gt;&lt;a href=&quot;#ç›®å½•-Table-of-Contents&quot; class=&quot;headerlink&quot; title=&quot; ç›®å½• (Table of Contents)&quot;&gt;&lt;/a&gt; &lt;strong&gt;ç›®å½• (Table of C
      
    
    </summary>
    
      <category term="æ•°æ®åº“" scheme="https://jasonsonghoho.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="cassandra" scheme="https://jasonsonghoho.github.io/public/tags/cassandra/"/>
    
      <category term="kairosdb" scheme="https://jasonsonghoho.github.io/public/tags/kairosdb/"/>
    
      <category term="TScached" scheme="https://jasonsonghoho.github.io/public/tags/TScached/"/>
    
      <category term="linux" scheme="https://jasonsonghoho.github.io/public/tags/linux/"/>
    
  </entry>
  
</feed>
